<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>BCR Toernooi</title>

  <style>
    /* Alles gescope'd op #bcr-toernooi-app zodat het elders niet stoort */

    #bcr-toernooi-app {
      font-family: system-ui, sans-serif;
      max-width: 1000px;
      margin: 20px auto;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    #bcr-toernooi-app header {
      background: #b30000;
      color: white;
      text-align: center;
      padding: 10px;
      font-size: 1.4em;
      font-weight: 600;
    }

    #bcr-toernooi-app .active-tournament {
      text-align: center;
      font-weight: bold;
      background: #f7f7f7;
      color: #333;
      padding: 8px;
      border-bottom: 1px solid #ddd;
    }

    /* Tabs */
    #bcr-toernooi-app .tab-buttons {
      display: flex;
      justify-content: space-between;
      flex-wrap: nowrap;
      overflow-x: auto;
      background: #eee;
      border-bottom: 1px solid #ccc;
    }

    #bcr-toernooi-app .tab-buttons button {
      flex: 1;
      min-width: 110px;
      background: none;
      border: none;
      padding: 8px 6px;
      font-size: 0.9em;
      cursor: pointer;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      transition: background 0.3s, color 0.3s;
      font-weight: 500;
      color: #333;
    }

    #bcr-toernooi-app .tab-buttons button.active {
      background: #b30000;
      color: #fff;
      font-weight: 600;
    }

    #bcr-toernooi-app .tab-content {
      display: none;
      padding: 20px;
    }

    #bcr-toernooi-app .tab-content.active {
      display: block;
    }

    /* Form layout */
    #bcr-toernooi-app form {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    #bcr-toernooi-app label {
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
    }

    #bcr-toernooi-app input[type="text"],
    #bcr-toernooi-app input[type="number"],
    #bcr-toernooi-app input[type="date"],
    #bcr-toernooi-app textarea,
    #bcr-toernooi-app select {
      width: 100%;
      padding: 6px;
      font-size: 0.95em;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    #bcr-toernooi-app input.small {
      width: 70px;
      text-align: center;
    }

    #bcr-toernooi-app textarea {
      min-height: 60px;
      resize: vertical;
    }

    #bcr-toernooi-app .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px 20px;
    }

    @media (max-width: 600px) {
      #bcr-toernooi-app .form-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Puntenvelden in twee kolommen */
    #bcr-toernooi-app .points-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    #bcr-toernooi-app .points-grid h4 {
      margin: 0 0 6px;
      font-size: 0.9rem;
      font-weight: 600;
      color: #333;
    }

    /* Feedback / meldingen */
    #bcr-toernooi-app #feedback {
      margin-top: 16px;
    }

    #bcr-toernooi-app #feedback .message {
      border-radius: 8px;
      padding: 10px 12px;
      font-weight: 600;
      position: relative;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      line-height: 1.4;
      font-size: 0.9rem;
    }

    #bcr-toernooi-app #feedback .message .close {
      position: absolute;
      top: 8px;
      right: 10px;
      cursor: pointer;
      font-weight: bold;
      opacity: 0.6;
    }

    #bcr-toernooi-app #feedback .message .close:hover {
      opacity: 1;
    }

    /* Knoppenrij onderaan formulier */
    #bcr-toernooi-app .button-row {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    #bcr-toernooi-app .btn {
      flex: 1;
      max-width: 220px;
      padding: 10px 0;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.25s ease;
      color: white;
      text-align: center;
      display: inline-block;
      text-decoration: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }

    #bcr-toernooi-app .btn:active {
      transform: scale(0.97);
    }

    /* Opslaan */
    #bcr-toernooi-app .btn-save {
      background-color: #007bff;
    }
    #bcr-toernooi-app .btn-save:hover {
      background-color: #005dc1;
    }

    /* Laden */
    #bcr-toernooi-app .btn-load {
      background-color: #6c757d;
    }
    #bcr-toernooi-app .btn-load:hover {
      background-color: #555d63;
    }

    /* Verwijderen */
    #bcr-toernooi-app .btn-delete {
      background-color: #dc3545;
    }
    #bcr-toernooi-app .btn-delete:hover {
      background-color: #b02a37;
    }

    /* Extra knoppen in spelers-tab */
    #bcr-toernooi-app .btn-secondary {
      background-color: #6c757d;
    }
    #bcr-toernooi-app .btn-secondary:hover {
      background-color: #555d63;
    }

    #bcr-toernooi-app .btn-lock {
      background-color: #198754;
    }
    #bcr-toernooi-app .btn-lock:hover {
      background-color: #146c43;
    }

    #bcr-toernooi-app .btn-unlock {
      background-color: #0dcaf0;
    }
    #bcr-toernooi-app .btn-unlock:hover {
      background-color: #0aa2c0;
    }

    /* Klein statusblok voor Firestore verbinding */
    #bcr-toernooi-app .connection-status {
      background: #e7f9e7;
      color: #276727;
      padding: 6px 12px;
      margin: 10px;
      border: 1px solid #7cc67c;
      border-radius: 6px;
      font-weight: bold;
      text-align: center;
      box-shadow: 0 0 4px rgba(0,0,0,0.1);
      font-size: 0.9rem;
    }

    /* Tabel spelers */
    #bcr-toernooi-app table.player-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      font-size: 0.9rem;
    }

    #bcr-toernooi-app table.player-table th {
      background: #eee;
      text-align: left;
      padding: 6px;
      border-bottom: 1px solid #ccc;
      font-weight: 600;
      white-space: nowrap;
    }

    #bcr-toernooi-app table.player-table td {
      padding: 6px;
      border-bottom: 1px solid #eee;
      vertical-align: top;
    }

    #bcr-toernooi-app table.player-table td.num {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    #bcr-toernooi-app table.player-table td.actions {
      text-align: center;
    }

    #bcr-toernooi-app table.player-table button.delete-player-btn {
      background: #dc3545;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      padding: 4px 8px;
      transition: background 0.25s ease;
    }

    #bcr-toernooi-app table.player-table button.delete-player-btn:hover {
      background: #b02a37;
    }

    /* Notice als geen toernooi actief is */
    #noTournamentNotice {
      color: #842029;
      background: #f8d7da;
      border: 1px solid #f5c2c7;
      padding: 8px;
      border-radius: 6px;
      margin-bottom: 12px;
      font-weight: 600;
      font-size: 0.9rem;
    }

    /* Kleinere sub-headings in spelers-tab */
    #bcr-toernooi-app h3 {
      margin: 0 0 10px;
      font-size: 1.1rem;
      font-weight: 600;
      color: #333;
    }


#bcr-toernooi-app table.player-table td.actions button {
  margin: 0 2px;
}

  </style>
</head>

<body>
  <div id="bcr-toernooi-app">
    <header>Biljarttoernooi Beheer</header>

    <div class="active-tournament" id="activeTournamentBanner">
      Geen toernooi geselecteerd
    </div>

    <div class="tab-buttons">
      <button class="active" data-tab="toernooi">Toernooi</button>
      <button data-tab="spelers">Spelers</button>
      <button data-tab="r1poules">1e Ronde poules</button>
      <button data-tab="r1resultaten">1e Ronde resultaten</button>
      <button data-tab="r2poules">2e Ronde poules</button>
      <button data-tab="r2resultaten">2e Ronde resultaten</button>
      <button data-tab="finale">Finale</button>
    </div>

    <!-- ===== START TAB: TOERNOOI ===== -->
    <div id="toernooi" class="tab-content active">
      <form id="tournamentForm">

        <div class="form-grid">
          <div>
            <label>Naam toernooi *</label>
            <input type="text" id="tournamentName" required />
          </div>
          <div>
            <label>Jaar *</label>
            <input type="number" id="tournamentYear" class="small" min="1900" max="2099" required />
          </div>
        </div>

        <div>
          <label>Organisatie</label>
          <textarea id="tournamentOrg" rows="3" placeholder="Namen van organisatoren..."></textarea>
        </div>

        <div class="form-grid">
          <div>
            <label>Einde 1e ronde</label>
            <input type="date" id="dateEndR1" />
          </div>
          <div>
            <label>Einde 2e ronde</label>
            <input type="date" id="dateEndR2" />
          </div>
          <div>
            <label>Start finale</label>
            <input type="date" id="dateStartFinale" />
          </div>
          <div>
            <label>Einde finale</label>
            <input type="date" id="dateEndFinale" />
          </div>
        </div>

        <div>
          <label>Maximaal aantal beurten</label>
          <input type="number" id="maxTurns" class="small" min="0" max="999" />
          <label style="font-weight:400; margin-left:8px;">
            <input type="checkbox" id="noMaxTurns" />
            Niet van toepassing
          </label>
        </div>

        <div class="points-grid">
          <div>
            <h4>&lt; kleiner dan max</h4>
            <label>Overwinning</label>
            <input type="number" class="small" id="pointsWinLess" min="0" max="999" />
            <label>Gelijkspel</label>
            <input type="number" class="small" id="pointsDrawLess" min="0" max="999" />
            <label>Nederlaag</label>
            <input type="number" class="small" id="pointsLoseLess" min="0" max="999" />
          </div>

          <div>
            <h4>= max</h4>
            <label>Overwinning</label>
            <input type="number" class="small" id="pointsWinMax" min="0" max="999" />
            <label>Gelijkspel</label>
            <input type="number" class="small" id="pointsDrawMax" min="0" max="999" />
            <label>Nederlaag</label>
            <input type="number" class="small" id="pointsLoseMax" min="0" max="999" />
          </div>
        </div>

        <div class="button-row">
          <button type="submit" id="saveBtn" class="btn btn-save">💾 Opslaan</button>
          <button type="button" id="loadBtn" class="btn btn-load">📂 Toernooi laden</button>
          <button type="button" id="deleteBtn" class="btn btn-delete">🗑️ Verwijder toernooi</button>
        </div>

        <div id="feedback"></div>
      </form>
    </div>
    <!-- ===== END TAB: TOERNOOI ===== -->


<!-- ===== START TAB: SPELERS ===== -->
<div id="spelers" class="tab-content" style="position:relative;">

  <h3>Deelnemers</h3>

  <div id="noTournamentNotice" style="display:none;">
    ⚠️ Geen toernooi geselecteerd. Selecteer eerst een toernooi om deelnemers te beheren.
  </div>

  <div id="playersFinalizedNotice" style="display:none; background:#e2e3e5;color:#41464b;
       border:1px solid #d3d6d8;padding:10px;border-radius:6px;margin-bottom:12px;
       font-weight:600;display:flex;align-items:center;gap:8px;">
    🔒 De spelerslijst is definitief. Toevoegen en verwijderen zijn uitgeschakeld, maar wijzigen blijft mogelijk.
  </div>

  <form id="playerForm" class="form-grid">
    <div>
      <label>Naam speler</label>
      <input type="text" id="playerName" required />
    </div>
    <div>
      <label>E-mailadres</label>
      <input type="text" id="playerEmail" />
    </div>
    <div>
      <label>Telefoonnummer</label>
      <input type="text" id="playerPhone" />
    </div>
    <div>
      <label>Te maken caramboles (1e ronde)</label>
      <input type="number" id="playerCaramboles" min="0" max="999" class="small" />
    </div>
    <div style="grid-column:1/-1;text-align:right;">
      <button type="submit" class="btn btn-save" id="addPlayerBtn" style="min-width:190px;">
        ➕ Speler toevoegen
      </button>
    </div>
  </form>

  <div class="button-row">
    <button type="button" id="sortByName" class="btn btn-secondary">Sorteer op naam</button>
    <button type="button" id="sortByCaramboles" class="btn btn-secondary">Sorteer op caramboles</button>
  </div>

  <div id="playerCount" style="margin-top:10px;font-weight:600;color:#333;">
    Aantal deelnemers: 0
  </div>

  <div id="playersTableContainer" style="position:relative; margin-top:10px;">
    <table id="playerTable" class="player-table" style="width:100%;border-collapse:collapse;">
      <thead>
        <tr>
          <th>Naam</th>
          <th>E-mail</th>
          <th>Telefoon</th>
          <th style="text-align:right;">Caramboles</th>
          <th style="text-align:center;">Acties</th>
        </tr>
      </thead>
      <tbody id="playerTableBody"></tbody>
    </table>

    <!-- ✅ Overlay die verschijnt bij definitieve lijst -->
    <div id="playersLockOverlay" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%;
         background:rgba(240,240,240,0.75); backdrop-filter:blur(2px); border-radius:10px;
         justify-content:center; align-items:center; font-size:1.2em; color:#555;
         font-weight:600; pointer-events:none;">
      🔒 Spelerslijst is definitief
    </div>
  </div>

  <div class="button-row" style="margin-top:15px;">
    <button type="button" id="finalizePlayers" class="btn btn-lock">✅ Lijst definitief maken</button>
    <button type="button" id="editPlayers" class="btn btn-unlock">✏️ Lijst bewerken</button>
  </div>

  <div id="playerFeedback"></div>

  <!-- ✅ Popup voor wijzigen van speler -->
  <div id="editPlayerModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
       background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;">
    <div style="background:#fff; padding:20px; border-radius:10px; width:320px; box-shadow:0 2px 8px rgba(0,0,0,0.2);">
      <h4 style="margin-top:0;">Speler wijzigen</h4>
      <form id="editPlayerForm" class="form-grid">
        <div>
          <label>Naam</label>
          <input type="text" id="editName" required />
        </div>
        <div>
          <label>E-mail</label>
          <input type="text" id="editEmail" />
        </div>
        <div>
          <label>Telefoon</label>
          <input type="text" id="editPhone" />
        </div>
        <div>
          <label>Caramboles</label>
          <input type="number" id="editCaramboles" min="0" max="999" class="small" />
        </div>
        <div class="button-row" style="margin-top:15px;">
          <button type="submit" class="btn btn-save">Opslaan</button>
          <button type="button" id="cancelEdit" class="btn btn-delete">Annuleren</button>
        </div>
      </form>
    </div>
  </div>

</div>
<!-- ===== END TAB: SPELERS ===== -->

<!-- ===== START TAB: 1E RONDE POULES ===== -->
<div id="r1poules" class="tab-content">

  <h3>1e Ronde – Poule-indeling</h3>

  <div id="noTournamentPoulesNotice" style="display:none;">
    ⚠️ Geen toernooi geselecteerd. Selecteer eerst een toernooi om poules te beheren.
  </div>

  <div id="poulesIntro" style="margin-bottom:15px;">
    <p>Hier kun je de spelers van het toernooi indelen in poules. 
       Elke poule heeft standaard 4 spelers (indien mogelijk). 
       Klik op een speler links en vervolgens op de poule waarin je deze wilt plaatsen.</p>
  </div>

  <div id="poulesControls" class="button-row">
    <button type="button" id="createPoulesBtn" class="btn btn-save">➕ Poules aanmaken</button>
    <button type="button" id="savePoulesBtn" class="btn btn-lock">💾 Indeling opslaan</button>
    <button type="button" id="clearPoulesBtn" class="btn btn-delete">🗑️ Alles wissen</button>
  </div>

  <!-- ✅ Info over verdeling -->
  <div id="poulesDistributionInfo" 
       style="margin-top:10px; font-weight:600; color:#333; background:#f8f9fa;
              border:1px solid #ddd; border-radius:6px; padding:8px 12px; display:none;">
  </div>


  <div id="poulesContent" style="display:flex; gap:20px; flex-wrap:wrap; margin-top:15px;">
    
    <!-- Linkerkant: beschikbare spelers -->
    <div style="flex:1; min-width:280px;">
      <h4>Beschikbare spelers</h4>
      <div id="availablePlayers" class="list-box" 
           style="border:1px solid #ccc; border-radius:8px; padding:10px; min-height:250px; background:#fafafa;">
        <p style="color:#777;">Nog geen spelers geladen.</p>
      </div>
    </div>

    <!-- Rechterkant: poules -->
    <div style="flex:2; min-width:400px;">
      <h4>Huidige poules</h4>
      <div id="poulesContainer" 
           style="display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:15px;">
        <!-- Poule-kaarten worden hier dynamisch toegevoegd -->
      </div>
    </div>

  </div>

  <div id="poulesFeedback" style="margin-top:15px;"></div>

</div>
<!-- ===== END TAB: 1E RONDE POULES ===== -->


<!-- ===== START TAB: 1E RONDE RESULTATEN ===== -->
<div id="r1resultaten" class="tab-content">

  <h3>1e Ronde – Wedstrijden & Resultaten</h3>

  <div id="noTournamentR1ResNotice" style="display:none;">
    ⚠️ Geen toernooi geselecteerd. Selecteer eerst een toernooi om wedstrijden te beheren.
  </div>

  <!-- ✅ Overzicht scoringsregels -->
  <div id="r1ScoringOverview"
       style="margin-bottom:15px;font-weight:500;color:#333;background:#f8f9fa;
              border:1px solid #ddd;border-radius:6px;padding:8px 12px;display:none;">
  </div>

  <div class="button-row" style="margin-bottom:15px;">
    <button type="button" id="refreshMatchesBtn" class="btn btn-secondary">🔄 Wedstrijden laden</button>
  </div>

  <!-- ✅ Overzicht totaal -->
  <div id="r1OverallProgress" 
       style="margin-bottom:15px;font-weight:600;color:#333;background:#f8f9fa;
              border:1px solid #ddd;border-radius:6px;padding:8px 12px;display:none;">
  </div>

  <div id="r1matchesWrapper" style="display:flex;flex-direction:column;gap:16px;">
    <!-- poule-blokken worden hier dynamisch ingevuld -->
  </div>
</div>
<!-- ===== END TAB: 1E RONDE RESULTATEN ===== -->



    <!-- ===== START TAB: ANDERE PLACEHOLDERS ===== -->

    <div id="r2poules" class="tab-content"><p>2e ronde poules (komt later)</p></div>
    <div id="r2resultaten" class="tab-content"><p>2e ronde resultaten (komt later)</p></div>
    <div id="finale" class="tab-content"><p>Finale-tab (komt later)</p></div>
    <!-- ===== END TAB: ANDERE PLACEHOLDERS ===== -->
  </div>



  <script type="module">
    /* Firebase imports */
    import { initializeApp } 
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getFirestore, 
      doc, 
      setDoc, 
      getDoc, 
      getDocs,
      deleteDoc,
      collection,
      addDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    /* Firebase config */
    const firebaseConfig = {
      apiKey: "AIzaSyAsg63E-lGgECsCxIfRJTFcTWB7LEGWNGc",
      authDomain: "bcr-toernooi.firebaseapp.com",
      projectId: "bcr-toernooi",
      storageBucket: "bcr-toernooi.firebasestorage.app",
      messagingSenderId: "856805712309",
      appId: "1:856805712309:web:8adb4158d825630ce079fc",
      measurementId: "G-ELH9TVY15L"
    };

    /* Init Firestore */
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* =========================================================
       GLOBALE STATE VOOR ACTIEF TOERNOOI
       ========================================================= */
    let activeTournamentId = null;      // bv. "OpenKampioenschap_2025"
    let playersFinalized = false;       // of de spelerslijst op slot staat

    /* =========================================================
       GEMEENSCHAPPELIJKE UI HELPERS
       ========================================================= */
    function showConnectionBanner() {
      const host = document.getElementById("bcr-toernooi-app");
      const statusDiv = document.createElement("div");
      statusDiv.className = "connection-status";
      statusDiv.textContent = "✅ Verbonden met Firestore";
      host.insertBefore(statusDiv, host.children[1] /* net onder header */);
    }

    function showFeedback(msg, type = "info") {
      const fb = document.getElementById('feedback');
      const color = type === "error" ? "#f8d7da" : type === "success" ? "#d1e7dd" : "#e2e3e5";
      const textColor = type === "error" ? "#842029" : type === "success" ? "#0f5132" : "#41464b";
      fb.innerHTML = `
        <div class="message" style="background:${color};color:${textColor};">
          ${msg}
          <span class="close" onclick="this.parentElement.remove()">×</span>
        </div>
      `;
      fb.scrollIntoView({ behavior: 'smooth' });
    }

    function showPlayerFeedback(msg, type = "info") {
      const pf = document.getElementById('playerFeedback');
      const color = type === "error" ? "#f8d7da" : type === "success" ? "#d1e7dd" : "#e2e3e5";
      const textColor = type === "error" ? "#842029" : type === "success" ? "#0f5132" : "#41464b";
      pf.innerHTML = `
        <div class="message" style="background:${color};color:${textColor};">
          ${msg}
          <span class="close" onclick="this.parentElement.remove()">×</span>
        </div>
      `;
      pf.scrollIntoView({ behavior: 'smooth' });
    }

    function updateActiveTournament(name, year) {
      const banner = document.getElementById('activeTournamentBanner');
      if (name && year) {
        banner.textContent = `Actief toernooi: ${name} (${year})`;
      } else {
        banner.textContent = "Geen toernooi geselecteerd";
      }
    }

    /* =========================================================
       TABS
       ========================================================= */
    document.querySelectorAll('#bcr-toernooi-app .tab-buttons button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#bcr-toernooi-app .tab-buttons button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('#bcr-toernooi-app .tab-content').forEach(tc => tc.classList.remove('active'));
        btn.classList.add('active');
        const pane = document.getElementById(btn.dataset.tab);
        pane.classList.add('active');

        // Speciale regel: als je naar "spelers" gaat -> check of er een toernooi actief is
        if (btn.dataset.tab === "spelers") {
          guardSpelersTabAvailability();
          if (activeTournamentId) {
            loadPlayersFromFirestore(); // lijst verversen bij openen
          }
        }
      });
    });

    /* =========================================================
       FUNCTIES TAB TOERNOOI
       ========================================================= */

    // Checkbox 'Niet van toepassing'
    const noMax = document.getElementById('noMaxTurns');
    const maxInputs = ['pointsWinMax','pointsDrawMax','pointsLoseMax','maxTurns']
      .map(id => document.getElementById(id));

    noMax.addEventListener('change', () => {
      const disabled = noMax.checked;
      maxInputs.forEach(i => {
        i.disabled = disabled;
        i.style.backgroundColor = disabled ? '#eee' : '';
      });
    });

    // Numerieke validatie
    document.querySelectorAll('#bcr-toernooi-app input[type="number"]').forEach(inp => {
      inp.addEventListener('blur', () => {
        const id = inp.id;
        const val = parseInt(inp.value);
        if (id === "tournamentYear") {
          if (!val) return;
          if (val > 2099) inp.value = 2099;
          if (val < 1900) inp.value = 1900;
        } else if (id === "playerCaramboles") {
          if (!val && val !== 0) return;
          if (val > 999) inp.value = 999;
          if (val < 0) inp.value = 0;
        } else {
          if (!val && val !== 0) return;
          if (val > 999) inp.value = 999;
          if (val < 0) inp.value = 0;
        }
      });
      if (inp.id !== "tournamentYear") {
        inp.addEventListener('input', () => {
          if (inp.value.length > 3) inp.value = inp.value.slice(0, 3);
        });
      }
    });

    // Opslaan / bijwerken van een toernooi
    async function saveTournament() {
      const naam = document.getElementById('tournamentName').value.trim();
      const jaar = document.getElementById('tournamentYear').value.trim();

      if (!naam || !jaar) {
        showFeedback("❌ Naam en jaar zijn verplicht.", "error");
        return;
      }

      const data = {
        naam,
        jaar,
        organisatie: document.getElementById('tournamentOrg').value.trim(),
        maxBeurten: document.getElementById('maxTurns').value || null,
        punten: {
          winLess: document.getElementById('pointsWinLess').value || 0,
          drawLess: document.getElementById('pointsDrawLess').value || 0,
          loseLess: document.getElementById('pointsLoseLess').value || 0,
          winMax: document.getElementById('pointsWinMax').value || 0,
          drawMax: document.getElementById('pointsDrawMax').value || 0,
          loseMax: document.getElementById('pointsLoseMax').value || 0
        },
        datums: {
          endR1: document.getElementById('dateEndR1').value || null,
          endR2: document.getElementById('dateEndR2').value || null,
          startFinale: document.getElementById('dateStartFinale').value || null,
          endFinale: document.getElementById('dateEndFinale').value || null
        },
        aangemaaktOp: new Date().toISOString(),
        playersFinalized: playersFinalized || false
      };

      try {
        const id = `${naam}_${jaar}`.replace(/\s+/g, "_");
        await setDoc(doc(db, "toernooien", id), data);
        activeTournamentId = id;
        playersFinalized = data.playersFinalized;
        showFeedback(`✅ Toernooi "${naam}" (${jaar}) is opgeslagen.`, "success");
        updateActiveTournament(naam, jaar);
        guardSpelersTabAvailability();
      } catch (err) {
        console.error("❌ Fout bij opslaan:", err);
        showFeedback("⚠️ Er ging iets mis bij het opslaan in Firestore.", "error");
      }
    }

    // Hulpfunctie om dropdown te bouwen en te hergebruiken voor laden / verwijderen
    async function buildTournamentSelect({ mode }) {
      const snapshot = await getDocs(collection(db, "toernooien"));
      const fb = document.getElementById("feedback");
      fb.innerHTML = "";

      if (snapshot.empty) {
        fb.innerHTML = `
          <div class="message" style="background:#f8d7da;color:#842029;">
            ⚠️ Er zijn nog geen toernooien opgeslagen.
            <span class="close" onclick="this.parentElement.remove()">×</span>
          </div>`;
        return null;
      }

      const select = document.createElement("select");
      select.style.marginTop = "10px";
      select.style.padding = "6px";
      select.style.borderRadius = "6px";
      select.style.border = "1px solid #ccc";
      select.style.minWidth = "250px";

      if (mode === "delete") {
        select.innerHTML = `<option value="">Kies een toernooi om te verwijderen...</option>`;
      } else {
        select.innerHTML = `<option value="">Kies een toernooi...</option>`;
      }

      snapshot.forEach(d => {
        const t = d.data();
        select.innerHTML += `<option value="${d.id}">${t.naam} (${t.jaar})</option>`;
      });

      fb.appendChild(select);
      return select;
    }

    // Laden van een toernooi via dropdown
    async function loadTournamentList() {
      try {
        const select = await buildTournamentSelect({ mode: "load" });
        if (!select) return;

        select.addEventListener("change", async () => {
          const id = select.value;
          if (!id) return;

          const ref = doc(db, "toernooien", id);
          const dSnap = await getDoc(ref);
          if (!dSnap.exists()) {
            showFeedback("⚠️ Toernooi niet gevonden.", "error");
            return;
          }

          const t = dSnap.data();
          document.getElementById('tournamentName').value = t.naam;
          document.getElementById('tournamentYear').value = t.jaar;
          document.getElementById('tournamentOrg').value = t.organisatie || "";
          document.getElementById('maxTurns').value = t.maxBeurten || "";
          document.getElementById('dateEndR1').value = t.datums?.endR1 || "";
          document.getElementById('dateEndR2').value = t.datums?.endR2 || "";
          document.getElementById('dateStartFinale').value = t.datums?.startFinale || "";
          document.getElementById('dateEndFinale').value = t.datums?.endFinale || "";
          document.getElementById('pointsWinLess').value = t.punten?.winLess || "";
          document.getElementById('pointsDrawLess').value = t.punten?.drawLess || "";
          document.getElementById('pointsLoseLess').value = t.punten?.loseLess || "";
          document.getElementById('pointsWinMax').value = t.punten?.winMax || "";
          document.getElementById('pointsDrawMax').value = t.punten?.drawMax || "";
          document.getElementById('pointsLoseMax').value = t.punten?.loseMax || "";

          activeTournamentId = id;
          playersFinalized = !!t.playersFinalized;
          updateActiveTournament(t.naam, t.jaar);
          showFeedback(`✅ Toernooi "${t.naam}" (${t.jaar}) geladen.`, "success");
          guardSpelersTabAvailability();
	  
	  // ✅ Nieuw: spelers van dit toernooi laden
	  await loadPlayersForActiveTournament();
	  await loadPoulesForActiveTournament();
	  await loadR1ResultsTabForActiveTournament();

        });
      } catch (err) {
        console.error("❌ Fout bij laden:", err);
        showFeedback("⚠️ Kon toernooien niet laden uit Firestore.", "error");
      }
    }

    // Verwijderen van een toernooi (met dubbele bevestiging)
    async function deleteTournament() {
      try {
        const select = await buildTournamentSelect({ mode: "delete" });
        if (!select) return;

        select.addEventListener("change", async () => {
          const id = select.value;
          if (!id) return;

          const ref = doc(db, "toernooien", id);
          const snap = await getDoc(ref);
          if (!snap.exists()) {
            showFeedback("⚠️ Toernooi niet gevonden.", "error");
            return;
          }

          const t = snap.data();

          const zeker = confirm(`Weet je zeker dat je het toernooi "${t.naam}" wilt verwijderen?`);
          if (!zeker) {
            showFeedback("Verwijderen geannuleerd.", "error");
            return;
          }

          const invoer = prompt(
            `Typ de naam van het toernooi exact in ter bevestiging:\n${t.naam}`
          );
          if (invoer !== t.naam) {
            showFeedback("❌ Naam komt niet overeen. Verwijderen geannuleerd.", "error");
            return;
          }

          // BELANGRIJK: spelers-subcollectie eerst verwijderen
          const playersSnap = await getDocs(collection(db, "toernooien", id, "spelers"));
          for (const pDoc of playersSnap.docs) {
            await deleteDoc(doc(db, "toernooien", id, "spelers", pDoc.id));
          }

          await deleteDoc(ref);
          showFeedback(`🗑️ Toernooi "${t.naam}" is verwijderd.`, "success");

          // Reset state als dit actief was
          if (activeTournamentId === id) {
            activeTournamentId = null;
            playersFinalized = false;
            updateActiveTournament(null, null);
            guardSpelersTabAvailability();
            clearPlayersTable();
          }

          // dropdown verversen
          await buildTournamentSelect({ mode: "delete" });
        });
      } catch (err) {
        console.error("❌ Fout bij verwijderen:", err);
        showFeedback("⚠️ Kon toernooi niet verwijderen.", "error");
      }
    }

/* ===== FUNCTIES TAB SPELERS ===== */

const playerForm = document.getElementById('playerForm');
const playerTableBody = document.getElementById('playerTableBody');
const sortByNameBtn = document.getElementById('sortByName');
const sortByCarambolesBtn = document.getElementById('sortByCaramboles');
const finalizeBtn = document.getElementById('finalizePlayers');
const editBtn = document.getElementById('editPlayers');
const addPlayerBtn = document.getElementById('addPlayerBtn');
const playerCount = document.getElementById('playerCount');
const playersFinalizedNotice = document.getElementById('playersFinalizedNotice');
const editPlayerModal = document.getElementById('editPlayerModal');
const editPlayerForm = document.getElementById('editPlayerForm');
const cancelEdit = document.getElementById('cancelEdit');
const noTournamentNotice = document.getElementById('noTournamentNotice');
const playersLockOverlay = document.getElementById('playersLockOverlay');

let currentPlayers = [];
let currentSort = null;
let editPlayerId = null;

function updatePlayerCount() {
  playerCount.textContent = `Aantal deelnemers: ${currentPlayers.length}`;
}

function openEditModal(player) {
  editPlayerId = player.id;
  document.getElementById('editName').value = player.naam || "";
  document.getElementById('editEmail').value = player.email || "";
  document.getElementById('editPhone').value = player.telefoon || "";
  document.getElementById('editCaramboles').value = player.caramboles ?? "";
  editPlayerModal.style.display = "flex";
}

function closeEditModal() {
  editPlayerId = null;
  editPlayerModal.style.display = "none";
}

cancelEdit.addEventListener('click', closeEditModal);

editPlayerForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!editPlayerId || !activeTournamentId) return;

  const updateData = {
    naam: document.getElementById('editName').value.trim(),
    email: document.getElementById('editEmail').value.trim(),
    telefoon: document.getElementById('editPhone').value.trim(),
    caramboles: Number(document.getElementById('editCaramboles').value) || 0
  };

  await setDoc(doc(db, "toernooien", activeTournamentId, "spelers", editPlayerId), updateData, { merge: true });
  showPlayerFeedback(`✏️ Speler "${updateData.naam}" bijgewerkt.`, "success");
  closeEditModal();
  await loadPlayersFromFirestore();
});

function clearPlayersTable() {
  currentPlayers = [];
  playerTableBody.innerHTML = "";
  updatePlayerCount();
}

function guardSpelersTabAvailability() {
  const disabled = !activeTournamentId;
  const overlay = document.getElementById("playersLockOverlay");

  noTournamentNotice.style.display = disabled ? "block" : "none";
  playersFinalizedNotice.style.display = playersFinalized ? "flex" : "none";

  // Toon of verberg de grijze overlay met sloticoon
  if (playersFinalized) {
    overlay.style.display = "flex";
  } else {
    overlay.style.display = "none";
  }

  // Invoervelden & knoppen blokkeren waar nodig
  [...playerForm.querySelectorAll("input,button")].forEach(el => {
    el.disabled = disabled || (playersFinalized && el.id === "addPlayerBtn");
    if (playersFinalized && el.id === "addPlayerBtn") {
      el.style.backgroundColor = "#bbb";
      el.style.cursor = "not-allowed";
      el.style.opacity = "0.6";
    } else {
      el.style.backgroundColor = "";
      el.style.cursor = "";
      el.style.opacity = "";
    }
  });

  sortByNameBtn.disabled = disabled;
  sortByCarambolesBtn.disabled = disabled;
  finalizeBtn.disabled = disabled || playersFinalized;
  editBtn.disabled = disabled || !playersFinalized;

  finalizeBtn.style.backgroundColor = finalizeBtn.disabled ? "#999" : "#198754";
  editBtn.style.backgroundColor = editBtn.disabled ? "#999" : "#0dcaf0";

  // Verwijderknoppen blokkeren bij finalized
  Array.from(playerTableBody.querySelectorAll(".delete-player-btn")).forEach(btn => {
    btn.disabled = disabled || playersFinalized;
    btn.style.backgroundColor = (disabled || playersFinalized) ? "#bbb" : "#dc3545";
    btn.style.cursor = (disabled || playersFinalized) ? "not-allowed" : "pointer";
    btn.style.opacity = (disabled || playersFinalized) ? "0.6" : "1";
  });
}

function renderPlayersTable() {
  playerTableBody.innerHTML = "";

  let rows = [...currentPlayers];
  if (currentSort === "name") rows.sort((a,b) => a.naam.localeCompare(b.naam, 'nl', {sensitivity: 'base'}));
  else if (currentSort === "caramboles") rows.sort((a,b) => (Number(a.caramboles||0)) - (Number(b.caramboles||0)));

  rows.forEach(player => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${player.naam || ""}</td>
      <td>${player.email || ""}</td>
      <td>${player.telefoon || ""}</td>
      <td class="num">${player.caramboles ?? ""}</td>
      <td class="actions">
        <button class="edit-player-btn" title="Wijzig speler" style="background:#0d6efd;color:#fff;border:none;border-radius:6px;cursor:pointer;padding:4px 8px;font-size:0.85rem;margin-right:4px;">✏️</button>
        <button class="delete-player-btn" title="Verwijder speler" style="background:#dc3545;color:#fff;border:none;border-radius:6px;cursor:pointer;padding:4px 8px;font-size:0.85rem;">🗑️</button>
      </td>
    `;

    const editBtn = tr.querySelector(".edit-player-btn");
    const delBtn = tr.querySelector(".delete-player-btn");

    // Altijd mogelijk te wijzigen
    editBtn.addEventListener("click", () => openEditModal(player));

    // Verwijderen alleen als niet definitief
    delBtn.disabled = playersFinalized;
    delBtn.addEventListener("click", async () => {
      if (!activeTournamentId || playersFinalized) return;
      if (!confirm(`Verwijder speler "${player.naam}"?`)) return;

      await deleteDoc(doc(db, "toernooien", activeTournamentId, "spelers", player.id));
      showPlayerFeedback(`🗑️ Speler "${player.naam}" verwijderd.`, "success");
      await loadPlayersFromFirestore();
    });

    playerTableBody.appendChild(tr);
  });

  updatePlayerCount();
  guardSpelersTabAvailability();
}

async function loadPlayersFromFirestore() {
  if (!activeTournamentId) {
    clearPlayersTable();
    guardSpelersTabAvailability();
    return;
  }

  const playersSnap = await getDocs(collection(db, "toernooien", activeTournamentId, "spelers"));
  currentPlayers = playersSnap.docs.map(d => ({ id: d.id, ...d.data() }));

  const tRef = doc(db, "toernooien", activeTournamentId);
  const tSnap = await getDoc(tRef);
  if (tSnap.exists()) playersFinalized = !!tSnap.data().playersFinalized;

  renderPlayersTable();
}

async function addPlayer(e) {
  e.preventDefault();
  if (!activeTournamentId) {
    showPlayerFeedback("⚠️ Geen actief toernooi geselecteerd.", "error");
    return;
  }
  if (playersFinalized) {
    showPlayerFeedback("❌ Lijst is definitief. Bewerken niet toegestaan.", "error");
    return;
  }

  const naam = document.getElementById('playerName').value.trim();
  const email = document.getElementById('playerEmail').value.trim();
  const telefoon = document.getElementById('playerPhone').value.trim();
  const caramboles = document.getElementById('playerCaramboles').value.trim();

  if (!naam) {
    showPlayerFeedback("❌ Naam speler is verplicht.", "error");
    return;
  }

  const newPlayer = { naam, email, telefoon, caramboles: caramboles ? Number(caramboles) : null };
  await addDoc(collection(db, "toernooien", activeTournamentId, "spelers"), newPlayer);

  showPlayerFeedback(`✅ Speler "${naam}" toegevoegd.`, "success");

  document.getElementById('playerName').value = "";
  document.getElementById('playerEmail').value = "";
  document.getElementById('playerPhone').value = "";
  document.getElementById('playerCaramboles').value = "";

  await loadPlayersFromFirestore();
}

sortByNameBtn.addEventListener("click", () => {
  currentSort = "name";
  renderPlayersTable();
});

sortByCarambolesBtn.addEventListener("click", () => {
  currentSort = "caramboles";
  renderPlayersTable();
});

finalizeBtn.addEventListener("click", async () => {
  if (!activeTournamentId) return;
  const confirmFinal = confirm("Weet je zeker dat je de spelerslijst definitief wilt maken?");
  if (!confirmFinal) return;

  await setDoc(doc(db, "toernooien", activeTournamentId), { playersFinalized: true }, { merge: true });
  playersFinalized = true;
  showPlayerFeedback("🔒 Spelerslijst is definitief gemaakt.", "success");
  guardSpelersTabAvailability();
});

editBtn.addEventListener("click", async () => {
  if (!activeTournamentId) return;
  const confirmEdit = confirm("Wil je de spelerslijst weer bewerkbaar maken?");
  if (!confirmEdit) return;

  await setDoc(doc(db, "toernooien", activeTournamentId), { playersFinalized: false }, { merge: true });
  playersFinalized = false;
  showPlayerFeedback("✏️ Spelerslijst is weer bewerkbaar.", "success");
  guardSpelersTabAvailability();
});

playerForm.addEventListener("submit", addPlayer);

async function loadPlayersForActiveTournament() {
  if (!activeTournamentId) return;
  await loadPlayersFromFirestore();
}

/* ===== EINDE FUNCTIES TAB SPELERS ===== */


/* ===== FUNCTIES TAB 1E RONDE POULES ===== */

const createPoulesBtn = document.getElementById('createPoulesBtn');
const savePoulesBtn = document.getElementById('savePoulesBtn');
const clearPoulesBtn = document.getElementById('clearPoulesBtn');
const availablePlayersDiv = document.getElementById('availablePlayers');
const poulesContainer = document.getElementById('poulesContainer');
const poulesFeedback = document.getElementById('poulesFeedback');
const noTournamentPoulesNotice = document.getElementById('noTournamentPoulesNotice');

let currentPoules = [];       // [{ naam, maxSpelers, spelers:[{id,naam,caramboles,...}] }, ...]
let selectedPlayer = null;    // spelerobject die is aangeklikt links
let availablePlayers = [];    // spelers die nog NIET in een poule zitten
let allPlayers = [];          // alle spelers uit Firestore (cache)

// ----- UI helpers -----

function showPoulesFeedback(msg, type="info") {
  poulesFeedback.innerHTML = `<div style="padding:6px 10px; border-radius:6px;
    background:${type==="error"?"#f8d7da":type==="success"?"#d1e7dd":"#e2e3e5"};
    color:${type==="error"?"#842029":type==="success"?"#0f5132":"#41464b"};
    border:1px solid ${type==="error"?"#f5c2c7":type==="success"?"#badbcc":"#d3d6d8"};
    margin-top:10px;">${msg}</div>`;
}

function updateSaveButtonState() {
  if (!savePoulesBtn) return;
  const totalPlayers = allPlayers.length;
  const assignedPlayers = currentPoules.reduce((sum, p) => sum + p.spelers.length, 0);
  const allAssigned = totalPlayers > 0 && assignedPlayers === totalPlayers;

  if (allAssigned) {
    savePoulesBtn.disabled = false;
    savePoulesBtn.style.opacity = "1";
    savePoulesBtn.title = "Alle spelers zijn ingedeeld — je kunt nu opslaan.";
  } else {
    savePoulesBtn.disabled = true;
    savePoulesBtn.style.opacity = "0.2";
    savePoulesBtn.title = "Opslaan is alleen mogelijk als alle spelers zijn ingedeeld.";
  }
}


// ----- hulpfunctie om te bepalen wie al in een poule zit -----

function getPlayerIdsInPoules() {
  const ids = new Set();
  currentPoules.forEach(p => {
    p.spelers.forEach(sp => ids.add(sp.id));
  });
  return ids;
}

// ----- render van de linkerkant (beschikbare spelers) -----

function renderAvailablePlayers() {
  availablePlayersDiv.innerHTML = "";

  if (!activeTournamentId) {
    noTournamentPoulesNotice.style.display = "block";
    return;
  }
  noTournamentPoulesNotice.style.display = "none";

  // filter nogmaals: alleen spelers die niet in een poule zitten
  const idsInPoules = getPlayerIdsInPoules();
  const notAssigned = allPlayers.filter(p => !idsInPoules.has(p.id));

  // sorteer op caramboles (hoog → laag)
  notAssigned.sort((a, b) => (b.caramboles || 0) - (a.caramboles || 0));

  availablePlayers = notAssigned;

  if (availablePlayers.length === 0) {
    availablePlayersDiv.innerHTML = `<p style="color:#777;">Geen vrije spelers meer.</p>`;
    return;
  }

  availablePlayers.forEach(p => {
    const div = document.createElement("div");
    div.className = "player-item";
    div.innerHTML = `<strong>${p.naam}</strong> (${p.caramboles || 0})`;
    div.dataset.id = p.id;
    div.style.cssText = `
      padding:6px 8px; border:1px solid #ccc; border-radius:5px;
      margin-bottom:4px; background:white; cursor:pointer;
      transition:all 0.2s ease;
    `;
    div.addEventListener("click", () => selectPlayer(p.id, div));
    availablePlayersDiv.appendChild(div);
  });
}


// ----- selectie van een speler links -----

function selectPlayer(id, element) {
  document.querySelectorAll(".player-item").forEach(el => el.style.background = "white");
  const player = availablePlayers.find(p => p.id === id);
  if (!player) return;
  selectedPlayer = player;
  element.style.background = "#cce5ff";
  showPoulesFeedback(`🎯 Geselecteerd: ${player.naam}`, "info");
}

// ----- render van de poules rechts -----

function renderPoules() {
  poulesContainer.innerHTML = "";

  currentPoules.forEach(poule => {
    const isFull = poule.spelers.length >= poule.maxSpelers;

    const card = document.createElement("div");
    card.className = "poule-card";
    card.style.cssText = `
      border:3px solid ${isFull ? "#198754" : "#ccc"};
      border-radius:8px; padding:8px; background:#fff; min-height:120px; cursor:pointer;
      transition:all 0.2s ease;
    `;

    // header met aantallen
    const header = document.createElement("h5");
    header.innerHTML = `
      ${poule.naam}
      <span style="font-weight:normal;font-size:0.9em;color:#555;">
        (${poule.spelers.length}/${poule.maxSpelers})
      </span>
    `;
    card.appendChild(header);

    // lijst met spelers
    const list = document.createElement("ul");
    list.style.marginTop = "5px";
    list.style.paddingLeft = "15px";

    poule.spelers.forEach(sp => {
      const li = document.createElement("li");
      li.style.display = "flex";
      li.style.justifyContent = "space-between";
      li.style.alignItems = "center";
      li.style.marginBottom = "2px";

      // speler + caramboles op 1 regel
      const labelSpan = document.createElement("span");
      labelSpan.textContent = `${sp.naam} (${sp.caramboles || 0})`;

      const delBtn = document.createElement("button");
      delBtn.title = "Verwijder speler uit poule";
      delBtn.style.cssText = `
        background:#dc3545;
        color:white;
        border:none;
        border-radius:4px;
        cursor:pointer;
        padding:2px 5px;
        font-size:0.8rem;
      `;
      delBtn.textContent = "🗑️";
      delBtn.addEventListener("click", (e) => {
        e.stopPropagation(); // voorkom dat klik op poule zelf ook triggert
        removePlayerFromPoule(poule.naam, sp.id);
      });

      li.appendChild(labelSpan);
      li.appendChild(delBtn);
      list.appendChild(li);
    });

    card.appendChild(list);

    // klik op poule = probeer geselecteerde speler toe te voegen
    card.addEventListener("click", () => addSelectedPlayerToPoule(poule.naam));
    poulesContainer.appendChild(card);
  });
}

// ----- poules aanmaken op basis van aantal spelers -----

async function createPoules() {
  if (!activeTournamentId) {
    showPoulesFeedback("⚠️ Geen toernooi actief.", "error");
    return;
  }

  const playersSnap = await getDocs(collection(db, "toernooien", activeTournamentId, "spelers"));
  allPlayers = playersSnap.docs.map(d => ({ id: d.id, ...d.data() }));

  const numPlayers = allPlayers.length;

  if (numPlayers < 12) {
    showPoulesFeedback("❌ Er zijn minimaal 12 spelers nodig om poules te kunnen aanmaken.", "error");
    return;
  }

  const basePoules = Math.floor(numPlayers / 4);
  const remainder = numPlayers % 4;

  let numPoules = basePoules;
  let numPoulesOf5 = 0;

  if (remainder === 1) numPoulesOf5 = 1;
  else if (remainder === 2) numPoulesOf5 = 2;
  else if (remainder === 3) numPoulesOf5 = 3;

  currentPoules = [];
  for (let i = 0; i < numPoules; i++) {
    const naam = `Poule ${String.fromCharCode(65 + i)}`;
    const maxSpelers = i < numPoulesOf5 ? 5 : 4;
    currentPoules.push({ naam, maxSpelers, spelers: [] });
  }

  selectedPlayer = null;

  // ✅ Info tonen boven poules
  const poulesInfo = document.getElementById("poulesDistributionInfo");
  if (poulesInfo) {
    poulesInfo.style.display = "block";
    poulesInfo.textContent = `Verdeling: ${numPoulesOf5} poule${numPoulesOf5!==1?"s":""} met 5 spelers, ` +
      `${numPoules - numPoulesOf5} poule${(numPoules - numPoulesOf5)!==1?"s":""} met 4 spelers ` +
      `(totaal ${numPlayers} spelers)`;
  }

  showPoulesFeedback(
    `✅ ${numPoules} poules aangemaakt. Klik op een speler links en daarna op een poule om toe te voegen.`,
    "success"
  );

  renderPoules();
  renderAvailablePlayers();

  updateSaveButtonState();
}


// ----- speler toevoegen aan poule -----

function addSelectedPlayerToPoule(pouleNaam) {
  if (!selectedPlayer) {
    showPoulesFeedback("⚠️ Selecteer eerst een speler links.", "error");
    return;
  }

  const poule = currentPoules.find(p => p.naam === pouleNaam);
  if (!poule) return;

  // vol?
  if (poule.spelers.length >= poule.maxSpelers) {
    showPoulesFeedback("❌ Deze poule zit vol.", "error");
    return;
  }

  // zit speler al ergens in?
  const alreadyInSomePoule = currentPoules.some(p =>
    p.spelers.find(sp => sp.id === selectedPlayer.id)
  );
  if (alreadyInSomePoule) {
    showPoulesFeedback("⚠️ Deze speler zit al in een poule.", "error");
    return;
  }

  // toevoegen
  poule.spelers.push(selectedPlayer);

  // haal speler uit availablePlayers
  availablePlayers = availablePlayers.filter(p => p.id !== selectedPlayer.id);
  selectedPlayer = null;

  // UI opnieuw tekenen
  renderPoules();
  renderAvailablePlayers();
  updateSaveButtonState();

  showPoulesFeedback("✅ Speler toegevoegd aan poule.", "success");
}

// ----- speler verwijderen uit poule -----

function removePlayerFromPoule(pouleNaam, spelerId) {
  const poule = currentPoules.find(p => p.naam === pouleNaam);
  if (!poule) return;

  const idx = poule.spelers.findIndex(sp => sp.id === spelerId);
  if (idx === -1) return;

  // speler die we terugzetten
  const [removedPlayer] = poule.spelers.splice(idx, 1);

  // alleen deze speler terug naar availablePlayers
  // maar niet dubbel toevoegen als hij toevallig nog vrij stond
  const alreadyFree = availablePlayers.find(p => p.id === removedPlayer.id);
  if (!alreadyFree) {
    availablePlayers.push(removedPlayer);
  }

  // UI opnieuw tekenen
  renderPoules();
  renderAvailablePlayers();
  updateSaveButtonState();

  showPoulesFeedback(`🗑️ ${removedPlayer.naam} is weer beschikbaar.`, "info");
}

// ----- opslaan in Firestore -----

async function savePoulesToFirestore() {
  if (!activeTournamentId) {
    showPoulesFeedback("⚠️ Geen toernooi actief.", "error");
    return;
  }
  if (currentPoules.length === 0) {
    showPoulesFeedback("⚠️ Geen poules om op te slaan.", "error");
    return;
  }

  // schrijf alle poules onder /toernooien/{id}/poules_r1/*
  const poulesRef = collection(db, "toernooien", activeTournamentId, "poules_r1");

  // eerst de oude wissen
  const existing = await getDocs(poulesRef);
  for (const d of existing.docs) {
    await deleteDoc(d.ref);
  }

  // dan de huidige opslaan
  for (const p of currentPoules) {
    await setDoc(
      doc(poulesRef, p.naam),
      {
        naam: p.naam,
        maxSpelers: p.maxSpelers,
        spelers: p.spelers
      }
    );
  }

  showPoulesFeedback("💾 Poule-indeling opgeslagen in Firestore.", "success");

  // ✅ knop uitschakelen na succesvol opslaan
  savePoulesBtn.disabled = true;
  savePoulesBtn.style.opacity = "0.2";
  savePoulesBtn.title = "De poule-indeling is opgeslagen.";

}

// ----- wissen/resetten -----

async function clearPoules() {
  if (!confirm("Weet je zeker dat je alle poules wilt wissen?")) return;

  currentPoules = [];
  selectedPlayer = null;

  poulesContainer.innerHTML = "";
  renderAvailablePlayers(); // alle spelers gaan weer links staan

  // Leegschrijven in Firestore
  if (activeTournamentId) {
    const poulesRef = collection(db, "toernooien", activeTournamentId, "poules_r1");
    const existing = await getDocs(poulesRef);
    for (const d of existing.docs) {
      await deleteDoc(d.ref);
    }
  }

  updateSaveButtonState();

  showPoulesFeedback("🗑️ Alle poules gewist.", "success");
}

// ----- bestaande indeling laden bij actief toernooi -----

async function loadPoulesForActiveTournament() {
  if (!activeTournamentId) return;

  // 1. lees alle spelers (cache in allPlayers)
  const playersSnap = await getDocs(collection(db, "toernooien", activeTournamentId, "spelers"));
  allPlayers = playersSnap.docs.map(d => ({ id: d.id, ...d.data() }));

  // 2. lees poules
  const poulesSnap = await getDocs(collection(db, "toernooien", activeTournamentId, "poules_r1"));
  if (!poulesSnap.empty) {
    currentPoules = poulesSnap.docs.map(d => d.data());
    showPoulesFeedback("📋 Poule-indeling geladen.", "success");
  } else {
    currentPoules = [];
  }

  // 3. sync beschikbare spelers op basis van wie al in currentPoules zit
  renderPoules();
  renderAvailablePlayers();

  selectedPlayer = null;
}

// ----- event listeners -----

createPoulesBtn.addEventListener("click", createPoules);
savePoulesBtn.addEventListener("click", savePoulesToFirestore);
clearPoulesBtn.addEventListener("click", clearPoules);

/* ===== EINDE FUNCTIES TAB 1E RONDE POULES ===== */


/* ===== FUNCTIES TAB 1E RONDE RESULTATEN ===== */

const noTournamentR1ResNotice = document.getElementById("noTournamentR1ResNotice");
const refreshMatchesBtn = document.getElementById("refreshMatchesBtn");
const r1matchesWrapper = document.getElementById("r1matchesWrapper");

let r1Matches = [];          
let toernooiSettings = {};   
let openPoules = new Set();  // onthoud welke poules open staan

// ✅ Popup-melding (fout of succes)
function showPopupMessage(msg, isError = true) {
  // als popup al bestaat: eerst verwijderen zodat we hem schoon opnieuw tekenen
  const existing = document.getElementById("popupMsg");
  if (existing) existing.remove();

  const popup = document.createElement("div");
  popup.id = "popupMsg";
  popup.style.cssText = `
    position:fixed; top:20%; left:50%; transform:translateX(-50%);
    background:${isError ? "#f8d7da" : "#d1e7dd"};
    color:${isError ? "#842029" : "#0f5132"};
    border:1px solid ${isError ? "#f5c2c7" : "#badbcc"};
    border-radius:8px; padding:20px 25px; z-index:2000;
    box-shadow:0 4px 12px rgba(0,0,0,0.3); text-align:center; min-width:280px;
  `;

  const msgDiv = document.createElement("div");
  msgDiv.textContent = msg;

  const btn = document.createElement("button");
  btn.textContent = "OK";
  btn.style.cssText = `
    margin-top:12px; background:#fff; border:1px solid #ccc;
    border-radius:4px; padding:5px 15px; cursor:pointer;
  `;
  btn.onclick = () => popup.remove();

  popup.appendChild(msgDiv);
  popup.appendChild(btn);
  document.body.appendChild(popup);
}

// ✅ Scoring-overzicht bovenaan
function renderScoringOverview() {
  const el = document.getElementById("r1ScoringOverview");
  if (!toernooiSettings || !toernooiSettings.punten) {
    el.style.display = "none";
    return;
  }

  const p = toernooiSettings.punten;
  const maxB = toernooiSettings.maxBeurten;
  const maxText = maxB ? maxB : "Niet van toepassing";

  el.style.display = "block";
  el.innerHTML = `
    <strong>Maximaal aantal beurten:</strong> ${maxText}<br>
    <strong>Punten:</strong>
    Winst &lt; max: ${p.winLess}, Gelijk &lt; max: ${p.drawLess}, Verlies &lt; max: ${p.loseLess} |
    Winst = max: ${p.winMax}, Gelijk = max: ${p.drawMax}, Verlies = max: ${p.loseMax}
  `;
}

// ✅ Totaaloverzicht bovenaan
function updateOverallProgress() {
  const total = r1Matches.length;
  const played = r1Matches.filter(m => m.afgerond).length;
  const perc = total > 0 ? Math.round((played / total) * 100) : 0;
  const el = document.getElementById("r1OverallProgress");
  el.style.display = total === 0 ? "none" : "block";
  el.textContent = total === 0 ? "" :
    `Totaal gespeeld: ${played} / ${total} wedstrijden (${perc}%)`;
}

// ✅ Wedstrijden laden vanuit Firestore
async function loadR1MatchesFromFirestore() {
  if (!activeTournamentId) {
    noTournamentR1ResNotice.style.display = "block";
    return;
  }
  noTournamentR1ResNotice.style.display = "none";

  // toernooi-instellingen (punten, maxBeurten)
  const tournRef = doc(db, "toernooien", activeTournamentId);
  const tournSnap = await getDoc(tournRef);
  toernooiSettings = tournSnap.data() || {};
  renderScoringOverview();

  // wedstrijden
  const matchesRef = collection(db, "toernooien", activeTournamentId, "r1_wedstrijden");
  const snap = await getDocs(matchesRef);
  r1Matches = snap.docs.map(d => ({ id: d.id, ...d.data() }));

  renderR1Matches();
}

// ✅ Render alle poules met wedstrijden
function renderR1Matches() {
  // Bewaar huidige open/dicht status vóórdat we het DOM leeggooien
  openPoules = new Set(
    Array.from(document.querySelectorAll(".poule-block"))
      .filter(b => b.querySelector(".poule-body")?.style.display !== "none")
      .map(b => b.dataset.poule)
  );

  r1matchesWrapper.innerHTML = "";
  if (r1Matches.length === 0) {
    r1matchesWrapper.innerHTML = "<p style='color:#777;'>Geen wedstrijden gevonden.</p>";
    updateOverallProgress();
    return;
  }

  // groepeer per poule
  const pouleMap = {};
  r1Matches.forEach(m => {
    if (!pouleMap[m.poule]) pouleMap[m.poule] = [];
    pouleMap[m.poule].push(m);
  });

  Object.keys(pouleMap).sort().forEach(pouleNaam => {
    const pouleMatches = pouleMap[pouleNaam];
    const playedCount = pouleMatches.filter(m => m.afgerond).length;
    const totalCount = pouleMatches.length;

    const pouleBlock = document.createElement("div");
    pouleBlock.className = "poule-block";
    pouleBlock.dataset.poule = pouleNaam;
    pouleBlock.style.cssText =
      "border:1px solid #ccc;border-radius:8px;overflow:hidden;background:#fff;";

    const header = document.createElement("div");
    header.innerHTML = `
      ${pouleNaam}
      <span style="font-weight:400;color:#444;">(${playedCount} / ${totalCount} gespeeld)</span>
    `;
    header.style.cssText =
      "background:#cfe2ff;padding:8px 12px;font-weight:600;cursor:pointer;";
    pouleBlock.appendChild(header);

    const body = document.createElement("div");
    body.className = "poule-body";
    body.style.padding = "10px";
    // herstel vorige open/dicht status
    body.style.display = openPoules.has(pouleNaam) ? "block" : "none";
    pouleBlock.appendChild(body);

    header.addEventListener("click", () => {
      body.style.display = body.style.display === "none" ? "block" : "none";
    });

    const table = document.createElement("table");
    table.style.width = "100%";
    table.style.borderCollapse = "collapse";
    const tbody = document.createElement("tbody");

    // Koprij
    const headerRow = document.createElement("tr");
    headerRow.style.cssText = "background:#f8f9fa;font-weight:600;font-size:0.9em;";
    headerRow.innerHTML = `
      <td>Speler X</td>
      <td>Te maken</td>
      <td>Gemaakte</td>
      <td>Pnt X</td>
      <td>Speler Y</td>
      <td>Te maken</td>
      <td>Gemaakte</td>
      <td>Pnt Y</td>
      <td>Beurten</td>
      <td style="text-align:center;">Acties</td>
    `;
    tbody.appendChild(headerRow);

    pouleMatches.forEach(match => {
      const tr = document.createElement("tr");
      tr.style.borderBottom = "1px solid #eee";

      tr.innerHTML = `
        <td>${match.spelerX.naam}</td>
        <td style="text-align:center;color:#666;">${match.spelerX.teMaken}</td>
        <td>
          <input type="number"
                 min="0"
                 max="${match.spelerX.teMaken}"
                 value="${match.gemaakteX ?? ''}"
                 class="inp small">
        </td>
        <td style="text-align:center;">${match.puntenX ?? '-'}</td>

        <td>${match.spelerY.naam}</td>
        <td style="text-align:center;color:#666;">${match.spelerY.teMaken}</td>
        <td>
          <input type="number"
                 min="0"
                 max="${match.spelerY.teMaken}"
                 value="${match.gemaakteY ?? ''}"
                 class="inp small">
        </td>
        <td style="text-align:center;">${match.puntenY ?? '-'}</td>

        <td>
          <input type="number"
                 min="0"
                 value="${match.beurten ?? ''}"
                 class="inp small">
        </td>

        <td style="text-align:center;">
          <button class="btn btn-save btn-sm save-btn"   title="Opslaan">💾</button>
          <button class="btn btn-unlock btn-sm edit-btn" title="Wijzigen">✏️</button>
          <button class="btn btn-delete btn-sm delete-btn" title="Wissen">🗑️</button>
        </td>
      `;
      tbody.appendChild(tr);

      const inputs    = tr.querySelectorAll("input");
      // inputs[0] = gemaakteX
      // inputs[1] = gemaakteY
      // inputs[2] = beurten
      const saveBtn   = tr.querySelector(".save-btn");
      const editBtn   = tr.querySelector(".edit-btn");
      const deleteBtn = tr.querySelector(".delete-btn");

      // als afgerond -> lock invoer
      if (match.afgerond) {
        inputs.forEach(i => i.disabled = true);
        tr.style.background = "#f8f9fa";
      }

      // OPSLAAN Uitslag
      saveBtn.addEventListener("click", async () => {
        const gemaakteX = parseInt(inputs[0].value);
        const gemaakteY = parseInt(inputs[1].value);
        const beurten   = parseInt(inputs[2].value);

        const teMakenX  = match.spelerX.teMaken;
        const teMakenY  = match.spelerY.teMaken;
        const maxB      = toernooiSettings.maxBeurten || null;

        if (isNaN(gemaakteX) || isNaN(gemaakteY) || isNaN(beurten)) {
          showPopupMessage("Alle velden moeten ingevuld zijn.");
          return;
        }
        if (gemaakteX > teMakenX || gemaakteY > teMakenY) {
          showPopupMessage("Een speler kan niet meer maken dan zijn te maken caramboles.");
          return;
        }
        if (maxB && beurten > maxB) {
          showPopupMessage(`Aantal beurten mag niet groter zijn dan ${maxB}.`);
          return;
        }

        // partij moet klaar zijn
        const partijNogNietAf = (!maxB || beurten < maxB);
        if (partijNogNietAf && (gemaakteX < teMakenX && gemaakteY < teMakenY)) {
          showPopupMessage("Partij niet voltooid: niemand is 'uit'.");
          return;
        }

        // uitslag & punten
        const pnt = toernooiSettings.punten || {};
        let result, puntenX, puntenY;
        if (gemaakteX >= teMakenX && gemaakteY >= teMakenY) {
          result = "gelijk";
        } else if (gemaakteX >= teMakenX) {
          result = "spelerX";
        } else if (gemaakteY >= teMakenY) {
          result = "spelerY";
        } else {
          const percX = gemaakteX / teMakenX;
          const percY = gemaakteY / teMakenY;
          if (percX > percY) result = "spelerX";
          else if (percY > percX) result = "spelerY";
          else result = "gelijk";
        }

        const less = !maxB || beurten < maxB;
        if (result === "gelijk") {
          puntenX = less ? pnt.drawLess : pnt.drawMax;
          puntenY = less ? pnt.drawLess : pnt.drawMax;
        } else if (result === "spelerX") {
          puntenX = less ? pnt.winLess : pnt.winMax;
          puntenY = less ? pnt.loseLess : pnt.loseMax;
        } else {
          puntenY = less ? pnt.winLess : pnt.winMax;
          puntenX = less ? pnt.loseLess : pnt.loseMax;
        }

        const ref = doc(db, "toernooien", activeTournamentId, "r1_wedstrijden", match.id);

        await setDoc(ref, {
          ...match,
          gemaakteX,
          gemaakteY,
          beurten,
          puntenX,
          puntenY,
          afgerond: true,
          resultaat: result
        });

        showPopupMessage("Wedstrijd succesvol opgeslagen!", false);

        // reload, maar behoud open/dicht-status
        await loadR1MatchesFromFirestore();
      });

      // VELDEN HEROPENSLOTEN VOOR BEWERKEN
      editBtn.addEventListener("click", () => {
        inputs.forEach(i => i.disabled = false);
        tr.style.background = "#fff";
      });

      // WISSEN RESULTAAT
      deleteBtn.addEventListener("click", async () => {
        if (!match.afgerond) {
          showPopupMessage("Deze partij heeft nog geen resultaat om te wissen.", true);
          return;
        }

        const zeker = confirm("Weet je zeker dat je het resultaat van deze partij wilt verwijderen?");
        if (!zeker) return;

        const ref = doc(db, "toernooien", activeTournamentId, "r1_wedstrijden", match.id);

        // we zetten alle uitslagvelden terug op 'leeg', maar laten spelerinformatie etc. staan
        await setDoc(ref, {
          ...match,
          gemaakteX: null,
          gemaakteY: null,
          beurten: null,
          puntenX: null,
          puntenY: null,
          afgerond: false,
          resultaat: null
        }, { merge: true });

        showPopupMessage("Wedstrijdresultaat verwijderd.", false);

        // reload, maar behoud open/dicht-status
        await loadR1MatchesFromFirestore();
      });

    }); // end pouleMatches.forEach

    tbody.appendChild(document.createElement("tr")); // kleine visuele spacer? optioneel
    table.appendChild(tbody);
    body.appendChild(table);
    r1matchesWrapper.appendChild(pouleBlock);
  });

  updateOverallProgress();
}

// handmatige refresh-knop
refreshMatchesBtn.addEventListener("click", loadR1MatchesFromFirestore);

// helper voor initialiseren dit tabblad na toernooi-laden
async function loadR1ResultsTabForActiveTournament() {
  if (!activeTournamentId) return;
  await loadR1MatchesFromFirestore();
}

/* ===== EINDE FUNCTIES TAB 1E RONDE RESULTATEN ===== */






    /* =========================================================
       EVENT LISTENERS VOOR TOERNOOI KNOPPEN
       ========================================================= */
    document.getElementById('tournamentForm').addEventListener('submit', e => {
      e.preventDefault();
      saveTournament();
    });

    document.getElementById('loadBtn').addEventListener('click', loadTournamentList);
    document.getElementById('deleteBtn').addEventListener('click', deleteTournament);

    /* =========================================================
       INIT
       ========================================================= */
    showConnectionBanner();
    guardSpelersTabAvailability();
  </script>
</body>
</html>

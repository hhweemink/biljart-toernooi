<!DOCTYPE html>
<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>BCR Toernooi</title>

    <style>
      /* Alles gescope'd op #bcr-toernooi-app zodat het elders niet stoort */

      #bcr-toernooi-app {
        font-family: system-ui, sans-serif;
        max-width: 1000px;
        margin: 20px auto;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      #bcr-toernooi-app header {
        background: #b30000;
        color: white;
        text-align: center;
        padding: 10px;
        font-size: 1.4em;
        font-weight: 600;
      }

      #bcr-toernooi-app .active-tournament {
        text-align: center;
        font-weight: bold;
        background: #f7f7f7;
        color: #333;
        padding: 8px;
        border-bottom: 1px solid #ddd;
      }

      /* Tabs */
      #bcr-toernooi-app .tab-buttons {
        display: flex;
        justify-content: space-between;
        flex-wrap: nowrap;
        overflow-x: auto;
        background: #eee;
        border-bottom: 1px solid #ccc;
      }

      #bcr-toernooi-app .tab-buttons button {
        flex: 1;
        min-width: 110px;
        background: none;
        border: none;
        padding: 8px 6px;
        font-size: 0.9em;
        cursor: pointer;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
        transition: background 0.3s, color 0.3s;
        font-weight: 500;
        color: #333;
      }

      #bcr-toernooi-app .tab-buttons button.active {
        background: #b30000;
        color: #fff;
        font-weight: 600;
      }

      #bcr-toernooi-app .tab-content {
        display: none;
        padding: 20px;
      }

      #bcr-toernooi-app .tab-content.active {
        display: block;
      }

      /* Form layout */
      #bcr-toernooi-app form {
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      #bcr-toernooi-app label {
        font-weight: 600;
        display: block;
        margin-bottom: 4px;
      }

      #bcr-toernooi-app input[type="text"],
      #bcr-toernooi-app input[type="number"],
      #bcr-toernooi-app input[type="date"],
      #bcr-toernooi-app textarea,
      #bcr-toernooi-app select {
        width: 100%;
        padding: 6px;
        font-size: 0.95em;
        border: 1px solid #ccc;
        border-radius: 6px;
      }

      #bcr-toernooi-app input.small {
        width: 70px;
        text-align: center;
      }

      #bcr-toernooi-app textarea {
        min-height: 60px;
        resize: vertical;
      }

      #bcr-toernooi-app .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px 20px;
      }

      @media (max-width: 600px) {
        #bcr-toernooi-app .form-grid {
          grid-template-columns: 1fr;
        }
      }

      /* Puntenvelden in twee kolommen */
      #bcr-toernooi-app .points-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
      }

      #bcr-toernooi-app .points-grid h4 {
        margin: 0 0 6px;
        font-size: 0.9rem;
        font-weight: 600;
        color: #333;
      }

      /* Feedback / meldingen */
      #bcr-toernooi-app #feedback {
        margin-top: 0;
      }

      #bcr-toernooi-app #feedback .message {
        border-radius: 8px;
        padding: 10px 12px;
        font-weight: 600;
        position: relative;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        line-height: 1.4;
        font-size: 0.9rem;
      }

      #bcr-toernooi-app #feedback .message .close {
        position: absolute;
        top: 8px;
        right: 10px;
        cursor: pointer;
        font-weight: bold;
        opacity: 0.6;
      }

      #bcr-toernooi-app #feedback .message .close:hover {
        opacity: 1;
      }

      /* Knoppenrij onderaan formulier */
      #bcr-toernooi-app .button-row {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-top: 1rem;
        flex-wrap: wrap;
      }

      #bcr-toernooi-app .btn {
        flex: 1;
        max-width: 220px;
        padding: 10px 0;
        font-size: 16px;
        font-weight: 600;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.25s ease;
        color: white;
        text-align: center;
        display: inline-block;
        text-decoration: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
      }

      #bcr-toernooi-app .btn:active {
        transform: scale(0.97);
      }

      /* Opslaan */
      #bcr-toernooi-app .btn-save {
        background-color: #007bff;
      }
      #bcr-toernooi-app .btn-save:hover {
        background-color: #005dc1;
      }

      /* Laden */
      #bcr-toernooi-app .btn-load {
        background-color: #6c757d;
      }
      #bcr-toernooi-app .btn-load:hover {
        background-color: #555d63;
      }

      /* Verwijderen */
      #bcr-toernooi-app .btn-delete {
        background-color: #fdb2ba;
      }
      #bcr-toernooi-app .btn-delete:hover {
        background-color: #ff0019;
      }

      /* Extra knoppen in spelers-tab */
      #bcr-toernooi-app .btn-secondary {
        background-color: #6c757d;
      }
      #bcr-toernooi-app .btn-secondary:hover {
        background-color: #555d63;
      }

      #bcr-toernooi-app .btn-lock {
        background-color: #198754;
      }
      #bcr-toernooi-app .btn-lock:hover {
        background-color: #146c43;
      }

      #bcr-toernooi-app .btn-unlock {
        background-color: #0dcaf0;
      }
      #bcr-toernooi-app .btn-unlock:hover {
        background-color: #0aa2c0;
      }

      /* Klein statusblok voor Firestore verbinding */
      #bcr-toernooi-app .connection-status {
        position: absolute;
        right: 18px;
        top: 50%;
        transform: translateY(-50%);

        display: inline-flex;
        align-items: center;
        gap: 4px;

        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid #c1e6c9;
        background: #e6f4ea;
        color: #137333;
        font-size: 0.78rem;
        font-weight: 500;
        box-shadow: none;
        white-space: nowrap;
      }

      /* ===== SPELERS-TAB: DEELNEMERSLIJST ===== */

      #bcr-toernooi-app table.player-table {
        width: 100%;
        border-collapse: collapse; /* strakke grid-lijnen */
        margin-top: 16px;
        font-size: 0.9rem;
      }

      /* Koprij */
      #bcr-toernooi-app table.player-table thead th {
        background: #f5f5f5;
        padding: 8px 12px;
        border-bottom: 1px solid #e6e6e6;
        border-right: 1px solid #e6e6e6; /* zelfde lichtgrijs als rijscheiding */
        text-align: left;
        font-weight: 600;
        white-space: nowrap;
        color: #444;
      }

      /* Datacellen */
      #bcr-toernooi-app table.player-table tbody td {
        padding: 8px 12px;
        border-bottom: 1px solid #e6e6e6; /* rij-scheiding */
        border-right: 1px solid #e6e6e6; /* kolom-scheiding in zelfde kleur */
        vertical-align: top;
        background: #ffffff; /* witte cellen i.p.v. grijs blok */
      }

      /* Hover: volledige rij licht grijs */
      #bcr-toernooi-app table.player-table tbody tr:hover td {
        background: #f9f9f9;
      }

      /* geen rechterrand op laatste kolom */
      #bcr-toernooi-app table.player-table th:last-child,
      #bcr-toernooi-app table.player-table td:last-child {
        border-right: none;
      }

      /* laatste rij geen extra dikke onderrand */
      #bcr-toernooi-app table.player-table tbody tr:last-child td {
        border-bottom: none;
      }

      /* hover over complete rij */
      #bcr-toernooi-app table.player-table tbody tr:hover {
        background: #f9f9f9;
      }

      /* Kolombreedtes specifiek voor spelers-tabel */
      #bcr-toernooi-app #playersTable th:nth-child(1) {
        width: 28%; /* Naam */
      }
      #bcr-toernooi-app #playersTable th:nth-child(2) {
        width: 34%; /* E-mail */
      }
      #bcr-toernooi-app #playersTable th:nth-child(3) {
        width: 18%; /* Telefoon */
      }
      #bcr-toernooi-app #playersTable th:nth-child(4) {
        width: 8%;
        text-align: center; /* header Caramboles */
      }
      #bcr-toernooi-app #playersTable th:nth-child(5) {
        width: 12%;
        text-align: center; /* header Acties */
      }

      /* Uitlijning caramboles-waarden */
      #bcr-toernooi-app table.player-table td.num {
        text-align: center;
        font-variant-numeric: tabular-nums;
      }

      /* Actiekolom */
      #bcr-toernooi-app table.player-table td.actions {
        text-align: center;
        white-space: nowrap;
      }
      #bcr-toernooi-app table.player-table td.actions button {
        margin: 0 2px;
      }

      /* Notice als geen toernooi actief is */
      #noTournamentNotice {
        color: #842029;
        background: #f8d7da;
        border: 1px solid #f5c2c7;
        padding: 8px;
        border-radius: 6px;
        margin-bottom: 12px;
        font-weight: 600;
        font-size: 0.9rem;
      }

      /* Kleinere sub-headings in spelers-tab */
      #bcr-toernooi-app h3 {
        margin: 0 0 10px;
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
      }

      #bcr-toernooi-app table.player-table td.actions button {
        margin: 0 2px;
      }

      #bcr-toernooi-app table.player-table td.actions {
        text-align: center;
        white-space: nowrap;
      }

      #bcr-toernooi-app #r1resultaten .actie-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border: 1px solid #ccc;
        border-radius: 6px;
        background: #fff;
        cursor: pointer;
        font-size: 1.3rem; /* groter icoon */
        line-height: 1;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
      }
      #bcr-toernooi-app #r1resultaten .actie-btn:hover {
        background: #f1f3f5;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.12);
      }
      #bcr-toernooi-app #r1resultaten .actie-btn:active {
        transform: scale(0.96);
      }

      /* kleurtjes per soort */
      #bcr-toernooi-app #r1resultaten .actie-btn.save {
        color: #198754;
        border-color: #198754;
      }
      #bcr-toernooi-app #r1resultaten .actie-btn.reset {
        color: #dc3545;
        border-color: #dc3545;
      }

      /* =========================================================
   VISUELE UPDATE: BASIS, HEADER, TABS, FORM & KNOPPEN
   (inspiratie: schapp-chat)
   ========================================================= */

      /* Basis + kleuren */
      #bcr-toernooi-app {
        --kleur-accent1: #8d0c00;
        --kleur-accent2: #ff3c3c;
        --kleur-bg: #f5f5f5;
        --kleur-kaart: #ffffff;
        --kleur-rand: #cccccc;
        --kleur-tekst: #222222;
        --radius: 8px;

        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        font-size: 0.92rem;
        color: var(--kleur-tekst);

        max-width: 1000px;
        margin: 20px auto;
        background: var(--kleur-kaart);
        border-radius: var(--radius);
        border: 1px solid var(--kleur-rand);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
      }

      /* Header bovenaan de app */
      #bcr-toernooi-app header {
        background: #ffffff;
        color: var(--kleur-accent1);
        padding: 14px 18px;
        font-size: 1.3rem;
        font-weight: 650;
        border-bottom: 1px solid #e1e1e1;

        /* voor subtiele Firestore badge rechts */
        display: flex;
        align-items: center;
        justify-content: center; /* titel in het midden */
        position: relative;
        text-align: center;
      }

      /* Actief toernooi-balk onder de header */
      #bcr-toernooi-app .active-tournament {
        padding: 8px 18px;
        border-bottom: 1px solid #eeeeee;
        font-size: 1.1rem;
        font-weight: 600;
        text-align: center;
      }

      /* Geen toernooi geselecteerd ‚Üí licht rood en iets meer contrast */
      #bcr-toernooi-app .active-tournament.no-tournament {
        background: #fcebec;
        color: #842029;
      }

      /* Wel een actief toernooi ‚Üí iets subtieler blauw/rood mix */
      #bcr-toernooi-app .active-tournament.has-tournament {
        background: #f5f0f0;
        color: #6b1d1d;
      }

      /* Tabs boven de inhoud */
      #bcr-toernooi-app .tab-buttons {
        display: flex;
        justify-content: flex-start;
        flex-wrap: nowrap;
        overflow-x: auto;
        background: #fafafa;
        border-bottom: 1px solid #dddddd;
      }

      #bcr-toernooi-app .tab-buttons button {
        flex: 0 0 auto;
        min-width: 110px;
        padding: 8px 10px;
        font-size: 0.86rem;
        font-weight: 500;
        border: none;
        border-bottom: 2px solid transparent;
        background: transparent;
        cursor: pointer;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
        color: #555555;
        transition: background 0.2s ease, color 0.2s ease,
          border-bottom-color 0.2s;
      }

      #bcr-toernooi-app .tab-buttons button:hover {
        background: #f0f0f0;
      }

      #bcr-toernooi-app .tab-buttons button.active {
        background: #ffffff;
        color: var(--kleur-accent1);
        border-bottom-color: var(--kleur-accent1);
      }

      /* Tabcontent iets luchtiger */
      #bcr-toernooi-app .tab-content {
        padding: 18px;
      }

      /* Typografie in formulieren */
      #bcr-toernooi-app label {
        font-size: 0.86rem;
        font-weight: 500;
        color: #444444;
        margin-bottom: 3px;
      }

      #bcr-toernooi-app input[type="text"],
      #bcr-toernooi-app input[type="number"],
      #bcr-toernooi-app input[type="date"],
      #bcr-toernooi-app textarea,
      #bcr-toernooi-app select {
        padding: 4px 6px;
        font-size: 0.9rem;
        border-radius: 6px;
        border: 1px solid #cccccc;
        box-sizing: border-box;
      }

      #bcr-toernooi-app input[type="text"]:focus,
      #bcr-toernooi-app input[type="number"]:focus,
      #bcr-toernooi-app input[type="date"]:focus,
      #bcr-toernooi-app textarea:focus,
      #bcr-toernooi-app select:focus {
        outline: 1px solid var(--kleur-accent1);
        border-color: var(--kleur-accent1);
      }

      /* Form-grid iets compacter ritme */
      #bcr-toernooi-app form {
        gap: 10px;
      }

      /* Kaart-stijl blok voor de moyenne ‚Üí caramboles tabel */
      #bcr-toernooi-app #moyCarTableBlock {
        margin-top: 0;
      }

      /* Subkopjes */
      #bcr-toernooi-app h3 {
        margin: 0 0 8px;
        font-size: 1.15rem;
        font-weight: 600;
        color: var(--kleur-accent1);
      }

      /* ===== KNOPSTIJLEN ‚Äì globale .btn, ge√Ønspireerd op schapp-chat ===== */

      #bcr-toernooi-app .button-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: flex-start;
        margin-top: 12px;
      }

      #bcr-toernooi-app .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 4px;

        border-radius: 6px;
        padding: 7px 12px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        border: 1px solid var(--kleur-accent1);
        background: var(--kleur-accent1);
        color: #ffffff;
        text-decoration: none;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        transition: background 0.2s ease, box-shadow 0.2s ease,
          transform 0.1s ease, color 0.2s ease, border-color 0.2s ease;
        min-width: 120px;
      }

      #bcr-toernooi-app .btn:hover {
        background: #7a0a00;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
      }

      #bcr-toernooi-app .btn:active {
        transform: scale(0.97);
      }

      /* Primair: opslaan / hoofdacties */
      #bcr-toernooi-app .btn-save {
        background: var(--kleur-accent1);
        border-color: var(--kleur-accent1);
        color: #ffffff;
      }

      /* Secundair: neutrale acties */
      #bcr-toernooi-app .btn-secondary,
      #bcr-toernooi-app .btn-load {
        background: #ffffff;
        color: var(--kleur-accent1);
        border-color: var(--kleur-accent1);
      }

      #bcr-toernooi-app .btn-secondary:hover,
      #bcr-toernooi-app .btn-load:hover {
        background: #fe9c9c;
      }

      /* Danger */
      #bcr-toernooi-app .btn-delete {
        background: #b00020;
        border-color: #b00020;
        color: #ffffff;
      }

      #bcr-toernooi-app .btn-delete:hover {
        background: #fe9c9c;
        color: var(--kleur-accent1);
      }

      /* Lock / unlock varianten (Spelers / poules) */
      #bcr-toernooi-app .btn-lock {
        background: #198754;
        border-color: #198754;
      }

      #bcr-toernooi-app .btn-lock:hover {
        background: #146c43;
      }

      #bcr-toernooi-app .btn-unlock {
        background: #0dcaf0;
        border-color: #0dcaf0;
        color: #053b4b;
      }

      #bcr-toernooi-app .btn-unlock:hover {
        background: #0aa2c0;
      }

      /* Iconen in knoppen (emoji maar kleiner & subtieler) */
      #bcr-toernooi-app .btn-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-right: 4px;
        font-size: 1rem;
        line-height: 1;
        filter: grayscale(1); /* maakt emoji grotendeels √©√©nkleurig */
        opacity: 0.85; /* iets subtieler */
      }

      /* Compacte icon-only knoppen (bijv. in tabellen) */
      #bcr-toernooi-app .btn-icon-only {
        min-width: 0;
        padding: 3px 6px;
        border-radius: 999px;
      }

      #bcr-toernooi-app .btn-icon-only .btn-icon {
        margin-right: 0;
        font-size: 0.9rem;
      }

      #bcr-toernooi-app .btn-label {
        vertical-align: middle;
      }

      /* Button in login-overlay dezelfde stijl geven */
      #loginOverlay .btn {
        width: 100%;
        justify-content: center;
        min-width: 0;
      }

      /* ===== TOERNOOI-TAB: BLOKKENLAY-OUT ===== */

      #bcr-toernooi-app .toernooi-block {
        border: 2px solid #777777;
        border-radius: 8px;
        background: #ebebeb;
        margin-bottom: 10px;
        box-shadow: 1px 1px 2px rgb(64, 64, 64);
      }

      #bcr-toernooi-app .toernooi-block-header {
        padding: 8px 12px;
        border-bottom: 1px solid #eeeeee;
        background: #fafafa;
      }

      #bcr-toernooi-app .toernooi-block-header h3 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: var(--kleur-accent1);
      }

      #bcr-toernooi-app .toernooi-block-body {
        padding: 10px 12px 12px;
      }

      /* Rij met twee blokken (Punten + Moyennetabel) */
      #bcr-toernooi-app .toernooi-block-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }

      #bcr-toernooi-app .toernooi-block-row .toernooi-block {
        flex: 1 1 280px;
      }

      /* Datums in √©√©n rij (4 kolommen) */
      #bcr-toernooi-app .dates-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 12px 16px;
        margin-top: 10px;
      }

      @media (max-width: 900px) {
        #bcr-toernooi-app .dates-grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }
      @media (max-width: 550px) {
        #bcr-toernooi-app .dates-grid {
          grid-template-columns: 1fr;
        }
      }

      /* Maximaal aantal beurten + 'Niet van toepassing' op √©√©n regel */
      #bcr-toernooi-app .maxturns-row {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
      }

      #bcr-toernooi-app .maxturns-row > label:first-child {
        margin-bottom: 0;
      }

      #bcr-toernooi-app .no-max-label {
        font-weight: 400;
        margin-left: 0;
      }

      /* Kleine finetune punten-grid binnen het blok */
      #bcr-toernooi-app .punten-block .points-grid {
        margin-top: 4px;
      }

      #bcr-toernooi-app .btn-icon-only {
        border-radius: 6px !important;
      }

      /* Zorg dat alle rode knoppen overal exact hetzelfde hover-gedrag hebben */
      #bcr-toernooi-app .btn-delete {
        background: #b00020;
        border-color: #b00020;
        color: #ffffff;
      }

      #bcr-toernooi-app .btn-delete:hover {
        background: #fe9c9c;
        color: var(--kleur-accent1);
      }

      /* ===== SPELERS-TAB UI ===== */

      .spelers-tab .toernooi-block {
        margin-top: 18px;
      }

      .player-count {
        margin-top: 6px;
        font-size: 0.9rem;
        color: #555;
      }

      .tab-notice {
        margin-bottom: 10px;
        padding: 8px 10px;
        border-radius: 6px;
        font-size: 0.9rem;
        background: #fff4e5;
        border: 1px solid #ffd8a8;
      }

      /* Spelers-tab: lokale 'geen toernooi'-melding verbergen
   (die info staat al bovenaan in de app) */
      #bcr-toernooi-app #noTournamentNotice {
        display: none !important;
      }

      /* ===== Algemeen: modale pop-ups (speler bewerken e.d.) ===== */

      #bcr-toernooi-app .modal {
        display: none; /* JS zet display op 'flex' als hij open moet */
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        z-index: 4000;
        align-items: center;
        justify-content: center;
      }

      #bcr-toernooi-app .modal-content {
        background: #ffffff;
        border-radius: 10px;
        border: 1px solid #dddddd;
        padding: 14px 16px 16px;
        width: min(420px, 90vw);
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.18);
      }

      #bcr-toernooi-app .modal-content h3 {
        margin: 0 0 10px;
        font-size: 1.05rem;
        font-weight: 600;
        color: var(--kleur-header, #333333);
      }

      #bcr-toernooi-app .modal-content .form-grid {
        margin-top: 4px;
      }

      #bcr-toernooi-app .modal-content .button-row {
        margin-top: 14px;
        justify-content: flex-end;
      }

      /* Popup knoppen mooi naast elkaar */
      #bcr-toernooi-app .modal-button-row {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 16px;
      }

      #bcr-toernooi-app .modal-button-row .btn {
        min-width: 120px;
        justify-content: center;
      }

      /* Popup: knoppen naast elkaar, buiten het form-grid dwingen */
      #bcr-toernooi-app .modal-button-row {
        display: flex !important;
        flex-direction: row !important;
        justify-content: flex-end;
        gap: 10px;
        width: 100%;
        grid-column: 1 / -1 !important; /* uitbreken uit de 2-kolommen grid */
      }

      #bcr-toernooi-app .modal-button-row .btn {
        min-width: 140px;
        justify-content: center;
      }

      #bcr-toernooi-app table.player-table td.num {
        text-align: center !important;
      }
    </style>
  </head>

  <body>
    <!-- ===== LOGIN OVERLAY ===== -->
    <div
      id="loginOverlay"
      style="
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.55);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 5000;
      "
    >
      <div
        style="
          background: #fff;
          padding: 20px 22px;
          border-radius: 10px;
          width: 320px;
          box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25);
        "
      >
        <h3 style="margin-top: 0">Inloggen beheer</h3>
        <form
          id="loginForm"
          style="display: flex; flex-direction: column; gap: 10px"
        >
          <div>
            <label>Gebruikersnaam</label>
            <input id="loginUsername" type="text" required />
          </div>
          <div>
            <label>Wachtwoord</label>
            <input id="loginPassword" type="password" required />
          </div>
          <button type="submit" class="btn btn-save" style="max-width: none">
            Inloggen
          </button>
          <div id="loginMsg" style="font-weight: 600; color: #842029"></div>
        </form>
      </div>
    </div>

    <div id="bcr-toernooi-app">
      <header style="text-align: center">
        Clubkampioenschappen BC Raalte 90
      </header>

      <div class="active-tournament no-tournament" id="activeTournamentBanner">
        Geen toernooi geselecteerd
      </div>

      <div class="tab-buttons">
        <button class="active" data-tab="toernooi">Toernooi</button>
        <button data-tab="spelers">Spelers</button>
        <button data-tab="r1poules">1e Ronde poules</button>
        <button data-tab="r1resultaten">1e Ronde resultaten</button>
        <button data-tab="r2poules">2e Ronde poules</button>
        <button data-tab="r2resultaten">2e Ronde resultaten</button>
        <button data-tab="finale">Finale</button>
        <button data-tab="admin" id="adminTabBtn" style="display: none">
          Admin
        </button>
      </div>

      <!-- ===== START TAB: TOERNOOI ===== -->
      <div id="toernooi" class="tab-content active">
        <form id="tournamentForm">
          <!-- BLOK 1: TOERNOOI-INFORMATIE -->
          <div class="toernooi-block toernooi-info-block">
            <div class="toernooi-block-header">
              <h3>Toernooigegevens</h3>
            </div>
            <div class="toernooi-block-body">
              <div class="form-grid">
                <div>
                  <label for="tournamentName">Naam toernooi *</label>
                  <input type="text" id="tournamentName" required />
                </div>
                <div>
                  <label for="tournamentYear">Jaar *</label>
                  <div style="display: flex; align-items: center; gap: 12px">
                    <input
                      type="number"
                      id="tournamentYear"
                      class="small"
                      min="1900"
                      max="2099"
                      required
                    />
                    <div style="display: flex; align-items: center; gap: 6px">
                      <input type="checkbox" id="tournamentPublished" />
                      <span
                        id="tournamentPublishedBadge"
                        style="
                          padding: 2px 8px;
                          border-radius: 999px;
                          font-size: 0.8rem;
                          background: #f8d7da;
                          color: #842029;
                          white-space: nowrap;
                        "
                      >
                        Niet gepubliceerd
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              <div style="margin-top: 10px">
                <label for="tournamentOrg">Organisatie</label>
                <textarea
                  id="tournamentOrg"
                  rows="3"
                  placeholder="Namen van organisatoren..."
                ></textarea>
              </div>

              <div class="dates-grid">
                <div>
                  <label for="dateEndR1">Einde 1e ronde</label>
                  <input type="date" id="dateEndR1" />
                </div>
                <div>
                  <label for="dateEndR2">Einde 2e ronde</label>
                  <input type="date" id="dateEndR2" />
                </div>
                <div>
                  <label for="dateStartFinale">Start finale</label>
                  <input type="date" id="dateStartFinale" />
                </div>
                <div>
                  <label for="dateEndFinale">Einde finale</label>
                  <input type="date" id="dateEndFinale" />
                </div>
              </div>
            </div>
          </div>

          <!-- BLOKRIJ 2: PUNTEN + MOYENNETABEL -->
          <div class="toernooi-block-row">
            <!-- BLOK 2A: PUNTEN -->
            <div class="toernooi-block punten-block">
              <div class="toernooi-block-header">
                <h3>Punten</h3>
              </div>
              <div class="toernooi-block-body">
                <div class="maxturns-row">
                  <label for="maxTurns">Maximaal aantal beurten</label>
                  <input
                    type="number"
                    id="maxTurns"
                    class="small"
                    min="0"
                    max="999"
                  />
                  <label class="no-max-label">
                    <input type="checkbox" id="noMaxTurns" />
                    Niet van toepassing
                  </label>
                </div>

                <div class="points-grid">
                  <div>
                    <h4>&lt; max</h4>
                    <label for="pointsWinLess">Overwinning</label>
                    <input
                      type="number"
                      class="small"
                      id="pointsWinLess"
                      min="0"
                      max="999"
                    />
                    <label for="pointsDrawLess">Gelijkspel</label>
                    <input
                      type="number"
                      class="small"
                      id="pointsDrawLess"
                      min="0"
                      max="999"
                    />
                    <label for="pointsLoseLess">Nederlaag</label>
                    <input
                      type="number"
                      class="small"
                      id="pointsLoseLess"
                      min="0"
                      max="999"
                    />
                  </div>

                  <div>
                    <h4>= max</h4>
                    <label for="pointsWinMax">Overwinning</label>
                    <input
                      type="number"
                      class="small"
                      id="pointsWinMax"
                      min="0"
                      max="999"
                    />
                    <label for="pointsDrawMax">Gelijkspel</label>
                    <input
                      type="number"
                      class="small"
                      id="pointsDrawMax"
                      min="0"
                      max="999"
                    />
                    <label for="pointsLoseMax">Nederlaag</label>
                    <input
                      type="number"
                      class="small"
                      id="pointsLoseMax"
                      min="0"
                      max="999"
                    />
                  </div>
                </div>
              </div>
            </div>

            <!-- BLOK 2B: MOYENNETABEL -->
            <div class="toernooi-block punten-block" id="moyCarTableBlock">
              <div class="toernooi-block-header">
                <h3>Moyennetabel</h3>
              </div>
              <div class="toernooi-block-body">
                <p>
                  Koppel een tabel die het
                  <strong>gespeelde moyenne</strong> omzet naar het aantal te
                  maken caramboles. Kies een bestaande tabel of upload een
                  nieuwe CSV met kolommen <code>van</code>, <code>tot</code>,
                  <code>car</code>.
                </p>

                <div
                  style="
                    display: flex;
                    flex-wrap: wrap;
                    gap: 8px;
                    align-items: center;
                    margin-bottom: 8px;
                  "
                >
                  <label
                    for="moyCarTableSelect"
                    style="font-weight: 600; white-space: nowrap"
                    >Gekoppelde tabel:</label
                  >

                  <div
                    style="
                      display: flex;
                      flex-wrap: wrap;
                      gap: 8px;
                      align-items: center;
                    "
                  >
                    <select
                      id="moyCarTableSelect"
                      style="min-width: 220px; padding: 4px 6px"
                    >
                      <option value="">Geen tabel gekoppeld</option>
                    </select>

                    <button
                      type="button"
                      id="moyCarLinkBtn"
                      class="btn btn-secondary"
                    >
                      <span class="btn-icon" aria-hidden="true">üîó</span>
                      <span class="btn-label">Koppel tabel</span>
                    </button>

                    <button
                      type="button"
                      id="moyCarShowBtn"
                      class="btn btn-secondary"
                    >
                      <span class="btn-icon" aria-hidden="true">üëÅÔ∏è</span>
                      <span class="btn-label">Toon tabel</span>
                    </button>

                    <span
                      id="moyCarTableStatus"
                      style="font-size: 0.85rem; color: #555"
                    ></span>
                  </div>
                </div>

                <div
                  style="
                    display: flex;
                    flex-wrap: wrap;
                    gap: 8px;
                    align-items: center;
                  "
                >
                  <input
                    type="text"
                    id="moyCarTableName"
                    placeholder="Naam nieuwe tabel (bijv. Bandstoten 2025)"
                    style="flex: 1; min-width: 220px; padding: 4px 6px"
                  />
                  <input
                    type="file"
                    id="moyCarFileInput"
                    accept=".csv"
                    style="max-width: 220px"
                  />
                  <button
                    type="button"
                    id="moyCarUploadBtn"
                    class="btn btn-secondary"
                    style="max-width: none"
                  >
                    <span class="btn-icon" aria-hidden="true">‚¨ÜÔ∏è</span>
                    <span class="btn-label">Upload tabel</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="toernooi-block punten-block" id="moyCarTableBlock">
            <!-- ONDERAAN: OPSLAAN / LADEN / VERWIJDEREN -->
            <div class="toernooi-block-header">
              <h3>Beheer toernooien</h3>
            </div>
            <div class="toernooi-block-body">
              <div class="button-row">
                <button type="submit" id="saveBtn" class="btn btn-secondary">
                  <span class="btn-icon" aria-hidden="true">üíæ</span>
                  <span class="btn-label">Opslaan nieuw toernooi</span>
                </button>

                <button type="button" id="loadBtn" class="btn btn-load">
                  <span class="btn-icon" aria-hidden="true">üìÇ</span>
                  <span class="btn-label">Toernooi laden</span>
                </button>

                <button type="button" id="deleteBtn" class="btn btn-delete">
                  <span class="btn-icon" aria-hidden="true">üóëÔ∏è</span>
                  <span class="btn-label">Verwijder toernooi</span>
                </button>
              </div>

              <div id="feedback"></div>
            </div>
          </div>
        </form>
      </div>
      <!-- ===== END TAB: TOERNOOI ===== -->

      <!-- ===== START TAB: SPELERS ===== 
      <div id="spelers" class="tab-content" style="position: relative">
        <h3>Deelnemers</h3>

        <div id="noTournamentNotice" style="display: none">
          ‚ö†Ô∏è Geen toernooi geselecteerd. Selecteer eerst een toernooi om
          deelnemers te beheren.
        </div>

        <form id="playerForm" class="form-grid">
          <div>
            <label>Naam speler</label>
            <input type="text" id="playerName" required />
          </div>
          <div>
            <label>E-mailadres</label>
            <input type="text" id="playerEmail" />
          </div>
          <div>
            <label>Telefoonnummer</label>
            <input type="text" id="playerPhone" />
          </div>
          <div>
            <label>Te maken caramboles (1e ronde)</label>
            <input
              type="number"
              id="playerCaramboles"
              min="0"
              max="999"
              class="small"
            />
          </div>
          <div style="grid-column: 1/-1; text-align: right">
            <button
              type="submit"
              class="btn btn-secondary"
              id="addPlayerBtn"
              style="min-width: 190px"
            >
              <span class="btn-icon" aria-hidden="true">‚ûï</span>
              <span class="btn-label">Speler toevoegen</span>
            </button>
          </div>
        </form>

        <div class="button-row">
          <button type="button" id="sortByName" class="btn btn-secondary">
            Sorteer op naam
          </button>
          <button type="button" id="sortByCaramboles" class="btn btn-secondary">
            Sorteer op caramboles
          </button>
        </div>

        <div
          id="playerCount"
          style="margin-top: 10px; font-weight: 600; color: #333"
        >
          Aantal deelnemers: 0
        </div>
        <div
          id="playersFinalizedNotice"
          style="
            display: none;
            background: #ca3535;
            color: #ffffff;
            border: 1px solid #ca3535;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 12px;
            margin-top: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
          "
        >
          üîí De spelerslijst is definitief. Alleen het wijzigen van het
          e-mailadres en het telefoonnummer is mogelijk.
        </div>
        <div
          id="playersTableContainer"
          style="position: relative; margin-top: 10px"
        >
          <table
            id="playerTable"
            class="player-table"
            style="width: 100%; border-collapse: collapse"
          >
            <thead>
              <tr>
                <th>Naam</th>
                <th>E-mail</th>
                <th>Telefoon</th>
                <th>Caramboles</th>
                <th style="text-align: center">Acties</th>
              </tr>
            </thead>
            <tbody id="playerTableBody"></tbody>
          </table>
        -->
      <!-- ‚úÖ Overlay die verschijnt bij definitieve lijst 
          <div
            id="playersLockOverlay"
            style="
              display: none;
              position: absolute;
              top: 0;
              left: 0;
              width: 80%;
              height: 100%;
              background: rgba(240, 240, 240, 0.75);
              backdrop-filter: blur(2px);
              border-radius: 10px;
              justify-content: center;
              align-items: center;
              font-size: 1.2em;
              color: #555;
              font-weight: 600;
              pointer-events: none;
            "
          >
            üîí Spelerslijst is definitief
          </div>
        </div>

        <div class="button-row" style="margin-top: 15px">
          <button type="button" id="finalizePlayers" class="btn btn-secondary">
            <span class="btn-icon" aria-hidden="true">üîí</span>
            <span class="btn-label">Lijst definitief maken</span>
          </button>
          <button type="button" id="editPlayers" class="btn btn-secondary">
            <span class="btn-icon" aria-hidden="true">üîì</span>
            <span class="btn-label">Lijst bewerken</span>
          </button>
        </div>

        <div id="playerFeedback"></div>
      -->
      <!-- ‚úÖ Popup voor wijzigen van speler 
        <div
          id="editPlayerModal"
          style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
          "
        >
          <div
            style="
              background: #fff;
              padding: 20px;
              border-radius: 10px;
              width: 320px;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            "
          >
            <h4 style="margin-top: 0">Speler wijzigen</h4>
            <form id="editPlayerForm" class="form-grid">
              <div>
                <label>Naam</label>
                <input type="text" id="editName" required />
              </div>
              <div>
                <label>E-mail</label>
                <input type="text" id="editEmail" />
              </div>
              <div>
                <label>Telefoon</label>
                <input type="text" id="editPhone" />
              </div>
              <div>
                <label>Caramboles</label>
                <input
                  type="number"
                  id="editCaramboles"
                  min="0"
                  max="999"
                  class="small"
                />
              </div>
              <div class="button-row" style="margin-top: 15px">
                <button type="submit" class="btn btn-save">Opslaan</button>
                <button type="button" id="cancelEdit" class="btn btn-delete">
                  Annuleren
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    -->
      <!-- ===== END TAB: SPELERS ===== -->

      <!-- ===== START TAB: SPELERS ===== -->
      <div
        id="spelers"
        class="tab-content spelers-tab"
        style="position: relative"
      >
        <!-- BLOK 1: NIEUWE DEELNEMER -->
        <div class="toernooi-block spelers-form-block">
          <div class="toernooi-block-header">
            <h3>Nieuwe deelnemer</h3>
          </div>
          <div class="toernooi-block-body">
            <div
              id="noTournamentNotice"
              class="tab-notice"
              style="display: none"
            >
              ‚ö†Ô∏è Geen toernooi geselecteerd. Selecteer eerst een toernooi om
              deelnemers te beheren.
            </div>

            <form id="playerForm" class="form-grid">
              <div>
                <label>Naam speler</label>
                <input type="text" id="playerName" required />
              </div>
              <div>
                <label>E-mailadres</label>
                <input type="text" id="playerEmail" />
              </div>
              <div>
                <label>Telefoonnummer</label>
                <input type="text" id="playerPhone" />
              </div>
              <div>
                <label>Te maken caramboles (1e ronde)</label>
                <input
                  type="number"
                  id="playerCaramboles"
                  min="0"
                  max="999"
                  class="small"
                />
              </div>
              <div style="grid-column: 1/-1; text-align: right">
                <!-- zelfde look als sorteerknoppen -->
                <button
                  type="submit"
                  class="btn btn-secondary"
                  id="addPlayerBtn"
                  style="min-width: 190px"
                >
                  <span class="btn-icon" aria-hidden="true">‚ûï</span>
                  <span class="btn-label">Speler toevoegen</span>
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- BLOK 2: DEELNEMERSLIJST -->
        <div class="toernooi-block spelers-list-block">
          <div class="toernooi-block-header">
            <h3>Deelnemerslijst</h3>
          </div>
          <div class="toernooi-block-body">
            <div class="button-row">
              <button type="button" id="sortByName" class="btn btn-secondary">
                Sorteer op naam
              </button>
              <button
                type="button"
                id="sortByCaramboles"
                class="btn btn-secondary"
              >
                Sorteer op caramboles
              </button>
            </div>

            <div id="playerCount" class="player-count">
              Aantal deelnemers: 0
            </div>

            <div
              id="playersFinalizedNotice"
              class="players-finalized-notice"
              style="
                display: none;
                background: #ca3535;
                color: #fff;
                padding: 8px 12px;
                border-radius: 6px;
                margin-top: 10px;
                display: flex;
                align-items: center;
                gap: 8px;
              "
            >
              <span aria-hidden="true">üîí</span>
              <div>
                <strong>De spelerslijst is definitief.</strong>
                <div style="font-size: 0.85rem">
                  Alleen contactgegevens (e-mail en telefoon) zijn nog
                  aanpasbaar.
                </div>
              </div>
            </div>

            <div
              id="playersTableContainer"
              style="position: relative; margin-top: 10px"
            >
              <table id="playersTable" class="player-table">
                <thead>
                  <tr>
                    <th>Naam</th>
                    <th>E-mail</th>
                    <th>Telefoon</th>
                    <th>Caramboles</th>
                    <th style="width: 120px; text-align: center">Acties</th>
                  </tr>
                </thead>
                <tbody id="playerTableBody">
                  <!-- Rijen worden dynamisch gevuld -->
                </tbody>
              </table>

              <div
                id="playersLockOverlay"
                style="
                  position: absolute;
                  inset: 0;
                  background: rgba(255, 255, 255, 0.8);
                  display: none;
                  align-items: center;
                  justify-content: center;
                  pointer-events: none;
                "
              >
                <div
                  style="
                    background: rgba(0, 0, 0, 0.65);
                    color: #fff;
                    padding: 10px 14px;
                    border-radius: 8px;
                    font-size: 0.9rem;
                  "
                >
                  üîí De spelerslijst is definitief. Naam en caramboles zijn niet
                  meer te wijzigen.
                </div>
              </div>
            </div>

            <div class="button-row" style="margin-top: 15px">
              <button
                type="button"
                id="finalizePlayers"
                class="btn btn-secondary"
              >
                <span class="btn-icon" aria-hidden="true">üîí</span>
                <span class="btn-label">Lijst definitief maken</span>
              </button>
              <button type="button" id="editPlayers" class="btn btn-secondary">
                <span class="btn-icon" aria-hidden="true">‚úèÔ∏è</span>
                <span class="btn-label">Lijst bewerken</span>
              </button>
            </div>

            <div id="playerFeedback"></div>
          </div>
        </div>

        <!-- Bewerken-modal blijft gewoon werken -->
        <div id="editPlayerModal" class="modal">
          <div class="modal-content">
            <h3>Speler bewerken</h3>
            <form id="editPlayerForm" class="form-grid">
              <div>
                <label>Naam</label>
                <input type="text" id="editName" required />
              </div>
              <div>
                <label>E-mail</label>
                <input type="text" id="editEmail" />
              </div>
              <div>
                <label>Telefoon</label>
                <input type="text" id="editPhone" />
              </div>
              <div>
                <label>Caramboles</label>
                <input
                  type="number"
                  id="editCaramboles"
                  min="0"
                  max="999"
                  class="small"
                />
              </div>
              <div class="button-row modal-button-row">
                <button type="submit" class="btn btn-secondary">
                  <span class="btn-icon" aria-hidden="true">üíæ</span>
                  <span class="btn-label">Opslaan</span>
                </button>
                <button type="button" id="cancelEdit" class="btn btn-secondary">
                  <span class="btn-icon" aria-hidden="true">‚úñÔ∏è</span>
                  <span class="btn-label">Annuleren</span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <!-- ===== END TAB: SPELERS ===== -->

      <!-- ===== START TAB: 1E RONDE POULES ===== -->
      <div id="r1poules" class="tab-content">
        <h3>1e Ronde ‚Äì Poule-indeling</h3>

        <div id="noTournamentPoulesNotice" style="display: none">
          ‚ö†Ô∏è Geen toernooi geselecteerd. Selecteer eerst een toernooi om poules
          te beheren.
        </div>

        <div id="poulesIntro" style="margin-bottom: 15px">
          <p>
            Hier kun je de spelers van het toernooi indelen in poules. Elke
            poule heeft standaard 4 spelers (indien mogelijk). Klik op een
            speler links en vervolgens op de poule waarin je deze wilt plaatsen.
          </p>
        </div>

        <div id="poulesControls" class="button-row">
          <button type="button" id="createPoulesBtn" class="btn btn-save">
            ‚ûï Poules aanmaken
          </button>
          <button
            type="button"
            id="baseLayoutBtn"
            class="btn btn-save"
            title="Kies een standaardindeling (willekeurig, op sterkte, gelijkmatig, enz.)"
          >
            üß© Kies basisindeling
          </button>
          <button type="button" id="savePoulesBtn" class="btn btn-lock">
            üíæ Indeling opslaan
          </button>
          <button type="button" id="clearPoulesBtn" class="btn btn-delete">
            üóëÔ∏è Alles wissen
          </button>
        </div>

        <!-- ‚úÖ Info over verdeling -->
        <div
          id="poulesDistributionInfo"
          style="
            margin-top: 10px;
            font-weight: 600;
            color: #333;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px 12px;
            display: none;
          "
        ></div>

        <div
          id="poulesContent"
          style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 15px"
        >
          <!-- Linkerkant: beschikbare spelers -->
          <div style="flex: 1; min-width: 280px">
            <h4>Beschikbare spelers</h4>
            <div
              id="availablePlayers"
              class="list-box"
              style="
                border: 1px solid #ccc;
                border-radius: 8px;
                padding: 10px;
                min-height: 250px;
                background: #fafafa;
              "
            >
              <p style="color: #777">Nog geen spelers geladen.</p>
            </div>
          </div>
          <!-- Rechterkant: poules -->
          <div style="flex: 2; min-width: 400px">
            <h4>Huidige poules</h4>
            <div
              id="poulesContainer"
              style="
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
                gap: 15px;
              "
            >
              <!-- Poule-kaarten worden hier dynamisch toegevoegd -->
            </div>
          </div>
        </div>

        <div id="poulesFeedback" style="margin-top: 15px"></div>

        <!-- Nieuw: export naar Word -->
        <div
          id="poulesExportRow"
          class="button-row"
          style="margin-top: 12px; justify-content: flex-end"
        >
          <button
            type="button"
            id="exportPoulesWordBtn"
            class="btn btn-secondary"
            title="Poule-indeling van de 1e ronde opslaan als Word-bestand"
          >
            <span class="btn-icon" aria-hidden="true">‚¨áÔ∏è</span>
            <span class="btn-label">Poule-indeling opslaan (Word)</span>
          </button>
        </div>
      </div>
      <!-- ===== END TAB: 1E RONDE POULES ===== -->

      <!-- ===== END TAB: 1E RONDE POULES ===== -->

      <!-- ===== START TAB: 1E RONDE RESULTATEN ===== -->
      <div id="r1resultaten" class="tab-content">
        <h3>1e Ronde ‚Äì Wedstrijden & Resultaten</h3>

        <div id="noTournamentR1ResNotice" style="display: none">
          ‚ö†Ô∏è Geen toernooi geselecteerd. Selecteer eerst een toernooi om
          wedstrijden te beheren.
        </div>

        <!-- Overzicht scoringsregels -->
        <div
          id="r1ScoringOverview"
          style="
            margin-bottom: 15px;
            font-weight: 500;
            color: #333;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px 12px;
            display: none;
          "
        ></div>

        <!-- Actieknoppen -->
        <div class="button-row" style="margin-bottom: 15px">
          <button type="button" id="createMatchesBtn" class="btn btn-save">
            ‚ûï Wedstrijdschema aanmaken
          </button>
          <button type="button" id="deleteMatchesBtn" class="btn btn-delete">
            üóëÔ∏è Wedstrijden wissen
          </button>
        </div>

        <!-- Algemeen voortgang -->
        <div
          id="r1OverallProgress"
          style="
            margin-bottom: 15px;
            font-weight: 600;
            color: #333;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px 12px;
            display: none;
          "
        ></div>

        <!-- Poule-blokken -->
        <div
          id="r1matchesWrapper"
          style="display: flex; flex-direction: column; gap: 16px"
        ></div>

        <!-- Globale eindstand -->
        <div
          id="r1GlobalStandWrapper"
          style="
            margin-top: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 12px;
            background: #fff;
          "
        >
          <h4 style="margin-top: 0">Eindstand 1e ronde (alle poules)</h4>
          <div id="r1GlobalStandTable" style="overflow-x: auto"></div>
        </div>
      </div>
      <!-- ===== END TAB: 1E RONDE RESULTATEN ===== -->

      <!-- ===== BEGIN TAB: 2E RONDE POULES ===== -->
      <div id="r2poules" class="tab-content">
        <h3>2e Ronde ‚Äì Poule-indeling</h3>

        <div id="noTournamentR2PoulesNotice" style="display: none">
          ‚ö†Ô∏è Geen toernooi geselecteerd. Selecteer eerst een toernooi om poules
          te beheren.
        </div>

        <div id="r2poulesIntro" style="margin-bottom: 15px">
          <p>
            Links vind je de globale eindstand van de 1e ronde. Klik op een
            speler en vervolgens op een poule om deze toe te voegen.
          </p>
        </div>

        <div id="r2poulesControls" class="button-row">
          <button type="button" id="createR2PoulesBtn" class="btn btn-save">
            ‚ûï Poules aanmaken
          </button>
          <button
            type="button"
            id="r2BaseLayoutBtn"
            class="btn btn-save"
            title="Kies de standaardindeling (gelijkmatig, slingerend, op basis van ranglijst)"
          >
            üß© Kies basisindeling
          </button>
          <button type="button" id="saveR2PoulesBtn" class="btn btn-lock">
            üíæ Indeling opslaan
          </button>
          <button type="button" id="clearR2PoulesBtn" class="btn btn-delete">
            üóëÔ∏è Alles wissen
          </button>
          <button type="button" id="resetCarambolesR2Btn" class="btn btn-save">
            Update 2e ronde caramboles
          </button>
        </div>

        <div
          id="r2poulesDistributionInfo"
          style="
            margin-top: 10px;
            font-weight: 600;
            color: #333;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px 12px;
            display: none;
          "
        ></div>

        <div
          id="r2poulesContent"
          style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 15px"
        >
          <!-- Linkerkant: ranglijst 1e ronde -->
          <div style="flex: 1; min-width: 280px">
            <!-- ===== 2E RONDE POULES ‚Äì LINKERKANT: RANGLIJST 1E RONDE ===== -->
            <div style="flex: 1; min-width: 280px">
              <h4>Ranglijst 1e ronde</h4>
              <table
                id="r2RankTable"
                style="width: 100%; border-collapse: collapse; font-size: 0.9em"
              >
                <thead style="background: #f8f9fa">
                  <tr>
                    <th style="text-align: left; padding: 6px 4px">#</th>
                    <th
                      style="text-align: center; padding: 6px 4px; width: 32px"
                      title="Afgemeld"
                    >
                      <span style="color: #b02a37; font-weight: 700"
                        >&#10006;</span
                      >
                    </th>
                    <th style="text-align: left; padding: 6px 4px">Speler</th>
                    <th style="text-align: right; padding: 6px 4px">
                      1e&nbsp;ronde
                    </th>
                    <th style="text-align: right; padding: 6px 4px">
                      2e&nbsp;ronde
                    </th>
                  </tr>
                </thead>

                <tbody id="r2RankTableBody"></tbody>
              </table>
              <!-- Nieuwe knop onder de tabel -->
              <div style="margin-top: 8px">
                <button
                  type="button"
                  id="saveCarambolesR2Btn"
                  class="btn btn-save"
                >
                  üíæ Opslaan car. 2e ronde
                </button>
              </div>
            </div>
          </div>

          <!-- Rechterkant: poules -->
          <div style="flex: 2; min-width: 400px">
            <h4>Huidige poules</h4>
            <div
              id="r2PoulesContainer"
              style="
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
                gap: 15px;
              "
            >
              <!-- Poule-kaarten komen hier -->
            </div>
          </div>
        </div>

        <div id="r2poulesFeedback" style="margin-top: 15px"></div>
      </div>
      <!-- ===== END TAB: 2E RONDE POULES ===== -->

      <!-- ===== BEGIN TAB: 2E RONDE RESULTATEN ===== -->
      <div id="r2resultaten" class="tab-content">
        <h3>2e Ronde ‚Äì Wedstrijden & Resultaten</h3>

        <div id="noTournamentR2ResNotice" style="display: none">
          ‚ö†Ô∏è Geen toernooi geselecteerd. Selecteer eerst een toernooi om
          wedstrijden te beheren.
        </div>

        <!-- Overzicht scoringsregels -->
        <div
          id="r2ScoringOverview"
          style="
            margin-bottom: 15px;
            font-weight: 500;
            color: #333;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px 12px;
            display: none;
          "
        ></div>

        <!-- Actieknoppen -->
        <div class="button-row" style="margin-bottom: 15px">
          <button type="button" id="createR2MatchesBtn" class="btn btn-save">
            ‚ûï Wedstrijdschema aanmaken
          </button>
          <button type="button" id="deleteR2MatchesBtn" class="btn btn-delete">
            üóëÔ∏è Wedstrijden wissen
          </button>
        </div>

        <!-- Algemeen voortgang -->
        <div
          id="r2OverallProgress"
          style="
            margin-bottom: 15px;
            font-weight: 600;
            color: #333;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px 12px;
            display: none;
          "
        ></div>

        <!-- Poule-blokken -->
        <div
          id="r2matchesWrapper"
          style="display: flex; flex-direction: column; gap: 16px"
        ></div>

        <!-- Globale eindstand -->
        <div
          style="
            margin-top: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 12px;
            background: #fff;
          "
        >
          <h4 style="margin-top: 0">Eindstand 2e ronde (alle poules)</h4>
          <div id="r2GlobalStandTable" style="overflow-x: auto"></div>
        </div>
      </div>
      <!-- ===== END TAB: 2E RONDE RESULTATEN ===== -->

      <!-- ===== START TAB: ANDERE PLACEHOLDERS ===== -->

      <!-- Tab 6: Finale -->
      <div id="finale" class="tab-content">
        <h3>Finale</h3>

        <div
          id="finaleNoTournament"
          style="
            display: none;
            padding: 10px 12px;
            background: #fff3cd;
            border: 1px solid #ffe69c;
            border-radius: 6px;
            color: #856404;
            margin-bottom: 15px;
          "
        >
          Geen toernooi geselecteerd. Kies eerst een toernooi op het tabblad
          <strong>Toernooi</strong>.
        </div>

        <div id="finaleContent" style="display: none">
          <!-- NIEUW: stap 0 ‚Äì aantal finalisten vastleggen -->
          <div
            style="
              border: 1px solid #ddd;
              border-radius: 8px;
              padding: 10px;
              margin-bottom: 12px;
              background: #fff;
            "
          >
            <h3 style="margin-top: 0; font-size: 1.05rem">
              Aantal deelnemers finale
            </h3>
            <p style="margin: 0 0 8px 0; font-size: 0.9rem; color: #555">
              Leg hier vast met hoeveel spelers de finale wordt gespeeld. Dit
              bepaalt hoeveel spelers boven de streep als finalist worden
              aangemerkt. Bij afmelding schuift de eerstvolgende speler door.
            </p>
            <div
              style="
                display: flex;
                align-items: center;
                gap: 8px;
                flex-wrap: wrap;
              "
            >
              <label for="finaleAantalInput" style="font-weight: 600"
                >Aantal finalisten:</label
              >
              <input
                type="number"
                id="finaleAantalInput"
                min="1"
                max="32"
                value="8"
                style="width: 80px; padding: 4px"
              />
              <button
                id="finaleSaveCountBtn"
                type="button"
                style="
                  padding: 6px 10px;
                  border-radius: 4px;
                  border: 1px solid var(--kleur-accent1, #8d0c00);
                  background: var(--kleur-accent1, #8d0c00);
                  color: #fff;
                  cursor: pointer;
                "
              >
                üíæ Vastleggen aantal finalisten
              </button>
            </div>
          </div>

          <!-- Kaart 1: finalisten + caramboles -->
          <div
            style="
              border: 1px solid #dee2e6;
              border-radius: 10px;
              padding: 12px 14px;
              margin-bottom: 18px;
              background: #f8f9fa;
            "
          >
            <h4 style="margin-top: 0; margin-bottom: 6px">
              Finalisten en caramboles
            </h4>
            <p
              style="
                margin-top: 0;
                margin-bottom: 10px;
                font-size: 0.9em;
                color: #555;
              "
            >
              De acht hoogst geplaatste spelers uit de
              <strong>totaalstand van de 2e ronde</strong> plaatsen zich
              automatisch voor de finale. Hier kun je het aantal te maken
              caramboles in de finale aanpassen en aangeven of een speler zich
              heeft afgemeld.
            </p>

            <div style="overflow-x: auto">
              <table
                style="
                  width: 100%;
                  border-collapse: collapse;
                  font-size: 0.9em;
                  background: #fff;
                "
              >
                <thead style="background: #f1f3f5">
                  <tr>
                    <th
                      style="
                        text-align: left;
                        padding: 6px 4px;
                        border-bottom: 1px solid #dee2e6;
                        width: 40px;
                      "
                    >
                      R2
                    </th>
                    <th
                      style="
                        text-align: center;
                        padding: 6px 4px;
                        border-bottom: 1px solid #dee2e6;
                        width: 40px;
                      "
                      title="Afgemeld"
                    >
                      ‚ùå
                    </th>
                    <th
                      style="
                        text-align: left;
                        padding: 6px 4px;
                        border-bottom: 1px solid #dee2e6;
                      "
                    >
                      Speler
                    </th>
                    <th
                      style="
                        text-align: right;
                        padding: 6px 4px;
                        border-bottom: 1px solid #dee2e6;
                        width: 80px;
                      "
                    >
                      Car. 2e&nbsp;ronde
                    </th>
                    <th
                      style="
                        text-align: right;
                        padding: 6px 4px;
                        border-bottom: 1px solid #dee2e6;
                        width: 90px;
                      "
                    >
                      Car. finale
                    </th>
                  </tr>
                </thead>
                <tbody id="finalePlayersBody"></tbody>
              </table>
            </div>

            <div class="button-row" style="margin-top: 8px; gap: 8px">
              <button
                type="button"
                id="finaleSaveCarambolesBtn"
                class="btn btn-save"
              >
                üíæ Opslaan car. finale
              </button>
            </div>

            <div
              id="finaleFeedback"
              style="margin-top: 8px; font-size: 0.9em; min-height: 18px"
            ></div>
          </div>

          <!-- Kaart 2: eindstand finale -->
          <div
            style="
              border: 1px solid #dee2e6;
              border-radius: 10px;
              padding: 12px 14px;
              background: #f8f9fa;
            "
          >
            <h4 style="margin-top: 0; margin-bottom: 6px">Eindstand finale</h4>
            <p
              style="
                margin-top: 0;
                margin-bottom: 10px;
                font-size: 0.9em;
                color: #555;
              "
            >
              De wedstrijden van de finale worden in een ander programma
              bijgehouden. Vul hier de
              <strong>definitieve eindstand</strong> in. De eindstand wordt
              getoond op basis van de ingevulde <strong>positie</strong>.
            </p>

            <div style="overflow-x: auto">
              <table
                style="
                  width: 100%;
                  border-collapse: collapse;
                  font-size: 0.9em;
                  background: #fff;
                "
              >
                <thead style="background: #f1f3f5">
                  <tr>
                    <th
                      style="
                        text-align: right;
                        padding: 6px 4px;
                        border-bottom: 1px solid #dee2e6;
                        width: 55px;
                      "
                    >
                      Pos.
                    </th>
                    <th
                      style="
                        text-align: left;
                        padding: 6px 4px;
                        border-bottom: 1px solid #dee2e6;
                      "
                    >
                      Speler
                    </th>
                    <th
                      style="
                        text-align: right;
                        padding: 6px 4px;
                        border-bottom: 1px solid #dee2e6;
                        width: 80px;
                      "
                    >
                      Car. finale
                    </th>
                    <th
                      style="
                        text-align: right;
                        padding: 6px 4px;
                        border-bottom: 1px solid #dee2e6;
                        width: 40px;
                      "
                    >
                      Gesp.
                    </th>
                    <th
                      style="
                        text-align: right;
                        padding: 6px 4px;
                        border-bottom: 1px solid #dee2e6;
                        width: 40px;
                      "
                    >
                      Pnt.
                    </th>
                    <th
                      style="
                        text-align: right;
                        padding: 6px 4px;
                        border-bottom: 1px solid #dee2e6;
                        width: 50px;
                      "
                    >
                      Car.
                    </th>
                    <th
                      style="
                        text-align: right;
                        padding: 6px 4px;
                        border-bottom: 1px solid #dee2e6;
                        width: 50px;
                      "
                    >
                      HS
                    </th>
                    <th
                      style="
                        text-align: right;
                        padding: 6px 4px;
                        border-bottom: 1px solid #dee2e6;
                        width: 40px;
                      "
                    >
                      Beurten
                    </th>
                    <th
                      style="
                        text-align: right;
                        padding: 6px 4px;
                        border-bottom: 1px solid #dee2e6;
                        width: 50px;
                      "
                    >
                      Moy.
                    </th>
                    <th
                      style="
                        text-align: right;
                        padding: 6px 4px;
                        border-bottom: 1px solid #dee2e6;
                        width: 50px;
                      "
                    >
                      Moy&nbsp;%
                    </th>
                    <th
                      style="
                        text-align: right;
                        padding: 6px 4px;
                        border-bottom: 1px solid #dee2e6;
                        width: 50px;
                      "
                    >
                      Car&nbsp;%
                    </th>
                  </tr>
                </thead>
                <tbody id="finaleResultsBody"></tbody>
              </table>
            </div>

            <div class="button-row" style="margin-top: 8px; gap: 8px">
              <button
                type="button"
                id="finaleSaveResultsBtn"
                class="btn btn-save"
              >
                üíæ Eindstand opslaan
              </button>
              <button type="button" id="finaleClearBtn" class="btn btn-delete">
                üóëÔ∏è Alles wissen
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== END TAB: ANDERE PLACEHOLDERS ===== -->

      <!-- ===== START TAB: ADMIN ===== -->
      <div id="admin" class="tab-content">
        <h3>Gebruikersbeheer</h3>

        <form id="userForm" class="form-grid" style="margin-bottom: 10px">
          <div>
            <label>Gebruikersnaam (login) *</label>
            <input type="text" id="uUsername" required />
          </div>
          <div>
            <label>Weergavenaam *</label>
            <input type="text" id="uDisplay" required />
          </div>
          <div>
            <label>Wachtwoord *</label>
            <input type="password" id="uPassword" required />
          </div>
          <div>
            <label>Rol</label>
            <select id="uRole">
              <option value="user">Gebruiker</option>
              <option value="admin">Admin</option>
            </select>
          </div>

          <div style="grid-column: 1/-1; text-align: right">
            <button class="btn btn-save" type="submit">
              ‚ûï Gebruiker opslaan
            </button>
          </div>
        </form>

        <div id="usersTableWrap"></div>

        <hr style="margin: 18px 0" />

        <h3>Toernooien koppelen aan gebruiker</h3>
        <div class="form-grid">
          <div>
            <label>Kies gebruiker</label>
            <select id="linkUserSelect"></select>
          </div>
          <div>
            <label>Kies toernooien</label>
            <div
              id="linkTournamentsList"
              style="
                border: 1px solid #ccc;
                border-radius: 6px;
                padding: 8px;
                max-height: 220px;
                overflow: auto;
              "
            >
              <em>laden...</em>
            </div>
          </div>
        </div>
        <div class="button-row">
          <button type="button" id="saveLinksBtn" class="btn btn-save">
            üíæ Koppelingen opslaan
          </button>
        </div>

        <div id="adminFeedback"></div>
      </div>
    </div>
    <!-- ===== END TAB: ADMIN ===== -->

    <script type="module">
      /* Firebase imports */
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        getDocs,
        deleteDoc,
        collection,
        addDoc,
        writeBatch,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

      /* Firebase config */
      const firebaseConfig = {
        apiKey: "AIzaSyAsg63E-lGgECsCxIfRJTFcTWB7LEGWNGc",
        authDomain: "bcr-toernooi.firebaseapp.com",
        projectId: "bcr-toernooi",
        storageBucket: "bcr-toernooi.firebasestorage.app",
        messagingSenderId: "856805712309",
        appId: "1:856805712309:web:8adb4158d825630ce079fc",
        measurementId: "G-ELH9TVY15L",
      };

      /* Init Firestore */
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      /* =========================================================
         LOGIN FLOW
      ========================================================= */
      const loginOverlay = document.getElementById("loginOverlay");
      const loginForm = document.getElementById("loginForm");
      const loginMsg = document.getElementById("loginMsg");

      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        loginMsg.textContent = "";

        const username = document.getElementById("loginUsername").value.trim();
        const password = document.getElementById("loginPassword").value;

        try {
          // user zoeken op username
          const usersSnap = await getDocs(collection(db, "users"));
          const match = usersSnap.docs
            .map((d) => ({ id: d.id, ...d.data() }))
            .find(
              (u) => (u.username || "").toLowerCase() === username.toLowerCase()
            );

          if (!match) {
            loginMsg.textContent = "Onbekende gebruiker.";
            return;
          }

          if (password !== match.password) {
            loginMsg.textContent = "Wachtwoord onjuist.";
            return;
          }

          currentUser = match;
          isAdmin = match.role === "admin";
          loginOverlay.style.display = "none";

          applyPermissions();
          await loadTournamentList(); // toernooilijst verversen
          await loadMoyCarTables(); // beschikbare moyenne‚Üícaramboles-tabellen laden
        } catch (err) {
          console.error(err);
          loginMsg.textContent = "Inloggen mislukt.";
        }
      });

      // overlay blijft staan tot login gelukt is

      /* =========================================================
                                                       GLOBALE STATE VOOR ACTIEF TOERNOOI
                                                       ========================================================= */
      let activeTournamentId = null; // bv. "OpenKampioenschap_2025"
      const pouleOpenState = {}; // 1e ronde: poule-naam ‚Üí boolean
      const pouleOpenStateR2 = {}; // 2e ronde: poule-naam ‚Üí boolean
      let playersFinalized = false; // of de spelerslijst op slot staat
      let moyCarTablesCache = []; // alle beschikbare moyenne‚Üícaramboles-tabellen

      // ‚úÖ TOEVOEGEN: Status of er al poules zijn aangemaakt in ronde 1
      let r1PoulesExist = false;

      /* =========================================================
         SIMPELE LOGIN / AUTH STATE
      ========================================================= */
      let currentUser = null; // {id, username, role, tournaments, displayName}
      let isAdmin = false;

      /* =========================================================
                                                       GEMEENSCHAPPELIJKE UI HELPERS
                                                       ========================================================= */
      function showConnectionBanner() {
        const host = document.getElementById("bcr-toernooi-app");
        if (!host) return;

        const header = host.querySelector("header");
        if (!header) return;

        const statusDiv = document.createElement("div");
        statusDiv.className = "connection-status";
        statusDiv.innerHTML = "‚úì Firestore";
        header.appendChild(statusDiv);
      }

      function showFeedback(msg, type = "info") {
        const fb = document.getElementById("feedback");
        const color =
          type === "error"
            ? "#f8d7da"
            : type === "success"
            ? "#d1e7dd"
            : "#e2e3e5";
        const textColor =
          type === "error"
            ? "#842029"
            : type === "success"
            ? "#0f5132"
            : "#41464b";
        fb.innerHTML = `
                                                        <div class="message" style="background:${color};color:${textColor};">
                                                          ${msg}
                                                          <span class="close" onclick="this.parentElement.remove()">√ó</span>
                                                        </div>
                                                      `;
        fb.scrollIntoView({ behavior: "smooth" });
      }

      function showPlayerFeedback(msg, type = "info") {
        const pf = document.getElementById("playerFeedback");
        const color =
          type === "error"
            ? "#f8d7da"
            : type === "success"
            ? "#d1e7dd"
            : "#e2e3e5";
        const textColor =
          type === "error"
            ? "#842029"
            : type === "success"
            ? "#0f5132"
            : "#41464b";
        pf.innerHTML = `
                                                        <div class="message" style="background:${color};color:${textColor};">
                                                          ${msg}
                                                          <span class="close" onclick="this.parentElement.remove()">√ó</span>
                                                        </div>
                                                      `;
        pf.scrollIntoView({ behavior: "smooth" });
      }

      // =========================================================
      //  TABEL MOYENNE ‚Üí CARAMBOLES (moyCarTables)
      // =========================================================

      async function loadMoyCarTables() {
        try {
          const snap = await getDocs(collection(db, "moyCarTables"));
          moyCarTablesCache = snap.docs.map((d) => ({
            id: d.id,
            ...d.data(),
          }));
          populateMoyCarTableSelect();
        } catch (err) {
          console.error("Fout bij laden moyCarTables:", err);
          const status = document.getElementById("moyCarTableStatus");
          if (status) {
            status.textContent = "Kon tabellen niet laden.";
            status.style.color = "#842029";
          }
        }
      }

      function populateMoyCarTableSelect(selectedId = null) {
        const sel = document.getElementById("moyCarTableSelect");
        if (!sel) return;

        sel.innerHTML = '<option value="">Geen tabel gekoppeld</option>';

        moyCarTablesCache.forEach((t) => {
          const opt = document.createElement("option");
          opt.value = t.id;
          opt.textContent = t.name || t.naam || t.id;
          sel.appendChild(opt);
        });

        if (selectedId) {
          sel.value = selectedId;
        }
      }

      function parseMoyCarCSV(text) {
        const lines = text
          .split(/\r?\n/)
          .map((l) => l.trim())
          .filter((l) => l.length > 0);

        if (!lines.length) {
          throw new Error("Bestand is leeg.");
        }

        const headerLine = lines[0].toLowerCase();
        const delimiter = headerLine.includes(";") ? ";" : ",";
        const headers = headerLine.split(delimiter).map((h) => h.trim());

        const idxVan = headers.indexOf("van");
        const idxTot = headers.indexOf("tot");
        const idxCar = headers.indexOf("car");

        if (idxVan === -1 || idxTot === -1 || idxCar === -1) {
          throw new Error(
            "Kopregel moet kolommen 'van', 'tot' en 'car' bevatten (CSV)."
          );
        }

        const rows = [];

        for (let i = 1; i < lines.length; i++) {
          const parts = lines[i].split(delimiter).map((p) => p.trim());
          if (parts.length < 3) continue;

          const van = Number(parts[idxVan].replace(",", "."));
          const tot = Number(parts[idxTot].replace(",", "."));
          const car = Number(parts[idxCar]);

          if (
            !Number.isFinite(van) ||
            !Number.isFinite(tot) ||
            !Number.isFinite(car)
          )
            continue;

          rows.push({ van, tot, car });
        }

        if (!rows.length) {
          throw new Error("Geen geldige regels gevonden in het CSV-bestand.");
        }

        return rows;
      }

      async function handleMoyCarUpload() {
        const nameInput = document.getElementById("moyCarTableName");
        const fileInput = document.getElementById("moyCarFileInput");
        const status = document.getElementById("moyCarTableStatus");

        if (!fileInput || !fileInput.files || !fileInput.files.length) {
          if (status) {
            status.textContent = "Kies eerst een CSV-bestand.";
            status.style.color = "#842029";
          }
          return;
        }

        const file = fileInput.files[0];
        const name =
          (nameInput ? nameInput.value.trim() : "") ||
          file.name.replace(/\.[^.]+$/, "");

        try {
          const text = await file.text();
          const rows = parseMoyCarCSV(text);

          const colRef = collection(db, "moyCarTables");
          const docRef = await addDoc(colRef, {
            name,
            rows,
            createdAt: new Date().toISOString(),
          });

          if (status) {
            status.textContent = `Tabel "${name}" ge√ºpload en opgeslagen.`;
            status.style.color = "#0f5132";
          }

          // formulier resetten
          fileInput.value = "";
          if (nameInput) nameInput.value = "";

          // lijst opnieuw laden en direct selecteren
          await loadMoyCarTables();
          const sel = document.getElementById("moyCarTableSelect");
          if (sel) sel.value = docRef.id;
        } catch (err) {
          console.error("Fout bij uploaden moyCarTable:", err);
          if (status) {
            status.textContent = `Fout bij uploaden: ${err.message}`;
            status.style.color = "#842029";
          }
        }
      }

      function showLinkedMoyCarTable() {
        const sel = document.getElementById("moyCarTableSelect");
        const status = document.getElementById("moyCarTableStatus");

        if (!sel) return;

        const tableId = sel.value;
        if (!tableId) {
          alert("Er is nog geen moyennetabel geselecteerd of gekoppeld.");
          return;
        }

        // Gebruik de cache die door loadMoyCarTables() gevuld wordt
        if (
          !Array.isArray(moyCarTablesCache) ||
          moyCarTablesCache.length === 0
        ) {
          alert(
            "Er zijn (nog) geen moyennetabellen geladen.\n" +
              "Log opnieuw in of ververs de pagina."
          );
          return;
        }

        const table = moyCarTablesCache.find((t) => t.id === tableId);
        if (!table) {
          alert(
            "De gekoppelde moyennetabel kon niet worden gevonden.\n" +
              "Mogelijk is deze verwijderd."
          );
          return;
        }

        const name = table.name || table.naam || table.id;
        const rows = Array.isArray(table.rows) ? table.rows : [];

        if (rows.length === 0) {
          alert(`Tabel "${name}" bevat geen regels.`);
          return;
        }

        // We gaan er van uit dat rows zoiets zijn als: { van, tot, car } of { min, max, caramboles }
        const lines = [];
        lines.push(`Tabel: ${name}`);
        lines.push("");
        lines.push("Van moy. ; Tot moy. ; Te maken caramboles");

        rows.forEach((r) => {
          const min = r.van ?? r.min ?? r.from ?? r.minMoy ?? r.fromMoy ?? "";
          const max = r.tot ?? r.max ?? r.to ?? r.maxMoy ?? r.toMoy ?? "";
          const car = r.car ?? r.caramboles ?? r.teMaken ?? r.caram ?? "";

          lines.push(`${min} ; ${max} ; ${car}`);
        });

        alert(lines.join("\n"));

        if (status) {
          status.textContent = `Tabel "${name}" getoond.`;
          status.style.color = "#0f5132";
        }
      }

      async function linkMoyCarTableToTournament() {
        if (!activeTournamentId) {
          alert("‚ö†Ô∏è Er is geen actief toernooi geselecteerd.");
          return;
        }

        const sel = document.getElementById("moyCarTableSelect");
        if (!sel) return;

        const tableId = sel.value || null;

        try {
          await updateDoc(doc(db, "toernooien", activeTournamentId), {
            moyCarTableId: tableId,
          });

          const statusEl = document.getElementById("moyCarTableStatus");
          if (statusEl) {
            if (tableId) {
              const label = sel.options[sel.selectedIndex]?.text || "";
              statusEl.textContent = `Gekoppeld aan: ${label}`;
            } else {
              statusEl.textContent = "Geen tabel gekoppeld.";
            }
          }

          alert("‚úÖ Moyenne‚Üícaramboles-tabel is gekoppeld aan dit toernooi.");
        } catch (err) {
          console.error("Fout bij koppelen moyCarTableId:", err);
          alert(
            "‚ùå Koppelen van de moyennetabel is mislukt. Probeer het opnieuw."
          );
        }
      }
      /*
            // Hulp: welke moy‚Üícar-tabel is nu gekoppeld aan het actieve toernooi?
            function getActiveMoyCarTable() {
              const select = document.getElementById("moyCarTableSelect");
              if (!select) return null;
              const id = select.value;
              if (!id) return null;
              if (!Array.isArray(moyCarTablesCache)) return null;
              const table = moyCarTablesCache.find((t) => t.id === id);
              if (!table || !Array.isArray(table.rows)) return null;
              return table;
            }
      */
      /*
            // Hulp: zoek in de tabel het aantal caramboles bij een gegeven moyenne
            function lookupCarambolesFromMoy(moy, table) {
              if (!table || !Array.isArray(table.rows)) return null;
              const val = Number(moy);
              if (!Number.isFinite(val)) return null;

              const rows = table.rows;

              for (let i = 0; i < rows.length; i++) {
                const r = rows[i];
                if (
                  typeof r.van !== "number" ||
                  typeof r.tot !== "number" ||
                  typeof r.car !== "number"
                ) {
                  continue;
                }

                const isLast = i === rows.length - 1;
                const lowerOk = val >= r.van;
                const upperOk = isLast ? val <= r.tot : val < r.tot;

                if (lowerOk && upperOk) {
                  return r.car;
                }
              }
              // geen passende rij gevonden
              return null;
            }
      */
      // Hulp: haal de actieve moy‚Üícar-tabel op die aan het toernooi is gekoppeld
      function getActiveMoyCarTable() {
        const sel = document.getElementById("moyCarTableSelect");
        if (!sel) return null;

        const tableId = sel.value;
        if (!tableId) return null;

        if (
          !Array.isArray(moyCarTablesCache) ||
          moyCarTablesCache.length === 0
        ) {
          return null;
        }

        const table = moyCarTablesCache.find((t) => t.id === tableId);
        if (!table || !Array.isArray(table.rows)) return null;
        return table;
      }

      // Hulp: zoek in de moy‚Üícar-tabel het aantal caramboles bij een gegeven moyenne
      function lookupCarambolesFromMoy(moy, table) {
        if (!table || !Array.isArray(table.rows)) return null;
        const val = Number(moy);
        if (!Number.isFinite(val)) return null;

        const rows = table.rows;

        for (let i = 0; i < rows.length; i++) {
          const r = rows[i];
          const van = Number(r.van);
          const tot = Number(r.tot);
          const car = Number(r.car);

          if (
            !Number.isFinite(van) ||
            !Number.isFinite(tot) ||
            !Number.isFinite(car)
          ) {
            continue;
          }

          const isLast = i === rows.length - 1;
          const lowerOk = val >= van;
          const upperOk = isLast ? val <= tot : val < tot;

          if (lowerOk && upperOk) {
            return car;
          }
        }

        // geen passende rij gevonden
        return null;
      }

      function updateActiveTournament(name, year) {
        const banner = document.getElementById("activeTournamentBanner");
        if (!banner) return;

        if (name && year) {
          banner.textContent = `Actief toernooi: ${name} (${year})`;
          banner.classList.remove("no-tournament");
          banner.classList.add("has-tournament");
        } else {
          banner.textContent = "Geen toernooi geselecteerd";
          banner.classList.remove("has-tournament");
          banner.classList.add("no-tournament");
        }
      }

      function applyPermissions() {
        // admin tab show/hide
        const adminBtn = document.getElementById("adminTabBtn");
        if (adminBtn) adminBtn.style.display = isAdmin ? "block" : "none";

        // Toernooi-tab: users mogen NIET opslaan/verwijderen en velden read-only
        const saveBtn = document.getElementById("saveBtn");
        const deleteBtn = document.getElementById("deleteBtn");
        const tournamentForm = document.getElementById("tournamentForm");

        if (!isAdmin) {
          // 1) knoppen verbergen i.p.v. alleen disablen
          if (saveBtn) {
            saveBtn.disabled = true;
            saveBtn.style.display = "none";
          }
          if (deleteBtn) {
            deleteBtn.disabled = true;
            deleteBtn.style.display = "none";
          }

          if (tournamentForm) {
            tournamentForm
              .querySelectorAll("input, select, textarea")
              .forEach((el) => {
                if (el.id === "loadBtn") return;
                el.disabled = true;
                el.style.backgroundColor = "#f0f0f0";
              });
          }
        } else {
          if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.style.display = "";
          }
          if (deleteBtn) {
            deleteBtn.disabled = false;
            deleteBtn.style.display = "";
          }

          if (tournamentForm) {
            tournamentForm
              .querySelectorAll("input, select, textarea")
              .forEach((el) => {
                el.disabled = false;
                el.style.backgroundColor = "";
              });
          }
        }

        // Admin tab data laden indien admin
        if (isAdmin) {
          loadUsersAdminTab();
          loadTournamentsForLinking();
        }
      }

      /* =========================================================
                                                       TABS
                                                       ========================================================= */
      document
        .querySelectorAll("#bcr-toernooi-app .tab-buttons button")
        .forEach((btn) => {
          btn.addEventListener("click", () => {
            document
              .querySelectorAll("#bcr-toernooi-app .tab-buttons button")
              .forEach((b) => b.classList.remove("active"));
            document
              .querySelectorAll("#bcr-toernooi-app .tab-content")
              .forEach((tc) => tc.classList.remove("active"));
            btn.classList.add("active");
            const pane = document.getElementById(btn.dataset.tab);
            pane.classList.add("active");

            // Speciale regel: als je naar "spelers" gaat -> check of er een toernooi actief is
            if (btn.dataset.tab === "spelers") {
              if (activeTournamentId) {
                // eerst de echte status uit Firestore halen
                loadPlayersFromFirestore().then(() => {
                  guardSpelersTabAvailability(); // daarna knoppen goed zetten
                });
              } else {
                guardSpelersTabAvailability();
              }
            }

            // Speciale regel: als je naar "1e ronde poules" gaat -> poules + knoppen verversen
            if (btn.dataset.tab === "r1poules") {
              if (typeof loadPoulesForActiveTournament === "function") {
                // haalt poules_r1 van het huidige toernooi op, vult currentPoules,
                // rendert opnieuw √©n roept zelf updateR1PoulesButtons() aan
                loadPoulesForActiveTournament();
              }
            }

            // Speciale regel: als je naar "finale" gaat -> finale-tab laden
            if (btn.dataset.tab === "finale") {
              if (typeof loadFinaleTab === "function") {
                loadFinaleTab();
              }
            }
          });
        });

      async function hasAnyPoulesOrMatchesForActiveTournament() {
        if (!activeTournamentId) return false;

        const basePath = ["toernooien", activeTournamentId];

        const checks = [
          ["poules_r1"],
          ["r1_wedstrijden"],
          ["poules_r2"],
          ["r2_wedstrijden"],
        ];

        for (const sub of checks) {
          const colRef = collection(db, ...basePath, ...sub);
          const snap = await getDocs(colRef);
          if (!snap.empty) return true;
        }

        return false;
      }

      async function clearAllPoulesAndMatchesForActiveTournament() {
        if (!activeTournamentId) return;

        const basePath = ["toernooien", activeTournamentId];

        const paths = [
          ["poules_r1"],
          ["r1_wedstrijden"],
          ["poules_r2"],
          ["r2_wedstrijden"],
        ];

        for (const sub of paths) {
          const colRef = collection(db, ...basePath, ...sub);
          const snap = await getDocs(colRef);
          if (snap.empty) continue;

          const batch = writeBatch(db);
          snap.forEach((d) => batch.delete(d.ref));
          await batch.commit();
        }

        // Lokale caches ook leegmaken
        if (typeof currentPoules !== "undefined") currentPoules = [];
        if (typeof r1Matches !== "undefined") r1Matches = [];
        if (typeof r1PoulesCache !== "undefined") r1PoulesCache = [];
        if (typeof r2CurrentPoules !== "undefined") r2CurrentPoules = [];
        if (typeof r2AllPlayers !== "undefined") r2AllPlayers = [];
        if (typeof r2AvailablePlayers !== "undefined") r2AvailablePlayers = [];
        if (typeof r2PoulesDirty !== "undefined") r2PoulesDirty = false;

        // UI opruimen waar mogelijk
        if (typeof renderPoules === "function") renderPoules();
        if (typeof renderAvailablePlayers === "function")
          renderAvailablePlayers();
        if (typeof renderR1Matches === "function") renderR1Matches();
        if (typeof renderR2Poules === "function") renderR2Poules();
        if (typeof renderR2AvailablePlayers === "function")
          renderR2AvailablePlayers();
      }

      /* =========================================================
                                                       FUNCTIES TAB TOERNOOI
                                                       ========================================================= */
      /* Publicatie-status helper */
      const publishedCheckbox = document.getElementById("tournamentPublished");
      const publishedBadge = document.getElementById(
        "tournamentPublishedBadge"
      );

      function updatePublishedBadge(checked) {
        if (!publishedBadge) return;
        if (checked) {
          publishedBadge.textContent = "Gepubliceerd";
          publishedBadge.style.backgroundColor = "#d1e7dd";
          publishedBadge.style.color = "#0f5132";
        } else {
          publishedBadge.textContent = "Niet gepubliceerd";
          publishedBadge.style.backgroundColor = "#f8d7da";
          publishedBadge.style.color = "#842029";
        }
      }

      if (publishedCheckbox) {
        publishedCheckbox.addEventListener("change", () => {
          updatePublishedBadge(publishedCheckbox.checked);
        });
        // default initialisatie
        updatePublishedBadge(publishedCheckbox.checked);
      }

      // Checkbox 'Niet van toepassing'
      const noMax = document.getElementById("noMaxTurns");
      const maxInputs = [
        "pointsWinMax",
        "pointsDrawMax",
        "pointsLoseMax",
        "maxTurns",
      ].map((id) => document.getElementById(id));

      noMax.addEventListener("change", () => {
        const disabled = noMax.checked;
        maxInputs.forEach((i) => {
          i.disabled = disabled;
          i.style.backgroundColor = disabled ? "#eee" : "";
        });
      });

      // Numerieke validatie
      document
        .querySelectorAll('#bcr-toernooi-app input[type="number"]')
        .forEach((inp) => {
          inp.addEventListener("blur", () => {
            const id = inp.id;
            const val = parseInt(inp.value);
            if (id === "tournamentYear") {
              if (!val) return;
              if (val > 2099) inp.value = 2099;
              if (val < 1900) inp.value = 1900;
            } else if (id === "playerCaramboles") {
              if (!val && val !== 0) return;
              if (val > 999) inp.value = 999;
              if (val < 0) inp.value = 0;
            } else {
              if (!val && val !== 0) return;
              if (val > 999) inp.value = 999;
              if (val < 0) inp.value = 0;
            }
          });
          if (inp.id !== "tournamentYear") {
            inp.addEventListener("input", () => {
              if (inp.value.length > 3) inp.value = inp.value.slice(0, 3);
            });
          }
        });

      // Opslaan / bijwerken van een toernooi
      async function saveTournament() {
        const naam = document.getElementById("tournamentName").value.trim();
        const jaar = document.getElementById("tournamentYear").value.trim();

        if (!naam || !jaar) {
          showFeedback("‚ùå Naam en jaar zijn verplicht.", "error");
          return;
        }

        const maxTurnsRaw = document.getElementById("maxTurns").value;
        const maxBeurten =
          maxTurnsRaw === "" || maxTurnsRaw == null
            ? null
            : Number(maxTurnsRaw);

        const data = {
          naam,
          jaar,
          organisatie: document.getElementById("tournamentOrg").value.trim(),
          maxBeurten,
          punten: {
            winLess: document.getElementById("pointsWinLess").value || 0,
            drawLess: document.getElementById("pointsDrawLess").value || 0,
            loseLess: document.getElementById("pointsLoseLess").value || 0,
            winMax: document.getElementById("pointsWinMax").value || 0,
            drawMax: document.getElementById("pointsDrawMax").value || 0,
            loseMax: document.getElementById("pointsLoseMax").value || 0,
          },
          datums: {
            endR1: document.getElementById("dateEndR1").value || null,
            endR2: document.getElementById("dateEndR2").value || null,
            startFinale:
              document.getElementById("dateStartFinale").value || null,
            endFinale: document.getElementById("dateEndFinale").value || null,
          },
          aangemaaktOp: new Date().toISOString(),
          playersFinalized: playersFinalized || false,
          aangemaaktOp: new Date().toISOString(),
          playersFinalized: playersFinalized || false,
          moyCarTableId:
            document.getElementById("moyCarTableSelect")?.value || null,

          publiceerPubliek:
            document.getElementById("tournamentPublished").checked || false,
        };

        try {
          const id = `${naam}_${jaar}`.replace(/\s+/g, "_");
          await setDoc(doc(db, "toernooien", id), data);
          activeTournamentId = id;
          playersFinalized = data.playersFinalized;
          showFeedback(
            `‚úÖ Toernooi "${naam}" (${jaar}) is opgeslagen.`,
            "success"
          );
          updateActiveTournament(naam, jaar);
          guardSpelersTabAvailability();
        } catch (err) {
          console.error("‚ùå Fout bij opslaan:", err);
          showFeedback(
            "‚ö†Ô∏è Er ging iets mis bij het opslaan in Firestore.",
            "error"
          );
        }
      }

      // Hulpfunctie om dropdown te bouwen en te hergebruiken voor laden / verwijderen
      async function buildTournamentSelect({ mode }) {
        const snapshot = await getDocs(collection(db, "toernooien"));
        const fb = document.getElementById("feedback");
        fb.innerHTML = "";

        if (snapshot.empty) {
          fb.innerHTML = `
                                                          <div class="message" style="background:#f8d7da;color:#842029;">
                                                            ‚ö†Ô∏è Er zijn nog geen toernooien opgeslagen.
                                                            <span class="close" onclick="this.parentElement.remove()">√ó</span>
                                                          </div>`;
          return null;
        }

        const select = document.createElement("select");
        select.style.marginTop = "10px";
        select.style.padding = "6px";
        select.style.borderRadius = "6px";
        select.style.border = "1px solid #ccc";
        select.style.minWidth = "250px";

        if (mode === "delete") {
          select.innerHTML = `<option value="">Kies een toernooi om te verwijderen...</option>`;
        } else {
          select.innerHTML = `<option value="">Kies een toernooi...</option>`;
        }

        snapshot.forEach((d) => {
          const t = d.data();

          // filtering voor niet-admin
          if (!isAdmin) {
            const allowed = currentUser?.tournaments || [];
            if (!allowed.includes(d.id)) return;
          }

          select.innerHTML += `<option value="${d.id}">${t.naam} (${t.jaar})</option>`;
        });

        fb.appendChild(select);
        return select;
      }

      // Laden van een toernooi via dropdown
      async function loadTournamentList() {
        try {
          const snapshot = await getDocs(collection(db, "toernooien"));
          const fb = document.getElementById("feedback");
          fb.innerHTML = "";

          if (snapshot.empty) {
            fb.innerHTML = `
                    <div class="message" style="background:#f8d7da;color:#842029;">
                      ‚ö†Ô∏è Er zijn nog geen toernooien opgeslagen.
                      <span class="close" onclick="this.parentElement.remove()">√ó</span>
                    </div>`;
            return;
          }

          // vaste dropdown hergebruiken
          let select = document.getElementById("tournamentSelect");
          if (!select) {
            select = document.createElement("select");
            select.id = "tournamentSelect";
            select.style.marginTop = "10px";
            select.style.padding = "6px";
            select.style.borderRadius = "6px";
            select.style.border = "1px solid #ccc";
            select.style.minWidth = "250px";
            fb.appendChild(select);

            // √©√©n keer event vastmaken
            select.addEventListener("change", async () => {
              const id = select.value;
              if (!id) return;

              const ref = doc(db, "toernooien", id);
              const dSnap = await getDoc(ref);
              if (!dSnap.exists()) {
                showFeedback("‚ö†Ô∏è Toernooi niet gevonden.", "error");
                return;
              }

              const t = dSnap.data();
              document.getElementById("tournamentName").value = t.naam;
              document.getElementById("tournamentYear").value = t.jaar;
              document.getElementById("tournamentOrg").value =
                t.organisatie || "";
              document.getElementById("maxTurns").value = t.maxBeurten || "";
              document.getElementById("dateEndR1").value =
                t.datums?.endR1 || "";
              document.getElementById("dateEndR2").value =
                t.datums?.endR2 || "";
              document.getElementById("dateStartFinale").value =
                t.datums?.startFinale || "";
              document.getElementById("dateEndFinale").value =
                t.datums?.endFinale || "";
              document.getElementById("pointsWinLess").value =
                t.punten?.winLess || "";
              document.getElementById("pointsDrawLess").value =
                t.punten?.drawLess || "";
              document.getElementById("pointsLoseLess").value =
                t.punten?.loseLess || "";
              document.getElementById("pointsWinMax").value =
                t.punten?.winMax || "";
              document.getElementById("pointsDrawMax").value =
                t.punten?.drawMax || "";
              document.getElementById("pointsLoseMax").value =
                t.punten?.loseMax || "";

              // Publicatie-status instellen
              const pubCheckbox = document.getElementById(
                "tournamentPublished"
              );
              if (pubCheckbox) {
                pubCheckbox.checked = !!t.publiceerPubliek;
                // badge mee updaten
                if (typeof updatePublishedBadge === "function") {
                  updatePublishedBadge(pubCheckbox.checked);
                }
              }
              // gekoppelde moyenne‚Üícaramboles-tabel selecteren
              const moySel = document.getElementById("moyCarTableSelect");
              if (moySel) {
                // zorg dat de lijst is gevuld
                await loadMoyCarTables();
                moySel.value = t.moyCarTableId || "";
              }

              activeTournamentId = id;
              playersFinalized = !!t.playersFinalized;
              updateActiveTournament(t.naam, t.jaar);
              showFeedback(
                `‚úÖ Toernooi "${t.naam}" (${t.jaar}) geladen.`,
                "success"
              );
              guardSpelersTabAvailability();

              await loadPlayersForActiveTournament();
              await loadPoulesForActiveTournament();
              await loadR1ResultsTabForActiveTournament();

              // ‚úÖ forceer eindstatus knoppen
              guardSpelersTabAvailability();
            });
          }

          // vul de dropdown
          select.innerHTML = '<option value="">Kies een toernooi...</option>';
          snapshot.forEach((d) => {
            const t = d.data();

            // filtering voor niet-admin
            if (!isAdmin) {
              const allowed = currentUser?.tournaments || [];
              if (!allowed.includes(d.id)) return;
            }

            select.innerHTML += `<option value="${d.id}">${t.naam} (${t.jaar})</option>`;
          });
        } catch (err) {
          console.error("‚ùå Fout bij laden:", err);
          showFeedback("‚ö†Ô∏è Kon toernooien niet laden uit Firestore.", "error");
        }
      }

      // Verwijderen van een toernooi (met dubbele bevestiging)
      async function deleteTournament() {
        try {
          const select = await buildTournamentSelect({ mode: "delete" });
          if (!select) return;

          select.addEventListener("change", async () => {
            const id = select.value;
            if (!id) return;

            const ref = doc(db, "toernooien", id);
            const snap = await getDoc(ref);
            if (!snap.exists()) {
              showFeedback("‚ö†Ô∏è Toernooi niet gevonden.", "error");
              return;
            }

            const t = snap.data();

            const zeker = confirm(
              `Weet je zeker dat je het toernooi "${t.naam}" wilt verwijderen?`
            );
            if (!zeker) {
              showFeedback("Verwijderen geannuleerd.", "error");
              return;
            }

            const invoer = prompt(
              `Typ de naam van het toernooi exact in ter bevestiging:\n${t.naam}`
            );
            if (invoer !== t.naam) {
              showFeedback(
                "‚ùå Naam komt niet overeen. Verwijderen geannuleerd.",
                "error"
              );
              return;
            }

            // BELANGRIJK: spelers-subcollectie eerst verwijderen
            const playersSnap = await getDocs(
              collection(db, "toernooien", id, "spelers")
            );
            for (const pDoc of playersSnap.docs) {
              await deleteDoc(doc(db, "toernooien", id, "spelers", pDoc.id));
            }

            await deleteDoc(ref);
            showFeedback(`üóëÔ∏è Toernooi "${t.naam}" is verwijderd.`, "success");

            // Reset state als dit actief was
            if (activeTournamentId === id) {
              activeTournamentId = null;
              playersFinalized = false;
              updateActiveTournament(null, null);
              guardSpelersTabAvailability();
              clearPlayersTable();
            }

            // dropdown verversen
            await buildTournamentSelect({ mode: "delete" });
          });
        } catch (err) {
          console.error("‚ùå Fout bij verwijderen:", err);
          showFeedback("‚ö†Ô∏è Kon toernooi niet verwijderen.", "error");
        }
      }

      /* ===== FUNCTIES TAB SPELERS ===== */

      const playerForm = document.getElementById("playerForm");
      const playerTableBody = document.getElementById("playerTableBody");
      const sortByNameBtn = document.getElementById("sortByName");
      const sortByCarambolesBtn = document.getElementById("sortByCaramboles");
      const finalizeBtn = document.getElementById("finalizePlayers");
      const editBtn = document.getElementById("editPlayers");
      const addPlayerBtn = document.getElementById("addPlayerBtn");
      const playerCount = document.getElementById("playerCount");
      const playersFinalizedNotice = document.getElementById(
        "playersFinalizedNotice"
      );
      const editPlayerModal = document.getElementById("editPlayerModal");
      const editPlayerForm = document.getElementById("editPlayerForm");
      const cancelEdit = document.getElementById("cancelEdit");
      const noTournamentNotice = document.getElementById("noTournamentNotice");
      const playersLockOverlay = document.getElementById("playersLockOverlay");

      let currentPlayers = [];
      let currentSort = null;
      let editPlayerId = null;
      // let r1PoulesExist = false; // true zodra er poules_r1 zijn

      function updatePlayerCount() {
        playerCount.textContent = `Aantal deelnemers: ${currentPlayers.length}`;
      }

      function openEditModal(player) {
        editPlayerId = player.id;

        const nameInput = document.getElementById("editName");
        const emailInput = document.getElementById("editEmail");
        const phoneInput = document.getElementById("editPhone");
        const carInput = document.getElementById("editCaramboles");

        nameInput.value = player.naam || "";
        emailInput.value = player.email || "";
        phoneInput.value = player.telefoon || "";
        carInput.value = player.caramboles ?? "";

        // Zodra er poules zijn: alleen e-mail & telefoon bewerkbaar
        const lockStructural = !!r1PoulesExist;

        nameInput.disabled = lockStructural;
        carInput.disabled = lockStructural;

        // kleine visuele hint
        nameInput.style.backgroundColor = lockStructural ? "#f0f0f0" : "";
        carInput.style.backgroundColor = lockStructural ? "#f0f0f0" : "";

        editPlayerModal.style.display = "flex";
      }

      function closeEditModal() {
        editPlayerId = null;
        editPlayerModal.style.display = "none";
      }

      cancelEdit.addEventListener("click", closeEditModal);

      editPlayerForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!editPlayerId || !activeTournamentId) return;

        const newData = {
          naam: document.getElementById("editName").value.trim(),
          email: document.getElementById("editEmail").value.trim(),
          telefoon: document.getElementById("editPhone").value.trim(),
          caramboles:
            Number(document.getElementById("editCaramboles").value) || 0,
        };

        // Bestaande speler opzoeken om te kunnen vergelijken
        const oldPlayer =
          currentPlayers.find((p) => p.id === editPlayerId) || {};
        const oldName = oldPlayer.naam || "";
        const oldCar = oldPlayer.caramboles ?? 0;

        const newName = newData.naam;
        const newCar = newData.caramboles;

        // Check: zitten we midden in het toernooi?
        // (= spelerslijst definitief √©n er zijn al poules/wedstrijden)
        let midTournament = false;
        if (playersFinalized) {
          const hasStructure = await hasAnyPoulesOrMatchesForActiveTournament();
          midTournament = hasStructure;
        }

        if (midTournament) {
          const nameChanged = oldName !== newName;
          const carChanged = oldCar !== newCar;

          if (nameChanged || carChanged) {
            showPlayerFeedback(
              "‚ùå Tijdens het toernooi mogen alleen e-mailadres en telefoonnummer worden gewijzigd. " +
                "Naam en te maken caramboles blijven ongewijzigd.",
              "error"
            );
            return;
          }
        }

        // Als we hier zijn: wijziging is toegestaan
        await setDoc(
          doc(db, "toernooien", activeTournamentId, "spelers", editPlayerId),
          newData,
          { merge: true }
        );
        showPlayerFeedback(
          `‚úèÔ∏è Speler "${newData.naam}" bijgewerkt.`,
          "success"
        );
        closeEditModal();
        await loadPlayersFromFirestore();
      });

      function clearPlayersTable() {
        currentPlayers = [];
        playerTableBody.innerHTML = "";
        updatePlayerCount();
      }

      function guardSpelersTabAvailability() {
        const disabled = !activeTournamentId;
        const hasPoules = !!r1PoulesExist; // NIEUW: controle op poules

        // Overlay & Notice voor definitieve lijst
        if (playersFinalized) {
          playersFinalizedNotice.style.display = "flex";
          playersLockOverlay.style.display = "flex";
        } else {
          playersFinalizedNotice.style.display = "none";
          playersLockOverlay.style.display = "none";
        }

        // Toernooi nodig waarschuwing
        noTournamentNotice.style.display = disabled ? "block" : "none";

        // formulier voor nieuwe speler
        if (playerForm) {
          [...playerForm.querySelectorAll("input,button")].forEach((el) => {
            if (el.id === "addPlayerBtn") {
              // Speler toevoegen mag NIET als: geen toernooi OF lijst definitief OF er al poules zijn
              const blockAdd = disabled || playersFinalized || hasPoules;
              el.disabled = blockAdd;
              if (blockAdd) {
                el.style.backgroundColor = "#ccc";
                el.style.cursor = "not-allowed";
                el.style.opacity = "0.7";
              } else {
                el.style.backgroundColor = "";
                el.style.cursor = "pointer";
                el.style.opacity = "1";
              }
            } else {
              // overige velden alleen blokkeren als er nog geen toernooi is
              el.disabled = disabled;
              if (disabled) {
                el.style.backgroundColor = "#f0f0f0";
                el.style.cursor = "not-allowed";
                el.style.opacity = "0.7";
              } else {
                el.style.backgroundColor = "";
                el.style.cursor = "";
                el.style.opacity = "";
              }
            }
          });
        }

        // sorteerknoppen
        if (sortByNameBtn) sortByNameBtn.disabled = disabled;
        if (sortByCarambolesBtn) sortByCarambolesBtn.disabled = disabled;

        // ‚úÖ 1) De 'Lijst definitief maken' knop is actief wanneer:
        // - Toernooi actief is (niet disabled)
        // - Lijst NIET definitief is (!playersFinalized)
        // - ER ZIJN GEEN poules (!hasPoules)
        if (finalizeBtn) {
          finalizeBtn.disabled = disabled || playersFinalized || hasPoules;
          finalizeBtn.style.opacity = finalizeBtn.disabled ? "0.6" : "1";
          finalizeBtn.style.cursor = finalizeBtn.disabled
            ? "not-allowed"
            : "pointer";
        }

        // ‚úÖ 2) De 'Lijst bewerken' knop is actief wanneer:
        // - Toernooi actief is (niet disabled)
        // - Lijst WEL definitief is (playersFinalized)
        // - ER ZIJN GEEN poules (!hasPoules)
        if (editBtn) {
          editBtn.disabled = disabled || !playersFinalized || hasPoules;
          editBtn.style.opacity = editBtn.disabled ? "0.6" : "1";
          editBtn.style.cursor = editBtn.disabled ? "not-allowed" : "pointer";
        }

        // Disable delete buttons in the table if finalized or has poules (NIEUW)
        document.querySelectorAll(".delete-player-btn").forEach((btn) => {
          btn.disabled = playersFinalized || hasPoules;
          btn.style.opacity = btn.disabled ? "0.4" : "1";
        });

        // Visuele status voor de bewerk knop in de tabel (NIEUW)
        document.querySelectorAll(".edit-player-btn").forEach((btn) => {
          const isStructuralLock = hasPoules; // Edit van naam/caramboles is geblokkeerd zodra poules bestaan
          btn.title = isStructuralLock
            ? "Alleen e-mail/telefoon zijn wijzigbaar (Poules bestaan)"
            : "Speler wijzigen";
        });
      }

      function renderPlayersTable() {
        playerTableBody.innerHTML = "";

        let rows = [...currentPlayers];
        if (currentSort === "name")
          rows.sort((a, b) =>
            a.naam.localeCompare(b.naam, "nl", { sensitivity: "base" })
          );
        else if (currentSort === "caramboles")
          rows.sort(
            (a, b) => Number(a.caramboles || 0) - Number(b.caramboles || 0)
          );
        rows.forEach((player) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
                                                      <td>${
                                                        player.naam || ""
                                                      }</td>
                                                      <td>${
                                                        player.email || ""
                                                      }</td>
                                                      <td>${
                                                        player.telefoon || ""
                                                      }</td>
                                                      <td class="num">${
                                                        player.caramboles ?? ""
                                                      }</td>
                                                      <td class="actions">
                                                        <button
                                                          class="edit-player-btn btn btn-secondary btn-icon-only"
                                                          title="Wijzig speler"
                                                        >
                                                          <span class="btn-icon" aria-hidden="true">‚úèÔ∏è</span>
                                                        </button>
                                                        <button
                                                          class="btn btn-delete delete-player-btn btn-icon-only"
                                                          title="Verwijder speler"
                                                        >
                                                          <span class="btn-icon" aria-hidden="true">üóëÔ∏è</span>
                                                        </button>
                                                      </td>
                                                    `;

          const editBtn = tr.querySelector(".edit-player-btn");
          const delBtn = tr.querySelector(".delete-player-btn");

          // Altijd mogelijk te wijzigen
          editBtn.addEventListener("click", () => openEditModal(player));

          // Verwijderen alleen als niet definitief
          delBtn.disabled = playersFinalized;
          delBtn.addEventListener("click", async () => {
            if (!activeTournamentId || playersFinalized) return;
            if (!confirm(`Verwijder speler "${player.naam}"?`)) return;

            await deleteDoc(
              doc(db, "toernooien", activeTournamentId, "spelers", player.id)
            );
            showPlayerFeedback(
              `üóëÔ∏è Speler "${player.naam}" verwijderd.`,
              "success"
            );
            await loadPlayersFromFirestore();
          });

          playerTableBody.appendChild(tr);
        });

        updatePlayerCount();
        guardSpelersTabAvailability();
      }

      async function loadPlayersFromFirestore() {
        if (!activeTournamentId) {
          clearPlayersTable();
          guardSpelersTabAvailability();
          return;
        }

        const playersSnap = await getDocs(
          collection(db, "toernooien", activeTournamentId, "spelers")
        );
        currentPlayers = playersSnap.docs.map((d) => ({
          id: d.id,
          ...d.data(),
        }));

        const tRef = doc(db, "toernooien", activeTournamentId);
        const tSnap = await getDoc(tRef);
        if (tSnap.exists()) playersFinalized = !!tSnap.data().playersFinalized;

        renderPlayersTable();
      }

      async function addPlayer(e) {
        e.preventDefault();
        if (!activeTournamentId) {
          showPlayerFeedback("‚ö†Ô∏è Geen actief toernooi geselecteerd.", "error");
          return;
        }
        if (playersFinalized) {
          showPlayerFeedback(
            "‚ùå Lijst is definitief. Bewerken niet toegestaan.",
            "error"
          );
          return;
        }

        const naam = document.getElementById("playerName").value.trim();
        const email = document.getElementById("playerEmail").value.trim();
        const telefoon = document.getElementById("playerPhone").value.trim();
        const caramboles = document
          .getElementById("playerCaramboles")
          .value.trim();

        if (!naam) {
          showPlayerFeedback("‚ùå Naam speler is verplicht.", "error");
          return;
        }

        const newPlayer = {
          naam,
          email,
          telefoon,
          caramboles: caramboles ? Number(caramboles) : null,
        };
        await addDoc(
          collection(db, "toernooien", activeTournamentId, "spelers"),
          newPlayer
        );

        showPlayerFeedback(`‚úÖ Speler "${naam}" toegevoegd.`, "success");

        document.getElementById("playerName").value = "";
        document.getElementById("playerEmail").value = "";
        document.getElementById("playerPhone").value = "";
        document.getElementById("playerCaramboles").value = "";

        await loadPlayersFromFirestore();
      }

      sortByNameBtn.addEventListener("click", () => {
        currentSort = "name";
        renderPlayersTable();
      });

      sortByCarambolesBtn.addEventListener("click", () => {
        currentSort = "caramboles";
        renderPlayersTable();
      });

      finalizeBtn.addEventListener("click", async () => {
        if (!activeTournamentId) return;
        const confirmFinal = confirm(
          "Weet je zeker dat je de spelerslijst definitief wilt maken?"
        );
        if (!confirmFinal) return;

        await setDoc(
          doc(db, "toernooien", activeTournamentId),
          { playersFinalized: true },
          { merge: true }
        );
        playersFinalized = true;
        showPlayerFeedback("üîí Spelerslijst is definitief gemaakt.", "success");
        guardSpelersTabAvailability();
        updateR1PoulesButtons();
      });

      editBtn.addEventListener("click", async () => {
        if (!activeTournamentId) return;

        // GEEN poules/wedstrijden meer wissen hier

        await setDoc(
          doc(db, "toernooien", activeTournamentId),
          { playersFinalized: false },
          { merge: true }
        );
        playersFinalized = false;
        showPlayerFeedback("‚úèÔ∏è Spelerslijst is weer bewerkbaar.", "success");
        guardSpelersTabAvailability();

        if (typeof updateR1PoulesButtons === "function") {
          updateR1PoulesButtons();
        }
      });

      playerForm.addEventListener("submit", addPlayer);

      // NIEUWE FUNCTIES VOOR DE KNOPPEN

      async function finalizePlayersAction() {
        if (!activeTournamentId) return;
        if (playersFinalized) {
          showPlayerFeedback("‚ùå Lijst is al definitief.", "error");
          return;
        }
        // ‚úÖ Controle: mag niet definitief worden als er al poules zijn
        if (r1PoulesExist) {
          showPlayerFeedback(
            "‚ùå Kan niet definitief maken: er zijn al poules aangemaakt. Wis eerst de poules als je de lijst nog wilt wijzigen.",
            "error"
          );
          return;
        }

        const confirmFinalize = confirm(
          "Weet je zeker dat je de spelerslijst definitief wilt maken? Hierna zijn aanpassingen aan namen en caramboles niet meer mogelijk, tenzij je de lijst weer bewerkt (en er nog geen poules zijn)."
        );
        if (!confirmFinalize) return;

        try {
          const tRef = doc(db, "toernooien", activeTournamentId);
          await updateDoc(tRef, { playersFinalized: true });
          playersFinalized = true;
          showPlayerFeedback("‚úÖ Spelerslijst definitief gemaakt.", "success");
          guardSpelersTabAvailability(); // Update knoppen direct
          renderPlayersTable();
        } catch (err) {
          console.error("Fout bij definitief maken:", err);
          showPlayerFeedback("‚ö†Ô∏è Kon lijst niet definitief maken.", "error");
        }
      }

      async function editPlayersAction() {
        if (!activeTournamentId) return;
        if (!playersFinalized) {
          showPlayerFeedback("‚ùå Lijst is al bewerkbaar.", "error");
          return;
        }
        // ‚úÖ Controle: mag niet bewerkbaar worden als er al poules zijn
        if (r1PoulesExist) {
          showPlayerFeedback(
            "‚ùå Kan lijst niet bewerken: er zijn al 1e ronde poules aangemaakt. Wis eerst de poules."
          );
          return;
        }
        const confirmEdit = confirm(
          "Weet je zeker dat je de spelerslijst weer wilt bewerken? De definitieve status wordt ongedaan gemaakt, en je kunt namen/caramboles weer wijzigen."
        );
        if (!confirmEdit) return;

        try {
          const tRef = doc(db, "toernooien", activeTournamentId);
          await updateDoc(tRef, { playersFinalized: false });
          playersFinalized = false;
          showPlayerFeedback("‚úèÔ∏è Spelerslijst is weer bewerkbaar.", "success");
          guardSpelersTabAvailability(); // Update knoppen direct
          renderPlayersTable();
        } catch (err) {
          console.error("Fout bij bewerken:", err);
          showPlayerFeedback("‚ö†Ô∏è Kon lijst niet bewerkbaar maken.", "error");
        }
      }

      async function loadPlayersForActiveTournament() {
        if (!activeTournamentId) return;
        await loadPlayersFromFirestore();
      }

      /* ===== EINDE FUNCTIES TAB SPELERS ===== */

      /* ===== FUNCTIES TAB 1E RONDE POULES ===== */

      const createPoulesBtn = document.getElementById("createPoulesBtn");
      const savePoulesBtn = document.getElementById("savePoulesBtn");
      const clearPoulesBtn = document.getElementById("clearPoulesBtn");
      const baseLayoutBtn = document.getElementById("baseLayoutBtn"); // NIEUW
      const exportPoulesWordBtn = document.getElementById(
        "exportPoulesWordBtn"
      ); // NIEUW
      const availablePlayersDiv = document.getElementById("availablePlayers");
      const poulesContainer = document.getElementById("poulesContainer");
      const poulesFeedback = document.getElementById("poulesFeedback");
      const noTournamentPoulesNotice = document.getElementById(
        "noTournamentPoulesNotice"
      );

      let currentPoules = []; // [{ naam, maxSpelers, spelers:[{id,naam,caramboles,...}] }, ...]
      let selectedPlayer = null; // spelerobject die is aangeklikt links
      let availablePlayers = []; // spelers die nog NIET in een poule zitten
      let allPlayers = []; // alle spelers uit Firestore (cache)

      // ----- UI helpers -----

      function showPoulesFeedback(msg, type = "info") {
        poulesFeedback.innerHTML = `<div style="padding:6px 10px; border-radius:6px;
                                                    background:${
                                                      type === "error"
                                                        ? "#f8d7da"
                                                        : type === "success"
                                                        ? "#d1e7dd"
                                                        : "#e2e3e5"
                                                    };
                                                    color:${
                                                      type === "error"
                                                        ? "#842029"
                                                        : type === "success"
                                                        ? "#0f5132"
                                                        : "#41464b"
                                                    };
                                                    border:1px solid ${
                                                      type === "error"
                                                        ? "#f5c2c7"
                                                        : type === "success"
                                                        ? "#badbcc"
                                                        : "#d3d6d8"
                                                    };
                                                    margin-top:10px;">${msg}</div>`;
      }

      function showFinaleFeedback(msg, type = "info") {
        const box = document.getElementById("finaleFeedback");
        if (!box) return;
        let color = "#e2e3e5";
        let textColor = "#41464b";
        if (type === "error") {
          color = "#f8d7da";
          textColor = "#842029";
        } else if (type === "success") {
          color = "#d1e7dd";
          textColor = "#0f5132";
        }
        box.innerHTML = `
          <div style="
            background:${color};
            color:${textColor};
            border-radius:6px;
            padding:6px 8px;
            border:1px solid rgba(0,0,0,0.05);
          ">
            ${msg}
          </div>
        `;
      }

      function updateR1PoulesButtons() {
        if (!createPoulesBtn || !savePoulesBtn || !clearPoulesBtn) return;

        const hasTournament = !!activeTournamentId;
        const hasPoules = currentPoules.length > 0;
        const playersDef = !!playersFinalized;

        // Wedstrijdschema bestaat zodra er r1Matches zijn
        const hasSchedule = Array.isArray(r1Matches) && r1Matches.length > 0;

        // hoeveel spelers al ingedeeld?
        const totalPlayers = allPlayers.length;
        const assignedPlayers = currentPoules.reduce(
          (sum, p) => sum + p.spelers.length,
          0
        );
        const allAssigned =
          totalPlayers > 0 && assignedPlayers === totalPlayers;

        // onthoud dit ook voor de spelers-tab
        r1PoulesExist = hasPoules;

        // ‚ûï Poules aanmaken:
        // - toernooi actief
        // - spelerslijst definitief
        // - nog g√©√©n poules
        // - en nog g√©√©n wedstrijdschema
        createPoulesBtn.disabled =
          !hasTournament || !playersDef || hasPoules || hasSchedule;

        // üíæ Indeling opslaan:
        // - toernooi actief
        // - spelerslijst definitief
        // - er zijn poules
        // - alle spelers zijn ingedeeld
        // - en nog g√©√©n wedstrijdschema
        const canSave =
          hasTournament &&
          playersDef &&
          hasPoules &&
          allAssigned &&
          !hasSchedule;
        savePoulesBtn.disabled = !canSave;

        // üóëÔ∏è Alles wissen:
        // - toernooi actief
        // - spelerslijst definitief
        // - er zijn poules
        // - en nog g√©√©n wedstrijdschema
        clearPoulesBtn.disabled =
          !hasTournament || !playersDef || !hasPoules || hasSchedule;

        // ‚¨áÔ∏è Export naar Word:
        // actief als: er een toernooi √©n een poule-indeling is
        const canExport = hasTournament && hasPoules;
        if (exportPoulesWordBtn) {
          exportPoulesWordBtn.disabled = !canExport;
        }

        [
          createPoulesBtn,
          savePoulesBtn,
          clearPoulesBtn,
          exportPoulesWordBtn,
        ].forEach((btn) => {
          if (!btn) return;
          btn.style.opacity = btn.disabled ? "0.4" : "1";
          btn.style.cursor = btn.disabled ? "not-allowed" : "pointer";
        });

        // üß© NIEUW: knop 'Kies basisindeling'
        // Actief als:
        // - er een toernooi is
        // - er poules zijn aangemaakt
        // - er nog GEEN wedstrijdschema is
        if (baseLayoutBtn) {
          const canBaseLayout = hasTournament && hasPoules && !hasSchedule;
          baseLayoutBtn.disabled = !canBaseLayout;
          baseLayoutBtn.style.opacity = canBaseLayout ? "1" : "0.4";
          baseLayoutBtn.style.cursor = canBaseLayout
            ? "pointer"
            : "not-allowed";
        }

        // verwijder-knoppen in poule-kaarten blokkeren als schema bestaat
        document
          .querySelectorAll("#poulesContainer button[data-player-id]")
          .forEach((btn) => {
            btn.disabled = hasSchedule;
            btn.style.opacity = btn.disabled ? "0.4" : "1";
            btn.style.cursor = btn.disabled ? "not-allowed" : "pointer";
          });
      }

      // ===== Basisindelingen ‚Äì helpers =====

      // hoe sterk is een speler? (caramboles 1e ronde, anders algemene caramboles, anders teMaken)
      function getPlayerStrength(speler) {
        if (!speler) return 0;
        const raw =
          speler.carambolesR1 ?? speler.caramboles ?? speler.teMaken ?? 0;
        return Number(raw) || 0;
      }

      // sorteer spelers op sterkte (sterkste eerst)
      function sortByStrength(players) {
        return [...players].sort(
          (a, b) => getPlayerStrength(b) - getPlayerStrength(a)
        );
      }

      // bouw een volgorde van poule-indexen (0..n-1) waarin slots worden gevuld
      // snake = false: A, B, C, D, A, B, C, D, ...
      // snake = true : A, B, C, D, D, C, B, A, A, B, C, D, ...
      function buildPouleIndexSequence(poules, snake = false) {
        const totalSlots = poules.reduce(
          (sum, p) => sum + (p.maxSpelers || 0),
          0
        );
        const seq = [];
        const n = poules.length;
        if (!totalSlots || !n) return seq;

        // Normale (roulerende) verdeling: A, B, C, D, A, B, C, D, ...
        if (!snake) {
          while (seq.length < totalSlots) {
            for (let i = 0; i < n && seq.length < totalSlots; i++) {
              seq.push(i);
            }
          }
          return seq;
        }

        // Snake-verdeling per "rij":
        // rij 1: 0,1,2,...,n-1  => A,B,C,D
        // rij 2: n-1,...,2,1,0  => D,C,B,A
        // rij 3: weer 0..n-1    => A,B,C,D
        // enz.
        const forward = Array.from({ length: n }, (_, i) => i); // 0..n-1
        const backward = Array.from({ length: n }, (_, i) => n - 1 - i); // n-1..0

        let useForward = true;
        while (seq.length < totalSlots) {
          const row = useForward ? forward : backward;
          for (const idx of row) {
            if (seq.length >= totalSlots) break;
            seq.push(idx);
          }
          useForward = !useForward; // volgende rij omdraaien
        }

        return seq;
      }

      // verdeel spelers in volgorde van 'sequence' over poules (zonder maxSpelers te overschrijden)
      function assignBySequence(playersOrdered, poules, sequence) {
        const assignments = {};
        poules.forEach((p) => {
          assignments[p.naam] = [];
        });

        let playerIdx = 0;
        for (const slotIdx of sequence) {
          if (playerIdx >= playersOrdered.length) break;
          const poule = poules[slotIdx];
          const list = assignments[poule.naam];
          if (list.length >= poule.maxSpelers) continue;
          list.push(playersOrdered[playerIdx]);
          playerIdx++;
        }
        return assignments;
      }

      // op sterkte per blok: eerst Poule A helemaal vullen, dan B, enz.
      function assignByBlocks(playersOrdered, poules) {
        const assignments = {};
        poules.forEach((p) => {
          assignments[p.naam] = [];
        });

        let idx = 0;
        poules.forEach((poule) => {
          const list = assignments[poule.naam];
          while (
            list.length < poule.maxSpelers &&
            idx < playersOrdered.length
          ) {
            list.push(playersOrdered[idx++]);
          }
        });

        return assignments;
      }

      // sterke en zwakke helft bepalen volgens jouw definitie
      function splitStrongWeak(players, poules) {
        const sorted = sortByStrength(players);
        const numPoules = poules.length;

        // aantal poules voor sterke helft: helft, naar boven afgerond
        const strongPouleCount = Math.ceil(numPoules / 2);
        const strongPoules = poules.slice(0, strongPouleCount);
        const weakPoules = poules.slice(strongPouleCount);

        // aantal spelers in sterke helft = som maxSpelers van sterke poules
        const strongSlots = strongPoules.reduce(
          (sum, p) => sum + (p.maxSpelers || 0),
          0
        );
        const strongPlayers = sorted.slice(0, strongSlots);
        const weakPlayers = sorted.slice(strongSlots);

        return { strongPlayers, weakPlayers, strongPoules, weakPoules };
      }

      function mergeAssignments(allPoules, strongAssignments, weakAssignments) {
        const result = {};
        allPoules.forEach((p) => {
          result[p.naam] =
            (strongAssignments && strongAssignments[p.naam]) ||
            (weakAssignments && weakAssignments[p.naam]) ||
            [];
        });
        return result;
      }

      // ===== Definitie van de verschillende basisindelingen =====

      const baseLayouts = [
        {
          id: "random",
          title: "Willekeurig",
          description:
            "Alle spelers worden in een willekeurige volgorde over de poules verdeeld.",
          apply(players, poules) {
            const shuffled = [...players];
            for (let i = shuffled.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            const seq = buildPouleIndexSequence(poules, false);
            return assignBySequence(shuffled, poules, seq);
          },
        },
        {
          id: "byStrengthBlocks",
          title: "Op sterkte (per poule)",
          description:
            "De sterkste 4 of 5 spelers in poule A, de volgende 4/5 in poule B, enzovoort.",
          apply(players, poules) {
            const sorted = sortByStrength(players);
            return assignByBlocks(sorted, poules);
          },
        },
        {
          id: "even_rr",
          title: "Gelijkmatig ‚Äì doorlopend",
          description:
            "Spelers op volgorde van sterkte: eerst de sterkste in poule A, dan B, C, ‚Ä¶; daarna opnieuw vanaf poule A (roulerend schema).",
          apply(players, poules) {
            const sorted = sortByStrength(players);
            const seq = buildPouleIndexSequence(poules, false);
            return assignBySequence(sorted, poules, seq);
          },
        },
        {
          id: "even_snake",
          title: "Gelijkmatig ‚Äì slingerend (snake)",
          description:
            "Zelfde als hierboven, maar dan slingerend: A‚ÄìB‚ÄìC‚ÄìD, daarna D‚ÄìC‚ÄìB‚ÄìA, enzovoort (in het Nederlands vaak een slingerend ‚Äòsnake‚Äô-schema).",
          apply(players, poules) {
            const sorted = sortByStrength(players);
            const seq = buildPouleIndexSequence(poules, true);
            return assignBySequence(sorted, poules, seq);
          },
        },
        {
          id: "half_rr",
          title: "Sterkste/zwakste helft ‚Äì doorlopend",
          description:
            "De sterkste helft van het deelnemersveld wordt gelijkmatig over de eerste helft van de poules verdeeld, de zwakste helft over de overige poules.",
          apply(players, poules) {
            const { strongPlayers, weakPlayers, strongPoules, weakPoules } =
              splitStrongWeak(players, poules);
            const seqStrong = buildPouleIndexSequence(strongPoules, false);
            const seqWeak = buildPouleIndexSequence(weakPoules, false);
            const strongAssign = assignBySequence(
              strongPlayers,
              strongPoules,
              seqStrong
            );
            const weakAssign = assignBySequence(
              weakPlayers,
              weakPoules,
              seqWeak
            );
            return mergeAssignments(poules, strongAssign, weakAssign);
          },
        },
        {
          id: "half_snake",
          title: "Sterkste/zwakste helft ‚Äì slingerend",
          description:
            "Zelfde als hierboven, maar binnen zowel sterke als zwakke helft in een slingerend (snake-)schema: A‚ÄìB‚ÄìC, dan C‚ÄìB‚ÄìA, enzovoort.",
          apply(players, poules) {
            const { strongPlayers, weakPlayers, strongPoules, weakPoules } =
              splitStrongWeak(players, poules);
            const seqStrong = buildPouleIndexSequence(strongPoules, true);
            const seqWeak = buildPouleIndexSequence(weakPoules, true);
            const strongAssign = assignBySequence(
              strongPlayers,
              strongPoules,
              seqStrong
            );
            const weakAssign = assignBySequence(
              weakPlayers,
              weakPoules,
              seqWeak
            );
            return mergeAssignments(poules, strongAssign, weakAssign);
          },
        },
      ];

      // ===== Popup + toepassen van de basisindeling =====

      function openBaseLayoutDialog() {
        if (!activeTournamentId) {
          showPoulesFeedback("‚ö†Ô∏è Geen toernooi actief.", "error");
          return;
        }
        if (!currentPoules.length) {
          showPoulesFeedback(
            "‚ö†Ô∏è Er zijn nog geen poules aangemaakt. Maak eerst poules aan.",
            "error"
          );
          return;
        }

        const hasSchedule = Array.isArray(r1Matches) && r1Matches.length > 0;
        if (hasSchedule) {
          showPoulesFeedback(
            "‚ùå Je kunt geen basisindeling kiezen als er al een wedstrijdschema is aangemaakt.",
            "error"
          );
          return;
        }

        const alreadyAssigned = currentPoules.reduce(
          (sum, p) => sum + p.spelers.length,
          0
        );
        if (alreadyAssigned > 0) {
          const ok = confirm(
            "Er zijn al spelers in de poules ingedeeld. De gekozen basisindeling zal de huidige indeling overschrijven. Doorgaan?"
          );
          if (!ok) return;
        }

        const existing = document.getElementById("baseIndelingDialog");
        if (existing) existing.remove();

        const overlay = document.createElement("div");
        overlay.id = "baseIndelingDialog";
        overlay.style.cssText = `
          position:fixed; inset:0; background:rgba(0,0,0,0.35);
          display:flex; align-items:center; justify-content:center; z-index:2100;
        `;

        const box = document.createElement("div");
        box.style.cssText = `
          background:#fff; border-radius:10px; padding:18px 20px;
          max-width:560px; width:90%;
          box-shadow:0 6px 18px rgba(0,0,0,0.25);
          font-size:0.95rem;
        `;

        let html = `
          <h4 style="margin-top:0;margin-bottom:10px;">Kies basisindeling voor de poules</h4>
          <p style="margin-top:0;margin-bottom:10px;">
            Kies √©√©n van de voorgedefinieerde indelingen. De spelers worden automatisch over de poules verdeeld;
            je kunt de indeling daarna nog handmatig aanpassen voordat je opslaat.
          </p>
          <form id="baseIndelingForm" style="max-height:320px;overflow:auto;margin-bottom:10px;">`;

        baseLayouts.forEach((layout, idx) => {
          html += `
            <label style="display:block;margin-bottom:8px;cursor:pointer;">
              <input type="radio" name="baseLayoutOption" value="${layout.id}"
                style="margin-right:6px;" ${idx === 0 ? "checked" : ""} />
              <strong>${layout.title}</strong><br>
              <span style="font-size:0.85em;color:#555;">${
                layout.description
              }</span>
            </label>`;
        });

        html += `
          </form>
          <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px;">
            <button type="button" id="cancelBaseLayoutBtn"
              style="padding:6px 12px;border-radius:6px;border:1px solid #ccc;background:#f8f9fa;cursor:pointer;">
              Annuleren
            </button>
            <button type="button" id="applyBaseLayoutBtn"
              style="padding:6px 12px;border-radius:6px;border:1px solid #0d6efd;background:#0d6efd;color:#fff;cursor:pointer;">
              Toepassen
            </button>
          </div>
        `;

        box.innerHTML = html;
        overlay.appendChild(box);
        document.body.appendChild(overlay);

        overlay
          .querySelector("#cancelBaseLayoutBtn")
          .addEventListener("click", () => overlay.remove());

        overlay
          .querySelector("#applyBaseLayoutBtn")
          .addEventListener("click", () => {
            const checked = overlay.querySelector(
              'input[name="baseLayoutOption"]:checked'
            );
            if (!checked) {
              alert("Kies eerst een basisindeling.");
              return;
            }
            const id = checked.value;
            applyBaseLayout(id);
            overlay.remove();
          });
      }

      function applyBaseLayout(layoutId) {
        const layout = baseLayouts.find((l) => l.id === layoutId);
        if (!layout) {
          showPoulesFeedback("‚ùå Onbekende basisindeling.", "error");
          return;
        }

        // gebruik alle spelers uit het toernooi als basis
        const playersSource =
          (allPlayers && allPlayers.length && allPlayers) ||
          availablePlayers ||
          [];
        if (!playersSource.length) {
          showPoulesFeedback(
            "‚ö†Ô∏è Er zijn nog geen spelers geladen. Laad eerst de spelerslijst.",
            "error"
          );
          return;
        }

        const hasSchedule = Array.isArray(r1Matches) && r1Matches.length > 0;
        if (hasSchedule) {
          showPoulesFeedback(
            "‚ùå Er is al een wedstrijdschema. De basisindeling kan niet meer worden gewijzigd.",
            "error"
          );
          return;
        }

        const assignments = layout.apply(playersSource, currentPoules);

        // toegewezen spelers in currentPoules schrijven
        const assignedIds = new Set();
        currentPoules.forEach((p) => {
          const list = assignments[p.naam] || [];
          p.spelers = list.map((pl) => {
            assignedIds.add(pl.id);
            return pl;
          });
        });

        // beschikbare spelers = spelers die niet zijn ingedeeld
        availablePlayers = playersSource.filter(
          (pl) => !assignedIds.has(pl.id)
        );
        selectedPlayer = null;

        renderPoules();
        renderAvailablePlayers();
        updateR1PoulesButtons();

        showPoulesFeedback(
          `‚úÖ Basisindeling "${layout.title}" toegepast. Je kunt de poules nog aanpassen en daarna de indeling opslaan.`,
          "success"
        );
      }

      // ----- hulpfunctie om te bepalen wie al in een poule zit -----

      function getPlayerIdsInPoules() {
        const ids = new Set();
        currentPoules.forEach((p) => {
          p.spelers.forEach((sp) => ids.add(sp.id));
        });
        return ids;
      }

      // ----- render van de linkerkant (beschikbare spelers) -----

      function renderAvailablePlayers() {
        availablePlayersDiv.innerHTML = "";

        if (!activeTournamentId) {
          noTournamentPoulesNotice.style.display = "block";
          return;
        }
        noTournamentPoulesNotice.style.display = "none";

        // filter nogmaals: alleen spelers die niet in een poule zitten
        const idsInPoules = getPlayerIdsInPoules();
        const notAssigned = allPlayers.filter((p) => !idsInPoules.has(p.id));

        // sorteer op caramboles (hoog ‚Üí laag)
        notAssigned.sort((a, b) => (b.caramboles || 0) - (a.caramboles || 0));

        availablePlayers = notAssigned;

        if (availablePlayers.length === 0) {
          availablePlayersDiv.innerHTML = `<p style="color:#777;">Geen vrije spelers meer.</p>`;
          return;
        }

        availablePlayers.forEach((p) => {
          const div = document.createElement("div");
          div.className = "player-item";
          div.innerHTML = `<strong>${p.naam}</strong> (${p.caramboles || 0})`;
          div.dataset.id = p.id;
          div.style.cssText = `
                                                      padding:6px 8px; border:1px solid #ccc; border-radius:5px;
                                                      margin-bottom:4px; background:white; cursor:pointer;
                                                      transition:all 0.2s ease;
                                                    `;
          div.addEventListener("click", () => selectPlayer(p.id, div));
          availablePlayersDiv.appendChild(div);
        });
      }

      // ----- selectie van een speler links -----

      function selectPlayer(id, element) {
        document
          .querySelectorAll(".player-item")
          .forEach((el) => (el.style.background = "white"));
        const player = availablePlayers.find((p) => p.id === id);
        if (!player) return;
        selectedPlayer = player;
        element.style.background = "#cce5ff";
        showPoulesFeedback(`üéØ Geselecteerd: ${player.naam}`, "info");
      }

      // ----- render van de poules rechts -----

      function renderPoules() {
        poulesContainer.innerHTML = "";

        currentPoules.forEach((poule) => {
          const isFull = poule.spelers.length >= poule.maxSpelers;

          const card = document.createElement("div");
          card.className = "poule-card";
          card.style.cssText = `
                                                      border:3px solid ${
                                                        isFull
                                                          ? "#198754"
                                                          : "#ccc"
                                                      };
                                                      border-radius:8px; padding:8px; background:#fff; min-height:120px; cursor:pointer;
                                                      transition:all 0.2s ease;
                                                    `;

          // header met aantallen
          const header = document.createElement("h5");
          header.innerHTML = `
                                                      ${poule.naam}
                                                      <span style="font-weight:normal;font-size:0.9em;color:#555;">
                                                        (${poule.spelers.length}/${poule.maxSpelers})
                                                      </span>
                                                    `;
          card.appendChild(header);

          // lijst met spelers
          const list = document.createElement("ul");
          list.style.marginTop = "5px";
          list.style.paddingLeft = "15px";

          poule.spelers.forEach((sp) => {
            const li = document.createElement("li");
            li.style.display = "flex";
            li.style.justifyContent = "space-between";
            li.style.alignItems = "center";
            li.style.marginBottom = "2px";

            // speler + caramboles op 1 regel
            const labelSpan = document.createElement("span");
            labelSpan.textContent = `${sp.naam} (${sp.caramboles || 0})`;

            const delBtn = document.createElement("button");
            delBtn.title = "Verwijder speler uit poule";
            delBtn.dataset.playerId = sp.id; // ‚úÖ NIEUW: nodig om later te kunnen disablen
            delBtn.style.cssText = `
                                                        background:#dc3545;
                                                        color:white;
                                                        border:none;
                                                        border-radius:4px;
                                                        cursor:pointer;
                                                        padding:2px 5px;
                                                        font-size:0.8rem;
                                                      `;
            delBtn.textContent = "üóëÔ∏è";
            delBtn.addEventListener("click", (e) => {
              e.stopPropagation(); // voorkom dat klik op poule zelf ook triggert
              removePlayerFromPoule(poule.naam, sp.id);
            });

            li.appendChild(labelSpan);
            li.appendChild(delBtn);
            list.appendChild(li);
          });

          card.appendChild(list);

          // klik op poule = probeer geselecteerde speler toe te voegen
          card.addEventListener("click", () =>
            addSelectedPlayerToPoule(poule.naam)
          );
          poulesContainer.appendChild(card);
        });
      }

      // ----- poules aanmaken op basis van aantal spelers -----

      async function createPoules() {
        if (!activeTournamentId) {
          showPoulesFeedback("‚ö†Ô∏è Geen toernooi actief.", "error");
          return;
        }

        const playersSnap = await getDocs(
          collection(db, "toernooien", activeTournamentId, "spelers")
        );
        allPlayers = playersSnap.docs.map((d) => ({ id: d.id, ...d.data() }));

        const numPlayers = allPlayers.length;

        if (numPlayers < 12) {
          showPoulesFeedback(
            "‚ùå Er zijn minimaal 12 spelers nodig om poules te kunnen aanmaken.",
            "error"
          );
          return;
        }

        const basePoules = Math.floor(numPlayers / 4);
        const remainder = numPlayers % 4;

        let numPoules = basePoules;
        let numPoulesOf5 = 0;

        if (remainder === 1) numPoulesOf5 = 1;
        else if (remainder === 2) numPoulesOf5 = 2;
        else if (remainder === 3) numPoulesOf5 = 3;

        currentPoules = [];
        for (let i = 0; i < numPoules; i++) {
          const naam = `Poule ${String.fromCharCode(65 + i)}`;
          const maxSpelers = i < numPoulesOf5 ? 5 : 4;
          currentPoules.push({ naam, maxSpelers, spelers: [] });
        }

        selectedPlayer = null;

        // ‚úÖ Info tonen boven poules
        const poulesInfo = document.getElementById("poulesDistributionInfo");
        if (poulesInfo) {
          poulesInfo.style.display = "block";
          poulesInfo.textContent =
            `Verdeling: ${numPoulesOf5} poule${
              numPoulesOf5 !== 1 ? "s" : ""
            } met 5 spelers, ` +
            `${numPoules - numPoulesOf5} poule${
              numPoules - numPoulesOf5 !== 1 ? "s" : ""
            } met 4 spelers ` +
            `(totaal ${numPlayers} spelers)`;
        }

        showPoulesFeedback(
          `‚úÖ ${numPoules} poules aangemaakt. Klik op een speler links en daarna op een poule om toe te voegen.`,
          "success"
        );

        renderPoules();
        renderAvailablePlayers();

        updateR1PoulesButtons();
      }

      // ----- speler toevoegen aan poule -----

      function addSelectedPlayerToPoule(pouleNaam) {
        if (!selectedPlayer) {
          showPoulesFeedback("‚ö†Ô∏è Selecteer eerst een speler links.", "error");
          return;
        }

        const poule = currentPoules.find((p) => p.naam === pouleNaam);
        if (!poule) return;

        // vol?
        if (poule.spelers.length >= poule.maxSpelers) {
          showPoulesFeedback("‚ùå Deze poule zit vol.", "error");
          return;
        }

        // zit speler al ergens in?
        const alreadyInSomePoule = currentPoules.some((p) =>
          p.spelers.find((sp) => sp.id === selectedPlayer.id)
        );
        if (alreadyInSomePoule) {
          showPoulesFeedback("‚ö†Ô∏è Deze speler zit al in een poule.", "error");
          return;
        }

        // toevoegen
        poule.spelers.push(selectedPlayer);

        // haal speler uit availablePlayers
        availablePlayers = availablePlayers.filter(
          (p) => p.id !== selectedPlayer.id
        );
        selectedPlayer = null;

        // UI opnieuw tekenen
        renderPoules();
        renderAvailablePlayers();
        updateR1PoulesButtons();

        showPoulesFeedback("‚úÖ Speler toegevoegd aan poule.", "success");
      }

      // ----- speler verwijderen uit poule -----

      function removePlayerFromPoule(pouleNaam, spelerId) {
        const poule = currentPoules.find((p) => p.naam === pouleNaam);
        if (!poule) return;

        const idx = poule.spelers.findIndex((sp) => sp.id === spelerId);
        if (idx === -1) return;

        // speler die we terugzetten
        const [removedPlayer] = poule.spelers.splice(idx, 1);

        // alleen deze speler terug naar availablePlayers
        // maar niet dubbel toevoegen als hij toevallig nog vrij stond
        const alreadyFree = availablePlayers.find(
          (p) => p.id === removedPlayer.id
        );
        if (!alreadyFree) {
          availablePlayers.push(removedPlayer);
        }

        // UI opnieuw tekenen
        renderPoules();
        renderAvailablePlayers();
        updateR1PoulesButtons();

        showPoulesFeedback(
          `üóëÔ∏è ${removedPlayer.naam} is weer beschikbaar.`,
          "info"
        );
      }

      // ----- opslaan in Firestore -----

      async function savePoulesToFirestore() {
        if (!activeTournamentId) {
          showPoulesFeedback("‚ö†Ô∏è Geen toernooi actief.", "error");
          return;
        }
        if (currentPoules.length === 0) {
          showPoulesFeedback("‚ö†Ô∏è Geen poules om op te slaan.", "error");
          return;
        }

        // schrijf alle poules onder /toernooien/{id}/poules_r1/*
        const poulesRef = collection(
          db,
          "toernooien",
          activeTournamentId,
          "poules_r1"
        );

        // eerst de oude wissen
        const existing = await getDocs(poulesRef);
        for (const d of existing.docs) {
          await deleteDoc(d.ref);
        }

        // dan de huidige opslaan
        for (const p of currentPoules) {
          await setDoc(doc(poulesRef, p.naam), {
            naam: p.naam,
            maxSpelers: p.maxSpelers,
            spelers: p.spelers,
          });
        }

        showPoulesFeedback(
          "üíæ Poule-indeling opgeslagen in Firestore.",
          "success"
        );

        // ‚úÖ knop uitschakelen na succesvol opslaan
        savePoulesBtn.disabled = true;
        savePoulesBtn.style.opacity = "0.2";
        savePoulesBtn.title = "De poule-indeling is opgeslagen.";
      }

      // ----- wissen/resetten -----

      async function clearPoules() {
        if (!confirm("Weet je zeker dat je alle poules wilt wissen?")) return;

        currentPoules = [];
        selectedPlayer = null;

        poulesContainer.innerHTML = "";
        renderAvailablePlayers(); // alle spelers gaan weer links staan

        // Leegschrijven in Firestore
        if (activeTournamentId) {
          const poulesRef = collection(
            db,
            "toernooien",
            activeTournamentId,
            "poules_r1"
          );
          const existing = await getDocs(poulesRef);
          for (const d of existing.docs) {
            await deleteDoc(d.ref);
          }
        }

        updateR1PoulesButtons();

        showPoulesFeedback("üóëÔ∏è Alle poules gewist.", "success");
      }

      // ----- bestaande indeling laden bij actief toernooi -----

      async function loadPoulesForActiveTournament() {
        if (!activeTournamentId) {
          currentPoules = [];
          r1PoulesExist = false; // Reset status bij geen toernooi
          if (typeof renderPoules === "function") renderPoules(); // Zorg dat de UI leeg is
          if (typeof renderAvailablePlayers === "function")
            renderAvailablePlayers();
          guardSpelersTabAvailability(); // Update knopstatus naar 'disabled'
          return;
        }

        try {
          // Zorg dat allPlayers altijd de spelers van het huidige toernooi bevat
          const playersSnap = await getDocs(
            collection(db, "toernooien", activeTournamentId, "spelers")
          );
          allPlayers = playersSnap.docs.map((d) => ({
            id: d.id,
            ...d.data(),
          }));

          const poulesSnap = await getDocs(
            collection(db, "toernooien", activeTournamentId, "poules_r1")
          );

          // ‚úÖ 1. Stel r1PoulesExist in op basis van het resultaat
          r1PoulesExist = poulesSnap.docs.length > 0;

          currentPoules = poulesSnap.docs.map((d) => ({
            id: d.id,
            ...d.data(),
          }));

          // Zorg ervoor dat de poule-spelers de meest recente spelerdata bevatten
          currentPoules.forEach((poule) => {
            // De 'spelers' array zou moeten bestaan als de poule goed is opgeslagen
            if (!poule.spelers) poule.spelers = [];

            poule.spelers = poule.spelers
              .map((pouleSpeler) => {
                const fullPlayer = allPlayers.find(
                  (ap) => ap.id === pouleSpeler.id
                );
                // Als de speler nog bestaat, geef dan de volledige (up-to-date) speler terug
                return fullPlayer || pouleSpeler;
              })
              .filter((p) => allPlayers.some((ap) => ap.id === p.id)); // Filter spelers die niet meer in allPlayers zitten
          });

          // 3. sync beschikbare spelers op basis van wie al in currentPoules zit
          renderPoules();
          renderAvailablePlayers();

          selectedPlayer = null;

          // Knop 'Poules aanmaken' blokkeren zodra er poules bestaan
          updateR1PoulesButtons();

          // ‚úÖ 2. BELANGRIJK: Update knopstatus op het Spelers-tabblad
          guardSpelersTabAvailability();
        } catch (e) {
          console.error("Fout bij laden poules:", e);
          // Reset de status bij een fout
          r1PoulesExist = false;
          guardSpelersTabAvailability();
        }
      }

      // ===== Export poule-indeling 1e ronde naar Word (DOCX + Save As) =====

      // Algemene helper: "Opslaan als..." dialoog (File System Access API)
      async function saveFileWithDialog(blob, suggestedName) {
        if (window.showSaveFilePicker) {
          // Chromium-browsers: echte Save As dialoog
          const handle = await window.showSaveFilePicker({
            suggestedName,
            types: [
              {
                description: "Word-document",
                accept: {
                  "application/vnd.openxmlformats-officedocument.wordprocessingml.document":
                    [".docx"],
                },
              },
            ],
          });
          const writable = await handle.createWritable();
          await writable.write(blob);
          await writable.close();
        } else {
          // Fallback: normale download (zoals eerst)
          const a = document.createElement("a");
          const url = URL.createObjectURL(blob);
          a.href = url;
          a.download = suggestedName;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          setTimeout(() => URL.revokeObjectURL(url), 0);
        }
      }

      // Bouwt een DOCX-blob met alle poules (2 naast elkaar) + kolom Telefoon
      // Bouwt een DOCX-blob met alle poules (2 naast elkaar) + kolom Telefoon
      // Bouwt een DOCX-blob met alle poules (2 naast elkaar) + kolom Telefoon
      async function buildPoulesWordDocumentBlob() {
        if (!window.docx) {
          throw new Error("docx-library is niet geladen.");
        }

        const {
          Document,
          Packer,
          Paragraph,
          Table,
          TableRow,
          TableCell,
          WidthType,
          HeadingLevel,
          AlignmentType,
          ImageRun,
          TextRun,
          BorderStyle,
        } = docx;

        const noTableBorders = {
          top: { style: BorderStyle.NONE, size: 0, color: "FFFFFF" },
          bottom: { style: BorderStyle.NONE, size: 0, color: "FFFFFF" },
          left: { style: BorderStyle.NONE, size: 0, color: "FFFFFF" },
          right: { style: BorderStyle.NONE, size: 0, color: "FFFFFF" },
          insideHorizontal: {
            style: BorderStyle.NONE,
            size: 0,
            color: "FFFFFF",
          },
          insideVertical: { style: BorderStyle.NONE, size: 0, color: "FFFFFF" },
        };

        const nameEl = document.getElementById("tournamentName");
        const yearEl = document.getElementById("tournamentYear");
        const tName = (nameEl?.value || "").trim();
        const tYear = (yearEl?.value || "").trim();

        const poules = Array.isArray(currentPoules) ? [...currentPoules] : [];
        if (!poules.length) {
          throw new Error("Er zijn geen poules om te exporteren.");
        }

        // Sorteer poules op naam
        poules.sort((a, b) => (a.naam || "").localeCompare(b.naam || ""));

        // Hoofdtitel, bv. "Harm Heemstra Trofee 2025"
        let mainTitle = tName || "Biljarttoernooi";
        if (tYear) {
          mainTitle += ` ${tYear}`;
        }

        // Document met standaard stijl (Arial) en smalle marges
        const doc = new Document({
          creator: "BC Raalte 90",
          title: mainTitle,
          description: "Poule-indeling 1e ronde",
          styles: {
            default: {
              document: {
                run: {
                  font: "Arial", // hier kun je desgewenst een ander font kiezen
                  size: 20, // 10 pt (Word: pt * 2)
                },
                paragraph: {
                  spacing: { after: 10 },
                },
              },
            },
          },
          sections: [], // section voegen we onderaan toe
        });

        // Logo laden
        let logoRun = null;
        try {
          const logoUrl =
            "https://hhweemink.github.io/biljart-toernooi/logobcr90-klein-vk.png";
          const resp = await fetch(logoUrl);
          if (resp.ok) {
            const buf = await resp.arrayBuffer();
            logoRun = new ImageRun({
              data: buf,
              transformation: {
                width: 120,
                height: 120,
              },
            });
          }
        } catch (e) {
          console.warn("Logo kon niet worden geladen voor Word-export:", e);
        }

        const children = [];

        // 1) Titel + subtitel gecentreerd
        children.push(
          new Paragraph({
            children: [
              new TextRun({
                text: mainTitle,
                bold: true,
                size: 32,
              }),
            ],
            alignment: AlignmentType.CENTER,
            spacing: { after: 10 },
          }),
          new Paragraph({
            children: [
              new TextRun({
                text: "Indeling 1e ronde",
                bold: true,
                size: 26,
              }),
            ],
            alignment: AlignmentType.CENTER,
            spacing: { after: 100 },
          })
        );

        // 2) Logo links, tekstvak met border rechts (naast elkaar, onder de kop)
        const headerLayoutTable = new Table({
          width: { size: 100, type: WidthType.PERCENTAGE },
          borders: noTableBorders, // layout-only, geen lijnen
          rows: [
            new TableRow({
              children: [
                new TableCell({
                  width: { size: 15, type: WidthType.PERCENTAGE },
                  borders: noTableBorders,
                  children: logoRun
                    ? [
                        new Paragraph({
                          children: [logoRun],
                          alignment: AlignmentType.LEFT,
                        }),
                      ]
                    : [new Paragraph({ text: "" })],
                }),
                new TableCell({
                  width: { size: 85, type: WidthType.PERCENTAGE },
                  // Dit is het "vak" met border
                  borders: {
                    top: {
                      style: BorderStyle.SINGLE,
                      size: 6,
                      color: "000000",
                    },
                    bottom: {
                      style: BorderStyle.SINGLE,
                      size: 6,
                      color: "000000",
                    },
                    left: {
                      style: BorderStyle.SINGLE,
                      size: 6,
                      color: "000000",
                    },
                    right: {
                      style: BorderStyle.SINGLE,
                      size: 6,
                      color: "000000",
                    },
                    insideHorizontal: {
                      style: BorderStyle.NONE,
                      size: 0,
                      color: "FFFFFF",
                    },
                    insideVertical: {
                      style: BorderStyle.NONE,
                      size: 0,
                      color: "FFFFFF",
                    },
                  },
                  children: [
                    new Paragraph({
                      children: [
                        new TextRun({
                          text: "[Hier kan de uitnodigingstekst / toelichting worden geplaatst.]",
                          italics: true,
                          size: 22,
                        }),
                      ],
                    }),
                  ],
                }),
              ],
            }),
          ],
        });

        children.push(
          headerLayoutTable,
          new Paragraph({
            text: "",
            spacing: { after: 0 }, // of 40, 60‚Ä¶ naar smaak
          })
        );

        // 3) Poules: twee naast elkaar, vaste breedte, kleine tussenruimte
        const poulesPerRow = 2;

        for (let i = 0; i < poules.length; i += poulesPerRow) {
          const groep = poules.slice(i, i + poulesPerRow);

          const outerCells = groep.map((poule) => {
            const spelers = Array.isArray(poule.spelers) ? poule.spelers : [];

            // Kopregel binnen de poule: Nr, Naam, Telefoon, Car.
            // Nr & Car smaller + gecentreerd
            const headerCells = [
              new TableCell({
                width: { size: 8, type: WidthType.PERCENTAGE },
                children: [
                  new Paragraph({
                    children: [new TextRun({ text: "Nr", bold: true })],
                    alignment: AlignmentType.CENTER,
                  }),
                ],
                margins: { top: 20, bottom: 20, left: 120, right: 120 },
              }),
              new TableCell({
                width: { size: 46, type: WidthType.PERCENTAGE },
                children: [
                  new Paragraph({
                    children: [new TextRun({ text: "Naam", bold: true })],
                  }),
                ],
                margins: { top: 20, bottom: 20, left: 120, right: 120 },
              }),
              new TableCell({
                width: { size: 34, type: WidthType.PERCENTAGE },
                children: [
                  new Paragraph({
                    children: [new TextRun({ text: "Telefoon", bold: true })],
                  }),
                ],
                margins: { top: 20, bottom: 20, left: 120, right: 120 },
              }),
              new TableCell({
                width: { size: 12, type: WidthType.PERCENTAGE },
                children: [
                  new Paragraph({
                    children: [new TextRun({ text: "Car.", bold: true })],
                    alignment: AlignmentType.CENTER,
                  }),
                ],
                margins: { top: 20, bottom: 20, left: 120, right: 120 },
              }),
            ];

            // Spelersregels
            const playerRows = spelers.map((speler, idx) => {
              const nummer = (idx + 1).toString();
              const naam = speler.naam || "";
              const telefoon = speler.telefoon || "";
              const car = (speler.caramboles ?? "").toString();

              return new TableRow({
                children: [
                  new TableCell({
                    width: { size: 8, type: WidthType.PERCENTAGE },
                    children: [
                      new Paragraph({
                        text: nummer,
                        alignment: AlignmentType.CENTER,
                      }),
                    ],
                    margins: { top: 20, bottom: 20, left: 120, right: 120 },
                  }),
                  new TableCell({
                    width: { size: 46, type: WidthType.PERCENTAGE },
                    children: [new Paragraph(naam)],
                    margins: { top: 20, bottom: 20, left: 120, right: 120 },
                  }),
                  new TableCell({
                    width: { size: 34, type: WidthType.PERCENTAGE },
                    children: [new Paragraph(telefoon)],
                    margins: { top: 20, bottom: 20, left: 120, right: 120 },
                  }),
                  new TableCell({
                    width: { size: 12, type: WidthType.PERCENTAGE },
                    children: [
                      new Paragraph({
                        text: car,
                        alignment: AlignmentType.CENTER,
                      }),
                    ],
                    margins: { top: 20, bottom: 20, left: 120, right: 120 },
                  }),
                ],
              });
            });

            const innerTable = new Table({
              width: { size: 100, type: WidthType.PERCENTAGE },
              rows: [
                new TableRow({
                  tableHeader: true,
                  children: headerCells,
                }),
                ...playerRows,
              ],
            });

            // Cel voor √©√©n poule (vaste 50% breedte, kleine marge)
            return new TableCell({
              width: { size: 50, type: WidthType.PERCENTAGE }, // vaste breedte per poule
              children: [
                new Paragraph({
                  text: poule.naam || "",
                  heading: HeadingLevel.HEADING_3,
                  spacing: { after: 10 },
                }),
                innerTable,
              ],
              margins: {
                top: 120,
                bottom: 120,
                left: 120,
                right: 120, // kleine "tussenruimte" tussen de twee poules
              },
            });
          });

          // Bij oneven aantal poules: lege rechtercel voor symmetrische layout
          if (outerCells.length < poulesPerRow) {
            outerCells.push(
              new TableCell({
                width: { size: 50, type: WidthType.PERCENTAGE },
                children: [new Paragraph("")],
              })
            );
          }

          const outerTable = new Table({
            width: { size: 100, type: WidthType.PERCENTAGE },
            borders: noTableBorders, // ‚Üê toevoegen
            rows: [
              new TableRow({
                borders: noTableBorders, // ‚Üê toevoegen
                children: outerCells.map(
                  (cell) =>
                    new TableCell({
                      ...cell.options, // behoud originele inhoud
                      borders: noTableBorders, // ‚Üê forceer borderless op cel
                    })
                ),
              }),
            ],
          });

          children.push(outerTable);
        }

        // E√©n sectie met alle content, met smalle marges
        doc.addSection({
          properties: {
            page: {
              margin: {
                top: 720, // 1,27 cm ‚Äì Word "smal"
                bottom: 720,
                left: 720,
                right: 720,
              },
            },
          },
          children,
        });

        const blob = await Packer.toBlob(doc);
        return blob;
      }

      // Dialoog + aanroepen van DOCX-export
      function openExportPoulesWordDialog() {
        if (!Array.isArray(currentPoules) || currentPoules.length === 0) {
          alert("Er is nog geen poule-indeling om te exporteren.");
          return;
        }

        const nameEl = document.getElementById("tournamentName");
        const yearEl = document.getElementById("tournamentYear");
        const tName = (nameEl?.value || "").trim();
        const tYear = (yearEl?.value || "").trim();

        let base = "poules_R1";
        if (tName) {
          const safeName = tName
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "") // accenten weg
            .toLowerCase()
            .replace(/[^a-z0-9\-_\s]/g, "")
            .replace(/\s+/g, "_");
          if (safeName) {
            base += "_" + safeName;
          }
        }
        if (tYear) {
          const safeYear = tYear.toString().replace(/[^0-9]/g, "");
          if (safeYear) {
            base += "_" + safeYear;
          }
        }
        let filename = base + ".docx";

        if (!window.docx) {
          alert(
            "De Word-export (docx) is niet beschikbaar omdat de docx-library niet geladen kon worden."
          );
          return;
        }

        (async () => {
          try {
            const blob = await buildPoulesWordDocumentBlob();
            await saveFileWithDialog(blob, filename);
          } catch (err) {
            console.error("Fout bij genereren of opslaan Word-document:", err);
            alert(
              "Er ging iets mis bij het maken of opslaan van het Word-bestand. Zie de console voor details."
            );
          }
        })();
      }

      // ----- event listeners -----

      createPoulesBtn.addEventListener("click", createPoules);
      savePoulesBtn.addEventListener("click", savePoulesToFirestore);
      clearPoulesBtn.addEventListener("click", clearPoules);

      // NIEUW: basisindeling kiezen
      if (baseLayoutBtn) {
        baseLayoutBtn.addEventListener("click", openBaseLayoutDialog);
      }

      // NIEUW: export poules naar Word
      if (exportPoulesWordBtn) {
        exportPoulesWordBtn.addEventListener(
          "click",
          openExportPoulesWordDialog
        );
      }

      /* ===== EINDE FUNCTIES TAB 1E RONDE POULES ===== */

      /* ===== FUNCTIES TAB 1E RONDE RESULTATEN ===== */

      // --- Elementen ophalen ---
      const noTournamentR1ResNotice = document.getElementById(
        "noTournamentR1ResNotice"
      );
      const r1matchesWrapper = document.getElementById("r1matchesWrapper");
      const r1GlobalStandTable = document.getElementById("r1GlobalStandTable");

      let r1Matches = [];
      let toernooiSettings = {};
      let r1PoulesCache = [];

      // ====== Popup melding ======
      function showPopupMessage(msg, isError = true) {
        const existing = document.getElementById("popupMsg");
        if (existing) existing.remove();

        const popup = document.createElement("div");
        popup.id = "popupMsg";
        popup.style.cssText = `
                            position:fixed; top:20%; left:50%; transform:translateX(-50%);
                            background:${isError ? "#f8d7da" : "#d1e7dd"};
                            color:${isError ? "#842029" : "#0f5132"};
                            border:1px solid ${isError ? "#f5c2c7" : "#badbcc"};
                            border-radius:8px; padding:20px 25px; z-index:2000;
                            box-shadow:0 4px 12px rgba(0,0,0,0.3); text-align:center; min-width:280px;
                          `;
        popup.innerHTML = `
                            <div>${msg}</div>
                            <button style="margin-top:12px; background:#fff; border:1px solid #ccc;
                              border-radius:4px; padding:5px 15px; cursor:pointer;">OK</button>`;
        popup.querySelector("button").onclick = () => popup.remove();
        document.body.appendChild(popup);
      }

      // ====== Scoring overzicht ======
      function renderScoringOverview() {
        const el = document.getElementById("r1ScoringOverview");
        if (!toernooiSettings || !toernooiSettings.punten) {
          el.style.display = "none";
          return;
        }
        const p = toernooiSettings.punten;
        const maxB = toernooiSettings.maxBeurten;
        const maxText = maxB ? maxB : "Niet van toepassing";
        el.style.display = "block";
        el.innerHTML = `
                            <strong>Maximaal aantal beurten:</strong> ${maxText}<br>
                            <strong>Punten:</strong>
                            Winst &lt; max: ${p.winLess}, Gelijk &lt; max: ${p.drawLess}, Verlies &lt; max: ${p.loseLess} |
                            Winst = max: ${p.winMax}, Gelijk = max: ${p.drawMax}, Verlies = max: ${p.loseMax}
                          `;
      }

      // ====== Algemeen overzicht voortgang ======
      function updateOverallProgress() {
        const total = r1Matches.length;
        const played = r1Matches.filter((m) => m.afgerond).length;
        const perc = total > 0 ? Math.round((played / total) * 100) : 0;
        const el = document.getElementById("r1OverallProgress");
        el.style.display = total === 0 ? "none" : "block";
        el.textContent =
          total === 0
            ? ""
            : `Totaal gespeeld: ${played} / ${total} wedstrijden (${perc}%)`;
      }

      function assignRankPoints(sortedArray, field, targetField) {
        let i = 0;
        while (i < sortedArray.length) {
          const startRank = i + 1; // ‚úÖ 1-based
          let j = i + 1;
          while (
            j < sortedArray.length &&
            sortedArray[j][field] === sortedArray[i][field]
          )
            j++;
          const endRank = j;
          const avgRank = (startRank + endRank) / 2;
          for (let k = i; k < j; k++) sortedArray[k][targetField] = avgRank;
          i = j;
        }
      }

      // ====== Globale eindstand berekenen ======

      /* ----------------------------------------------------------
               1E RONDE RESULTATEN ‚Äì globale ranglijst (met poule-factor)
            ---------------------------------------------------------- */
      function buildGlobalRankingFromStats(allMatches, r1Poules) {
        // Map met volledige poule-docs (voor evt. toekomstig gebruik)
        const pouleMap = {};
        (r1Poules || []).forEach((p) => {
          pouleMap[p.id] = p;
        });

        // 1. verzamelen statistieken per speler
        const statsPerSpeler = {};
        allMatches.forEach((m) => {
          if (!m.spelerX || !m.spelerY) return;

          [m.spelerX, m.spelerY].forEach((sp) => {
            if (!statsPerSpeler[sp.id]) {
              statsPerSpeler[sp.id] = {
                spelerId: sp.id,
                naam: sp.naam,
                teMaken: sp.teMaken,
                puntenTotaal: 0,
                carambolesTotaal: 0,
                beurtenTotaal: 0,
                wedstrijdenGespeeld: 0,
                poule: m.poule,
              };
            }
          });

          if (!m.afgerond) return;

          const sx = statsPerSpeler[m.spelerX.id];
          sx.puntenTotaal += Number(m.puntenX) || 0;
          sx.carambolesTotaal += Number(m.gemaakteX) || 0;
          sx.beurtenTotaal += Number(m.beurten) || 0;
          sx.wedstrijdenGespeeld++;

          const sy = statsPerSpeler[m.spelerY.id];
          sy.puntenTotaal += Number(m.puntenY) || 0;
          sy.carambolesTotaal += Number(m.gemaakteY) || 0;
          sy.beurtenTotaal += Number(m.beurten) || 0;
          sy.wedstrijdenGespeeld++;
        });

        // 2. moy, %car en puntenAdj (puntenAdj = al-herberekende punten)
        const allStats = Object.values(statsPerSpeler).map((s) => {
          const moy =
            s.beurtenTotaal > 0 ? s.carambolesTotaal / s.beurtenTotaal : 0;
          const totTeMaken = s.teMaken * (s.wedstrijdenGespeeld || 0);
          const percCar =
            totTeMaken > 0 ? (s.carambolesTotaal / totTeMaken) * 100 : 0;

          // Let op: puntenTotaal is al inclusief factor, via herberekening van de wedstrijden
          const puntenAdj = s.puntenTotaal || 0;

          return { ...s, moy, percCar, puntenAdj };
        });

        // 3. ranking voor punten (op basis van aangepaste punten)
        const byPoints = [...allStats].sort(
          (a, b) => b.puntenAdj - a.puntenAdj
        );
        // ‚úÖ gebruik helper: gelijke punten ‚Üí gemiddelde rang
        assignRankPoints(byPoints, "puntenAdj", "rankPoints_punten");

        // 4. ranking voor % caramboles
        const byPercCar = [...allStats].sort((a, b) => b.percCar - a.percCar);
        // ‚úÖ idem voor %car
        assignRankPoints(byPercCar, "percCar", "rankPoints_percCar");

        // 5. totale ranking (som van de twee rangen)
        allStats.forEach((s) => {
          s.rankTotaal = s.rankPoints_punten + s.rankPoints_percCar;
        });

        return allStats.sort((a, b) => {
          if (a.rankTotaal !== b.rankTotaal) {
            return a.rankTotaal - b.rankTotaal;
          }
          // bij gelijke rankTotaal: eerst hoogste aangepaste punten
          if (b.puntenAdj !== a.puntenAdj) {
            return b.puntenAdj - a.puntenAdj;
          }
          // daarna hoogste %car
          return b.percCar - a.percCar;
        });
      }

      /* ----------------------------------------------------------
         FINALE ‚Äì helpers om kandidaten op te bouwen
      ---------------------------------------------------------- */

      /* ----------------------------------------------------------
         FINALE ‚Äì helpers om kandidaten op te bouwen
      ---------------------------------------------------------- */

      function buildFinaleCandidatesFromR2() {
        // We verwachten dat r2Matches en r2PoulesCache gevuld zijn
        const stats = buildGlobalRankingFromStats(
          r2Matches || [],
          r2PoulesCache || []
        );
        if (!stats || !stats.length) return [];

        // Sorteer op totale rang (staat al gesorteerd, maar voor de zekerheid)
        const ordered = [...stats].sort((a, b) => a.rankTotaal - b.rankTotaal);

        const playersMap = {};
        (currentPlayers || []).forEach((p) => {
          playersMap[p.id] = p;
        });

        // Nieuw: gecombineerde moyenne over 1e + 2e ronde
        const combinedMoyMap = new Map();
        try {
          if (Array.isArray(r1Matches) && r1Matches.length) {
            const allMatches = [...r1Matches, ...(r2Matches || [])];
            const combinedStats = buildGlobalRankingFromStats(allMatches, []);
            combinedStats.forEach((cs) => {
              if (
                typeof cs.moy === "number" &&
                Number.isFinite(cs.moy) &&
                cs.spelerId
              ) {
                combinedMoyMap.set(cs.spelerId, cs.moy);
              }
            });
          }
        } catch (err) {
          console.warn(
            "‚ö†Ô∏è Kon gecombineerde moyenne 1e+2e ronde niet berekenen:",
            err
          );
        }

        const moyCarTable = getActiveMoyCarTable();

        // ‚úÖ niet meer alleen top-8, maar de hele lijst
        return ordered.map((s, index) => {
          const pDoc = playersMap[s.spelerId] || {};

          const carR2 =
            typeof pDoc.carambolesR2 === "number"
              ? pDoc.carambolesR2
              : typeof s.teMaken === "number"
              ? s.teMaken
              : typeof pDoc.caramboles === "number"
              ? pDoc.caramboles
              : 0;

          // Waarde uit gecombineerde moyenne (1e + 2e ronde) via de tabel
          const combMoy = combinedMoyMap.get(s.spelerId);
          let fromTable = null;
          if (
            moyCarTable &&
            typeof combMoy === "number" &&
            Number.isFinite(combMoy)
          ) {
            fromTable = lookupCarambolesFromMoy(combMoy, moyCarTable);
          }

          // Basis: finale-aantal mag nooit lager zijn dan wat er in de 2e ronde te maken was
          const baseFinaleFromTable =
            fromTable != null ? Math.max(fromTable, carR2) : carR2;

          let carFinale;
          let carFinaleFromSaved = false;

          if (
            typeof pDoc.carambolesFinale === "number" &&
            !isNaN(pDoc.carambolesFinale)
          ) {
            // Bewust opgeslagen waarde, maar ook hier nooit lager dan 2e ronde
            carFinale = Math.max(pDoc.carambolesFinale, carR2);
            carFinaleFromSaved = true;
          } else {
            // Geen opgeslagen waarde ‚Üí gebruik tabel/fallback, al met ondergrens carR2
            carFinale = baseFinaleFromTable;
            carFinaleFromSaved = false;
          }

          return {
            spelerId: s.spelerId,
            naam: s.naam,
            // rangnummer in de totaalstand van R2
            r2Rank: index + 1,
            carR2,
            carFinale,
            carFinaleFromSaved,
            withdrawFinale: !!pDoc.withdrawFinale,
            // velden voor eindstand (kunnen leeg zijn)
            finalPos:
              typeof pDoc.finalPos === "number" && pDoc.finalPos > 0
                ? pDoc.finalPos
                : "",
            finalGames:
              typeof pDoc.finalGames === "number" ? pDoc.finalGames : "",
            finalPts: typeof pDoc.finalPts === "number" ? pDoc.finalPts : "",
            finalCaramboles:
              typeof pDoc.finalCaramboles === "number"
                ? pDoc.finalCaramboles
                : "",
            finalHS: typeof pDoc.finalHS === "number" ? pDoc.finalHS : "",
            finalBeurten:
              typeof pDoc.finalBeurten === "number" ? pDoc.finalBeurten : "",
            finalMoy: typeof pDoc.finalMoy === "number" ? pDoc.finalMoy : "",
            finalMoyPerc:
              typeof pDoc.finalMoyPerc === "number" ? pDoc.finalMoyPerc : "",
            finalCarPerc:
              typeof pDoc.finalCarPerc === "number" ? pDoc.finalCarPerc : "",
          };
        });
      }

      /* ----------------------------------------------------------
         FINALE ‚Äì tab laden
      ---------------------------------------------------------- */

      /* ----------------------------------------------------------
         FINALE ‚Äì tab laden
      ---------------------------------------------------------- */

      let finaleAantalDeelnemers = 8; // standaard, per toernooi overschrijfbaar
      let finaleCountSaved = false; // is het aantal finalisten bewust vastgelegd?
      let finaleCarambolesSaved = false; // zijn de caramboles voor de finale bewust opgeslagen?
      let finaleResultsSaved = false; // is er al (deels) een eindstand ingevuld/bewaard?

      async function loadFinaleTab() {
        const noT = document.getElementById("finaleNoTournament");
        const content = document.getElementById("finaleContent");
        const aantalInput = document.getElementById("finaleAantalInput");

        if (!activeTournamentId) {
          if (noT) noT.style.display = "block";
          if (content) content.style.display = "none";
          return;
        }
        if (noT) noT.style.display = "none";
        if (content) content.style.display = "block";

        // flags resetten voor deze load
        finaleCountSaved = false;
        finaleCarambolesSaved = false;
        finaleResultsSaved = false;

        // 1) Finale-aantal uit toernooidocument ophalen (met fallback 8)
        try {
          const tRef = doc(db, "toernooien", activeTournamentId);
          const tSnap = await getDoc(tRef);
          const data = tSnap.exists() ? tSnap.data() : {};
          const storedAantal =
            typeof data.finaleAantalDeelnemers === "number"
              ? data.finaleAantalDeelnemers
              : 8;

          finaleCountSaved =
            typeof data.finaleAantalDeelnemers === "number" && storedAantal > 0;

          finaleAantalDeelnemers = storedAantal > 0 ? storedAantal : 8;
          if (aantalInput) {
            aantalInput.value = String(finaleAantalDeelnemers);
          }
        } catch (err) {
          console.warn("‚ö†Ô∏è Kon finaleAantalDeelnemers niet laden:", err);
          finaleAantalDeelnemers = 8;
          if (aantalInput) {
            aantalInput.value = "8";
          }
        }

        // 1b) Spelers opnieuw ophalen zodat finale-velden uit Firestore komen
        try {
          if (typeof loadPlayersForActiveTournament === "function") {
            await loadPlayersForActiveTournament();
          }
        } catch (err) {
          console.warn("‚ö†Ô∏è Kon spelers voor finale niet opnieuw laden:", err);
        }

        // 2) Zorg dat we r2Matches / r2PoulesCache hebben
        try {
          await loadR2MatchesFromFirestore();
        } catch (err) {
          console.error("Fout bij laden 2e ronde voor finale:", err);
          showFinaleFeedback(
            "‚ùå Kan de totaalstand van de 2e ronde niet laden. Controleer het tabblad 2e ronde resultaten.",
            "error"
          );
          return;
        }

        // 3) Finale-kandidaten opbouwen
        finaleCandidates = buildFinaleCandidatesFromR2() || [];

        if (!finaleCandidates.length) {
          showFinaleFeedback(
            "Er is nog geen (volledige) totaalstand van de 2e ronde. De finale kan pas worden samengesteld als alle uitslagen van de 2e ronde bekend zijn.",
            "info"
          );
        } else {
          showFinaleFeedback(
            `De totaalstand van de 2e ronde is geladen. De eerste ${finaleAantalDeelnemers} spelers (boven de streep) zijn de finalisten. Bij afmelding schuift de volgende speler automatisch door.`,
            "success"
          );
        }

        // Op basis van bestaande data bepalen of caramboles/eindstand al eens zijn opgeslagen
        if (finaleCandidates.length) {
          // caramboles finale: alleen "bewust opgeslagen" als ze uit Firestore komen
          finaleCarambolesSaved = finaleCandidates.some(
            (c) =>
              c.carFinaleFromSaved === true ||
              (typeof c.carFinaleFromSaved === "undefined" &&
                typeof c.carFinale === "number" &&
                !isNaN(c.carFinale))
          );

          // eindstand ingevuld? (een van de eindstandvelden bevat een waarde)
          finaleResultsSaved = finaleCandidates.some(
            (c) =>
              c.finalPos !== "" ||
              c.finalGames !== "" ||
              c.finalPts !== "" ||
              c.finalCaramboles !== "" ||
              c.finalHS !== "" ||
              c.finalBeurten !== "" ||
              c.finalMoy !== "" ||
              c.finalMoyPerc !== "" ||
              c.finalCarPerc !== ""
          );
        }

        renderFinaleSelection();
        renderFinaleResultsInputs();
        updateFinaleButtons();
      }

      function computeFinaleOrdering() {
        if (!Array.isArray(finaleCandidates) || !finaleCandidates.length) {
          return { ordered: [], finalistIds: new Set(), cutIndex: -1 };
        }

        const maxFinalistsRaw = Number(finaleAantalDeelnemers);
        const maxFinalists =
          Number.isFinite(maxFinalistsRaw) && maxFinalistsRaw > 0
            ? maxFinalistsRaw
            : 8;

        // Actieve (niet-afgemelde) spelers op volgorde van R2-rang
        const active = finaleCandidates
          .filter((c) => !c.withdrawFinale)
          .sort((a, b) => a.r2Rank - b.r2Rank);

        const finalists = active.slice(0, maxFinalists);
        const nonFinalActive = active.slice(maxFinalists);

        // Afgemelde spelers onderaan (wel op R2-rang gesorteerd)
        const withdrawn = finaleCandidates
          .filter((c) => c.withdrawFinale)
          .sort((a, b) => a.r2Rank - b.r2Rank);

        const ordered = [...finalists, ...nonFinalActive, ...withdrawn];
        const finalistIds = new Set(finalists.map((c) => c.spelerId));
        const cutIndex = finalists.length ? finalists.length - 1 : -1;

        return { ordered, finalistIds, cutIndex };
      }

      function renderFinaleSelection() {
        const tbody = document.getElementById("finalePlayersBody");
        if (!tbody) return;
        tbody.innerHTML = "";

        const { ordered, finalistIds, cutIndex } = computeFinaleOrdering();

        if (!ordered.length) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" style="padding:8px;color:#777;">
                Nog geen finalisten beschikbaar.
              </td>
            </tr>
          `;
          return;
        }

        ordered.forEach((c, index) => {
          const isCutRow = index === cutIndex;
          const borderStyle = isCutRow
            ? "border-bottom:2px solid #333;"
            : "border-bottom:1px solid #eee;";

          // üî¥ Nieuw: visuele indicatie voor afgemelde spelers
          const rowStyle = c.withdrawFinale
            ? "background:#ffe6e6;" // lichtrood
            : ""; // normale achtergrond

          const afgemeldText = c.withdrawFinale
            ? `<span style="color:#b30000;font-size:0.85em;">(afgemeld)</span>`
            : "";

          const tr = document.createElement("tr");
          tr.dataset.spelerId = c.spelerId;
          tr.style.cssText = rowStyle;

          tr.innerHTML = `
            <td style="padding:4px;text-align:left;${borderStyle}">
              ${c.r2Rank}
            </td>
            <td style="padding:4px;text-align:center;${borderStyle}">
              <input
                type="checkbox"
                class="finale-withdraw-checkbox"
                ${c.withdrawFinale ? "checked" : ""}
              />
            </td>
            <td style="padding:4px;text-align:left;${borderStyle}">
              ${c.naam} ${afgemeldText}
            </td>
            <td style="padding:4px;text-align:right;${borderStyle}">
              ${c.carR2 ?? ""}
            </td>
            <td style="padding:4px;text-align:right;${borderStyle}">
              <input
                type="number"
                class="finale-car-input"
                min="0"
                style="width:70px;text-align:right;"
                value="${c.carFinale ?? ""}"
              />
            </td>
          `;

          tbody.appendChild(tr);
        });

        // Event-handlers voor afmelden + caramboles
        tbody.querySelectorAll(".finale-withdraw-checkbox").forEach((cb) => {
          // Na vastleggen van de eindstand mag je geen finalisten meer afmelden
          if (finaleResultsSaved) {
            cb.disabled = true;
            cb.style.cursor = "not-allowed";
            return;
          }

          cb.addEventListener("change", () => {
            const tr = cb.closest("tr");
            const id = tr?.dataset.spelerId;
            const c = finaleCandidates.find((x) => x.spelerId === id);
            if (!c) return;
            c.withdrawFinale = cb.checked;

            // Zodra iemand wordt afgemeld ‚Üí lijst opnieuw opbouwen (verschuiven + kleurtjes)
            renderFinaleSelection();
            renderFinaleResultsInputs();
          });
        });

        tbody.querySelectorAll(".finale-car-input").forEach((inp) => {
          inp.addEventListener("input", () => {
            const tr = inp.closest("tr");
            const id = tr?.dataset.spelerId;
            const c = finaleCandidates.find((x) => x.spelerId === id);
            if (!c) return;
            const v = Number(inp.value);
            c.carFinale = isNaN(v) ? 0 : v;
          });
        });
      }

      function renderFinaleResultsInputs() {
        const tbody = document.getElementById("finaleResultsBody");
        if (!tbody) return;
        tbody.innerHTML = "";

        const { ordered, finalistIds } = computeFinaleOrdering();
        let finalists = ordered.filter((c) => finalistIds.has(c.spelerId));

        if (!finalists.length) {
          tbody.innerHTML = `
            <tr>
              <td colspan="11" style="padding:8px;color:#777;">
                Nog geen finalisten beschikbaar.
              </td>
            </tr>
          `;
          return;
        }

        // ‚úÖ Sorteer weergave van de eindstand op Positie-kolom
        finalists = [...finalists].sort((a, b) => {
          const pa = Number(a.finalPos);
          const pb = Number(b.finalPos);

          const validA = Number.isFinite(pa);
          const validB = Number.isFinite(pb);

          if (validA && validB) return pa - pb; // beide geldig ‚Üí echte sortering
          if (validA) return -1; // A geldig, B niet ‚Üí A boven B
          if (validB) return 1; // B geldig, A niet ‚Üí B boven A
          return 0; // beide ongeldig ‚Üí volgorde gelijk
        });

        finalists.forEach((c) => {
          const tr = document.createElement("tr");
          tr.dataset.spelerId = c.spelerId;
          tr.innerHTML = `
            <td style="padding:4px;text-align:right;border-bottom:1px solid #eee;">
              <input
                type="number"
                class="finale-pos-input"
                min="1"
                style="width:30px;text-align:right;"
                value="${c.finalPos ?? ""}"
              />
            </td>
            <td style="padding:4px;text-align:left;border-bottom:1px solid #eee;">
              ${c.naam}
            </td>
            <td style="padding:4px;text-align:right;border-bottom:1px solid #eee;">
              ${c.carFinale ?? ""}
            </td>
            <td style="padding:4px;text-align:right;border-bottom:1px solid #eee;">
              <input
                type="number"
                class="finale-games-input"
                min="0"
                style="width:30px;text-align:right;"
                value="${c.finalGames ?? ""}"
              />
            </td>
            <td style="padding:4px;text-align:right;border-bottom:1px solid #eee;">
              <input
                type="number"
                class="finale-pts-input"
                min="0"
                style="width:40px;text-align:right;"
                value="${c.finalPts ?? ""}"
              />
            </td>
            <td style="padding:4px;text-align:right;border-bottom:1px solid #eee;">
              <input
                type="number"
                class="finale-caramboles-input"
                min="0"
                style="width:50px;text-align:right;"
                value="${c.finalCaramboles ?? ""}"
              />
            </td>
            <td style="padding:4px;text-align:right;border-bottom:1px solid #eee;">
              <input
                type="number"
                class="finale-hs-input"
                min="0"
                style="width:40px;text-align:right;"
                value="${c.finalHS ?? ""}"
              />
            </td>
            <td style="padding:4px;text-align:right;border-bottom:1px solid #eee;">
              <input
                type="number"
                class="finale-beurten-input"
                min="0"
                style="width:50px;text-align:right;"
                value="${c.finalBeurten ?? ""}"
              />
            </td>
            <td style="padding:4px;text-align:right;border-bottom:1px solid #eee;">
              <input
                type="number"
                step="0.001"
                class="finale-moy-input"
                min="0"
                style="width:60px;text-align:right;"
                value="${c.finalMoy ?? ""}"
              />
            </td>
            <td style="padding:4px;text-align:right;border-bottom:1px solid #eee;">
              <input
                type="number"
                step="0.1"
                class="finale-moyperc-input"
                min="0"
                style="width:60px;text-align:right;"
                value="${c.finalMoyPerc ?? ""}"
              />
            </td>
            <td style="padding:4px;text-align:right;border-bottom:1px solid #eee;">
              <input
                type="number"
                step="0.1"
                class="finale-carperc-input"
                min="0"
                style="width:60px;text-align:right;"
                value="${c.finalCarPerc ?? ""}"
              />
            </td>
          `;
          tbody.appendChild(tr);
        });

        // Zelfde updateFromRow-logica als je huidige code
        const updateFromRow = (tr, field, selector) => {
          const id = tr?.dataset.spelerId;
          const c = finaleCandidates.find((x) => x.spelerId === id);
          if (!c) return;
          const inp = tr.querySelector(selector);
          if (!inp) return;
          const v = inp.value;
          c[field] = v === "" ? "" : Number(v);
        };

        tbody.querySelectorAll("tr").forEach((tr) => {
          tr.querySelectorAll("input").forEach((inp) => {
            inp.addEventListener("input", () => {
              if (inp.classList.contains("finale-pos-input")) {
                updateFromRow(tr, "finalPos", ".finale-pos-input");
              } else if (inp.classList.contains("finale-games-input")) {
                updateFromRow(tr, "finalGames", ".finale-games-input");
              } else if (inp.classList.contains("finale-pts-input")) {
                updateFromRow(tr, "finalPts", ".finale-pts-input");
              } else if (inp.classList.contains("finale-caramboles-input")) {
                updateFromRow(
                  tr,
                  "finalCaramboles",
                  ".finale-caramboles-input"
                );
              } else if (inp.classList.contains("finale-hs-input")) {
                updateFromRow(tr, "finalHS", ".finale-hs-input");
              } else if (inp.classList.contains("finale-beurten-input")) {
                updateFromRow(tr, "finalBeurten", ".finale-beurten-input");
              } else if (inp.classList.contains("finale-moy-input")) {
                updateFromRow(tr, "finalMoy", ".finale-moy-input");
              } else if (inp.classList.contains("finale-moyperc-input")) {
                updateFromRow(tr, "finalMoyPerc", ".finale-moyperc-input");
              } else if (inp.classList.contains("finale-carperc-input")) {
                updateFromRow(tr, "finalCarPerc", ".finale-carperc-input");
              }
            });
          });
        });
      }

      async function saveFinaleCarambolesAndWithdraw() {
        if (!activeTournamentId) {
          showFinaleFeedback(
            "‚ùå Geen toernooi geselecteerd. Kies eerst een toernooi.",
            "error"
          );
          return;
        }
        if (!finaleCandidates.length) {
          showFinaleFeedback(
            "Geen finalisten om op te slaan. Controleer de totaalstand van de 2e ronde.",
            "error"
          );
          return;
        }

        try {
          const batch = writeBatch(db);
          finaleCandidates.forEach((c) => {
            const ref = doc(
              db,
              "toernooien",
              activeTournamentId,
              "spelers",
              c.spelerId
            );
            const car =
              typeof c.carFinale === "number" && !isNaN(c.carFinale)
                ? c.carFinale
                : 0;
            batch.update(ref, {
              carambolesFinale: car,
              withdrawFinale: !!c.withdrawFinale,
            });
          });

          await batch.commit();
          finaleCarambolesSaved = true;
          showFinaleFeedback(
            "‚úÖ Caramboles finale en afmeldingen opgeslagen.",
            "success"
          );
        } catch (err) {
          console.error("Fout bij opslaan finale caramboles:", err);
          showFinaleFeedback(
            "‚ùå Fout bij opslaan van de caramboles voor de finale.",
            "error"
          );
        }
      }

      async function saveFinaleResults() {
        if (!activeTournamentId) {
          showFinaleFeedback(
            "‚ùå Geen toernooi geselecteerd. Kies eerst een toernooi.",
            "error"
          );
          return;
        }
        if (!finaleCandidates.length) {
          showFinaleFeedback(
            "Geen finalisten om op te slaan. Controleer de totaalstand van de 2e ronde.",
            "error"
          );
          return;
        }

        const toNumberOrNull = (v) => {
          if (v === "" || v === null || typeof v === "undefined") return null;
          const n = Number(v);
          return isNaN(n) ? null : n;
        };

        try {
          const batch = writeBatch(db);

          finaleCandidates.forEach((c) => {
            const ref = doc(
              db,
              "toernooien",
              activeTournamentId,
              "spelers",
              c.spelerId
            );
            batch.update(ref, {
              finalPos: toNumberOrNull(c.finalPos),
              finalGames: toNumberOrNull(c.finalGames),
              finalPts: toNumberOrNull(c.finalPts),
              finalCaramboles: toNumberOrNull(c.finalCaramboles),
              finalHS: toNumberOrNull(c.finalHS),
              finalBeurten: toNumberOrNull(c.finalBeurten),
              finalMoy: toNumberOrNull(c.finalMoy),
              finalMoyPerc: toNumberOrNull(c.finalMoyPerc),
              finalCarPerc: toNumberOrNull(c.finalCarPerc),
            });
          });

          await batch.commit();
          finaleResultsSaved = true;

          // Sorteer lokale weergave strikt op positie (Positie-kolom)
          finaleCandidates.sort((a, b) => {
            const pa = Number(a.finalPos);
            const pb = Number(b.finalPos);

            // Niet-invulbare of lege posities komen onderaan
            if (!Number.isFinite(pa)) return 1;
            if (!Number.isFinite(pb)) return -1;

            return pa - pb;
          });

          // Na sorteren opnieuw tekenen
          renderFinaleResultsInputs();

          showFinaleFeedback("‚úÖ Eindstand finale opgeslagen.", "success");
        } catch (err) {
          console.error("Fout bij opslaan eindstand finale:", err);
          showFinaleFeedback(
            "‚ùå Fout bij opslaan van de eindstand van de finale.",
            "error"
          );
        }
      }

      async function resetFinaleAll() {
        if (!activeTournamentId) {
          showFinaleFeedback(
            "Er is geen actief toernooi geselecteerd.",
            "error"
          );
          return;
        }

        const ok = window.confirm(
          "Weet je zeker dat je alle finalegegevens wilt wissen?\n\n" +
            "- alle ingevoerde eindstand (posities, moyennes, etc.)\n" +
            "- alle caramboles voor de finale\n" +
            "- alle markeringen 'afgemeld voor finale'\n" +
            "- en het aantal finalisten wordt teruggezet naar 8."
        );
        if (!ok) return;

        try {
          const batch = writeBatch(db);

          // 1) Toernooi: aantal finalisten terug naar 8
          const tRef = doc(db, "toernooien", activeTournamentId);
          batch.update(tRef, { finaleAantalDeelnemers: 8 });

          // 2) Finalevelden bij alle huidige kandidaten leegmaken
          (finaleCandidates || []).forEach((c) => {
            const sRef = doc(
              db,
              "toernooien",
              activeTournamentId,
              "spelers",
              c.spelerId
            );
            batch.update(sRef, {
              carambolesFinale: null,
              withdrawFinale: null,
              finalPos: null,
              finalGames: null,
              finalPts: null,
              finalCaramboles: null,
              finalHS: null,
              finalBeurten: null,
              finalMoy: null,
              finalMoyPerc: null,
              finalCarPerc: null,
            });
          });

          await batch.commit();

          // 3) Lokale state & UI resetten
          finaleAantalDeelnemers = 8;
          finaleCountSaved = false;
          finaleCarambolesSaved = false;
          finaleResultsSaved = false;

          const aantalInput = document.getElementById("finaleAantalInput");
          if (aantalInput) {
            aantalInput.value = "8";
          }

          (finaleCandidates || []).forEach((c) => {
            c.carFinale = undefined;
            c.withdrawFinale = false;
            c.finalPos = "";
            c.finalGames = "";
            c.finalPts = "";
            c.finalCaramboles = "";
            c.finalHS = "";
            c.finalBeurten = "";
            c.finalMoy = "";
            c.finalMoyPerc = "";
            c.finalCarPerc = "";
          });

          renderFinaleSelection();
          renderFinaleResultsInputs();
          updateFinaleButtons();

          showFinaleFeedback(
            "Alle finalegegevens zijn gewist en teruggezet naar de beginsituatie (8 finalisten).",
            "success"
          );
        } catch (err) {
          console.error("Fout bij wissen finale:", err);
          showFinaleFeedback(
            "‚ùå Fout bij het wissen van de finalegegevens.",
            "error"
          );
        }
      }

      /* ----------------------------------------------------------
               FINALE ‚Äì knoppenlogica
            ---------------------------------------------------------- */

      function updateFinaleButtons() {
        const hasTournament = !!activeTournamentId;
        const hasCandidates =
          Array.isArray(finaleCandidates) && finaleCandidates.length > 0;

        const aantalInput = document.getElementById("finaleAantalInput");
        const saveCountBtn = document.getElementById("finaleSaveCountBtn");
        const saveCarBtn = document.getElementById("finaleSaveCarambolesBtn");
        const saveResBtn = document.getElementById("finaleSaveResultsBtn");
        const clearBtn = document.getElementById("finaleClearBtn");

        const aantalVal = aantalInput ? Number(aantalInput.value) : NaN;
        const countValidInput =
          Number.isFinite(aantalVal) && aantalVal > 0 && aantalVal <= 32;

        const hasWithdraw =
          Array.isArray(finaleCandidates) &&
          finaleCandidates.some((c) => !!c.withdrawFinale);

        // 1) Vastleggen aantal finalisten (beginstap)
        //    Actief als:
        //    - geldig aantal
        //    - er is een toernooi + kandidaten
        //    - nog geen afmeldingen
        //    - nog geen (deel)eindstand vastgelegd
        if (saveCountBtn) {
          const canSaveCount =
            hasTournament &&
            hasCandidates &&
            countValidInput &&
            !hasWithdraw &&
            !finaleResultsSaved;
          saveCountBtn.disabled = !canSaveCount;
          saveCountBtn.style.opacity = canSaveCount ? "1" : "0.4";
          saveCountBtn.style.cursor = canSaveCount ? "pointer" : "not-allowed";
        }

        // 2) Opslaan car. finale
        //    - toernooi + kandidaten
        //    - aantal finalisten is vastgelegd
        //    - nog geen eindstand vastgelegd
        if (saveCarBtn) {
          const canSaveCar =
            hasTournament &&
            hasCandidates &&
            finaleCountSaved &&
            !finaleResultsSaved;
          saveCarBtn.disabled = !canSaveCar;
          saveCarBtn.style.opacity = canSaveCar ? "1" : "0.4";
          saveCarBtn.style.cursor = canSaveCar ? "pointer" : "not-allowed";
        }

        // 3) Opslaan eindstand finale
        //    - toernooi + kandidaten
        //    - aantal finalisten vastgelegd
        //    - caramboles finale zijn opgeslagen
        //    (mag ook als er al eerder een eindstand is opgeslagen, voor correcties)
        if (saveResBtn) {
          const canSaveRes =
            hasTournament &&
            hasCandidates &&
            finaleCountSaved &&
            finaleCarambolesSaved;
          saveResBtn.disabled = !canSaveRes;
          saveResBtn.style.opacity = canSaveRes ? "1" : "0.4";
          saveResBtn.style.cursor = canSaveRes ? "pointer" : "not-allowed";
        }

        // 4) Alles wissen ‚Äì zolang er een toernooi actief is
        if (clearBtn) {
          const canClear = hasTournament;
          clearBtn.disabled = !canClear;
          clearBtn.style.opacity = canClear ? "1" : "0.4";
          clearBtn.style.cursor = canClear ? "pointer" : "not-allowed";
        }
      }

      async function saveFinaleCount() {
        if (!activeTournamentId) {
          showFinaleFeedback(
            "Er is geen actief toernooi geselecteerd.",
            "error"
          );
          return;
        }
        const input = document.getElementById("finaleAantalInput");
        if (!input) return;

        const val = Number(input.value);
        if (!Number.isFinite(val) || val <= 0 || val > 32) {
          showFinaleFeedback(
            "Geef een geldig aantal finalisten (1‚Äì32).",
            "error"
          );
          return;
        }

        try {
          const tRef = doc(db, "toernooien", activeTournamentId);
          await updateDoc(tRef, { finaleAantalDeelnemers: val });
          finaleAantalDeelnemers = val;
          finaleCountSaved = true;
          showFinaleFeedback(
            `Aantal finalisten is vastgelegd op ${val}.`,
            "success"
          );

          // Opnieuw tekenen met nieuwe streep
          renderFinaleSelection();
          renderFinaleResultsInputs();
        } catch (err) {
          console.error("Fout bij opslaan finaleAantalDeelnemers:", err);
          showFinaleFeedback(
            "‚ùå Opslaan van het aantal finalisten is mislukt.",
            "error"
          );
        } finally {
          updateFinaleButtons();
        }
      }

      /* ----------------------------------------------------------
               FINALE ‚Äì event listeners
            ---------------------------------------------------------- */

      // Aantal finalisten ‚Äì bij tikken direct knoppenstatus updaten
      const finaleAantalInput = document.getElementById("finaleAantalInput");
      if (finaleAantalInput) {
        finaleAantalInput.addEventListener("input", () => {
          updateFinaleButtons();
        });
      }

      // Vastleggen aantal finalisten
      const finaleSaveCountBtn = document.getElementById("finaleSaveCountBtn");
      if (finaleSaveCountBtn) {
        finaleSaveCountBtn.addEventListener("click", () => {
          saveFinaleCount();
        });
      }

      // Opslaan car. finale (caramboles + afmeldingen)
      const finaleSaveCarambolesBtn = document.getElementById(
        "finaleSaveCarambolesBtn"
      );
      if (finaleSaveCarambolesBtn) {
        finaleSaveCarambolesBtn.addEventListener("click", async () => {
          await saveFinaleCarambolesAndWithdraw();
          updateFinaleButtons();
        });
      }

      // Opslaan eindstand finale
      const finaleSaveResultsBtn = document.getElementById(
        "finaleSaveResultsBtn"
      );
      if (finaleSaveResultsBtn) {
        finaleSaveResultsBtn.addEventListener("click", async () => {
          await saveFinaleResults();
          updateFinaleButtons();
        });
      }

      // Alles wissen (finale volledig resetten)
      const finaleClearBtn = document.getElementById("finaleClearBtn");
      if (finaleClearBtn) {
        finaleClearBtn.addEventListener("click", async () => {
          await resetFinaleAll();
        });
      }

      // Alle gespeelde wedstrijden in een poule opnieuw doorrekenen met de huidige factor
      async function recalcR1PouleMatches(pouleId) {
        if (!activeTournamentId) return;

        const pouleDoc = r1PoulesCache.find((p) => p.id === pouleId);
        if (!pouleDoc) return;

        // Pak alle wedstrijden van deze poule
        const matchesInPoule = r1Matches.filter((m) => m.poule === pouleId);

        for (const m of matchesInPoule) {
          // alleen afgeronde wedstrijden opnieuw berekenen
          if (!m.afgerond) continue;

          const gX = Number(m.gemaakteX) || 0;
          const gY = Number(m.gemaakteY) || 0;
          const b = Number(m.beurten) || 0;

          const { pX, pY, uitslag } = calcR1Points(
            gX,
            gY,
            b,
            toernooiSettings.maxBeurten || 0,
            m.spelerX.teMaken,
            m.spelerY.teMaken,
            toernooiSettings.punten,
            pouleDoc
          );

          // Opslaan in Firestore
          await saveMatchResultFields(m.id, {
            gemaakteX: gX,
            gemaakteY: gY,
            beurten: b,
            puntenX: pX,
            puntenY: pY,
            uitslag,
          });

          // Lokale cache ook bijwerken
          m.puntenX = pX;
          m.puntenY = pY;
          m.uitslag = uitslag;
        }

        // UI opnieuw opbouwen met de nieuwe punten
        renderR1Matches();
      }

      // =============================
      // R1 RESULTATEN ‚Äì knopstatussen
      // =============================
      // =============================
      // R1 RESULTATEN ‚Äì knopstatussen
      // =============================
      function updateR1ResultsButtons() {
        const createBtn = document.getElementById("createMatchesBtn");
        const deleteBtn = document.getElementById("deleteMatchesBtn");
        if (!createBtn || !deleteBtn) return;

        const hasTournament = !!activeTournamentId;

        // Wedstrijdschema bestaat zodra er r1Matches zijn
        const hasSchedule = Array.isArray(r1Matches) && r1Matches.length > 0;

        // Poule-indeling moet al opgeslagen/bestaan
        const hasPoules = !!r1PoulesExist;

        // Er is al minstens 1 uitslag opgeslagen als er een afgeronde match is
        const hasAnyResult =
          hasSchedule && r1Matches.some((m) => m && m.afgerond === true);

        // ‚úÖ NIEUW / FIX: R2 poules bestaan?
        const hasR2PoulesLocal =
          Array.isArray(r2CurrentPoules) && r2CurrentPoules.length > 0;

        // 1) Wedstrijdschema aanmaken:
        // actief als: geen schema + w√©l poules + toernooi actief
        createBtn.disabled = !hasTournament || hasSchedule || !hasPoules;

        // 2) Wedstrijden wissen:
        // actief als: schema bestaat + g√©√©n enkele uitslag
        deleteBtn.disabled = !hasTournament || !hasSchedule || hasAnyResult;

        // extra voorwaarde: als R2-poules bestaan ‚Üí nooit wissen
        if (hasR2PoulesLocal) {
          deleteBtn.disabled = true;
        }

        [createBtn, deleteBtn].forEach((btn) => {
          btn.style.opacity = btn.disabled ? "0.4" : "1";
          btn.style.cursor = btn.disabled ? "not-allowed" : "pointer";
        });
      }

      // =============================
      // R2 RESULTATEN ‚Äì knopstatussen
      // =============================
      function updateR2ResultsButtons() {
        const createBtn = document.getElementById("createR2MatchesBtn");
        const deleteBtn = document.getElementById("deleteR2MatchesBtn");
        if (!createBtn || !deleteBtn) return;

        const hasTournament = !!activeTournamentId;

        // Wedstrijdschema 2e ronde bestaat zodra er r2Matches zijn
        const hasR2Schedule = Array.isArray(r2Matches) && r2Matches.length > 0;

        // R2-poules moeten opgeslagen/bestaan (Firestore) ‚Üí r2PoulesCache is leidend
        const hasR2PoulesSaved =
          Array.isArray(r2PoulesCache) && r2PoulesCache.length > 0;

        // Er is al minstens 1 uitslag opgeslagen als er een afgeronde match is
        const hasAnyR2Result =
          hasR2Schedule && r2Matches.some((m) => m && m.afgerond === true);

        // 1) Wedstrijdschema aanmaken:
        // actief als: geen schema + w√©l poules + toernooi actief
        createBtn.disabled =
          !hasTournament || hasR2Schedule || !hasR2PoulesSaved;

        // 2) Wedstrijden wissen:
        // actief als: schema bestaat + g√©√©n enkele uitslag
        deleteBtn.disabled = !hasTournament || !hasR2Schedule || hasAnyR2Result;

        // Visuele indicatie (zelfde stijl als elders)
        [createBtn, deleteBtn].forEach((btn) => {
          btn.style.opacity = btn.disabled ? "0.4" : "1";
          btn.style.cursor = btn.disabled ? "not-allowed" : "pointer";
        });
      }

      // ====== Wedstrijden ophalen ======
      async function loadR1MatchesFromFirestore() {
        if (!activeTournamentId) {
          noTournamentR1ResNotice.style.display = "block";
          return;
        }
        noTournamentR1ResNotice.style.display = "none";

        const tournRef = doc(db, "toernooien", activeTournamentId);
        const tournSnap = await getDoc(tournRef);
        toernooiSettings = tournSnap.data() || {};
        renderScoringOverview();

        const matchesRef = collection(
          db,
          "toernooien",
          activeTournamentId,
          "r1_wedstrijden"
        );
        const snap = await getDocs(matchesRef);
        r1Matches = snap.docs.map((d) => ({ id: d.id, ...d.data() }));

        const poulesRef = collection(
          db,
          "toernooien",
          activeTournamentId,
          "poules_r1"
        );
        const poulesSnap = await getDocs(poulesRef);
        r1PoulesCache = poulesSnap.docs.map((d) => ({ id: d.id, ...d.data() }));

        renderR1Matches();

        updateR1ResultsButtons();
        updateR1PoulesButtons(); // zodat poules-tab ook meteen meeloopt
      }

      /* ----------------------------------------------------------
               1E RONDE RESULTATEN ‚Äì helper: thuis/uit sorteren
            ---------------------------------------------------------- */
      function sortHomeAway(arr) {
        const groups = new Map();
        arr.forEach((m) => {
          const key = [m.spelerX.id, m.spelerY.id].sort().join("_");
          if (!groups.has(key)) groups.set(key, []);
          groups.get(key).push(m);
        });
        const ordered = [];
        groups.forEach((matches) => {
          if (matches.length === 1) {
            ordered.push(matches[0]);
            return;
          }
          // consistente volgorde: A‚ÄìB v√≥√≥r B‚ÄìA (alfabetisch op naam)
          matches.sort((a, b) => {
            const ka = `${a.spelerX.naam}‚Äî${a.spelerY.naam}`.toLowerCase();
            const kb = `${b.spelerX.naam}‚Äî${b.spelerY.naam}`.toLowerCase();
            return ka.localeCompare(kb);
          });
          matches.forEach((m) => ordered.push(m));
        });
        return ordered;
      }

      // ====== Wedstrijden tonen ======
      /* ----------------------------------------------------------
               1E RONDE RESULTATEN ‚Äì render wedstrijden + nieuwe stand
            ---------------------------------------------------------- */
      function renderR1Matches() {
        r1matchesWrapper.innerHTML = "";
        if (!r1Matches.length) {
          r1matchesWrapper.innerHTML =
            "<p style='color:#777'>Geen wedstrijden gevonden.</p>";
          updateOverallProgress();
          r1GlobalStandTable.innerHTML = "";
          return;
        }
        updateOverallProgress();

        const pouleMap = {};
        r1Matches.forEach((m) => {
          if (!pouleMap[m.poule]) pouleMap[m.poule] = [];
          pouleMap[m.poule].push(m);
        });

        Object.keys(pouleMap)
          .sort()
          .forEach((pouleNaam) => {
            const matchesRaw = pouleMap[pouleNaam];
            const pouleDoc = r1PoulesCache.find((p) => p.id === pouleNaam);
            const pouleSize = pouleDoc?.spelers?.length || 4;
            const is5 = pouleSize === 5;
            const matches = sortHomeAway(matchesRaw);

            const played = matches.filter((m) => m.afgerond).length;
            const total = matches.length;
            const perc = total ? Math.round((played / total) * 100) : 0;

            const headerId = `phead_${pouleNaam}`;
            const bodyId = `pbody_${pouleNaam}`;

            // factor-info uit pouleDoc (indien aanwezig)
            const basePlayers = pouleDoc?.factorBasePlayers || 4;
            const factorEnabled = !!pouleDoc?.factorEnabled;
            const rawFactorValue =
              typeof pouleDoc?.factorValue === "number"
                ? pouleDoc.factorValue
                : null;

            let factorValue;
            if (factorEnabled && rawFactorValue != null) {
              factorValue = rawFactorValue;
            } else if (is5) {
              // oude 0,75-logica blijft default voor 5-spelers poules
              factorValue = 0.75;
            } else {
              factorValue = 1.0;
            }

            const factorText =
              factorValue !== 1
                ? `(punten √ó${factorValue.toFixed(2).replace(".", ",")})`
                : "";

            const factorNote = pouleDoc?.factorNote || "";
            const factorBadge =
              factorEnabled && factorValue !== 1
                ? `<span
                            class="poule-factor-indicator"
                            title="${
                              factorNote
                                ? "Toelichting: " +
                                  factorNote.replace(/"/g, "&quot;")
                                : "Afwijkende factor voor puntentelling in deze poule"
                            }"
                            style="margin-left:4px;font-size:0.75em;background:#fff3cd;color:#856404;border-radius:999px;padding:2px 6px;border:1px solid #ffe69c;"
                         >!</span>`
                : "";
            const wasOpen = pouleOpenState[pouleNaam] === true;

            let html = `
                    <div class="poule-block" data-poule="${pouleNaam}">
                      <div
                        id="${headerId}"
                        class="poule-header"
                        style="cursor:pointer;display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:#f8f9fa;border-radius:8px;border:1px solid #dee2e6;"
                      >
                        <div style="display:flex;align-items:center;gap:6px;">
                          <strong>${pouleNaam}</strong>
                          ${
                            factorText
                              ? `<span style="font-size:0.85em;color:#b02a37;">${factorText}</span>`
                              : ""
                          }
                          ${factorBadge}
                          <button
                            type="button"
                            class="poule-factor-btn"
                            data-poule="${pouleNaam}"
                            title="Factor voor puntentelling instellen"
                            style="margin-left:4px;background:#ffc107;color:#212529;border:none;border-radius:50%;width:22px;height:22px;font-size:0.9em;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;"
                          >!</button>
                        </div>
                        <div style="font-size:0.85em;color:#555;">
                          Totaal gespeeld: ${played} / ${total} wedstrijden
                        </div>
                      </div>
                      <div id="${bodyId}" class="poule-body"
                         style="display:${wasOpen ? "block" : "none"};
                         padding:10px;border:1px solid #dee2e6;border-top:none;
                          border-radius:0 0 8px 8px;background:white;">

                      <table style="width:100%;border-collapse:collapse;font-size:0.92em">
                        <thead style="background:#eef2f6">
                          <tr>
                            <th style="text-align:left;padding:6px 4px">Speler A</th>
                            <th style="text-align:right;padding:6px 4px">Te&nbsp;maken A</th>
                            <th style="text-align:left;padding:6px 4px">Speler B</th>
                            <th style="text-align:right;padding:6px 4px">Te&nbsp;maken B</th>
                            <th style="text-align:right;padding:6px 4px">Gemaakte A</th>
                            <th style="text-align:right;padding:6px 4px">Gemaakte B</th>
                            <th style="text-align:right;padding:6px 4px">Beurten</th>
                            <th style="text-align:center;padding:6px 4px">Uitslag</th>
                            <th style="text-align:center;padding:6px 4px">Acties</th>
                          </tr>
                        </thead>
                        <tbody>`;

            matches.forEach((m) => {
              const gX = m.gemaakteX ?? "";
              const gY = m.gemaakteY ?? "";
              const b = m.beurten ?? "";
              const uitslag =
                m.puntenX != null && m.puntenY != null
                  ? `${m.puntenX} - ${m.puntenY}`
                  : "";
              const rowBg = m.afgerond ? "background:#B3FF87" : "";

              html += `
                    <tr data-matchid="${
                      m.id
                    }" style="border-bottom:1px solid #eee;${rowBg}">
                      <td style="padding:6px 4px">${m.spelerX?.naam ?? ""}</td>
                      <td style="padding:6px 4px;text-align:right">${
                        m.spelerX?.teMaken ?? ""
                      }</td>
                      <td style="padding:6px 4px">${m.spelerY?.naam ?? ""}</td>
                      <td style="padding:6px 4px;text-align:right">${
                        m.spelerY?.teMaken ?? ""
                      }</td>
                      <td style="padding:6px 4px;text-align:right"><input type="number" value="${gX}" class="r1-input" data-field="gemaakteX" style="width:70px;text-align:right"></td>
                      <td style="padding:6px 4px;text-align:right"><input type="number" value="${gY}" class="r1-input" data-field="gemaakteY" style="width:70px;text-align:right"></td>
                      <td style="padding:6px 4px;text-align:right"><input type="number" value="${b}" class="r1-input" data-field="beurten"   style="width:70px;text-align:right"></td>
                      <td style="padding:6px 4px;text-align:center;font-weight:600">${uitslag}</td>
                      <td style="padding:6px 4px;text-align:center">
                        <button class="actie-btn save" data-action="save" title="Opslaan">üíæ</button>
                        <button class="actie-btn reset" data-action="reset" title="Uitslag verwijderen">üóëÔ∏è</button>
                      </td>
                    </tr>`;
            });

            html += `</tbody></table>`;

            // ----- Nieuwe poule-stand -----
            html += `<div style="margin-top:12px;border-top:1px dashed #ddd;padding-top:10px">${renderPouleStandHTML(
              pouleNaam,
              matches,
              pouleDoc
            )}</div>`;

            html += `</div></div>`;
            r1matchesWrapper.insertAdjacentHTML("beforeend", html);

            // factor-knop koppelen (niet het inklappen laten triggeren)
            const factorBtn = document.querySelector(
              `.poule-factor-btn[data-poule="${pouleNaam}"]`
            );
            if (factorBtn) {
              factorBtn.addEventListener("click", (e) => {
                e.stopPropagation(); // header-click niet uitvoeren
                configureR1PouleFactor(pouleNaam);
              });
            }

            // in/uitklappen
            const headerEl = document.getElementById(headerId);
            const bodyEl = document.getElementById(bodyId);
            headerEl.addEventListener("click", () => {
              const hidden = bodyEl.style.display === "none";
              bodyEl.style.display = hidden ? "block" : "none";
              headerEl.style.borderRadius = hidden ? "8px 8px 0 0" : "8px";
              pouleOpenState[pouleNaam] = hidden; // onthouden
            });
          });

        // globale stand
        const globalStats = buildGlobalRankingFromStats(
          r1Matches,
          r1PoulesCache
        );
        let gHtml = `
                <table style="width:100%;border-collapse:collapse;font-size:0.9em;margin-top:10px">
                  <thead style="background:#f8f9fa">
                    <tr>
                      <th style="text-align:left;padding:4px;border-bottom:1px solid #ddd">#</th>
                      <th style="text-align:left;padding:4px;border-bottom:1px solid #ddd">Speler</th>
                      <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">Ptn</th>
                      <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">Rang&nbsp;Ptn</th>
                      <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">%Car</th>
                      <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">Rang&nbsp;%Car</th>
                      <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">Totaal&nbsp;Rang</th>
                    </tr>
                  </thead>
                  <tbody>`;
        globalStats.forEach((row, idx) => {
          const percCarText = row.percCar.toFixed(1).replace(".", ",") + "%";
          const isTop8 = idx < 8;
          const bgColor = "";
          gHtml += `
                  <tr style="border-bottom:1px solid #eee;${bgColor}">
                    <td style="padding:4px">${idx + 1}</td>
                    <td style="padding:4px">${row.naam}</td>
                    <td style="padding:4px;text-align:right">${Number(
                      row.puntenAdj ?? row.puntenTotaal
                    )}</td>
                    <td style="padding:4px;text-align:right;color:#f00">${row.rankPoints_punten.toFixed(
                      1
                    )}</td>
                    <td style="padding:4px;text-align:right">${percCarText}</td>
                    <td style="padding:4px;text-align:right;color:#f00">${row.rankPoints_percCar.toFixed(
                      1
                    )}</td>
                    <td style="padding:4px;text-align:right;font-weight:600;color:#f00">${row.rankTotaal.toFixed(
                      1
                    )}</td>
                  </tr>`;
        });
        gHtml += `</tbody></table>`;
        r1GlobalStandTable.innerHTML = gHtml;
      }

      // ----------------------------------------------------------
      // 1E RONDE RESULTATEN ‚Äì factor per poule instellen
      // ----------------------------------------------------------
      async function configureR1PouleFactor(pouleId) {
        if (!activeTournamentId) {
          alert("Er is geen actief toernooi geladen.");
          return;
        }

        const pouleDoc = r1PoulesCache.find((p) => p.id === pouleId);
        if (!pouleDoc) {
          alert("Poule niet gevonden.");
          return;
        }

        const huidigeActual = pouleDoc.factorActualPlayers || "";
        const huidigeNote = pouleDoc.factorNote || "";
        const basePlayers = pouleDoc.factorBasePlayers || 4;

        const input = prompt(
          `Werkelijk aantal spelers voor puntentelling in ${pouleId} (leeg = factor uitzetten):`,
          huidigeActual ? String(huidigeActual) : ""
        );
        if (input === null) return; // gebruiker annuleert

        const trimmed = input.trim();

        const pouleRef = doc(
          db,
          "toernooien",
          activeTournamentId,
          "poules_r1",
          pouleId
        );

        // Leeg = factor uitzetten, terug naar "normale" logica
        if (trimmed === "") {
          await updateDoc(pouleRef, {
            factorEnabled: false,
          });
          pouleDoc.factorEnabled = false;
          // UI en globale stand opnieuw laden
          await loadR1MatchesFromFirestore();
          return;
        }

        const actual = Number(trimmed);
        if (!Number.isFinite(actual) || actual < 2 || actual > 8) {
          alert("Voer een geldig aantal spelers in (minimaal 2, maximaal 8).");
          return;
        }

        const note = prompt(
          "Korte toelichting (wordt als mouse-over getoond, bijv. welke speler is uitgevallen):",
          huidigeNote
        );

        // Factor berekenen op basis van 'normaal' 4 spelers vs werkelijk aantal
        const refPlayers = basePlayers || 4; // standaard 4
        const matchesRef = (refPlayers - 1) * 2;
        const matchesActual = (actual - 1) * 2;
        const factor = matchesActual > 0 ? matchesRef / matchesActual : 1.0;

        const factorEnabled = Math.abs(factor - 1) > 0.0001;

        await updateDoc(pouleRef, {
          factorEnabled,
          factorBasePlayers: refPlayers,
          factorActualPlayers: actual,
          factorValue: factor,
          factorNote: note || "",
        });

        // lokale cache bijwerken zodat UI niet "achterloopt"
        pouleDoc.factorEnabled = factorEnabled;
        pouleDoc.factorBasePlayers = refPlayers;
        pouleDoc.factorActualPlayers = actual;
        pouleDoc.factorValue = factor;
        pouleDoc.factorNote = note || "";

        await recalcR1PouleMatches(pouleId);

        // alles opnieuw tekenen met nieuwe factor
        await loadR1MatchesFromFirestore();
      }

      // ====== Automatisch laden bij tab ======
      async function loadR1ResultsTabForActiveTournament() {
        if (!activeTournamentId) return;
        await loadR1MatchesFromFirestore();
      }

      // ====== Poules ophalen ======
      async function getR1Poules() {
        const poulesRef = collection(
          db,
          "toernooien",
          activeTournamentId,
          "poules_r1"
        );
        const snap = await getDocs(poulesRef);
        return snap.docs.map((d) => ({ id: d.id, ...d.data() }));
      }

      // ====== Wedstrijdschema aanmaken (alle poules) ======
      async function createR1MatchSchedule() {
        if (!activeTournamentId) {
          showPopupMessage("‚ö†Ô∏è Geen toernooi geselecteerd.", true);
          return;
        }
        console.log("Test getR1Poules:", typeof getR1Poules, getR1Poules);
        const poules = await getR1Poules();

        poules.forEach((p) => {
          console.log("Poule", p.id, "heeft veldnamen:", Object.keys(p));
          console.log("‚Üí spelers:", p.spelers);
        });

        if (!poules.length) {
          showPopupMessage(
            "‚ö†Ô∏è Geen poules gevonden. Maak eerst een poule-indeling.",
            true
          );
          return;
        }

        // Oude wedstrijden wissen voor alle poules
        const matchesRef = collection(
          db,
          "toernooien",
          activeTournamentId,
          "r1_wedstrijden"
        );
        const existingSnap = await getDocs(matchesRef);
        const batchDelete = writeBatch(db);
        let deleteCount = 0;
        existingSnap.forEach((d) => {
          batchDelete.delete(d.ref);
          deleteCount++;
        });

        if (deleteCount > 0) {
          const confirmOverwrite = confirm(
            `Er bestaan al ${deleteCount} wedstrijden.\n\nWil je deze overschrijven? Alle bestaande uitslagen gaan verloren.`
          );
          if (!confirmOverwrite) return;
          await batchDelete.commit();
        }

        // Nieuwe wedstrijden aanmaken
        const batch = writeBatch(db);
        let totalMatches = 0;

        poules.forEach((poule) => {
          const spelers = poule.spelers || [];
          for (let i = 0; i < spelers.length; i++) {
            for (let j = 0; j < spelers.length; j++) {
              if (i === j) continue;
              const safePouleId = poule.id.replace(/\s+/g, "_");
              const matchId = `${safePouleId}_${spelers[i].id}_${spelers[j].id}`;

              const matchRef = doc(
                db,
                "toernooien",
                activeTournamentId,
                "r1_wedstrijden",
                matchId
              );
              batch.set(matchRef, {
                poule: poule.id,
                spelerX: {
                  id: spelers[i].id,
                  naam: spelers[i].naam,
                  teMaken:
                    spelers[i].carambolesR1 || spelers[i].caramboles || 0,
                },
                spelerY: {
                  id: spelers[j].id,
                  naam: spelers[j].naam,
                  teMaken:
                    spelers[j].carambolesR1 || spelers[j].caramboles || 0,
                },
                gemaakteX: null,
                gemaakteY: null,
                beurten: null,
                puntenX: null,
                puntenY: null,
                afgerond: false,
                resultaat: null,
              });
              totalMatches++;
            }
          }
        });
        console.log("Aanmaken wedstrijden:", totalMatches);
        await batch.commit();
        console.log(
          "Batch commit voltooid ‚Äî wedstrijden zouden nu in Firestore moeten staan"
        );

        showPopupMessage(
          `‚úÖ Wedstrijdschema aangemaakt: ${totalMatches} wedstrijden.`,
          false
        );
        await loadR1MatchesFromFirestore();

        updateR1ResultsButtons();
        updateR1PoulesButtons();
      }

      // ====== Wedstrijden wissen ======
      async function deleteR1Matches() {
        if (!activeTournamentId) {
          showPopupMessage("‚ö†Ô∏è Geen toernooi geselecteerd.", true);
          return;
        }

        const confirmDelete = confirm(
          "Weet je zeker dat je ALLE wedstrijden van de 1e ronde wilt verwijderen?\n\n‚ö†Ô∏è Alle ingevoerde uitslagen gaan verloren!"
        );
        if (!confirmDelete) return;

        const matchesRef = collection(
          db,
          "toernooien",
          activeTournamentId,
          "r1_wedstrijden"
        );
        const snap = await getDocs(matchesRef);
        if (snap.empty) {
          showPopupMessage("Er zijn geen wedstrijden om te verwijderen.", true);
          return;
        }

        const batch = writeBatch(db);
        let count = 0;
        snap.forEach((d) => {
          batch.delete(d.ref);
          count++;
        });

        await batch.commit();
        showPopupMessage(`üóëÔ∏è ${count} wedstrijden verwijderd.`, false);
        await loadR1MatchesFromFirestore();

        updateR1ResultsButtons();
        updateR1PoulesButtons();
      }

      function renderPouleStandHTML(pouleNaam, matches, pouleDoc) {
        // spelers + te maken caramboles
        const spelers = (pouleDoc?.spelers || []).map((s) => ({
          id: s.id,
          naam: s.naam,
          teMaken: s.carambolesR2 ?? s.carambolesR1 ?? s.caramboles ?? 0,
        }));

        const stats = new Map();
        spelers.forEach((s) =>
          stats.set(s.id, {
            id: s.id,
            naam: s.naam,
            teMaken: s.teMaken,
            punten: 0,
            car: 0,
            beurten: 0,
            gespeeld: 0,
          })
        );

        // ruwe stats opbouwen
        matches.forEach((m) => {
          if (!m.spelerX || !m.spelerY) return;

          if (m.gemaakteX != null) {
            const sX = stats.get(m.spelerX.id);
            if (sX) {
              sX.car += Number(m.gemaakteX) || 0;
              sX.beurten += Number(m.beurten) || 0;
              if (m.puntenX != null) sX.punten += Number(m.puntenX) || 0;
              if (m.afgerond) sX.gespeeld += 1;
            }
          }

          if (m.gemaakteY != null) {
            const sY = stats.get(m.spelerY.id);
            if (sY) {
              sY.car += Number(m.gemaakteY) || 0;
              sY.beurten += Number(m.beurten) || 0;
              if (m.puntenY != null) sY.punten += Number(m.puntenY) || 0;
              if (m.afgerond) sY.gespeeld += 1;
            }
          }
        });

        // ‚ö†Ô∏è Geen factor meer toepassen in de stand: punten zijn al inclusief factor
        const factor = 1;

        // moy, %car en aangepaste punten
        const rows = Array.from(stats.values()).map((s) => {
          const moy = s.beurten > 0 ? s.car / s.beurten : 0;
          const totTeMaken = s.teMaken * (s.gespeeld || 0);
          const percCar = totTeMaken > 0 ? (s.car / totTeMaken) * 100 : 0;
          const puntenAdj = s.punten || 0;
          return { ...s, moy, percCar, puntenAdj };
        });

        // sortering: aangepaste punten ‚Üì, gespeeld ‚Üë, %car ‚Üì, moy ‚Üì, naam ‚Üë
        rows.sort((a, b) => {
          if (b.puntenAdj !== a.puntenAdj) return b.puntenAdj - a.puntenAdj;
          if (a.gespeeld !== b.gespeeld) return a.gespeeld - b.gespeeld;
          if (b.percCar !== a.percCar) return b.percCar - a.percCar;
          if (b.moy !== a.moy) return b.moy - a.moy;
          return a.naam.localeCompare(b.naam);
        });

        let html = `
                <div style="font-weight:600;margin-bottom:6px">Stand ${pouleNaam}</div>
                <table style="width:100%;border-collapse:collapse;font-size:0.9em">
                  <thead style="background:#f8f9fa">
                    <tr>
                      <th style="text-align:left;padding:4px;border-bottom:1px solid #ddd">Speler</th>
                      <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">Te maken</th>
                      <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">Gespeeld</th>
                      <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">Punten</th>
                      <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">Gemaakt</th>
                      <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">Beurten</th>
                      <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">Moy</th>
                      <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">%Car</th>
                    </tr>
                  </thead>
                  <tbody>`;

        rows.forEach((r) => {
          const perc = r.percCar.toFixed(1).replace(".", ",") + "%";
          const moy = r.moy.toFixed(3).replace(".", ",");
          const puntenText = (
            r.puntenAdj % 1 === 0 ? r.puntenAdj : r.puntenAdj.toFixed(1)
          )
            .toString()
            .replace(".", ",");

          html += `
                  <tr style="border-bottom:1px solid #eee">
                    <td style="padding:4px">${r.naam}</td>
                    <td style="padding:4px;text-align:right">${r.teMaken}</td>
                    <td style="padding:4px;text-align:right">${r.gespeeld}</td>
                    <td style="padding:4px;text-align:right">${puntenText}</td>
                    <td style="padding:4px;text-align:right">${r.car}</td>
                    <td style="padding:4px;text-align:right">${r.beurten}</td>
                    <td style="padding:4px;text-align:right">${moy}</td>
                    <td style="padding:4px;text-align:right">${perc}</td>
                  </tr>`;
        });

        html += `</tbody></table>`;
        return html;
      }

      /* ----------------------------------------------------------
               1E RONDE RESULTATEN ‚Äì event-listeners voor actie-knoppen
            ---------------------------------------------------------- */
      r1matchesWrapper.addEventListener("click", async (e) => {
        const btn = e.target.closest(".actie-btn");
        if (!btn) return;
        e.stopPropagation(); // voorkom conflict met rij-klik
        const tr = btn.closest("tr");
        const id = tr.dataset.matchid;
        const action = btn.dataset.action;

        if (action === "save") {
          const inputs = tr.querySelectorAll(".r1-input");
          const values = {};
          inputs.forEach((i) => (values[i.dataset.field] = Number(i.value)));

          const m = r1Matches.find((x) => x.id === id);
          const err = validateR1Inputs(
            values.gemaakteX,
            values.gemaakteY,
            values.beurten,
            toernooiSettings.maxBeurten || 0,
            m.spelerX.teMaken,
            m.spelerY.teMaken
          );
          if (err) {
            showPopupMessage(err, true);
            return;
          }

          const pouleDoc = r1PoulesCache.find((p) => p.id === m.poule);
          const { pX, pY, uitslag } = calcR1Points(
            values.gemaakteX,
            values.gemaakteY,
            values.beurten,
            toernooiSettings.maxBeurten || 0,
            m.spelerX.teMaken,
            m.spelerY.teMaken,
            toernooiSettings.punten,
            pouleDoc
          );

          await saveMatchResultFields(id, {
            gemaakteX: values.gemaakteX,
            gemaakteY: values.gemaakteY,
            beurten: values.beurten,
            puntenX: pX,
            puntenY: pY,
            resultaat: uitslag,
            afgerond: true,
          });
        } else if (action === "reset") {
          await resetMatchResult(id);
        }
      });

      /* ----------------------------------------------------------
               1E RONDE RESULTATEN ‚Äì ontbrekende helpers
            ---------------------------------------------------------- */
      function validateR1Inputs(gX, gY, b, maxB, tX, tY) {
        maxB = Number(maxB) || 0;
        if ([gX, gY, b].some((v) => Number.isNaN(v)))
          return "‚ùå Vul overal een geldig getal in.";
        if (gX < 0 || gY < 0)
          return "‚ùå Gemaakte caramboles mogen niet negatief zijn.";
        if (b <= 0) return "‚ùå Aantal beurten moet groter zijn dan 0.";

        if (gX > tX || gY > tY)
          return "‚ùå Het aantal gemaakte caramboles mag niet hoger zijn dan het aantal te maken.";
        if (maxB && b > maxB)
          return `‚ö†Ô∏è Het aantal beurten mag niet hoger zijn dan het maximale aantal beurten (${maxB}).`;
        if (!maxB || b < maxB) {
          const xKlaar = gX >= tX;
          const yKlaar = gY >= tY;
          if (!xKlaar && !yKlaar)
            return "‚ö†Ô∏è Minstens √©√©n speler moet zijn partij hebben uitgemaakt.";
        }
        return null;
      }

      function calcR1FactorForPoule(pouleDoc) {
        if (!pouleDoc) return 1;

        // Als jij later factorEnabled/factorValue in de poule-doc opslaat:
        if (
          pouleDoc.factorEnabled &&
          typeof pouleDoc.factorValue === "number"
        ) {
          return pouleDoc.factorValue;
        }

        // Default: 5-spelers-poule ‚Üí 0,75, anders 1,0
        const size = (pouleDoc.spelers || []).length || 4;
        if (size === 5) return 0.75;
        return 1;
      }

      function calcR1Points(
        gX,
        gY,
        b,
        maxB,
        tX,
        tY,
        pCfg = {},
        pouleDoc = null
      ) {
        maxB = Number(maxB) || 0;

        const factor = calcR1FactorForPoule(pouleDoc);
        const punten = {
          winLess: (pCfg.winLess ?? 2) * factor,
          drawLess: (pCfg.drawLess ?? 1) * factor,
          loseLess: (pCfg.loseLess ?? 0) * factor,
          winMax: (pCfg.winMax ?? 2) * factor,
          drawMax: (pCfg.drawMax ?? 1) * factor,
          loseMax: (pCfg.loseMax ?? 0) * factor,
        };

        let pX = 0,
          pY = 0,
          uitslag = "";

        if (!maxB || b < maxB) {
          const xKlaar = gX >= tX;
          const yKlaar = gY >= tY;
          if (xKlaar && !yKlaar) {
            pX = punten.winLess;
            pY = punten.loseLess;
            uitslag = "1 - 0";
          } else if (!xKlaar && yKlaar) {
            pX = punten.loseLess;
            pY = punten.winLess;
            uitslag = "0 - 1";
          } else if (xKlaar && yKlaar) {
            pX = pY = punten.drawLess;
            uitslag = "¬Ω - ¬Ω";
          }
        } else if (maxB && b === maxB) {
          const percX = (gX / tX) * 100;
          const percY = (gY / tY) * 100;
          if (percX > percY) {
            pX = punten.winMax;
            pY = punten.loseMax;
            uitslag = "1 - 0";
          } else if (percY > percX) {
            pX = punten.loseMax;
            pY = punten.winMax;
            uitslag = "0 - 1";
          } else {
            pX = pY = punten.drawMax;
            uitslag = "¬Ω - ¬Ω";
          }
        }
        return { pX, pY, uitslag };
      }

      async function saveMatchResultFields(matchId, update) {
        const ref = doc(
          db,
          "toernooien",
          activeTournamentId,
          "r1_wedstrijden",
          matchId
        );
        await updateDoc(ref, update);
        showPopupMessage("‚úÖ Wedstrijd opgeslagen", false);
        await loadR1MatchesFromFirestore();
      }

      async function resetMatchResult(matchId) {
        const ok = confirm(
          "Alleen de ingevoerde resultaten van deze wedstrijd verwijderen?"
        );
        if (!ok) return;
        const ref = doc(
          db,
          "toernooien",
          activeTournamentId,
          "r1_wedstrijden",
          matchId
        );
        await updateDoc(ref, {
          gemaakteX: null,
          gemaakteY: null,
          beurten: null,
          puntenX: null,
          puntenY: null,
          afgerond: false,
          resultaat: null,
        });
        showPopupMessage("üóëÔ∏è Uitslag verwijderd", false);
        await loadR1MatchesFromFirestore();
      }
      /* ===== EINDE FUNCTIES TAB 1E RONDE RESULTATEN ===== */

      /* =========================================================
               2E RONDE POULES ‚Äì GLOBALE VARIABELEN
            ========================================================= */
      let r2CurrentPoules = []; // [{naam, maxSpelers:4, spelers:[]}, ...]
      let r2SelectedPlayer = null; // spelerobject
      let r2AllPlayers = []; // globale ranglijst 1e ronde
      let r2AvailablePlayers = []; // nog niet ingedeeld

      // Vlag: zijn de caramboles 2e ronde "bewust" opgeslagen?
      // - wordt TRUE na 'Opslaan car. 2e ronde' of na resetAllCarambolesR2()
      // - wordt opnieuw bepaald bij het laden van een toernooi
      let r2CarambolesBulkSaved = false;

      // Vlag: is de poule-indeling gewijzigd sinds de laatste opslag?
      // - wordt TRUE na elke wijziging (speler toevoegen/verwijderen, basisindeling, nieuwe poules)
      // - wordt FALSE na succesvol opslaan, wissen of laden uit Firestore
      let r2PoulesDirty = false;

      // Onthoud bij welk toernooi de huidige r2CurrentPoules horen
      let r2PoulesTournamentId = null;

      /* =========================================================
               2E RONDE POULES ‚Äì UI HELPERS
            ========================================================= */
      function showR2PoulesFeedback(msg, type = "info") {
        const fb = document.getElementById("r2poulesFeedback");
        const color =
          type === "error"
            ? "#f8d7da"
            : type === "success"
            ? "#d1e7dd"
            : "#e2e3e5";
        const textColor =
          type === "error"
            ? "#842029"
            : type === "success"
            ? "#0f5132"
            : "#41464b";
        fb.innerHTML = `<div style="padding:6px 10px;border-radius:6px;background:${color};color:${textColor};border:1px solid ${
          type === "error"
            ? "#f5c2c7"
            : type === "success"
            ? "#badbcc"
            : "#d3d6d8"
        }">${msg}</div>`;
      }

      /* =========================================================
               2E RONDE POULES ‚Äì RANGLIJST LADEN
            ========================================================= */
      /* =========================================================
               2E RONDE POULES ‚Äì RANGLIJST LADEN
            ========================================================= */
      /* =========================================================
               2E RONDE POULES ‚Äì RANGLIJST LADEN
            ========================================================= */
      async function loadR2GlobalRanking() {
        if (!activeTournamentId) return;

        // 1. Bouw globale ranglijst op basis van 1e ronde-wedstrijden
        const globalStats = buildGlobalRankingFromStats(
          r1Matches,
          r1PoulesCache
        );

        // 2. Sorteer op totaalrang (laagste = beste)
        const sortedStats = [...globalStats].sort(
          (a, b) => a.rankTotaal - b.rankTotaal
        );

        // 2b. Actieve moy‚Üícar-tabel ophalen (kan ook null zijn)
        const moyCarTable = getActiveMoyCarTable();

        // 3. Combineer met spelersgegevens (caramboles 1e & 2e ronde)
        r2AllPlayers = sortedStats.map((p, idx) => {
          // bijbehorend speler-document uit de spelers-collection (voor carambolesR2 / withdrawR2)
          const spelerDoc = Array.isArray(currentPlayers)
            ? currentPlayers.find((sp) => sp.id === p.spelerId) || {}
            : {};

          // te maken caramboles in de 1e ronde
          const caramboles1e = p.teMaken ?? spelerDoc.caramboles ?? 0;

          // moyenne over alle wedstrijden in de 1e ronde (uit globalStats)
          const moyR1 =
            typeof p.moy === "number" && Number.isFinite(p.moy) ? p.moy : null;

          // automatisch voorgesteld aantal caramboles 2e ronde o.b.v. moyenne
          let autoCarR2 = null;
          if (moyCarTable && moyR1 !== null) {
            autoCarR2 = lookupCarambolesFromMoy(moyR1, moyCarTable);
          }

          // eventueel eerder handmatig/expliciet ingevulde caramboles voor 2e ronde
          const caramboles2e =
            spelerDoc.carambolesR2 != null
              ? spelerDoc.carambolesR2
              : autoCarR2 != null
              ? autoCarR2
              : undefined;

          return {
            id: p.spelerId,
            naam: p.naam,
            punten: p.puntenTotaal,
            percCar: p.percCar,
            rankPunten: p.rankPoints_punten,
            rankPercCar: p.rankPoints_percCar,
            rankTotaal: p.rankTotaal,
            // vaste rangnummer uit de 1e ronde (blijft altijd gekoppeld aan deze speler)
            startRank: idx + 1,
            // caramboles voor de UI
            caramboles: caramboles1e,
            carambolesR2: caramboles2e,
            // optioneel handig als je het ooit wilt tonen
            moyR1,
            // afgemeld voor 2e ronde? (standaard false als veld niet bestaat)
            withdrawR2: !!spelerDoc.withdrawR2,
          };
        });

        // 4. lijst met beschikbare spelers initialiseren
        r2AvailablePlayers = [...r2AllPlayers];

        // 5. Vlag initialiseren:
        //    Bij het laden van een toernooi gaan we er vanuit
        //    dat de gebruiker eerst bewust op "Opslaan car. 2e ronde" klikt.
        r2CarambolesBulkSaved = false;
      }

      /* ----------------------------------------------------------
               2E RONDE POULES ‚Äì RANGLIJST ALS TABEL (vervangt vorige renderR2AvailablePlayers)
            ---------------------------------------------------------- */
      function renderR2AvailablePlayers() {
        const tbody = document.getElementById("r2RankTableBody");
        tbody.innerHTML = "";

        if (!r2AvailablePlayers.length) {
          tbody.innerHTML =
            '<tr><td colspan="5" style="color:#777;padding:6px">Geen vrije spelers meer.</td></tr>';
          return;
        }

        // Altijd sorteren op vaste startRank uit de 1e ronde
        const sorted = [...r2AvailablePlayers].sort(
          (a, b) => (a.startRank || 9999) - (b.startRank || 9999)
        );

        const active = sorted.filter((p) => !p.withdrawR2);
        const withdrawn = sorted.filter((p) => p.withdrawR2);

        function renderRow(p, isWithdrawn) {
          const tr = document.createElement("tr");
          tr.dataset.id = p.id;
          tr.style.cursor = isWithdrawn ? "default" : "pointer";

          const dimColor = isWithdrawn ? "color:#999;" : "";
          const nameExtra = isWithdrawn
            ? ' <span style="font-size:0.8em;color:#b02a37;margin-left:4px">(afgemeld 2e ronde)</span>'
            : "";

          tr.innerHTML = `
                  <td style="padding:6px 4px;${dimColor}">${
            p.startRank ?? ""
          }</td>
                  <td style="padding:6px 4px;text-align:center;">
                    <input
                      type="checkbox"
                      class="r2-withdraw-checkbox"
                      ${p.withdrawR2 ? "checked" : ""}
                      style="cursor:pointer"
                    >
                  </td>
                  <td style="padding:6px 4px;${dimColor}">${
            p.naam
          }${nameExtra}</td>
                  <td style="padding:6px 4px;text-align:right;${dimColor}">${
            p.caramboles ?? 0
          }</td>
                  <td style="padding:6px 4px;text-align:right;">
                    <input
                      type="number"
                      class="carambolesR2-input small"
                      value="${p.carambolesR2 ?? p.caramboles ?? 0}"
                      min="0"
                      max="999"
                      style="width:60px;text-align:right;${
                        isWithdrawn ? "background:#f8f9fa;color:#999;" : ""
                      }"
                    >
                  </td>
                `;

          // Alleen actieve spelers kunnen geselecteerd worden voor poules
          if (!isWithdrawn) {
            tr.addEventListener("click", (e) => {
              if (e.target.tagName !== "INPUT") {
                selectR2Player(p.id, tr);
              }
            });
          }

          tbody.appendChild(tr);
        }

        // Eerst alle actieve spelers
        active.forEach((p) => renderRow(p, false));

        // Dan ‚Äì indien aanwezig ‚Äì de afmeldingen in een blok onder de lijn
        if (withdrawn.length) {
          const sep = document.createElement("tr");
          sep.innerHTML =
            '<td colspan="5" style="padding-top:8px;border-top:1px solid #ccc;font-size:0.8em;color:#555;">Afmeldingen 2e ronde</td>';
          tbody.appendChild(sep);
          withdrawn.forEach((p) => renderRow(p, true));
        }

        updateR2PoulesButtons();
      }

      /* ----------------------------------------------------------
               2E RONDE POULES ‚Äì SPELER SELECTEREN
            ---------------------------------------------------------- */
      function selectR2Player(id, rowEl) {
        // alle rijen eerst "resetten"
        document
          .querySelectorAll("#r2RankTableBody tr")
          .forEach((el) => (el.style.background = "white"));

        const player = r2AvailablePlayers.find((p) => p.id === id);
        if (!player) return;

        // afgemelde speler mag niet geselecteerd worden
        if (player.withdrawR2) {
          showR2PoulesFeedback(
            "‚ö†Ô∏è Deze speler is afgemeld voor de 2e ronde en kan niet meer in een poule worden ingedeeld.",
            "error"
          );
          return;
        }

        r2SelectedPlayer = player;

        // highlight de geselecteerde rij
        if (rowEl) {
          rowEl.style.background = "#ffeeba";
        }

        showR2PoulesFeedback(`üéØ Geselecteerd: ${player.naam}`, "info");
      }

      /* =========================================================
               2E RONDE POULES ‚Äì POULES AANMAKEN
            ========================================================= */
      async function createR2Poules() {
        if (!activeTournamentId) {
          showR2PoulesFeedback("‚ö†Ô∏è Geen toernooi actief.", "error");
          return;
        }
        await loadR2GlobalRanking();
        if (r2AllPlayers.length === 0) {
          showR2PoulesFeedback("‚ö†Ô∏è Geen ranglijst 1e ronde gevonden.", "error");
          return;
        }
        const aantal = prompt(
          "Hoeveel poules moeten er worden aangemaakt?",
          "4"
        );
        const n = parseInt(aantal);
        if (!n || n < 1) {
          showR2PoulesFeedback("‚ùå Ongeldig aantal.", "error");
          return;
        }
        r2CurrentPoules = [];
        for (let i = 0; i < n; i++) {
          r2CurrentPoules.push({
            naam: `Poule ${String.fromCharCode(65 + i)}`,
            maxSpelers: 4,
            spelers: [],
          });
        }
        r2SelectedPlayer = null;
        // nieuwe poules = indeling nog niet opgeslagen
        r2PoulesDirty = true;
        renderR2Poules();
        renderR2AvailablePlayers();
        showR2PoulesFeedback(`‚úÖ ${n} poules aangemaakt.`, "success");
        updateR2PoulesButtons();
      }

      /* =========================================================
               2E RONDE POULES ‚Äì BASISINDELING (GELIJKMATIG, SLINGEREND)
            ========================================================= */

      function applyR2SnakeBaseLayout() {
        if (!activeTournamentId) {
          showR2PoulesFeedback("‚ö†Ô∏è Geen toernooi actief.", "error");
          return;
        }

        const hasR2Poules =
          Array.isArray(r2CurrentPoules) && r2CurrentPoules.length > 0;
        if (!hasR2Poules) {
          showR2PoulesFeedback(
            "‚ö†Ô∏è Maak eerst 2e ronde poules aan voordat je een basisindeling kiest.",
            "error"
          );
          return;
        }

        if (!Array.isArray(r2AllPlayers) || r2AllPlayers.length === 0) {
          showR2PoulesFeedback(
            "‚ö†Ô∏è Geen spelerslijst gevonden. Zorg dat de ranglijst van de 1e ronde beschikbaar is.",
            "error"
          );
          return;
        }

        // Sorteer spelers op startRank (1 = sterkste / hoogste plaats 1e ronde)
        // Let op: spelers die zich hebben afgemeld voor de 2e ronde worden hier uitgesloten.
        const orderedPlayers = [...r2AllPlayers]
          .filter((p) => !p.withdrawR2)
          .sort((a, b) => (a.startRank || 9999) - (b.startRank || 9999));

        // "Skelet" van poules voor de helper-functies
        const pouleSkeleton = r2CurrentPoules.map((p) => ({
          naam: p.naam,
          maxSpelers: p.maxSpelers || 4,
        }));

        // Slingerend poule-indexpatroon (snake)
        const seq = buildPouleIndexSequence(pouleSkeleton, true);

        // Laat bestaande helper het echte toewijzen doen
        const assignments = assignBySequence(
          orderedPlayers,
          pouleSkeleton,
          seq
        );

        // Schrijf assignments terug naar r2CurrentPoules
        r2CurrentPoules = r2CurrentPoules.map((p) => ({
          ...p,
          spelers: (assignments[p.naam] || []).map((sp) => ({ ...sp })),
        }));

        // Bepaal welke spelers nog beschikbaar zijn
        const idsInPoules = new Set(
          r2CurrentPoules.flatMap((p) => (p.spelers || []).map((sp) => sp.id))
        );
        r2AvailablePlayers = r2AllPlayers.filter(
          (sp) => !idsInPoules.has(sp.id)
        );
        // basisindeling = indeling gewijzigd t.o.v. vorige opslag
        r2PoulesDirty = true;
        renderR2Poules();
        renderR2AvailablePlayers();
        updateR2PoulesButtons();
        showR2PoulesFeedback(
          "‚úÖ Basisindeling voor de 2e ronde is toegepast (gelijkmatig, slingerend op basis van ranglijst).",
          "success"
        );
      }

      function openR2BaseLayoutDialog() {
        // Niet toestaan als er al een wedstrijdschema is
        const hasR2Schedule = Array.isArray(r2Matches) && r2Matches.length > 0;
        if (hasR2Schedule) {
          showR2PoulesFeedback(
            "‚ùå Je kunt de basisindeling niet meer wijzigen omdat er al een wedstrijdschema voor de 2e ronde is aangemaakt.",
            "error"
          );
          return;
        }

        const hasR2Poules =
          Array.isArray(r2CurrentPoules) && r2CurrentPoules.length > 0;
        if (!hasR2Poules) {
          showR2PoulesFeedback(
            "‚ö†Ô∏è Maak eerst 2e ronde poules aan voordat je een basisindeling kiest.",
            "error"
          );
          return;
        }

        // Zijn er al spelers ingedeeld?
        const alreadyAssigned =
          hasR2Poules &&
          r2CurrentPoules.some(
            (p) => Array.isArray(p.spelers) && p.spelers.length > 0
          );

        if (alreadyAssigned) {
          const ok = confirm(
            "Er zijn al spelers over de poules verdeeld.\n\n" +
              "Als je de basisindeling toepast, wordt de huidige indeling overschreven.\n\n" +
              "Wil je doorgaan?"
          );
          if (!ok) return;
        }

        // Verwijder bestaande dialog (als die er is)
        const existing = document.getElementById("r2BaseIndelingDialog");
        if (existing) existing.remove();

        const overlay = document.createElement("div");
        overlay.id = "r2BaseIndelingDialog";
        overlay.style.cssText = `
                position:fixed;inset:0;z-index:2000;
                background:rgba(0,0,0,0.4);
                display:flex;align-items:center;justify-content:center;
              `;

        overlay.innerHTML = `
                <div style="
                  background:#fff;
                  border-radius:10px;
                  padding:18px 20px;
                  max-width:520px;
                  width:90%;
                  box-shadow:0 6px 20px rgba(0,0,0,0.25);
                  font-size:0.95rem;
                ">
                  <h3 style="margin-top:0;margin-bottom:10px;">
                    Basisindeling 2e ronde poules
                  </h3>
                  <p style="margin:0 0 8px;">
                    Voor de 2e ronde gebruiken we altijd de indeling
                    <strong>‚ÄúGelijkmatig ‚Äì slingerend‚Äù</strong>.
                  </p>
                  <p style="margin:0 0 8px;">
                    De spelers worden op volgorde van hun ranglijst (1e ronde)
                    verdeeld over de poules: eerst van A naar D, daarna weer terug
                    van D naar A, dan opnieuw A naar D, enzovoort.
                    Dit wordt ook wel <em>slingerend indelen</em> genoemd.
                  </p>
                  <p style="margin:0 0 14px;font-size:0.9rem;color:#555;">
                    Voorbeeld bij vier poules: A ‚Äì B ‚Äì C ‚Äì D ‚Äì D ‚Äì C ‚Äì B ‚Äì A ‚Äì A ‚Äì B ‚Äì C ‚Äì D ‚Äì ...
                  </p>
                  <div style="margin-top:14px;display:flex;justify-content:flex-end;gap:8px;">
                    <button type="button"
                      class="r2-base-cancel"
                      style="padding:6px 12px;border-radius:6px;border:1px solid #ccc;background:#f8f9fa;cursor:pointer;">
                      Annuleren
                    </button>
                    <button type="button"
                      class="r2-base-apply"
                      style="padding:6px 14px;border-radius:6px;border:1px solid #198754;background:#198754;color:white;cursor:pointer;font-weight:600;">
                      Indeling toepassen
                    </button>
                  </div>
                </div>
              `;

        overlay
          .querySelector(".r2-base-cancel")
          .addEventListener("click", () => overlay.remove());

        overlay
          .querySelector(".r2-base-apply")
          .addEventListener("click", () => {
            overlay.remove();
            applyR2SnakeBaseLayout();
          });

        document.body.appendChild(overlay);
      }

      /* =========================================================
               2E RONDE POULES ‚Äì POULES RENDEREN
            ========================================================= */
      function renderR2Poules() {
        const container = document.getElementById("r2PoulesContainer");
        container.innerHTML = "";

        r2CurrentPoules.forEach((poule) => {
          const isFull = poule.spelers.length >= poule.maxSpelers;

          const card = document.createElement("div");
          card.className = "poule-card";
          card.style.cssText = `border:3px solid ${
            isFull ? "#198754" : "#ccc"
          };border-radius:8px;padding:8px;background:#fff;min-height:120px;cursor:pointer;`;

          // HTML voor de poulekaart inclusief delete-knoppen met data-player-id
          card.innerHTML = `
                  <h5>
                    ${poule.naam}
                    <span style="font-weight:normal;font-size:0.9em;color:#555;">
                      (${poule.spelers.length}/${poule.maxSpelers})
                    </span>
                  </h5>
                  <ul style="margin-top:5px;padding-left:15px">
                    ${poule.spelers
                      .map(
                        (sp) => `
                      <li style="display:flex;justify-content:space-between;margin-bottom:2px">
                        <span>${sp.naam} (${sp.carambolesR2})</span>
                        <button
                          type="button"
                          data-player-id="${sp.id}"
                          style="background:#dc3545;color:white;border:none;border-radius:4px;cursor:pointer;padding:2px 5px;font-size:0.8rem"
                          title="Verwijder speler uit poule"
                        >
                          üóëÔ∏è
                        </button>
                      </li>`
                      )
                      .join("")}
                  </ul>
                `;

          // Verwijder-knoppen binnen deze kaart aankoppelen
          const delButtons = card.querySelectorAll("button[data-player-id]");
          delButtons.forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation(); // voorkom dat de kaart-click ook triggert
              const spelerId = btn.dataset.playerId;
              removeR2PlayerFromPoule(poule.naam, spelerId);
            });
          });

          // Klik op de kaart zelf = geselecteerde speler toevoegen aan deze poule
          card.addEventListener("click", () =>
            addSelectedR2PlayerToPoule(poule.naam)
          );

          container.appendChild(card);
        });
        updateR2PoulesButtons();
      }

      /* =========================================================
               2E RONDE POULES ‚Äì SPELER VERWIJDEREN UIT POULE
            ========================================================= */
      function removeR2PlayerFromPoule(pouleNaam, spelerId) {
        const poule = r2CurrentPoules.find((p) => p.naam === pouleNaam);
        if (!poule) return;

        const idx = poule.spelers.findIndex((sp) => sp.id === spelerId);
        if (idx === -1) return;

        // speler die we terugzetten
        const [removedPlayer] = poule.spelers.splice(idx, 1);

        // alleen deze speler terug naar r2AvailablePlayers
        const alreadyFree = r2AvailablePlayers.find(
          (p) => p.id === removedPlayer.id
        );
        if (!alreadyFree) {
          r2AvailablePlayers.push(removedPlayer);
        }

        // als deze speler toevallig geselecteerd was, selectie verwijderen
        if (r2SelectedPlayer && r2SelectedPlayer.id === removedPlayer.id) {
          r2SelectedPlayer = null;
        }

        // UI opnieuw tekenen
        // indeling gewijzigd (speler verwijderd)
        r2PoulesDirty = true;

        // UI opnieuw tekenen
        renderR2Poules();

        renderR2Poules();
        renderR2AvailablePlayers();
        showR2PoulesFeedback(
          "‚ôªÔ∏è Speler is uit de poule gehaald en staat weer bij de beschikbare spelers.",
          "success"
        );
        updateR2PoulesButtons();
      }

      /* =========================================================
               2E RONDE POULES ‚Äì SPELER TOEVOEGEN AAN POULE
            ========================================================= */
      function addSelectedR2PlayerToPoule(pouleNaam) {
        if (!r2SelectedPlayer) {
          showR2PoulesFeedback("‚ö†Ô∏è Selecteer eerst een speler links.", "error");
          return;
        }
        const poule = r2CurrentPoules.find((p) => p.naam === pouleNaam);
        if (!poule) return;
        if (poule.spelers.length >= poule.maxSpelers) {
          showR2PoulesFeedback("‚ùå Deze poule zit vol.", "error");
          return;
        }
        const alreadyInSomePoule = r2CurrentPoules.some((p) =>
          p.spelers.find((sp) => sp.id === r2SelectedPlayer.id)
        );
        if (alreadyInSomePoule) {
          showR2PoulesFeedback("‚ö†Ô∏è Deze speler zit al in een poule.", "error");
          return;
        }
        poule.spelers.push(r2SelectedPlayer);
        r2AvailablePlayers = r2AvailablePlayers.filter(
          (p) => p.id !== r2SelectedPlayer.id
        );
        r2SelectedPlayer = null;
        // indeling gewijzigd (speler toegevoegd)
        r2PoulesDirty = true;
        renderR2Poules();
        renderR2AvailablePlayers();
        showR2PoulesFeedback("‚úÖ Speler toegevoegd aan poule.", "success");
        updateR2PoulesButtons();
      }

      /* =========================================================
               2E RONDE POULES ‚Äì OPSLAAN IN FIRESTORE
            ========================================================= */

      async function saveCarambolesR2(spelerId, nieuweWaarde) {
        if (!activeTournamentId) return;

        const spelerRef = doc(
          db,
          "toernooien",
          activeTournamentId,
          "spelers",
          spelerId
        );

        // 1. Schrijf naar Firestore
        await updateDoc(spelerRef, { carambolesR2: nieuweWaarde });

        // 2. Update lokale caches in dit tabblad
        const p = r2AllPlayers.find((x) => x.id === spelerId);
        if (p) p.carambolesR2 = nieuweWaarde;

        const q = r2AvailablePlayers.find((x) => x.id === spelerId);
        if (q) q.carambolesR2 = nieuweWaarde;

        // 3. Heel belangrijk: ook de globale spelerslijst bijwerken
        if (
          typeof currentPlayers !== "undefined" &&
          Array.isArray(currentPlayers)
        ) {
          const cp = currentPlayers.find((x) => x.id === spelerId);
          if (cp) {
            cp.carambolesR2 = nieuweWaarde;
          }
        }
        updateR2PoulesButtons();
      }

      // Nieuw: afmelden / weer aanmelden voor de 2e ronde
      async function setR2WithdrawStatus(spelerId, withdrawn) {
        if (!activeTournamentId) return;

        const spelerRef = doc(
          db,
          "toernooien",
          activeTournamentId,
          "spelers",
          spelerId
        );

        // 1. Schrijf naar Firestore
        await updateDoc(spelerRef, { withdrawR2: withdrawn });

        // 2. Lokale caches bijwerken
        const p = r2AllPlayers.find((x) => x.id === spelerId);
        if (p) p.withdrawR2 = withdrawn;

        const q = r2AvailablePlayers.find((x) => x.id === spelerId);
        if (q) q.withdrawR2 = withdrawn;

        // 3. Ook de globale spelerslijst bijwerken (currentPlayers)
        if (Array.isArray(currentPlayers)) {
          const r = currentPlayers.find((x) => x.id === spelerId);
          if (r) r.withdrawR2 = withdrawn;
        }
      }

      async function saveR2PoulesToFirestore() {
        if (!activeTournamentId) {
          showR2PoulesFeedback("‚ö†Ô∏è Geen toernooi actief.", "error");
          return;
        }
        if (r2CurrentPoules.length === 0) {
          showR2PoulesFeedback("‚ö†Ô∏è Geen poules om op te slaan.", "error");
          return;
        }
        const poulesRef = collection(
          db,
          "toernooien",
          activeTournamentId,
          "poules_r2"
        );
        const existing = await getDocs(poulesRef);
        for (const d of existing.docs) await deleteDoc(d.ref);
        for (const p of r2CurrentPoules) {
          await setDoc(doc(poulesRef, p.naam), {
            naam: p.naam,
            maxSpelers: p.maxSpelers,
            spelers: p.spelers,
          });
        }

        // na succesvol opslaan: indeling is niet meer "dirty"
        r2PoulesDirty = false;
        showR2PoulesFeedback("üíæ 2e ronde poules opgeslagen.", "success");
        updateR2PoulesButtons();
      }

      /* =========================================================
               2E RONDE POULES ‚Äì ALLES WISSEN
            ========================================================= */
      async function clearR2Poules() {
        if (!confirm("Weet je zeker dat je alle 2e ronde poules wilt wissen?"))
          return;

        // Lokale pouledata leegmaken
        r2CurrentPoules = [];
        r2SelectedPlayer = null;
        r2PoulesDirty = false; // niets meer om op te slaan

        renderR2Poules();

        // Ranglijst en beschikbare spelers opnieuw opbouwen
        await loadR2GlobalRanking(); // herset beschikbare spelers
        if (typeof renderR2AvailablePlayers === "function") {
          renderR2AvailablePlayers();
        }

        // Eventuele poules in Firestore verwijderen
        if (activeTournamentId) {
          const poulesRef = collection(
            db,
            "toernooien",
            activeTournamentId,
            "poules_r2"
          );
          const existing = await getDocs(poulesRef);
          for (const d of existing.docs) await deleteDoc(d.ref);
        }

        showR2PoulesFeedback("üóëÔ∏è Alle 2e ronde poules gewist.", "success");
        updateR2PoulesButtons();
      }

      function resetAllCarambolesR2() {
        if (!activeTournamentId) return;

        const table = getActiveMoyCarTable();
        if (!table) {
          alert(
            "Er is geen moyennetabel gekoppeld aan dit toernooi.\n" +
              "Koppel eerst een tabel onder 'Moyenne ‚Üí caramboles'."
          );
          return;
        }

        if (!Array.isArray(r1Matches) || r1Matches.length === 0) {
          alert(
            "Er zijn nog geen (volledige) resultaten in de 1e ronde.\n" +
              "De gemiddelden kunnen nog niet worden berekend."
          );
          return;
        }

        const ok = confirm(
          "Weet je zeker dat je alle 2e ronde caramboles wilt bijwerken op basis van de gespeelde moyenne in de 1e ronde en de gekoppelde moyennetabel?"
        );
        if (!ok) return;

        let stats;
        try {
          stats = buildGlobalRankingFromStats(r1Matches, r1PoulesCache || []);
        } catch (err) {
          console.error("Fout bij berekenen globale stats 1e ronde:", err);
          alert(
            "Het is niet gelukt om de moyennes van de 1e ronde te berekenen.\n" +
              "Controleer de console voor meer details."
          );
          return;
        }

        const moyMap = new Map();
        if (Array.isArray(stats)) {
          stats.forEach((s) => {
            if (
              typeof s.moy === "number" &&
              Number.isFinite(s.moy) &&
              s.spelerId
            ) {
              moyMap.set(s.spelerId, s.moy);
            }
          });
        }

        let updatedCount = 0;
        let skippedCount = 0;

        for (const speler of r2AllPlayers) {
          const moy = moyMap.get(speler.id);
          if (typeof moy !== "number" || !Number.isFinite(moy)) {
            skippedCount++;
            continue;
          }

          const car = lookupCarambolesFromMoy(moy, table);
          if (car == null) {
            skippedCount++;
            continue;
          }

          // Waarde uit kolom "1e ronde" (basis-aantal te maken caramboles)
          const baseR1Raw = speler.caramboles;
          const baseR1Num = Number(baseR1Raw);
          const baseR1 =
            Number.isFinite(baseR1Num) && baseR1Num > 0 ? baseR1Num : 0;

          // Uitgangspunt: aantal te maken caramboles mag in de loop van
          // het toernooi nooit lager worden dan de 1e-ronde-waarde.
          // -> neem het maximum van 1e ronde en tabelwaarde.
          speler.carambolesR2 = baseR1 > 0 ? Math.max(baseR1, car) : car;

          updatedCount++;
        }

        // Tabel opnieuw tekenen met de nieuwe waarden
        renderR2AvailablePlayers();

        // Na een update moeten de waarden nog expliciet opgeslagen worden
        r2CarambolesBulkSaved = false;

        let msg =
          "üîÅ 2e ronde caramboles zijn bijgewerkt op basis van de moyennetabel.";
        if (updatedCount || skippedCount) {
          msg += ` (${updatedCount} spelers bijgewerkt`;
          if (skippedCount) {
            msg += `, ${skippedCount} spelers overgeslagen`;
          }
          msg += ".)";
        }

        showR2PoulesFeedback(
          msg + " Vergeet niet om ze op te slaan met 'Opslaan car. 2e ronde'.",
          "success"
        );
        updateR2PoulesButtons();
      }

      async function saveAllCarambolesR2FromTable() {
        if (!activeTournamentId) return;

        const ok = confirm(
          "Wil je alle huidige waarden voor 2e ronde caramboles opslaan?"
        );
        if (!ok) return;

        // Loop over alle spelers in de ranglijst
        for (const speler of r2AllPlayers) {
          const waarde = speler.carambolesR2 ?? speler.caramboles ?? 0;
          await saveCarambolesR2(speler.id, waarde);
        }

        // Markeer dat er nu bewust een volledige opslag is gedaan
        r2CarambolesBulkSaved = true;

        showR2PoulesFeedback(
          "üíæ Alle 2e ronde caramboles zijn opgeslagen.",
          "success"
        );
        updateR2PoulesButtons();
      }

      /* =========================================================
               2E RONDE POULES ‚Äì EVENT LISTENERS
            ========================================================= */
      document
        .getElementById("createR2PoulesBtn")
        .addEventListener("click", createR2Poules);

      document
        .getElementById("r2BaseLayoutBtn")
        .addEventListener("click", openR2BaseLayoutDialog);
      document
        .getElementById("saveR2PoulesBtn")
        .addEventListener("click", saveR2PoulesToFirestore);
      document
        .getElementById("clearR2PoulesBtn")
        .addEventListener("click", clearR2Poules);
      document
        .getElementById("saveCarambolesR2Btn")
        .addEventListener("click", saveAllCarambolesR2FromTable);

      document
        .getElementById("resetCarambolesR2Btn")
        .addEventListener("click", resetAllCarambolesR2);

      document
        .getElementById("r2RankTableBody")
        .addEventListener("change", async (e) => {
          const target = e.target;
          const row = target.closest("tr");
          if (!row) return;

          const spelerId = row.dataset.id;
          if (!spelerId) return;

          // 1) wijziging caramboles 2e ronde
          if (target.classList.contains("carambolesR2-input")) {
            const nieuweWaarde = Number(target.value);
            await saveCarambolesR2(spelerId, nieuweWaarde);
            showR2PoulesFeedback(
              "‚úÖ Aantal caramboles 2e ronde aangepast.",
              "success"
            );
            return;
          }

          // 2) wijziging afmeld-status (checkbox)
          if (target.classList.contains("r2-withdraw-checkbox")) {
            const withdrawn = target.checked; // aangevinkt = afgemeld

            try {
              await setR2WithdrawStatus(spelerId, withdrawn);
              // ranglijst opnieuw tekenen zodat speler boven/onder de lijn komt
              renderR2AvailablePlayers();
              updateR2PoulesButtons();
              showR2PoulesFeedback(
                withdrawn
                  ? "‚ùå Speler is afgemeld voor de 2e ronde en wordt niet meer automatisch ingedeeld."
                  : "‚úÖ Speler is weer aangemeld voor de 2e ronde.",
                "success"
              );
            } catch (err) {
              console.error(err);
              // rollback checkbox
              target.checked = !target.checked;
              showR2PoulesFeedback(
                "‚ö†Ô∏è Opslaan van de afmelding is mislukt.",
                "error"
              );
            }
          }
        });

      // =============================================
      // 2E RONDE POULES ‚Äì knopstatussen
      // =============================================
      function updateR2PoulesButtons() {
        const createBtn = document.getElementById("createR2PoulesBtn");
        const baseLayoutBtn = document.getElementById("r2BaseLayoutBtn");
        const saveBtn = document.getElementById("saveR2PoulesBtn");
        const clearBtn = document.getElementById("clearR2PoulesBtn");
        const resetCarBtn = document.getElementById("resetCarambolesR2Btn");
        const saveCarBtn = document.getElementById("saveCarambolesR2Btn");

        if (
          !createBtn ||
          !baseLayoutBtn ||
          !saveBtn ||
          !clearBtn ||
          !resetCarBtn ||
          !saveCarBtn
        ) {
          return;
        }

        const hasTournament = !!activeTournamentId;

        // Poules bestaan zodra r2CurrentPoules gevuld is
        const hasR2Poules =
          Array.isArray(r2CurrentPoules) && r2CurrentPoules.length > 0;

        // Wedstrijdschema 2e ronde bestaat zodra r2Matches bestaan
        const hasR2Schedule = Array.isArray(r2Matches) && r2Matches.length > 0;

        // Caramboles 2e ronde bewust vastgelegd? (alleen via de knop / reset)
        const carambolesSaved = !!r2CarambolesBulkSaved;

        // Alle poules volledig gevuld?
        let allFilled = false;
        if (hasR2Poules) {
          allFilled = r2CurrentPoules.every(
            (p) => Array.isArray(p.spelers) && p.spelers.length === p.maxSpelers
          );
        }

        // === Knopstatussen ===

        // 1) Poules aanmaken
        // actief als: g√©√©n poules + caramboles opgeslagen + g√©√©n wedstrijdschema
        createBtn.disabled =
          !hasTournament || hasR2Poules || !carambolesSaved || hasR2Schedule;

        // 1b) Basisindeling kiezen
        // actief als: poules bestaan + g√©√©n wedstrijdschema
        baseLayoutBtn.disabled =
          !hasTournament || !hasR2Poules || hasR2Schedule;

        // 2) Indeling opslaan
        // actief als: poules bestaan + alle poules gevuld + g√©√©n schema
        // √©n er zijn niet-opgeslagen wijzigingen (r2PoulesDirty)
        saveBtn.disabled =
          !hasTournament ||
          !hasR2Poules ||
          !allFilled ||
          hasR2Schedule ||
          !r2PoulesDirty;

        // 3) Alles wissen
        // actief als: poules bestaan + g√©√©n schema
        clearBtn.disabled = !hasTournament || !hasR2Poules || hasR2Schedule;

        // 4) Reset caramboles
        // actief als: g√©√©n poules
        resetCarBtn.disabled = !hasTournament || hasR2Poules;

        // 5) Opslaan car. 2e ronde
        // actief als: caramboles nog NIET zijn opgeslagen en er g√©√©n schema is
        saveCarBtn.disabled =
          !hasTournament || carambolesSaved || hasR2Schedule;

        // 6) Delete-knoppen achter spelers in poules deactiveren als schema bestaat
        document
          .querySelectorAll("#r2PoulesContainer button[data-player-id]")
          .forEach((btn) => {
            btn.disabled = hasR2Schedule;
            btn.style.opacity = btn.disabled ? "0.4" : "1";
            btn.style.cursor = btn.disabled ? "not-allowed" : "pointer";
          });

        // Visuele indicatie voor de hoofdknoppen
        [
          createBtn,
          baseLayoutBtn,
          saveBtn,
          clearBtn,
          resetCarBtn,
          saveCarBtn,
        ].forEach((btn) => {
          btn.style.opacity = btn.disabled ? "0.4" : "1";
          btn.style.cursor = btn.disabled ? "not-allowed" : "pointer";
        });
      }

      /* =========================================================
               2E RONDE POULES ‚Äì START BIJ TAB-OPENING
            ========================================================= */
      async function loadR2PoulesForActiveTournament() {
        if (!activeTournamentId) return;

        // 1) Altijd eerst ranglijst (her)bouwen
        await loadR2GlobalRanking();

        // 1b) Als we naar een ander toernooi zijn gesprongen:
        //     lokale poule-indeling resetten, zodat er niets "meelekt"
        if (r2PoulesTournamentId !== activeTournamentId) {
          r2CurrentPoules = [];
          r2SelectedPlayer = null;
          r2PoulesDirty = false;
          r2PoulesTournamentId = activeTournamentId;
        }

        // 2) Probeer poules uit Firestore te halen
        const poulesRef = collection(
          db,
          "toernooien",
          activeTournamentId,
          "poules_r2"
        );
        const snap = await getDocs(poulesRef);

        if (!snap.empty) {
          // Firestore is leidend als er al opgeslagen poules zijn
          r2CurrentPoules = snap.docs.map((d) => d.data());
          // toestand uit Firestore = niet dirty
          r2PoulesDirty = false;
        } else {
          // Firestore leeg bij dit toernooi
          // -> geen poules tonen (r2CurrentPoules is hierboven al gewist bij toernooiwissel)
          if (!Array.isArray(r2CurrentPoules) || r2CurrentPoules.length === 0) {
            r2PoulesDirty = false;
          }
        }

        // 3) Ongeacht bron: haal alle spelers die al in een poule zitten uit available
        const idsInPoules = new Set(
          (r2CurrentPoules || []).flatMap((p) =>
            (p.spelers || []).map((sp) => sp.id)
          )
        );

        r2AvailablePlayers = r2AllPlayers.filter((p) => !idsInPoules.has(p.id));

        // 4) UI altijd opnieuw tekenen
        renderR2Poules();
        renderR2AvailablePlayers();
        updateR2PoulesButtons();
      }

      /* =========================================================
               2E RONDE POULES ‚Äì AUTO-LADEN BIJ TAB-KLIK
            ========================================================= */
      document
        .querySelector('button[data-tab="r2poules"]')
        .addEventListener("click", () => {
          loadR2PoulesForActiveTournament();

          updateR2PoulesButtons();
        });

      /* =========================================================
               2E RONDE RESULTATEN ‚Äì GLOBALE VARIABELEN
            ========================================================= */
      let r2Matches = [];
      let r2ToernooiSettings = {};
      let r2PoulesCache = [];
      // ===== FINALE =====
      let finaleCandidates = [];

      /* =========================================================
               2E RONDE RESULTATEN ‚Äì UI HELPERS
            ========================================================= */
      function showR2PopupMessage(msg, isError = true) {
        const existing = document.getElementById("r2PopupMsg");
        if (existing) existing.remove();
        const popup = document.createElement("div");
        popup.id = "r2PopupMsg";
        popup.style.cssText = `
                position:fixed;top:20%;left:50%;transform:translateX(-50%);
                background:${isError ? "#f8d7da" : "#d1e7dd"};
                color:${isError ? "#842029" : "#0f5132"};
                border:1px solid ${isError ? "#f5c2c7" : "#badbcc"};
                border-radius:8px;padding:20px 25px;z-index:2000;
                box-shadow:0 4px 12px rgba(0,0,0,0.3);text-align:center;min-width:280px`;
        popup.innerHTML = `
                <div>${msg}</div>
                <button style="margin-top:12px;background:#fff;border:1px solid #ccc;
                  border-radius:4px;padding:5px 15px;cursor:pointer;">OK</button>`;
        popup.querySelector("button").onclick = () => popup.remove();
        document.body.appendChild(popup);
      }

      function renderR2ScoringOverview() {
        const el = document.getElementById("r2ScoringOverview");
        if (!r2ToernooiSettings || !r2ToernooiSettings.punten) {
          el.style.display = "none";
          return;
        }
        const p = r2ToernooiSettings.punten;
        const maxB = r2ToernooiSettings.maxBeurten;
        const maxText = maxB ? maxB : "Niet van toepassing";
        el.style.display = "block";
        el.innerHTML = `
                <strong>Maximaal aantal beurten:</strong> ${maxText}<br>
                <strong>Punten:</strong>
                Winst &lt; max: ${p.winLess}, Gelijk &lt; max: ${p.drawLess}, Verlies &lt; max: ${p.loseLess} |
                Winst = max: ${p.winMax}, Gelijk = max: ${p.drawMax}, Verlies = max: ${p.loseMax}`;
      }

      function updateR2OverallProgress() {
        const total = r2Matches.length;
        const played = r2Matches.filter((m) => m.afgerond).length;
        const perc = total ? Math.round((played / total) * 100) : 0;
        const el = document.getElementById("r2OverallProgress");
        el.style.display = total === 0 ? "none" : "block";
        el.textContent = `Totaal gespeeld: ${played} / ${total} wedstrijden (${perc}%)`;
      }

      /* =========================================================
               2E RONDE RESULTATEN ‚Äì WEDSTRIJDEN LADEN
            ========================================================= */
      async function loadR2MatchesFromFirestore() {
        if (!activeTournamentId) {
          document.getElementById("noTournamentR2ResNotice").style.display =
            "block";
          return;
        }
        document.getElementById("noTournamentR2ResNotice").style.display =
          "none";

        const tournRef = doc(db, "toernooien", activeTournamentId);
        const tournSnap = await getDoc(tournRef);
        r2ToernooiSettings = tournSnap.data() || {};
        renderR2ScoringOverview();

        const matchesRef = collection(
          db,
          "toernooien",
          activeTournamentId,
          "r2_wedstrijden"
        );
        const snap = await getDocs(matchesRef);
        r2Matches = snap.docs.map((d) => ({ id: d.id, ...d.data() }));

        const poulesRef = collection(
          db,
          "toernooien",
          activeTournamentId,
          "poules_r2"
        );
        const poulesSnap = await getDocs(poulesRef);
        r2PoulesCache = poulesSnap.docs.map((d) => ({ id: d.id, ...d.data() }));
        renderR2Matches();
        updateR2ResultsButtons(); // ‚úÖ knoppen altijd goed zetten na laden
      }

      // ======================================================================
      // 2E RONDE RESULTATEN ‚Äì ALLE WEDSTRIJDEN VAN EEN POULE OPNIEUW BEREKENEN
      // ======================================================================
      async function recalcR2PouleMatches(pouleId) {
        if (!activeTournamentId) return;

        const pouleDoc = r2PoulesCache.find((p) => p.id === pouleId);
        if (!pouleDoc) return;

        // Alle wedstrijden van deze poule
        const matchesInPoule = r2Matches.filter((m) => m.poule === pouleId);

        for (const m of matchesInPoule) {
          if (!m.afgerond) continue; // alleen afgeronde wedstrijden herberekenen

          const gX = Number(m.gemaakteX) || 0;
          const gY = Number(m.gemaakteY) || 0;
          const b = Number(m.beurten) || 0;

          // Punten opnieuw bepalen op basis van DE NIEUWE factor
          const { pX, pY, uitslag } = calcR1Points(
            gX,
            gY,
            b,
            toernooiSettings.maxBeurten || 0,
            m.spelerX.teMaken,
            m.spelerY.teMaken,
            toernooiSettings.punten,
            pouleDoc
          );

          // Opslaan in Firestore
          await saveR2MatchResultFields(m.id, {
            gemaakteX: gX,
            gemaakteY: gY,
            beurten: b,
            puntenX: pX,
            puntenY: pY,
            uitslag,
          });

          // Update lokale cache
          m.puntenX = pX;
          m.puntenY = pY;
          m.uitslag = uitslag;
        }

        // UI opnieuw opbouwen
        // await loadR2MatchesFromFirestore();
      }

      /* =========================================================
               2E RONDE RESULTATEN ‚Äì WEDSTRIJDEN TONEN
            ========================================================= */
      function renderR2Matches() {
        const wrapper = document.getElementById("r2matchesWrapper");
        wrapper.innerHTML = "";
        if (!r2Matches.length) {
          wrapper.innerHTML =
            "<p style='color:#777'>Geen wedstrijden gevonden.</p>";
          updateR2OverallProgress();
          document.getElementById("r2GlobalStandTable").innerHTML = "";
          return;
        }
        updateR2OverallProgress();

        const pouleMap = {};
        r2Matches.forEach((m) => {
          if (!pouleMap[m.poule]) pouleMap[m.poule] = [];
          pouleMap[m.poule].push(m);
        });

        Object.keys(pouleMap)
          .sort()
          .forEach((pouleNaam) => {
            const matchesRaw = pouleMap[pouleNaam];
            const pouleDoc = r2PoulesCache.find((p) => p.id === pouleNaam);
            const pouleSize = pouleDoc?.spelers?.length || 4;
            const is5 = pouleSize === 5;
            const matches = sortHomeAway(matchesRaw); // hergebruik bestaande helper

            const played = matches.filter((m) => m.afgerond).length;
            const total = matches.length;
            const perc = total ? Math.round((played / total) * 100) : 0;

            const headerId = `r2phead_${pouleNaam}`;
            const bodyId = `r2pbody_${pouleNaam}`;

            // factor-info uit pouleDoc (indien aanwezig)
            const basePlayers = pouleDoc?.factorBasePlayers || 4;
            const factorEnabled = !!pouleDoc?.factorEnabled;
            const rawFactorValue =
              typeof pouleDoc?.factorValue === "number"
                ? pouleDoc.factorValue
                : null;

            let factorValue;
            if (factorEnabled && rawFactorValue != null) {
              factorValue = rawFactorValue;
            } else if (is5) {
              // default 5-spelers poule ‚Üí 0,75
              factorValue = 0.75;
            } else {
              factorValue = 1.0;
            }

            const factorText =
              factorValue !== 1
                ? `(punten √ó${factorValue.toFixed(2).replace(".", ",")})`
                : "";

            const factorNote = pouleDoc?.factorNote || "";
            const factorBadge =
              factorEnabled && factorValue !== 1
                ? `<span
                          class="r2-poule-factor-indicator"
                          title="${
                            factorNote
                              ? "Toelichting: " +
                                factorNote.replace(/"/g, "&quot;")
                              : "Afwijkende factor voor puntentelling in deze poule"
                          }"
                          style="margin-left:4px;font-size:0.75em;background:#fff3cd;color:#856404;border-radius:999px;padding:2px 6px;border:1px solid #ffe69c;"
                        >!</span>`
                : "";

            const wasOpen = pouleOpenStateR2[pouleNaam] === true;

            let html = `
                    <div class="poule-block" data-poule="${pouleNaam}" style="border:1px solid #ccc;border-radius:8px;background:#fff;margin-bottom:16px">
                      <div
                        id="${headerId}"
                        class="poule-header"
                        style="cursor:pointer;display:flex;justify-content:space-between;align-items:center;background:#e9f5ff;padding:8px 10px;border-radius:8px 8px 0 0;font-weight:600"
                      >
                        <div style="display:flex;align-items:center;gap:6px;">
                          <strong>${pouleNaam}</strong>
                          ${
                            factorText
                              ? `<span style="font-size:0.85em;color:#0c6dfd;">${factorText}</span>`
                              : ""
                          }
                          ${factorBadge}
                          <button
                            type="button"
                            class="r2-poule-factor-btn"
                            data-poule="${pouleNaam}"
                            title="Factor voor puntentelling instellen (2e ronde)"
                            style="margin-left:4px;background:#ffc107;color:#212529;border:none;border-radius:50%;width:22px;height:22px;font-size:0.9em;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;"
                          >!</button>
                        </div>
                        <div style="font-size:0.85em;color:#34495e;">
                          Totaal gespeeld: ${played} / ${total} wedstrijden (${perc}%)
                        </div>
                      </div>
                         <div id="${bodyId}" class="poule-body"
                          style="display:${
                            wasOpen ? "block" : "none"
                          };padding:10px 10px 12px">

                      <table style="width:100%;border-collapse:collapse;font-size:0.92em">
                        <thead style="background:#eef2f6">
                          <tr>
                            <th style="text-align:left;padding:6px 4px">Speler A</th>
                            <th style="text-align:right;padding:6px 4px">Te&nbsp;maken A</th>
                            <th style="text-align:left;padding:6px 4px">Speler B</th>
                            <th style="text-align:right;padding:6px 4px">Te&nbsp;maken B</th>
                            <th style="text-align:right;padding:6px 4px">Gemaakte A</th>
                            <th style="text-align:right;padding:6px 4px">Gemaakte B</th>
                            <th style="text-align:right;padding:6px 4px">Beurten</th>
                            <th style="text-align:center;padding:6px 4px">Uitslag</th>
                            <th style="text-align:center;padding:6px 4px">Acties</th>
                          </tr>
                        </thead>
                        <tbody>`;

            matches.forEach((m) => {
              const gX = m.gemaakteX ?? "";
              const gY = m.gemaakteY ?? "";
              const b = m.beurten ?? "";
              const uitslag =
                m.puntenX != null && m.puntenY != null
                  ? `${m.puntenX} - ${m.puntenY}`
                  : "";
              const rowBg = m.afgerond ? "background:#B3FF87" : "";

              html += `
                    <tr data-matchid="${
                      m.id
                    }" style="border-bottom:1px solid #eee;${rowBg}">
                      <td style="padding:6px 4px">${m.spelerX?.naam ?? ""}</td>
                      <td style="padding:6px 4px;text-align:right">${
                        m.spelerX?.teMaken ?? ""
                      }</td>
                      <td style="padding:6px 4px">${m.spelerY?.naam ?? ""}</td>
                      <td style="padding:6px 4px;text-align:right">${
                        m.spelerY?.teMaken ?? ""
                      }</td>
                      <td style="padding:6px 4px;text-align:right"><input type="number" value="${gX}" class="r2-input" data-field="gemaakteX" style="width:70px;text-align:right"></td>
                      <td style="padding:6px 4px;text-align:right"><input type="number" value="${gY}" class="r2-input" data-field="gemaakteY" style="width:70px;text-align:right"></td>
                      <td style="padding:6px 4px;text-align:right"><input type="number" value="${b}" class="r2-input" data-field="beurten" style="width:70px;text-align:right"></td>
                      <td style="padding:6px 4px;text-align:center;font-weight:600">${uitslag}</td>
                      <td style="padding:6px 4px;text-align:center">
                        <button class="actie-btn save" data-action="save" title="Opslaan">üíæ</button>
                        <button class="actie-btn reset" data-action="reset" title="Uitslag verwijderen">üóëÔ∏è</button>
                      </td>
                    </tr>`;
            });

            html += `</tbody></table>`;
            html += `<div style="margin-top:12px;border-top:1px dashed #ddd;padding-top:10px">${renderPouleStandHTML(
              pouleNaam,
              matches,
              pouleDoc
            )}</div>`;
            html += `</div></div>`;
            wrapper.insertAdjacentHTML("beforeend", html);

            // in/uitklappen ‚Äì beginstatus: gebruik eerder gekozen open/dicht toestand
            const headerEl = document.getElementById(headerId);
            const bodyEl = document.getElementById(bodyId);

            // beginstatus op basis van pouleOpenStateR2
            if (wasOpen) {
              bodyEl.style.display = "block";
              headerEl.style.borderRadius = "8px 8px 0 0";
            } else {
              bodyEl.style.display = "none";
              headerEl.style.borderRadius = "8px";
            }

            headerEl.addEventListener("click", () => {
              const nowOpen = bodyEl.style.display === "none";
              bodyEl.style.display = nowOpen ? "block" : "none";
              headerEl.style.borderRadius = nowOpen ? "8px 8px 0 0" : "8px";
              pouleOpenStateR2[pouleNaam] = nowOpen; // onthouden
            });

            // factor-knop koppelen (voorkom dat de header inklapt)
            const factorBtn = document.querySelector(
              `.r2-poule-factor-btn[data-poule="${pouleNaam}"]`
            );
            if (factorBtn) {
              factorBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                configureR2PouleFactor(pouleNaam);
              });
            }
          });

        // globale stand
        const globalStats = buildGlobalRankingFromStats(
          r2Matches,
          r2PoulesCache
        );
        let gHtml = `
                <table style="width:100%;border-collapse:collapse;font-size:0.9em;margin-top:10px">
                  <thead style="background:#f8f9fa">
                    <tr>
                      <th style="text-align:left;padding:4px;border-bottom:1px solid #ddd">#</th>
                      <th style="text-align:left;padding:4px;border-bottom:1px solid #ddd">Speler</th>
                      <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">Ptn</th>
                      <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">Rang&nbsp;Ptn</th>
                      <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">%Car</th>
                      <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">Rang&nbsp;%Car</th>
                      <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">Totaal&nbsp;Rang</th>
                    </tr>
                  </thead>
                  <tbody>`;
        globalStats.forEach((row, idx) => {
          const percCarText = row.percCar.toFixed(1).replace(".", ",") + "%";
          const isTop8 = idx < 8;
          const bgColor = isTop8 ? "background:#d1e7dd;" : "";
          gHtml += `
                  <tr style="border-bottom:1px solid #eee;${bgColor}">
                    <td style="padding:4px">${idx + 1}</td>
                    <td style="padding:4px">${row.naam}</td>
                    <td style="padding:4px;text-align:right">${Number(
                      row.puntenTotaal
                    )}</td>
                    <td style="padding:4px;text-align:right">${row.rankPoints_punten.toFixed(
                      1
                    )}</td>
                    <td style="padding:4px;text-align:right">${percCarText}</td>
                    <td style="padding:4px;text-align:right">${row.rankPoints_percCar.toFixed(
                      1
                    )}</td>
                    <td style="padding:4px;text-align:right;font-weight:600">${row.rankTotaal.toFixed(
                      1
                    )}</td>
                  </tr>`;
        });
        gHtml += `</tbody></table>`;
        document.getElementById("r2GlobalStandTable").innerHTML = gHtml;
      }

      // ----------------------------------------------------------
      // 2E RONDE RESULTATEN ‚Äì factor per poule instellen
      // ----------------------------------------------------------
      async function configureR2PouleFactor(pouleId) {
        if (!activeTournamentId) {
          alert("Er is geen actief toernooi geladen.");
          return;
        }

        const pouleDoc = r2PoulesCache.find((p) => p.id === pouleId);
        if (!pouleDoc) {
          alert("Poule niet gevonden.");
          return;
        }

        const huidigeActual = pouleDoc.factorActualPlayers || "";
        const huidigeNote = pouleDoc.factorNote || "";
        const basePlayers = pouleDoc.factorBasePlayers || 4;

        const input = prompt(
          `Werkelijk aantal spelers voor puntentelling in ${pouleId} (leeg = factor uitzetten):`,
          huidigeActual ? String(huidigeActual) : ""
        );
        if (input === null) return; // gebruiker annuleert

        const trimmed = input.trim();

        const pouleRef = doc(
          db,
          "toernooien",
          activeTournamentId,
          "poules_r2",
          pouleId
        );

        // Leeg = factor uitzetten, terug naar normale logica
        if (trimmed === "") {
          await updateDoc(pouleRef, {
            factorEnabled: false,
          });
          pouleDoc.factorEnabled = false;
          await loadR2MatchesFromFirestore();
          return;
        }

        const actual = Number(trimmed);
        if (!Number.isFinite(actual) || actual < 2 || actual > 8) {
          alert("Voer een geldig aantal spelers in (minimaal 2, maximaal 8).");
          return;
        }

        const note = prompt(
          "Korte toelichting (wordt als mouse-over getoond, bijv. welke speler is uitgevallen):",
          huidigeNote
        );

        // Factor berekenen op basis van 'normaal' aantal spelers vs werkelijk aantal
        const refPlayers = basePlayers || 4; // standaard 4
        const matchesRef = (refPlayers - 1) * 2;
        const matchesActual = (actual - 1) * 2;
        const factor = matchesActual > 0 ? matchesRef / matchesActual : 1.0;

        const factorEnabled = Math.abs(factor - 1) > 0.0001;

        await updateDoc(pouleRef, {
          factorEnabled,
          factorBasePlayers: refPlayers,
          factorActualPlayers: actual,
          factorValue: factor,
          factorNote: note || "",
        });

        // lokale cache bijwerken
        pouleDoc.factorEnabled = factorEnabled;
        pouleDoc.factorBasePlayers = refPlayers;
        pouleDoc.factorActualPlayers = actual;
        pouleDoc.factorValue = factor;
        pouleDoc.factorNote = note || "";

        // ============================
        // Uitslagen opnieuw berekenen
        // ============================
        await recalcR2PouleMatches(pouleId);

        // alles opnieuw laden met nieuwe factor
        await loadR2MatchesFromFirestore();
      }

      /* =========================================================
               2E RONDE RESULTATEN ‚Äì EVENT-LISTENERS VOOR ACTIE-KNOPPEN
            ========================================================= */
      document
        .getElementById("r2matchesWrapper")
        .addEventListener("click", async (e) => {
          const btn = e.target.closest(".actie-btn");
          if (!btn) return;
          e.stopPropagation();
          const tr = btn.closest("tr");
          const id = tr.dataset.matchid;
          const action = btn.dataset.action;

          if (action === "save") {
            const inputs = tr.querySelectorAll(".r2-input");
            const values = {};
            inputs.forEach((i) => (values[i.dataset.field] = Number(i.value)));

            const m = r2Matches.find((x) => x.id === id);
            const err = validateR1Inputs(
              values.gemaakteX,
              values.gemaakteY,
              values.beurten,
              r2ToernooiSettings.maxBeurten || 0,
              m.spelerX.teMaken,
              m.spelerY.teMaken
            );
            if (err) {
              showR2PopupMessage(err, true);
              return;
            }

            const pouleDoc = r2PoulesCache.find((p) => p.id === m.poule);
            const { pX, pY, uitslag } = calcR1Points(
              values.gemaakteX,
              values.gemaakteY,
              values.beurten,
              r2ToernooiSettings.maxBeurten || 0,
              m.spelerX.teMaken,
              m.spelerY.teMaken,
              r2ToernooiSettings.punten,
              pouleDoc
            );

            await saveR2MatchResultFields(id, {
              gemaakteX: values.gemaakteX,
              gemaakteY: values.gemaakteY,
              beurten: values.beurten,
              puntenX: pX,
              puntenY: pY,
              resultaat: uitslag,
              afgerond: true,
            });
          } else if (action === "reset") {
            await resetR2MatchResult(id);
          }
        });

      /* =========================================================
               2E RONDE RESULTATEN ‚Äì HELPERS (hergebruik 1e ronde)
            ========================================================= */
      async function saveR2MatchResultFields(matchId, update) {
        const ref = doc(
          db,
          "toernooien",
          activeTournamentId,
          "r2_wedstrijden",
          matchId
        );

        // 1) Updaten in Firestore
        await updateDoc(ref, update);

        // 2) Lokale cache bijwerken
        if (Array.isArray(r2Matches)) {
          const idx = r2Matches.findIndex((m) => m.id === matchId);
          if (idx !== -1) {
            r2Matches[idx] = { ...r2Matches[idx], ...update };
          }
        }

        // 3) UI verversen, maar open/dicht-status van poules behouden
        showR2PopupMessage("‚úÖ Wedstrijd opgeslagen", false);
        renderR2Matches();
        updateR2ResultsButtons();
      }

      async function resetR2MatchResult(matchId) {
        const ok = confirm(
          "Alleen de ingevoerde resultaten van deze wedstrijd verwijderen?"
        );
        if (!ok) return;

        const ref = doc(
          db,
          "toernooien",
          activeTournamentId,
          "r2_wedstrijden",
          matchId
        );

        // 1) Firestore resetten
        await updateDoc(ref, {
          gemaakteX: null,
          gemaakteY: null,
          beurten: null,
          puntenX: null,
          puntenY: null,
          afgerond: false,
          resultaat: null,
        });

        // 2) Lokale cache resetten
        if (Array.isArray(r2Matches)) {
          const idx = r2Matches.findIndex((m) => m.id === matchId);
          if (idx !== -1) {
            r2Matches[idx] = {
              ...r2Matches[idx],
              gemaakteX: null,
              gemaakteY: null,
              beurten: null,
              puntenX: null,
              puntenY: null,
              afgerond: false,
              resultaat: null,
            };
          }
        }

        // 3) UI verversen, maar open/dicht-status behouden
        showR2PopupMessage("üóëÔ∏è Uitslag verwijderd", false);
        renderR2Matches();
        updateR2ResultsButtons();
      }

      /* =========================================================
               2E RONDE RESULTATEN ‚Äì WEDSTRIJDEN AANMAKEN
            ========================================================= */
      async function createR2MatchSchedule() {
        if (!activeTournamentId) {
          showR2PopupMessage("‚ö†Ô∏è Geen toernooi geselecteerd.", true);
          return;
        }
        const poules = await getR2Poules();
        if (!poules.length) {
          showR2PopupMessage(
            "‚ö†Ô∏è Geen poules gevonden. Maak eerst een poule-indeling.",
            true
          );
          return;
        }

        const matchesRef = collection(
          db,
          "toernooien",
          activeTournamentId,
          "r2_wedstrijden"
        );
        const existingSnap = await getDocs(matchesRef);
        if (!existingSnap.empty) {
          const confirmOverwrite = confirm(
            `Er bestaan al ${existingSnap.size} wedstrijden in 2e ronde.\n\nWil je deze overschrijven? Alle bestaande uitslagen gaan verloren.`
          );
          if (!confirmOverwrite) return;
          const batch = writeBatch(db);
          existingSnap.forEach((d) => batch.delete(d.ref));
          await batch.commit();
        }

        const batch = writeBatch(db);
        let totalMatches = 0;
        poules.forEach((poule) => {
          const spelers = poule.spelers || [];
          for (let i = 0; i < spelers.length; i++) {
            for (let j = 0; j < spelers.length; j++) {
              if (i === j) continue;
              const safePouleId = poule.id.replace(/\s+/g, "_");
              const matchId = `${safePouleId}_${spelers[i].id}_${spelers[j].id}`;
              const matchRef = doc(
                db,
                "toernooien",
                activeTournamentId,
                "r2_wedstrijden",
                matchId
              );
              batch.set(matchRef, {
                poule: poule.id,
                spelerX: {
                  id: spelers[i].id,
                  naam: spelers[i].naam,
                  teMaken:
                    spelers[i].carambolesR2 || spelers[i].caramboles || 0,
                },
                spelerY: {
                  id: spelers[j].id,
                  naam: spelers[j].naam,
                  teMaken:
                    spelers[j].carambolesR2 || spelers[j].caramboles || 0,
                },
                gemaakteX: null,
                gemaakteY: null,
                beurten: null,
                puntenX: null,
                puntenY: null,
                afgerond: false,
                resultaat: null,
              });
              totalMatches++;
            }
          }
        });
        await batch.commit();
        showR2PopupMessage(
          `‚úÖ Wedstrijdschema 2e ronde aangemaakt: ${totalMatches} wedstrijden.`,
          false
        );
        await loadR2MatchesFromFirestore();
      }

      /* =========================================================
               2E RONDE RESULTATEN ‚Äì WEDSTRIJDEN WISSEN
            ========================================================= */
      async function deleteR2Matches() {
        if (!activeTournamentId) {
          showR2PopupMessage("‚ö†Ô∏è Geen toernooi geselecteerd.", true);
          return;
        }
        const confirmDelete = confirm(
          "Weet je zeker dat je ALLE wedstrijden van de 2e ronde wilt verwijderen?\n\n‚ö†Ô∏è Alle ingevoerde uitslagen gaan verloren!"
        );
        if (!confirmDelete) return;
        const matchesRef = collection(
          db,
          "toernooien",
          activeTournamentId,
          "r2_wedstrijden"
        );
        const snap = await getDocs(matchesRef);
        if (snap.empty) {
          showR2PopupMessage(
            "Er zijn geen wedstrijden om te verwijderen.",
            true
          );
          return;
        }
        const batch = writeBatch(db);
        let count = 0;
        snap.forEach((d) => {
          batch.delete(d.ref);
          count++;
        });
        await batch.commit();
        showR2PopupMessage(
          `üóëÔ∏è ${count} wedstrijden 2e ronde verwijderd.`,
          false
        );
        await loadR2MatchesFromFirestore();
      }

      /* =========================================================
               2E RONDE RESULTATEN ‚Äì POULES OPVRAGEN
            ========================================================= */
      async function getR2Poules() {
        const poulesRef = collection(
          db,
          "toernooien",
          activeTournamentId,
          "poules_r2"
        );
        const snap = await getDocs(poulesRef);
        return snap.docs.map((d) => ({ id: d.id, ...d.data() }));
      }

      /* =========================================================
         ADMIN TAB: USERS CRUD
      ========================================================= */
      const userForm = document.getElementById("userForm");
      const usersTableWrap = document.getElementById("usersTableWrap");
      const adminFeedback = document.getElementById("adminFeedback");
      const linkUserSelect = document.getElementById("linkUserSelect");
      const linkTournamentsList = document.getElementById(
        "linkTournamentsList"
      );
      const saveLinksBtn = document.getElementById("saveLinksBtn");

      let adminUsersCache = [];
      let adminTournamentsCache = [];

      function showAdminFeedback(msg, type = "info") {
        const color =
          type === "error"
            ? "#f8d7da"
            : type === "success"
            ? "#d1e7dd"
            : "#e2e3e5";
        const textColor =
          type === "error"
            ? "#842029"
            : type === "success"
            ? "#0f5132"
            : "#41464b";
        adminFeedback.innerHTML = `
          <div class="message" style="background:${color};color:${textColor};">
            ${msg}
            <span class="close" onclick="this.parentElement.remove()">√ó</span>
          </div>`;
      }

      async function loadUsersAdminTab() {
        const snap = await getDocs(collection(db, "users"));
        adminUsersCache = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
        renderUsersTable();
        buildLinkUserSelect();
      }

      function renderTournamentBadges(tournamentIds) {
        if (!tournamentIds.length) return "0";

        const labels = tournamentIds.map((tid) => {
          const t = adminTournamentsCache.find((x) => x.id === tid);
          if (!t) return tid; // fallback als cache nog leeg is
          return `${t.naam} (${t.jaar})`;
        });

        const count = tournamentIds.length;
        return `
              <div style="display:flex;flex-direction:column;gap:4px;">
                <div><strong>${count}</strong></div>
                <div style="font-size:12px;color:#555;">
                  ${labels.join("<br>")}
                </div>
              </div>
            `;
      }

      function renderUsersTable() {
        if (!usersTableWrap) return;

        if (!adminUsersCache.length) {
          usersTableWrap.innerHTML = "<p>Nog geen gebruikers.</p>";
          return;
        }

        let html = `
          <table class="player-table">
            <thead>
              <tr>
                <th>Gebruikersnaam</th>
                <th>Naam</th>
                <th>Rol</th>
                <th>Toernooien</th>
                <th style="text-align:center;">Acties</th>
              </tr>
            </thead>
            <tbody>`;

        adminUsersCache.forEach((u) => {
          html += `
            <tr data-uid="${u.id}">
              <td>${u.username || ""}</td>
              <td>${u.displayName || ""}</td>
              <td>${u.role || "user"}</td>
              <td>
                ${renderTournamentBadges(u.tournaments || [])}
              </td>

              <td class="actions">
                <button class="edit-user-btn" style="background:#0d6efd;color:#fff;border:none;border-radius:6px;padding:4px 8px;">‚úèÔ∏è</button>
                <button class="delete-user-btn" style="background:#dc3545;color:#fff;border:none;border-radius:6px;padding:4px 8px;">üóëÔ∏è</button>
              </td>
            </tr>`;
        });

        html += `</tbody></table>`;
        usersTableWrap.innerHTML = html;

        usersTableWrap.querySelectorAll(".edit-user-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const tr = btn.closest("tr");
            const u = adminUsersCache.find((x) => x.id === tr.dataset.uid);
            if (!u) return;
            document.getElementById("uUsername").value = u.username || "";
            document.getElementById("uDisplay").value = u.displayName || "";
            document.getElementById("uRole").value = u.role || "user";
            document.getElementById("uPassword").value = ""; // leeg laten => alleen wijzigen als ingevuld
            userForm.dataset.editing = u.id;
            showAdminFeedback(`Bewerken: ${u.username}`, "info");
          });
        });

        usersTableWrap.querySelectorAll(".delete-user-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const tr = btn.closest("tr");
            const uid = tr.dataset.uid;
            const u = adminUsersCache.find((x) => x.id === uid);
            if (!u) return;

            // ‚úÖ Check: laatste admin mag niet verwijderd worden
            if (u.role === "admin") {
              const adminsLeft = adminUsersCache.filter(
                (x) => x.role === "admin" && x.id !== uid
              );
              if (adminsLeft.length === 0) {
                showAdminFeedback(
                  "Je kunt de laatste admin niet verwijderen.",
                  "error"
                );
                return;
              }
            }

            if (!confirm(`Verwijder gebruiker "${u.username}"?`)) return;

            await deleteDoc(doc(db, "users", uid));
            showAdminFeedback("Gebruiker verwijderd.", "success");
            await loadUsersAdminTab();
          });
        });
      }

      userForm?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const username = document.getElementById("uUsername").value.trim();
        const displayName = document.getElementById("uDisplay").value.trim();
        const password = document.getElementById("uPassword").value;
        const role = document.getElementById("uRole").value;

        if (!username || !displayName) {
          showAdminFeedback("Gebruikersnaam en naam zijn verplicht.", "error");
          return;
        }

        const editingId = userForm.dataset.editing || null;

        // ‚úÖ check: laatste admin mag niet gedegradeerd worden
        if (editingId) {
          const existing = adminUsersCache.find((x) => x.id === editingId);
          if (existing?.role === "admin" && role !== "admin") {
            const otherAdmins = adminUsersCache.filter(
              (x) => x.role === "admin" && x.id !== editingId
            );
            if (otherAdmins.length === 0) {
              showAdminFeedback(
                "Je kunt de laatste admin niet omzetten naar gebruiker.",
                "error"
              );
              return;
            }
          }
        }

        // wachtwoord alleen verplicht bij nieuwe user
        if (!editingId && !password) {
          showAdminFeedback(
            "Wachtwoord is verplicht bij nieuwe gebruiker.",
            "error"
          );
          return;
        }

        // username uniek houden
        const lower = username.toLowerCase();
        const conflict = adminUsersCache.find(
          (u) => u.username?.toLowerCase() === lower && u.id !== editingId
        );
        if (conflict) {
          showAdminFeedback("Gebruikersnaam bestaat al.", "error");
          return;
        }

        const data = { username, displayName, role };

        if (password) {
          data.password = password;
        }

        if (editingId) {
          await setDoc(doc(db, "users", editingId), data, { merge: true });
          showAdminFeedback("Gebruiker bijgewerkt.", "success");
          userForm.dataset.editing = "";
        } else {
          data.tournaments = [];
          await addDoc(collection(db, "users"), data);
          showAdminFeedback("Gebruiker toegevoegd.", "success");
        }

        userForm.reset();
        await loadUsersAdminTab();
      });

      /* =========================================================
         ADMIN TAB: TOERNOOI KOPPELINGEN
      ========================================================= */
      async function loadTournamentsForLinking() {
        const snap = await getDocs(collection(db, "toernooien"));
        adminTournamentsCache = snap.docs.map((d) => ({
          id: d.id,
          ...d.data(),
        }));
        renderTournamentsChecklist();

        // ‚úÖ extra: nu cache gevuld is, usertabel opnieuw tekenen met namen
        renderUsersTable();
      }

      function buildLinkUserSelect() {
        if (!linkUserSelect) return;
        linkUserSelect.innerHTML = `<option value="">Kies gebruiker...</option>`;
        adminUsersCache.forEach((u) => {
          linkUserSelect.innerHTML += `<option value="${u.id}">${u.username} (${u.displayName})</option>`;
        });

        linkUserSelect.onchange = () => renderTournamentsChecklist();
      }

      function renderTournamentsChecklist() {
        if (!linkTournamentsList) return;
        const uid = linkUserSelect.value;
        const user = adminUsersCache.find((u) => u.id === uid);

        linkTournamentsList.innerHTML = "";

        adminTournamentsCache
          .sort(
            (a, b) =>
              (a.jaar || 0) - (b.jaar || 0) ||
              (a.naam || "").localeCompare(b.naam || "")
          )
          .forEach((t) => {
            const checked = user?.tournaments?.includes(t.id) ? "checked" : "";
            const row = document.createElement("label");
            row.style.display = "block";
            row.style.marginBottom = "4px";
            row.innerHTML = `
              <input type="checkbox" data-tid="${t.id}" ${checked} />
              ${t.naam} (${t.jaar})
            `;
            linkTournamentsList.appendChild(row);
          });
      }

      saveLinksBtn?.addEventListener("click", async () => {
        const uid = linkUserSelect.value;
        if (!uid) {
          showAdminFeedback("Kies eerst een gebruiker.", "error");
          return;
        }
        const selected = [
          ...linkTournamentsList.querySelectorAll("input[type=checkbox]"),
        ]
          .filter((cb) => cb.checked)
          .map((cb) => cb.dataset.tid);

        await setDoc(
          doc(db, "users", uid),
          { tournaments: selected },
          { merge: true }
        );
        showAdminFeedback("Koppelingen opgeslagen.", "success");
        await loadUsersAdminTab();
      });

      /* =========================================================
         1E RONDE RESULTATEN ‚Äì AUTO-LADEN BIJ TAB-KLIK
      ========================================================= */
      document
        .querySelector('button[data-tab="r1resultaten"]')
        .addEventListener("click", () => {
          Object.keys(pouleOpenState).forEach(
            (k) => (pouleOpenState[k] = false)
          );
          loadR1MatchesFromFirestore(); // vult r1Matches
          updateR1ResultsButtons(); // zet knoppen direct goed
        });

      /* =========================================================
               2E RONDE RESULTATEN ‚Äì AUTO-LADEN BIJ TAB-KLIK
            ========================================================= */
      document
        .querySelector('button[data-tab="r2resultaten"]')
        .addEventListener("click", async () => {
          Object.keys(pouleOpenStateR2).forEach(
            (k) => (pouleOpenStateR2[k] = false)
          );
          await loadR2MatchesFromFirestore(); // vult r2Matches + r2PoulesCache
          updateR2ResultsButtons(); // zet knoppen direct goed
        });

      /* =========================================================
               2E RONDE RESULTATEN ‚Äì KNOPPEN EVENT LISTENERS
            ========================================================= */
      document
        .getElementById("createR2MatchesBtn")
        .addEventListener("click", createR2MatchSchedule);
      document
        .getElementById("deleteR2MatchesBtn")
        .addEventListener("click", deleteR2Matches);

      /* =========================================================
                                                       EVENT LISTENERS VOOR TOERNOOI KNOPPEN
                                                       ========================================================= */
      document
        .getElementById("tournamentForm")
        .addEventListener("submit", (e) => {
          e.preventDefault();
          saveTournament();
        });

      document
        .getElementById("loadBtn")
        .addEventListener("click", loadTournamentList);
      document
        .getElementById("deleteBtn")
        .addEventListener("click", deleteTournament);

      // ‚úÖ TOEVOEGEN: Event listeners voor de spelerslijst status knoppen
      if (finalizeBtn)
        finalizeBtn.addEventListener("click", finalizePlayersAction);
      if (editBtn) editBtn.addEventListener("click", editPlayersAction);

      document
        .getElementById("createMatchesBtn")
        .addEventListener("click", createR1MatchSchedule);

      document
        .getElementById("deleteMatchesBtn")
        .addEventListener("click", deleteR1Matches);

      const moyCarUploadBtn = document.getElementById("moyCarUploadBtn");
      if (moyCarUploadBtn) {
        moyCarUploadBtn.addEventListener("click", handleMoyCarUpload);
      }

      const moyCarLinkBtn = document.getElementById("moyCarLinkBtn");
      if (moyCarLinkBtn) {
        moyCarLinkBtn.addEventListener("click", linkMoyCarTableToTournament);
      }

      // üîπ NIEUW: knop "Toon moyennetabel"
      const moyCarShowBtn = document.getElementById("moyCarShowBtn");
      if (moyCarShowBtn) {
        moyCarShowBtn.addEventListener("click", () => {
          showLinkedMoyCarTable();
        });
      }

      /* =========================================================
                                                       INIT
                                                       ========================================================= */
      document.addEventListener("DOMContentLoaded", showConnectionBanner);
      guardSpelersTabAvailability();

      if (typeof updateR2PoulesButtons === "function") {
        updateR2PoulesButtons();
      }
    </script>
    <script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
  </body>
</html>

<!DOCTYPE html>
<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>BCR Toernooi</title>

    <style>
      /* Alles gescope'd op #bcr-toernooi-app zodat het elders niet stoort */

      #bcr-toernooi-app {
        font-family: system-ui, sans-serif;
        max-width: 1000px;
        margin: 20px auto;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      #bcr-toernooi-app header {
        background: #b30000;
        color: white;
        text-align: center;
        padding: 10px;
        font-size: 1.4em;
        font-weight: 600;
      }

      #bcr-toernooi-app .active-tournament {
        text-align: center;
        font-weight: bold;
        background: #f7f7f7;
        color: #333;
        padding: 8px;
        border-bottom: 1px solid #ddd;
      }

      /* Tabs */
      #bcr-toernooi-app .tab-buttons {
        display: flex;
        justify-content: space-between;
        flex-wrap: nowrap;
        overflow-x: auto;
        background: #eee;
        border-bottom: 1px solid #ccc;
      }

      #bcr-toernooi-app .tab-buttons button {
        flex: 1;
        min-width: 110px;
        background: none;
        border: none;
        padding: 8px 6px;
        font-size: 0.9em;
        cursor: pointer;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
        transition: background 0.3s, color 0.3s;
        font-weight: 500;
        color: #333;
      }

      #bcr-toernooi-app .tab-buttons button.active {
        background: #b30000;
        color: #fff;
        font-weight: 600;
      }

      #bcr-toernooi-app .tab-content {
        display: none;
        padding: 20px;
      }

      #bcr-toernooi-app .tab-content.active {
        display: block;
      }

      /* Form layout */
      #bcr-toernooi-app form {
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      #bcr-toernooi-app label {
        font-weight: 600;
        display: block;
        margin-bottom: 4px;
      }

      #bcr-toernooi-app input[type="text"],
      #bcr-toernooi-app input[type="number"],
      #bcr-toernooi-app input[type="date"],
      #bcr-toernooi-app textarea,
      #bcr-toernooi-app select {
        width: 100%;
        padding: 6px;
        font-size: 0.95em;
        border: 1px solid #ccc;
        border-radius: 6px;
      }

      #bcr-toernooi-app input.small {
        width: 70px;
        text-align: center;
      }

      #bcr-toernooi-app textarea {
        min-height: 60px;
        resize: vertical;
      }

      #bcr-toernooi-app .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px 20px;
      }

      @media (max-width: 600px) {
        #bcr-toernooi-app .form-grid {
          grid-template-columns: 1fr;
        }
      }

      /* Puntenvelden in twee kolommen */
      #bcr-toernooi-app .points-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
      }

      #bcr-toernooi-app .points-grid h4 {
        margin: 0 0 6px;
        font-size: 0.9rem;
        font-weight: 600;
        color: #333;
      }

      /* Feedback / meldingen */
      #bcr-toernooi-app #feedback {
        margin-top: 16px;
      }

      #bcr-toernooi-app #feedback .message {
        border-radius: 8px;
        padding: 10px 12px;
        font-weight: 600;
        position: relative;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        line-height: 1.4;
        font-size: 0.9rem;
      }

      #bcr-toernooi-app #feedback .message .close {
        position: absolute;
        top: 8px;
        right: 10px;
        cursor: pointer;
        font-weight: bold;
        opacity: 0.6;
      }

      #bcr-toernooi-app #feedback .message .close:hover {
        opacity: 1;
      }

      /* Knoppenrij onderaan formulier */
      #bcr-toernooi-app .button-row {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-top: 1rem;
        flex-wrap: wrap;
      }

      #bcr-toernooi-app .btn {
        flex: 1;
        max-width: 220px;
        padding: 10px 0;
        font-size: 16px;
        font-weight: 600;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.25s ease;
        color: white;
        text-align: center;
        display: inline-block;
        text-decoration: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
      }

      #bcr-toernooi-app .btn:active {
        transform: scale(0.97);
      }

      /* Opslaan */
      #bcr-toernooi-app .btn-save {
        background-color: #007bff;
      }
      #bcr-toernooi-app .btn-save:hover {
        background-color: #005dc1;
      }

      /* Laden */
      #bcr-toernooi-app .btn-load {
        background-color: #6c757d;
      }
      #bcr-toernooi-app .btn-load:hover {
        background-color: #555d63;
      }

      /* Verwijderen */
      #bcr-toernooi-app .btn-delete {
        background-color: #dc3545;
      }
      #bcr-toernooi-app .btn-delete:hover {
        background-color: #b02a37;
      }

      /* Extra knoppen in spelers-tab */
      #bcr-toernooi-app .btn-secondary {
        background-color: #6c757d;
      }
      #bcr-toernooi-app .btn-secondary:hover {
        background-color: #555d63;
      }

      #bcr-toernooi-app .btn-lock {
        background-color: #198754;
      }
      #bcr-toernooi-app .btn-lock:hover {
        background-color: #146c43;
      }

      #bcr-toernooi-app .btn-unlock {
        background-color: #0dcaf0;
      }
      #bcr-toernooi-app .btn-unlock:hover {
        background-color: #0aa2c0;
      }

      /* Klein statusblok voor Firestore verbinding */
      #bcr-toernooi-app .connection-status {
        background: #e7f9e7;
        color: #276727;
        padding: 6px 12px;
        margin: 10px;
        border: 1px solid #7cc67c;
        border-radius: 6px;
        font-weight: bold;
        text-align: center;
        box-shadow: 0 0 4px rgba(0, 0, 0, 0.1);
        font-size: 0.9rem;
      }

      /* Tabel spelers */
      #bcr-toernooi-app table.player-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
        font-size: 0.9rem;
      }

      #bcr-toernooi-app table.player-table th {
        background: #eee;
        text-align: left;
        padding: 6px;
        border-bottom: 1px solid #ccc;
        font-weight: 600;
        white-space: nowrap;
      }

      #bcr-toernooi-app table.player-table td {
        padding: 6px;
        border-bottom: 1px solid #eee;
        vertical-align: top;
      }

      #bcr-toernooi-app table.player-table td.num {
        text-align: right;
        font-variant-numeric: tabular-nums;
      }

      #bcr-toernooi-app table.player-table td.actions {
        text-align: center;
      }

      #bcr-toernooi-app table.player-table button.delete-player-btn {
        background: #dc3545;
        color: #fff;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.8rem;
        padding: 4px 8px;
        transition: background 0.25s ease;
      }

      #bcr-toernooi-app table.player-table button.delete-player-btn:hover {
        background: #b02a37;
      }

      /* Notice als geen toernooi actief is */
      #noTournamentNotice {
        color: #842029;
        background: #f8d7da;
        border: 1px solid #f5c2c7;
        padding: 8px;
        border-radius: 6px;
        margin-bottom: 12px;
        font-weight: 600;
        font-size: 0.9rem;
      }

      /* Kleinere sub-headings in spelers-tab */
      #bcr-toernooi-app h3 {
        margin: 0 0 10px;
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
      }

      #bcr-toernooi-app table.player-table td.actions button {
        margin: 0 2px;
      }

      #bcr-toernooi-app #r1resultaten .actie-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border: 1px solid #ccc;
        border-radius: 6px;
        background: #fff;
        cursor: pointer;
        font-size: 1.3rem; /* groter icoon */
        line-height: 1;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
      }
      #bcr-toernooi-app #r1resultaten .actie-btn:hover {
        background: #f1f3f5;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.12);
      }
      #bcr-toernooi-app #r1resultaten .actie-btn:active {
        transform: scale(0.96);
      }

      /* kleurtjes per soort */
      #bcr-toernooi-app #r1resultaten .actie-btn.save {
        color: #198754;
        border-color: #198754;
      }
      #bcr-toernooi-app #r1resultaten .actie-btn.reset {
        color: #dc3545;
        border-color: #dc3545;
      }
    </style>
  </head>

  <body>
    <!-- ===== LOGIN OVERLAY ===== -->
    <div
      id="loginOverlay"
      style="
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.55);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 5000;
      "
    >
      <div
        style="
          background: #fff;
          padding: 20px 22px;
          border-radius: 10px;
          width: 320px;
          box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25);
        "
      >
        <h3 style="margin-top: 0">Inloggen beheer</h3>
        <form
          id="loginForm"
          style="display: flex; flex-direction: column; gap: 10px"
        >
          <div>
            <label>Gebruikersnaam</label>
            <input id="loginUsername" type="text" required />
          </div>
          <div>
            <label>Wachtwoord</label>
            <input id="loginPassword" type="password" required />
          </div>
          <button type="submit" class="btn btn-save" style="max-width: none">
            Inloggen
          </button>
          <div id="loginMsg" style="font-weight: 600; color: #842029"></div>
        </form>
      </div>
    </div>

    <div id="bcr-toernooi-app">
      <header>Biljarttoernooi Beheer</header>

      <div class="active-tournament" id="activeTournamentBanner">
        Geen toernooi geselecteerd
      </div>

      <div class="tab-buttons">
        <button class="active" data-tab="toernooi">Toernooi</button>
        <button data-tab="spelers">Spelers</button>
        <button data-tab="r1poules">1e Ronde poules</button>
        <button data-tab="r1resultaten">1e Ronde resultaten</button>
        <button data-tab="r2poules">2e Ronde poules</button>
        <button data-tab="r2resultaten">2e Ronde resultaten</button>
        <button data-tab="finale">Finale</button>
        <button data-tab="admin" id="adminTabBtn" style="display: none">
          Admin
        </button>
      </div>

      <!-- ===== START TAB: TOERNOOI ===== -->
      <div id="toernooi" class="tab-content active">
        <form id="tournamentForm">
          <div class="form-grid">
            <div>
              <label>Naam toernooi *</label>
              <input type="text" id="tournamentName" required />
            </div>
            <div>
              <label>Jaar *</label>
              <div style="display: flex; align-items: center; gap: 12px">
                <input
                  type="number"
                  id="tournamentYear"
                  class="small"
                  min="1900"
                  max="2099"
                  required
                />
                <div style="display: flex; align-items: center; gap: 6px">
                  <input type="checkbox" id="tournamentPublished" />
                  <span
                    id="tournamentPublishedBadge"
                    style="
                      padding: 2px 8px;
                      border-radius: 999px;
                      font-size: 0.8rem;
                      background: #f8d7da;
                      color: #842029;
                      white-space: nowrap;
                    "
                  >
                    Niet gepubliceerd
                  </span>
                </div>
              </div>
            </div>
          </div>

          <div>
            <label>Organisatie</label>
            <textarea
              id="tournamentOrg"
              rows="3"
              placeholder="Namen van organisatoren..."
            ></textarea>
          </div>

          <div class="form-grid">
            <div>
              <label>Einde 1e ronde</label>
              <input type="date" id="dateEndR1" />
            </div>
            <div>
              <label>Einde 2e ronde</label>
              <input type="date" id="dateEndR2" />
            </div>
            <div>
              <label>Start finale</label>
              <input type="date" id="dateStartFinale" />
            </div>
            <div>
              <label>Einde finale</label>
              <input type="date" id="dateEndFinale" />
            </div>
          </div>

          <div>
            <label>Maximaal aantal beurten</label>
            <input
              type="number"
              id="maxTurns"
              class="small"
              min="0"
              max="999"
            />
            <label style="font-weight: 400; margin-left: 8px">
              <input type="checkbox" id="noMaxTurns" />
              Niet van toepassing
            </label>
          </div>

          <div class="points-grid">
            <div>
              <h4>&lt; kleiner dan max</h4>
              <label>Overwinning</label>
              <input
                type="number"
                class="small"
                id="pointsWinLess"
                min="0"
                max="999"
              />
              <label>Gelijkspel</label>
              <input
                type="number"
                class="small"
                id="pointsDrawLess"
                min="0"
                max="999"
              />
              <label>Nederlaag</label>
              <input
                type="number"
                class="small"
                id="pointsLoseLess"
                min="0"
                max="999"
              />
            </div>

            <div>
              <h4>= max</h4>
              <label>Overwinning</label>
              <input
                type="number"
                class="small"
                id="pointsWinMax"
                min="0"
                max="999"
              />
              <label>Gelijkspel</label>
              <input
                type="number"
                class="small"
                id="pointsDrawMax"
                min="0"
                max="999"
              />
              <label>Nederlaag</label>
              <input
                type="number"
                class="small"
                id="pointsLoseMax"
                min="0"
                max="999"
              />
            </div>
          </div>

          <div class="button-row">
            <button type="submit" id="saveBtn" class="btn btn-save">
              üíæ Opslaan
            </button>
            <button type="button" id="loadBtn" class="btn btn-load">
              üìÇ Toernooi laden
            </button>
            <button type="button" id="deleteBtn" class="btn btn-delete">
              üóëÔ∏è Verwijder toernooi
            </button>
          </div>

          <div id="feedback"></div>
        </form>
      </div>
      <!-- ===== END TAB: TOERNOOI ===== -->

      <!-- ===== START TAB: SPELERS ===== -->
      <div id="spelers" class="tab-content" style="position: relative">
        <h3>Deelnemers</h3>

        <div id="noTournamentNotice" style="display: none">
          ‚ö†Ô∏è Geen toernooi geselecteerd. Selecteer eerst een toernooi om
          deelnemers te beheren.
        </div>

        <form id="playerForm" class="form-grid">
          <div>
            <label>Naam speler</label>
            <input type="text" id="playerName" required />
          </div>
          <div>
            <label>E-mailadres</label>
            <input type="text" id="playerEmail" />
          </div>
          <div>
            <label>Telefoonnummer</label>
            <input type="text" id="playerPhone" />
          </div>
          <div>
            <label>Te maken caramboles (1e ronde)</label>
            <input
              type="number"
              id="playerCaramboles"
              min="0"
              max="999"
              class="small"
            />
          </div>
          <div style="grid-column: 1/-1; text-align: right">
            <button
              type="submit"
              class="btn btn-save"
              id="addPlayerBtn"
              style="min-width: 190px"
            >
              ‚ûï Speler toevoegen
            </button>
          </div>
        </form>

        <div class="button-row">
          <button type="button" id="sortByName" class="btn btn-secondary">
            Sorteer op naam
          </button>
          <button type="button" id="sortByCaramboles" class="btn btn-secondary">
            Sorteer op caramboles
          </button>
        </div>

        <div
          id="playerCount"
          style="margin-top: 10px; font-weight: 600; color: #333"
        >
          Aantal deelnemers: 0
        </div>
        <div
          id="playersFinalizedNotice"
          style="
            display: none;
            background: #ca3535;
            color: #ffffff;
            border: 1px solid #ca3535;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 12px;
            margin-top: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
          "
        >
          üîí De spelerslijst is definitief. Alleen het wijzigen van het
          e-mailadres en het telefoonnummer is mogelijk.
        </div>
        <div
          id="playersTableContainer"
          style="position: relative; margin-top: 10px"
        >
          <table
            id="playerTable"
            class="player-table"
            style="width: 100%; border-collapse: collapse"
          >
            <thead>
              <tr>
                <th>Naam</th>
                <th>E-mail</th>
                <th>Telefoon</th>
                <th style="text-align: right">Caramboles</th>
                <th style="text-align: center">Acties</th>
              </tr>
            </thead>
            <tbody id="playerTableBody"></tbody>
          </table>

          <!-- ‚úÖ Overlay die verschijnt bij definitieve lijst -->
          <div
            id="playersLockOverlay"
            style="
              display: none;
              position: absolute;
              top: 0;
              left: 0;
              width: 80%;
              height: 100%;
              background: rgba(240, 240, 240, 0.75);
              backdrop-filter: blur(2px);
              border-radius: 10px;
              justify-content: center;
              align-items: center;
              font-size: 1.2em;
              color: #555;
              font-weight: 600;
              pointer-events: none;
            "
          >
            üîí Spelerslijst is definitief
          </div>
        </div>

        <div class="button-row" style="margin-top: 15px">
          <button type="button" id="finalizePlayers" class="btn btn-lock">
            ‚úÖ Lijst definitief maken
          </button>
          <button type="button" id="editPlayers" class="btn btn-unlock">
            ‚úèÔ∏è Lijst bewerken
          </button>
        </div>

        <div id="playerFeedback"></div>

        <!-- ‚úÖ Popup voor wijzigen van speler -->
        <div
          id="editPlayerModal"
          style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
          "
        >
          <div
            style="
              background: #fff;
              padding: 20px;
              border-radius: 10px;
              width: 320px;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            "
          >
            <h4 style="margin-top: 0">Speler wijzigen</h4>
            <form id="editPlayerForm" class="form-grid">
              <div>
                <label>Naam</label>
                <input type="text" id="editName" required />
              </div>
              <div>
                <label>E-mail</label>
                <input type="text" id="editEmail" />
              </div>
              <div>
                <label>Telefoon</label>
                <input type="text" id="editPhone" />
              </div>
              <div>
                <label>Caramboles</label>
                <input
                  type="number"
                  id="editCaramboles"
                  min="0"
                  max="999"
                  class="small"
                />
              </div>
              <div class="button-row" style="margin-top: 15px">
                <button type="submit" class="btn btn-save">Opslaan</button>
                <button type="button" id="cancelEdit" class="btn btn-delete">
                  Annuleren
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <!-- ===== END TAB: SPELERS ===== -->

      <!-- ===== START TAB: 1E RONDE POULES ===== -->
      <div id="r1poules" class="tab-content">
        <h3>1e Ronde ‚Äì Poule-indeling</h3>

        <div id="noTournamentPoulesNotice" style="display: none">
          ‚ö†Ô∏è Geen toernooi geselecteerd. Selecteer eerst een toernooi om poules
          te beheren.
        </div>

        <div id="poulesIntro" style="margin-bottom: 15px">
          <p>
            Hier kun je de spelers van het toernooi indelen in poules. Elke
            poule heeft standaard 4 spelers (indien mogelijk). Klik op een
            speler links en vervolgens op de poule waarin je deze wilt plaatsen.
          </p>
        </div>

        <div id="poulesControls" class="button-row">
          <button type="button" id="createPoulesBtn" class="btn btn-save">
            ‚ûï Poules aanmaken
          </button>
          <button type="button" id="savePoulesBtn" class="btn btn-lock">
            üíæ Indeling opslaan
          </button>
          <button type="button" id="clearPoulesBtn" class="btn btn-delete">
            üóëÔ∏è Alles wissen
          </button>
        </div>

        <!-- ‚úÖ Info over verdeling -->
        <div
          id="poulesDistributionInfo"
          style="
            margin-top: 10px;
            font-weight: 600;
            color: #333;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px 12px;
            display: none;
          "
        ></div>

        <div
          id="poulesContent"
          style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 15px"
        >
          <!-- Linkerkant: beschikbare spelers -->
          <div style="flex: 1; min-width: 280px">
            <h4>Beschikbare spelers</h4>
            <div
              id="availablePlayers"
              class="list-box"
              style="
                border: 1px solid #ccc;
                border-radius: 8px;
                padding: 10px;
                min-height: 250px;
                background: #fafafa;
              "
            >
              <p style="color: #777">Nog geen spelers geladen.</p>
            </div>
          </div>

          <!-- Rechterkant: poules -->
          <div style="flex: 2; min-width: 400px">
            <h4>Huidige poules</h4>
            <div
              id="poulesContainer"
              style="
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
                gap: 15px;
              "
            >
              <!-- Poule-kaarten worden hier dynamisch toegevoegd -->
            </div>
          </div>
        </div>

        <div id="poulesFeedback" style="margin-top: 15px"></div>
      </div>
      <!-- ===== END TAB: 1E RONDE POULES ===== -->

      <!-- ===== START TAB: 1E RONDE RESULTATEN ===== -->
      <div id="r1resultaten" class="tab-content">
        <h3>1e Ronde ‚Äì Wedstrijden & Resultaten</h3>

        <div id="noTournamentR1ResNotice" style="display: none">
          ‚ö†Ô∏è Geen toernooi geselecteerd. Selecteer eerst een toernooi om
          wedstrijden te beheren.
        </div>

        <!-- Overzicht scoringsregels -->
        <div
          id="r1ScoringOverview"
          style="
            margin-bottom: 15px;
            font-weight: 500;
            color: #333;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px 12px;
            display: none;
          "
        ></div>

        <!-- Actieknoppen -->
        <div class="button-row" style="margin-bottom: 15px">
          <button type="button" id="createMatchesBtn" class="btn btn-save">
            ‚ûï Wedstrijdschema aanmaken
          </button>
          <button type="button" id="deleteMatchesBtn" class="btn btn-delete">
            üóëÔ∏è Wedstrijden wissen
          </button>
        </div>

        <!-- Algemeen voortgang -->
        <div
          id="r1OverallProgress"
          style="
            margin-bottom: 15px;
            font-weight: 600;
            color: #333;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px 12px;
            display: none;
          "
        ></div>

        <!-- Poule-blokken -->
        <div
          id="r1matchesWrapper"
          style="display: flex; flex-direction: column; gap: 16px"
        ></div>

        <!-- Globale eindstand -->
        <div
          id="r1GlobalStandWrapper"
          style="
            margin-top: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 12px;
            background: #fff;
          "
        >
          <h4 style="margin-top: 0">Eindstand 1e ronde (alle poules)</h4>
          <div id="r1GlobalStandTable" style="overflow-x: auto"></div>
        </div>
      </div>
      <!-- ===== END TAB: 1E RONDE RESULTATEN ===== -->

      <!-- ===== BEGIN TAB: 2E RONDE POULES ===== -->
      <div id="r2poules" class="tab-content">
        <h3>2e Ronde ‚Äì Poule-indeling</h3>

        <div id="noTournamentR2PoulesNotice" style="display: none">
          ‚ö†Ô∏è Geen toernooi geselecteerd. Selecteer eerst een toernooi om poules
          te beheren.
        </div>

        <div id="r2poulesIntro" style="margin-bottom: 15px">
          <p>
            Links vind je de globale eindstand van de 1e ronde. Klik op een
            speler en vervolgens op een poule om deze toe te voegen.
          </p>
        </div>

        <div id="r2poulesControls" class="button-row">
          <button type="button" id="createR2PoulesBtn" class="btn btn-save">
            ‚ûï Poules aanmaken
          </button>
          <button type="button" id="saveR2PoulesBtn" class="btn btn-lock">
            üíæ Indeling opslaan
          </button>
          <button type="button" id="clearR2PoulesBtn" class="btn btn-delete">
            üóëÔ∏è Alles wissen
          </button>
          <button type="button" id="resetCarambolesR2Btn" class="btn btn-save">
            Reset 2e ronde caramboles
          </button>
        </div>

        <div
          id="r2poulesDistributionInfo"
          style="
            margin-top: 10px;
            font-weight: 600;
            color: #333;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px 12px;
            display: none;
          "
        ></div>

        <div
          id="r2poulesContent"
          style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 15px"
        >
          <!-- Linkerkant: ranglijst 1e ronde -->
          <div style="flex: 1; min-width: 280px">
            <!-- ===== 2E RONDE POULES ‚Äì LINKERKANT: RANGLIJST 1E RONDE ===== -->
            <div style="flex: 1; min-width: 280px">
              <h4>Ranglijst 1e ronde</h4>
              <table
                id="r2RankTable"
                style="width: 100%; border-collapse: collapse; font-size: 0.9em"
              >
                <thead style="background: #f8f9fa">
                  <tr>
                    <th style="text-align: left; padding: 6px 4px">#</th>
                    <th style="text-align: left; padding: 6px 4px">Speler</th>
                    <th style="text-align: right; padding: 6px 4px">
                      1e&nbsp;ronde
                    </th>
                    <th style="text-align: right; padding: 6px 4px">
                      2e&nbsp;ronde
                    </th>
                  </tr>
                </thead>
                <tbody id="r2RankTableBody"></tbody>
              </table>
              <!-- Nieuwe knop onder de tabel -->
              <div style="margin-top: 8px">
                <button
                  type="button"
                  id="saveCarambolesR2Btn"
                  class="btn btn-save"
                >
                  üíæ Opslaan car. 2e ronde
                </button>
              </div>
            </div>
          </div>

          <!-- Rechterkant: poules -->
          <div style="flex: 2; min-width: 400px">
            <h4>Huidige poules</h4>
            <div
              id="r2PoulesContainer"
              style="
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
                gap: 15px;
              "
            >
              <!-- Poule-kaarten komen hier -->
            </div>
          </div>
        </div>

        <div id="r2poulesFeedback" style="margin-top: 15px"></div>
      </div>
      <!-- ===== END TAB: 2E RONDE POULES ===== -->

      <!-- ===== BEGIN TAB: 2E RONDE RESULTATEN ===== -->
      <div id="r2resultaten" class="tab-content">
        <h3>2e Ronde ‚Äì Wedstrijden & Resultaten</h3>

        <div id="noTournamentR2ResNotice" style="display: none">
          ‚ö†Ô∏è Geen toernooi geselecteerd. Selecteer eerst een toernooi om
          wedstrijden te beheren.
        </div>

        <!-- Overzicht scoringsregels -->
        <div
          id="r2ScoringOverview"
          style="
            margin-bottom: 15px;
            font-weight: 500;
            color: #333;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px 12px;
            display: none;
          "
        ></div>

        <!-- Actieknoppen -->
        <div class="button-row" style="margin-bottom: 15px">
          <button type="button" id="createR2MatchesBtn" class="btn btn-save">
            ‚ûï Wedstrijdschema aanmaken
          </button>
          <button type="button" id="deleteR2MatchesBtn" class="btn btn-delete">
            üóëÔ∏è Wedstrijden wissen
          </button>
        </div>

        <!-- Algemeen voortgang -->
        <div
          id="r2OverallProgress"
          style="
            margin-bottom: 15px;
            font-weight: 600;
            color: #333;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px 12px;
            display: none;
          "
        ></div>

        <!-- Poule-blokken -->
        <div
          id="r2matchesWrapper"
          style="display: flex; flex-direction: column; gap: 16px"
        ></div>

        <!-- Globale eindstand -->
        <div
          style="
            margin-top: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 12px;
            background: #fff;
          "
        >
          <h4 style="margin-top: 0">Eindstand 2e ronde (alle poules)</h4>
          <div id="r2GlobalStandTable" style="overflow-x: auto"></div>
        </div>
      </div>
      <!-- ===== END TAB: 2E RONDE RESULTATEN ===== -->

      <!-- ===== START TAB: ANDERE PLACEHOLDERS ===== -->

      <div id="finale" class="tab-content"><p>Finale-tab (komt later)</p></div>
      <!-- ===== END TAB: ANDERE PLACEHOLDERS ===== -->

      <!-- ===== START TAB: ADMIN ===== -->
      <div id="admin" class="tab-content">
        <h3>Gebruikersbeheer</h3>

        <form id="userForm" class="form-grid" style="margin-bottom: 10px">
          <div>
            <label>Gebruikersnaam (login) *</label>
            <input type="text" id="uUsername" required />
          </div>
          <div>
            <label>Weergavenaam *</label>
            <input type="text" id="uDisplay" required />
          </div>
          <div>
            <label>Wachtwoord *</label>
            <input type="password" id="uPassword" required />
          </div>
          <div>
            <label>Rol</label>
            <select id="uRole">
              <option value="user">Gebruiker</option>
              <option value="admin">Admin</option>
            </select>
          </div>

          <div style="grid-column: 1/-1; text-align: right">
            <button class="btn btn-save" type="submit">
              ‚ûï Gebruiker opslaan
            </button>
          </div>
        </form>

        <div id="usersTableWrap"></div>

        <hr style="margin: 18px 0" />

        <h3>Toernooien koppelen aan gebruiker</h3>
        <div class="form-grid">
          <div>
            <label>Kies gebruiker</label>
            <select id="linkUserSelect"></select>
          </div>
          <div>
            <label>Kies toernooien</label>
            <div
              id="linkTournamentsList"
              style="
                border: 1px solid #ccc;
                border-radius: 6px;
                padding: 8px;
                max-height: 220px;
                overflow: auto;
              "
            >
              <em>laden...</em>
            </div>
          </div>
        </div>
        <div class="button-row">
          <button type="button" id="saveLinksBtn" class="btn btn-save">
            üíæ Koppelingen opslaan
          </button>
        </div>

        <div id="adminFeedback"></div>
      </div>
    </div>
    <!-- ===== END TAB: ADMIN ===== -->

    <script type="module">
      /* Firebase imports */
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        getDocs,
        deleteDoc,
        collection,
        addDoc,
        writeBatch,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

      /* Firebase config */
      const firebaseConfig = {
        apiKey: "AIzaSyAsg63E-lGgECsCxIfRJTFcTWB7LEGWNGc",
        authDomain: "bcr-toernooi.firebaseapp.com",
        projectId: "bcr-toernooi",
        storageBucket: "bcr-toernooi.firebasestorage.app",
        messagingSenderId: "856805712309",
        appId: "1:856805712309:web:8adb4158d825630ce079fc",
        measurementId: "G-ELH9TVY15L",
      };

      /* Init Firestore */
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      /* =========================================================
   LOGIN FLOW
========================================================= */
      const loginOverlay = document.getElementById("loginOverlay");
      const loginForm = document.getElementById("loginForm");
      const loginMsg = document.getElementById("loginMsg");

      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        loginMsg.textContent = "";

        const username = document.getElementById("loginUsername").value.trim();
        const password = document.getElementById("loginPassword").value;

        try {
          // user zoeken op username
          const usersSnap = await getDocs(collection(db, "users"));
          const match = usersSnap.docs
            .map((d) => ({ id: d.id, ...d.data() }))
            .find(
              (u) => (u.username || "").toLowerCase() === username.toLowerCase()
            );

          if (!match) {
            loginMsg.textContent = "Onbekende gebruiker.";
            return;
          }

          if (password !== match.password) {
            loginMsg.textContent = "Wachtwoord onjuist.";
            return;
          }

          currentUser = match;
          isAdmin = match.role === "admin";
          loginOverlay.style.display = "none";

          applyPermissions();
          await loadTournamentList(); // meteen lijst verversen met filtering
        } catch (err) {
          console.error(err);
          loginMsg.textContent = "Inloggen mislukt.";
        }
      });

      // overlay blijft staan tot login gelukt is

      /* =========================================================
                                                 GLOBALE STATE VOOR ACTIEF TOERNOOI
                                                 ========================================================= */
      let activeTournamentId = null; // bv. "OpenKampioenschap_2025"
      const pouleOpenState = {}; // 1e ronde: poule-naam ‚Üí boolean
      const pouleOpenStateR2 = {}; // 2e ronde: poule-naam ‚Üí boolean
      let playersFinalized = false; // of de spelerslijst op slot staat

      // ‚úÖ TOEVOEGEN: Status of er al poules zijn aangemaakt in ronde 1
      let r1PoulesExist = false;

      /* =========================================================
   SIMPELE LOGIN / AUTH STATE
========================================================= */
      let currentUser = null; // {id, username, role, tournaments, displayName}
      let isAdmin = false;

      /* =========================================================
                                                 GEMEENSCHAPPELIJKE UI HELPERS
                                                 ========================================================= */
      function showConnectionBanner() {
        const host = document.getElementById("bcr-toernooi-app");
        const statusDiv = document.createElement("div");
        statusDiv.className = "connection-status";
        statusDiv.textContent = "‚úÖ Verbonden met Firestore";
        host.insertBefore(statusDiv, host.children[1] /* net onder header */);
      }

      function showFeedback(msg, type = "info") {
        const fb = document.getElementById("feedback");
        const color =
          type === "error"
            ? "#f8d7da"
            : type === "success"
            ? "#d1e7dd"
            : "#e2e3e5";
        const textColor =
          type === "error"
            ? "#842029"
            : type === "success"
            ? "#0f5132"
            : "#41464b";
        fb.innerHTML = `
                                                  <div class="message" style="background:${color};color:${textColor};">
                                                    ${msg}
                                                    <span class="close" onclick="this.parentElement.remove()">√ó</span>
                                                  </div>
                                                `;
        fb.scrollIntoView({ behavior: "smooth" });
      }

      function showPlayerFeedback(msg, type = "info") {
        const pf = document.getElementById("playerFeedback");
        const color =
          type === "error"
            ? "#f8d7da"
            : type === "success"
            ? "#d1e7dd"
            : "#e2e3e5";
        const textColor =
          type === "error"
            ? "#842029"
            : type === "success"
            ? "#0f5132"
            : "#41464b";
        pf.innerHTML = `
                                                  <div class="message" style="background:${color};color:${textColor};">
                                                    ${msg}
                                                    <span class="close" onclick="this.parentElement.remove()">√ó</span>
                                                  </div>
                                                `;
        pf.scrollIntoView({ behavior: "smooth" });
      }

      function updateActiveTournament(name, year) {
        const banner = document.getElementById("activeTournamentBanner");
        if (name && year) {
          banner.textContent = `Actief toernooi: ${name} (${year})`;
        } else {
          banner.textContent = "Geen toernooi geselecteerd";
        }
      }

      function applyPermissions() {
        // admin tab show/hide
        const adminBtn = document.getElementById("adminTabBtn");
        if (adminBtn) adminBtn.style.display = isAdmin ? "block" : "none";

        // Toernooi-tab: users mogen NIET opslaan/verwijderen en velden read-only
        const saveBtn = document.getElementById("saveBtn");
        const deleteBtn = document.getElementById("deleteBtn");
        const tournamentForm = document.getElementById("tournamentForm");

        if (!isAdmin) {
          // 1) knoppen verbergen i.p.v. alleen disablen
          if (saveBtn) {
            saveBtn.disabled = true;
            saveBtn.style.display = "none";
          }
          if (deleteBtn) {
            deleteBtn.disabled = true;
            deleteBtn.style.display = "none";
          }

          if (tournamentForm) {
            tournamentForm
              .querySelectorAll("input, select, textarea")
              .forEach((el) => {
                if (el.id === "loadBtn") return;
                el.disabled = true;
                el.style.backgroundColor = "#f0f0f0";
              });
          }
        } else {
          if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.style.display = "";
          }
          if (deleteBtn) {
            deleteBtn.disabled = false;
            deleteBtn.style.display = "";
          }

          if (tournamentForm) {
            tournamentForm
              .querySelectorAll("input, select, textarea")
              .forEach((el) => {
                el.disabled = false;
                el.style.backgroundColor = "";
              });
          }
        }

        // Admin tab data laden indien admin
        if (isAdmin) {
          loadUsersAdminTab();
          loadTournamentsForLinking();
        }
      }

      /* =========================================================
                                                 TABS
                                                 ========================================================= */
      document
        .querySelectorAll("#bcr-toernooi-app .tab-buttons button")
        .forEach((btn) => {
          btn.addEventListener("click", () => {
            document
              .querySelectorAll("#bcr-toernooi-app .tab-buttons button")
              .forEach((b) => b.classList.remove("active"));
            document
              .querySelectorAll("#bcr-toernooi-app .tab-content")
              .forEach((tc) => tc.classList.remove("active"));
            btn.classList.add("active");
            const pane = document.getElementById(btn.dataset.tab);
            pane.classList.add("active");

            // Speciale regel: als je naar "spelers" gaat -> check of er een toernooi actief is
            if (btn.dataset.tab === "spelers") {
              if (activeTournamentId) {
                // eerst de echte status uit Firestore halen
                loadPlayersFromFirestore().then(() => {
                  guardSpelersTabAvailability(); // daarna knoppen goed zetten
                });
              } else {
                guardSpelersTabAvailability();
              }
            }

            // Speciale regel: als je naar "1e ronde poules" gaat -> knoppenstatus updaten
            if (btn.dataset.tab === "r1poules") {
              if (typeof updateR1PoulesButtons === "function") {
                updateR1PoulesButtons();
              }
            }
          });
        });

      async function hasAnyPoulesOrMatchesForActiveTournament() {
        if (!activeTournamentId) return false;

        const basePath = ["toernooien", activeTournamentId];

        const checks = [
          ["poules_r1"],
          ["r1_wedstrijden"],
          ["poules_r2"],
          ["r2_wedstrijden"],
        ];

        for (const sub of checks) {
          const colRef = collection(db, ...basePath, ...sub);
          const snap = await getDocs(colRef);
          if (!snap.empty) return true;
        }

        return false;
      }

      async function clearAllPoulesAndMatchesForActiveTournament() {
        if (!activeTournamentId) return;

        const basePath = ["toernooien", activeTournamentId];

        const paths = [
          ["poules_r1"],
          ["r1_wedstrijden"],
          ["poules_r2"],
          ["r2_wedstrijden"],
        ];

        for (const sub of paths) {
          const colRef = collection(db, ...basePath, ...sub);
          const snap = await getDocs(colRef);
          if (snap.empty) continue;

          const batch = writeBatch(db);
          snap.forEach((d) => batch.delete(d.ref));
          await batch.commit();
        }

        // Lokale caches ook leegmaken
        if (typeof currentPoules !== "undefined") currentPoules = [];
        if (typeof r1Matches !== "undefined") r1Matches = [];
        if (typeof r1PoulesCache !== "undefined") r1PoulesCache = [];
        if (typeof r2CurrentPoules !== "undefined") r2CurrentPoules = [];
        if (typeof r2AllPlayers !== "undefined") r2AllPlayers = [];
        if (typeof r2AvailablePlayers !== "undefined") r2AvailablePlayers = [];

        // UI opruimen waar mogelijk
        if (typeof renderPoules === "function") renderPoules();
        if (typeof renderAvailablePlayers === "function")
          renderAvailablePlayers();
        if (typeof renderR1Matches === "function") renderR1Matches();
        if (typeof renderR2Poules === "function") renderR2Poules();
        if (typeof renderR2AvailablePlayers === "function")
          renderR2AvailablePlayers();
      }

      /* =========================================================
                                                 FUNCTIES TAB TOERNOOI
                                                 ========================================================= */
      /* Publicatie-status helper */
      const publishedCheckbox = document.getElementById("tournamentPublished");
      const publishedBadge = document.getElementById(
        "tournamentPublishedBadge"
      );

      function updatePublishedBadge(checked) {
        if (!publishedBadge) return;
        if (checked) {
          publishedBadge.textContent = "Gepubliceerd";
          publishedBadge.style.backgroundColor = "#d1e7dd";
          publishedBadge.style.color = "#0f5132";
        } else {
          publishedBadge.textContent = "Niet gepubliceerd";
          publishedBadge.style.backgroundColor = "#f8d7da";
          publishedBadge.style.color = "#842029";
        }
      }

      if (publishedCheckbox) {
        publishedCheckbox.addEventListener("change", () => {
          updatePublishedBadge(publishedCheckbox.checked);
        });
        // default initialisatie
        updatePublishedBadge(publishedCheckbox.checked);
      }

      // Checkbox 'Niet van toepassing'
      const noMax = document.getElementById("noMaxTurns");
      const maxInputs = [
        "pointsWinMax",
        "pointsDrawMax",
        "pointsLoseMax",
        "maxTurns",
      ].map((id) => document.getElementById(id));

      noMax.addEventListener("change", () => {
        const disabled = noMax.checked;
        maxInputs.forEach((i) => {
          i.disabled = disabled;
          i.style.backgroundColor = disabled ? "#eee" : "";
        });
      });

      // Numerieke validatie
      document
        .querySelectorAll('#bcr-toernooi-app input[type="number"]')
        .forEach((inp) => {
          inp.addEventListener("blur", () => {
            const id = inp.id;
            const val = parseInt(inp.value);
            if (id === "tournamentYear") {
              if (!val) return;
              if (val > 2099) inp.value = 2099;
              if (val < 1900) inp.value = 1900;
            } else if (id === "playerCaramboles") {
              if (!val && val !== 0) return;
              if (val > 999) inp.value = 999;
              if (val < 0) inp.value = 0;
            } else {
              if (!val && val !== 0) return;
              if (val > 999) inp.value = 999;
              if (val < 0) inp.value = 0;
            }
          });
          if (inp.id !== "tournamentYear") {
            inp.addEventListener("input", () => {
              if (inp.value.length > 3) inp.value = inp.value.slice(0, 3);
            });
          }
        });

      // Opslaan / bijwerken van een toernooi
      async function saveTournament() {
        const naam = document.getElementById("tournamentName").value.trim();
        const jaar = document.getElementById("tournamentYear").value.trim();

        if (!naam || !jaar) {
          showFeedback("‚ùå Naam en jaar zijn verplicht.", "error");
          return;
        }

        const maxTurnsRaw = document.getElementById("maxTurns").value;
        const maxBeurten =
          maxTurnsRaw === "" || maxTurnsRaw == null
            ? null
            : Number(maxTurnsRaw);

        const data = {
          naam,
          jaar,
          organisatie: document.getElementById("tournamentOrg").value.trim(),
          maxBeurten,
          punten: {
            winLess: document.getElementById("pointsWinLess").value || 0,
            drawLess: document.getElementById("pointsDrawLess").value || 0,
            loseLess: document.getElementById("pointsLoseLess").value || 0,
            winMax: document.getElementById("pointsWinMax").value || 0,
            drawMax: document.getElementById("pointsDrawMax").value || 0,
            loseMax: document.getElementById("pointsLoseMax").value || 0,
          },
          datums: {
            endR1: document.getElementById("dateEndR1").value || null,
            endR2: document.getElementById("dateEndR2").value || null,
            startFinale:
              document.getElementById("dateStartFinale").value || null,
            endFinale: document.getElementById("dateEndFinale").value || null,
          },
          aangemaaktOp: new Date().toISOString(),
          playersFinalized: playersFinalized || false,
          aangemaaktOp: new Date().toISOString(),
          playersFinalized: playersFinalized || false,
          publiceerPubliek:
            document.getElementById("tournamentPublished").checked || false,
        };

        try {
          const id = `${naam}_${jaar}`.replace(/\s+/g, "_");
          await setDoc(doc(db, "toernooien", id), data);
          activeTournamentId = id;
          playersFinalized = data.playersFinalized;
          showFeedback(
            `‚úÖ Toernooi "${naam}" (${jaar}) is opgeslagen.`,
            "success"
          );
          updateActiveTournament(naam, jaar);
          guardSpelersTabAvailability();
        } catch (err) {
          console.error("‚ùå Fout bij opslaan:", err);
          showFeedback(
            "‚ö†Ô∏è Er ging iets mis bij het opslaan in Firestore.",
            "error"
          );
        }
      }

      // Hulpfunctie om dropdown te bouwen en te hergebruiken voor laden / verwijderen
      async function buildTournamentSelect({ mode }) {
        const snapshot = await getDocs(collection(db, "toernooien"));
        const fb = document.getElementById("feedback");
        fb.innerHTML = "";

        if (snapshot.empty) {
          fb.innerHTML = `
                                                    <div class="message" style="background:#f8d7da;color:#842029;">
                                                      ‚ö†Ô∏è Er zijn nog geen toernooien opgeslagen.
                                                      <span class="close" onclick="this.parentElement.remove()">√ó</span>
                                                    </div>`;
          return null;
        }

        const select = document.createElement("select");
        select.style.marginTop = "10px";
        select.style.padding = "6px";
        select.style.borderRadius = "6px";
        select.style.border = "1px solid #ccc";
        select.style.minWidth = "250px";

        if (mode === "delete") {
          select.innerHTML = `<option value="">Kies een toernooi om te verwijderen...</option>`;
        } else {
          select.innerHTML = `<option value="">Kies een toernooi...</option>`;
        }

        snapshot.forEach((d) => {
          const t = d.data();

          // filtering voor niet-admin
          if (!isAdmin) {
            const allowed = currentUser?.tournaments || [];
            if (!allowed.includes(d.id)) return;
          }

          select.innerHTML += `<option value="${d.id}">${t.naam} (${t.jaar})</option>`;
        });

        fb.appendChild(select);
        return select;
      }

      // Laden van een toernooi via dropdown
      async function loadTournamentList() {
        try {
          const snapshot = await getDocs(collection(db, "toernooien"));
          const fb = document.getElementById("feedback");
          fb.innerHTML = "";

          if (snapshot.empty) {
            fb.innerHTML = `
              <div class="message" style="background:#f8d7da;color:#842029;">
                ‚ö†Ô∏è Er zijn nog geen toernooien opgeslagen.
                <span class="close" onclick="this.parentElement.remove()">√ó</span>
              </div>`;
            return;
          }

          // vaste dropdown hergebruiken
          let select = document.getElementById("tournamentSelect");
          if (!select) {
            select = document.createElement("select");
            select.id = "tournamentSelect";
            select.style.marginTop = "10px";
            select.style.padding = "6px";
            select.style.borderRadius = "6px";
            select.style.border = "1px solid #ccc";
            select.style.minWidth = "250px";
            fb.appendChild(select);

            // √©√©n keer event vastmaken
            select.addEventListener("change", async () => {
              const id = select.value;
              if (!id) return;

              const ref = doc(db, "toernooien", id);
              const dSnap = await getDoc(ref);
              if (!dSnap.exists()) {
                showFeedback("‚ö†Ô∏è Toernooi niet gevonden.", "error");
                return;
              }

              const t = dSnap.data();
              document.getElementById("tournamentName").value = t.naam;
              document.getElementById("tournamentYear").value = t.jaar;
              document.getElementById("tournamentOrg").value =
                t.organisatie || "";
              document.getElementById("maxTurns").value = t.maxBeurten || "";
              document.getElementById("dateEndR1").value =
                t.datums?.endR1 || "";
              document.getElementById("dateEndR2").value =
                t.datums?.endR2 || "";
              document.getElementById("dateStartFinale").value =
                t.datums?.startFinale || "";
              document.getElementById("dateEndFinale").value =
                t.datums?.endFinale || "";
              document.getElementById("pointsWinLess").value =
                t.punten?.winLess || "";
              document.getElementById("pointsDrawLess").value =
                t.punten?.drawLess || "";
              document.getElementById("pointsLoseLess").value =
                t.punten?.loseLess || "";
              document.getElementById("pointsWinMax").value =
                t.punten?.winMax || "";
              document.getElementById("pointsDrawMax").value =
                t.punten?.drawMax || "";
              document.getElementById("pointsLoseMax").value =
                t.punten?.loseMax || "";

              // Publicatie-status instellen
              const pubCheckbox = document.getElementById(
                "tournamentPublished"
              );
              if (pubCheckbox) {
                pubCheckbox.checked = !!t.publiceerPubliek;
                // badge mee updaten
                if (typeof updatePublishedBadge === "function") {
                  updatePublishedBadge(pubCheckbox.checked);
                }
              }

              activeTournamentId = id;
              playersFinalized = !!t.playersFinalized;
              updateActiveTournament(t.naam, t.jaar);
              showFeedback(
                `‚úÖ Toernooi "${t.naam}" (${t.jaar}) geladen.`,
                "success"
              );
              guardSpelersTabAvailability();

              await loadPlayersForActiveTournament();
              await loadPoulesForActiveTournament();
              await loadR1ResultsTabForActiveTournament();

              // ‚úÖ forceer eindstatus knoppen
              guardSpelersTabAvailability();
            });
          }

          // vul de dropdown
          select.innerHTML = '<option value="">Kies een toernooi...</option>';
          snapshot.forEach((d) => {
            const t = d.data();

            // filtering voor niet-admin
            if (!isAdmin) {
              const allowed = currentUser?.tournaments || [];
              if (!allowed.includes(d.id)) return;
            }

            select.innerHTML += `<option value="${d.id}">${t.naam} (${t.jaar})</option>`;
          });
        } catch (err) {
          console.error("‚ùå Fout bij laden:", err);
          showFeedback("‚ö†Ô∏è Kon toernooien niet laden uit Firestore.", "error");
        }
      }

      // Verwijderen van een toernooi (met dubbele bevestiging)
      async function deleteTournament() {
        try {
          const select = await buildTournamentSelect({ mode: "delete" });
          if (!select) return;

          select.addEventListener("change", async () => {
            const id = select.value;
            if (!id) return;

            const ref = doc(db, "toernooien", id);
            const snap = await getDoc(ref);
            if (!snap.exists()) {
              showFeedback("‚ö†Ô∏è Toernooi niet gevonden.", "error");
              return;
            }

            const t = snap.data();

            const zeker = confirm(
              `Weet je zeker dat je het toernooi "${t.naam}" wilt verwijderen?`
            );
            if (!zeker) {
              showFeedback("Verwijderen geannuleerd.", "error");
              return;
            }

            const invoer = prompt(
              `Typ de naam van het toernooi exact in ter bevestiging:\n${t.naam}`
            );
            if (invoer !== t.naam) {
              showFeedback(
                "‚ùå Naam komt niet overeen. Verwijderen geannuleerd.",
                "error"
              );
              return;
            }

            // BELANGRIJK: spelers-subcollectie eerst verwijderen
            const playersSnap = await getDocs(
              collection(db, "toernooien", id, "spelers")
            );
            for (const pDoc of playersSnap.docs) {
              await deleteDoc(doc(db, "toernooien", id, "spelers", pDoc.id));
            }

            await deleteDoc(ref);
            showFeedback(`üóëÔ∏è Toernooi "${t.naam}" is verwijderd.`, "success");

            // Reset state als dit actief was
            if (activeTournamentId === id) {
              activeTournamentId = null;
              playersFinalized = false;
              updateActiveTournament(null, null);
              guardSpelersTabAvailability();
              clearPlayersTable();
            }

            // dropdown verversen
            await buildTournamentSelect({ mode: "delete" });
          });
        } catch (err) {
          console.error("‚ùå Fout bij verwijderen:", err);
          showFeedback("‚ö†Ô∏è Kon toernooi niet verwijderen.", "error");
        }
      }

      /* ===== FUNCTIES TAB SPELERS ===== */

      const playerForm = document.getElementById("playerForm");
      const playerTableBody = document.getElementById("playerTableBody");
      const sortByNameBtn = document.getElementById("sortByName");
      const sortByCarambolesBtn = document.getElementById("sortByCaramboles");
      const finalizeBtn = document.getElementById("finalizePlayers");
      const editBtn = document.getElementById("editPlayers");
      const addPlayerBtn = document.getElementById("addPlayerBtn");
      const playerCount = document.getElementById("playerCount");
      const playersFinalizedNotice = document.getElementById(
        "playersFinalizedNotice"
      );
      const editPlayerModal = document.getElementById("editPlayerModal");
      const editPlayerForm = document.getElementById("editPlayerForm");
      const cancelEdit = document.getElementById("cancelEdit");
      const noTournamentNotice = document.getElementById("noTournamentNotice");
      const playersLockOverlay = document.getElementById("playersLockOverlay");

      let currentPlayers = [];
      let currentSort = null;
      let editPlayerId = null;
      // let r1PoulesExist = false; // true zodra er poules_r1 zijn

      function updatePlayerCount() {
        playerCount.textContent = `Aantal deelnemers: ${currentPlayers.length}`;
      }

      function openEditModal(player) {
        editPlayerId = player.id;

        const nameInput = document.getElementById("editName");
        const emailInput = document.getElementById("editEmail");
        const phoneInput = document.getElementById("editPhone");
        const carInput = document.getElementById("editCaramboles");

        nameInput.value = player.naam || "";
        emailInput.value = player.email || "";
        phoneInput.value = player.telefoon || "";
        carInput.value = player.caramboles ?? "";

        // Zodra er poules zijn: alleen e-mail & telefoon bewerkbaar
        const lockStructural = !!r1PoulesExist;

        nameInput.disabled = lockStructural;
        carInput.disabled = lockStructural;

        // kleine visuele hint
        nameInput.style.backgroundColor = lockStructural ? "#f0f0f0" : "";
        carInput.style.backgroundColor = lockStructural ? "#f0f0f0" : "";

        editPlayerModal.style.display = "flex";
      }

      function closeEditModal() {
        editPlayerId = null;
        editPlayerModal.style.display = "none";
      }

      cancelEdit.addEventListener("click", closeEditModal);

      editPlayerForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!editPlayerId || !activeTournamentId) return;

        const newData = {
          naam: document.getElementById("editName").value.trim(),
          email: document.getElementById("editEmail").value.trim(),
          telefoon: document.getElementById("editPhone").value.trim(),
          caramboles:
            Number(document.getElementById("editCaramboles").value) || 0,
        };

        // Bestaande speler opzoeken om te kunnen vergelijken
        const oldPlayer =
          currentPlayers.find((p) => p.id === editPlayerId) || {};
        const oldName = oldPlayer.naam || "";
        const oldCar = oldPlayer.caramboles ?? 0;

        const newName = newData.naam;
        const newCar = newData.caramboles;

        // Check: zitten we midden in het toernooi?
        // (= spelerslijst definitief √©n er zijn al poules/wedstrijden)
        let midTournament = false;
        if (playersFinalized) {
          const hasStructure = await hasAnyPoulesOrMatchesForActiveTournament();
          midTournament = hasStructure;
        }

        if (midTournament) {
          const nameChanged = oldName !== newName;
          const carChanged = oldCar !== newCar;

          if (nameChanged || carChanged) {
            showPlayerFeedback(
              "‚ùå Tijdens het toernooi mogen alleen e-mailadres en telefoonnummer worden gewijzigd. " +
                "Naam en te maken caramboles blijven ongewijzigd.",
              "error"
            );
            return;
          }
        }

        // Als we hier zijn: wijziging is toegestaan
        await setDoc(
          doc(db, "toernooien", activeTournamentId, "spelers", editPlayerId),
          newData,
          { merge: true }
        );
        showPlayerFeedback(
          `‚úèÔ∏è Speler "${newData.naam}" bijgewerkt.`,
          "success"
        );
        closeEditModal();
        await loadPlayersFromFirestore();
      });

      function clearPlayersTable() {
        currentPlayers = [];
        playerTableBody.innerHTML = "";
        updatePlayerCount();
      }

      function guardSpelersTabAvailability() {
        const disabled = !activeTournamentId;
        const hasPoules = !!r1PoulesExist; // NIEUW: controle op poules

        // Overlay & Notice voor definitieve lijst
        if (playersFinalized) {
          playersFinalizedNotice.style.display = "flex";
          playersLockOverlay.style.display = "flex";
        } else {
          playersFinalizedNotice.style.display = "none";
          playersLockOverlay.style.display = "none";
        }

        // Toernooi nodig waarschuwing
        noTournamentNotice.style.display = disabled ? "block" : "none";

        // formulier voor nieuwe speler
        if (playerForm) {
          [...playerForm.querySelectorAll("input,button")].forEach((el) => {
            if (el.id === "addPlayerBtn") {
              // Speler toevoegen mag NIET als: geen toernooi OF lijst definitief OF er al poules zijn
              const blockAdd = disabled || playersFinalized || hasPoules;
              el.disabled = blockAdd;
              if (blockAdd) {
                el.style.backgroundColor = "#ccc";
                el.style.cursor = "not-allowed";
                el.style.opacity = "0.7";
              } else {
                el.style.backgroundColor = "";
                el.style.cursor = "pointer";
                el.style.opacity = "1";
              }
            } else {
              // overige velden alleen blokkeren als er nog geen toernooi is
              el.disabled = disabled;
              if (disabled) {
                el.style.backgroundColor = "#f0f0f0";
                el.style.cursor = "not-allowed";
                el.style.opacity = "0.7";
              } else {
                el.style.backgroundColor = "";
                el.style.cursor = "";
                el.style.opacity = "";
              }
            }
          });
        }

        // sorteerknoppen
        if (sortByNameBtn) sortByNameBtn.disabled = disabled;
        if (sortByCarambolesBtn) sortByCarambolesBtn.disabled = disabled;

        // ‚úÖ 1) De 'Lijst definitief maken' knop is actief wanneer:
        // - Toernooi actief is (niet disabled)
        // - Lijst NIET definitief is (!playersFinalized)
        // - ER ZIJN GEEN poules (!hasPoules)
        if (finalizeBtn) {
          finalizeBtn.disabled = disabled || playersFinalized || hasPoules;
          finalizeBtn.style.opacity = finalizeBtn.disabled ? "0.6" : "1";
          finalizeBtn.style.cursor = finalizeBtn.disabled
            ? "not-allowed"
            : "pointer";
        }

        // ‚úÖ 2) De 'Lijst bewerken' knop is actief wanneer:
        // - Toernooi actief is (niet disabled)
        // - Lijst WEL definitief is (playersFinalized)
        // - ER ZIJN GEEN poules (!hasPoules)
        if (editBtn) {
          editBtn.disabled = disabled || !playersFinalized || hasPoules;
          editBtn.style.opacity = editBtn.disabled ? "0.6" : "1";
          editBtn.style.cursor = editBtn.disabled ? "not-allowed" : "pointer";
        }

        // Disable delete buttons in the table if finalized or has poules (NIEUW)
        document.querySelectorAll(".delete-player-btn").forEach((btn) => {
          btn.disabled = playersFinalized || hasPoules;
          btn.style.opacity = btn.disabled ? "0.4" : "1";
        });

        // Visuele status voor de bewerk knop in de tabel (NIEUW)
        document.querySelectorAll(".edit-player-btn").forEach((btn) => {
          const isStructuralLock = hasPoules; // Edit van naam/caramboles is geblokkeerd zodra poules bestaan
          btn.title = isStructuralLock
            ? "Alleen e-mail/telefoon zijn wijzigbaar (Poules bestaan)"
            : "Speler wijzigen";
        });
      }

      function renderPlayersTable() {
        playerTableBody.innerHTML = "";

        let rows = [...currentPlayers];
        if (currentSort === "name")
          rows.sort((a, b) =>
            a.naam.localeCompare(b.naam, "nl", { sensitivity: "base" })
          );
        else if (currentSort === "caramboles")
          rows.sort(
            (a, b) => Number(a.caramboles || 0) - Number(b.caramboles || 0)
          );

        rows.forEach((player) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
                                                <td>${player.naam || ""}</td>
                                                <td>${player.email || ""}</td>
                                                <td>${
                                                  player.telefoon || ""
                                                }</td>
                                                <td class="num">${
                                                  player.caramboles ?? ""
                                                }</td>
                                                <td class="actions">
                                                  <button class="edit-player-btn" title="Wijzig speler" style="background:#0d6efd;color:#fff;border:none;border-radius:6px;cursor:pointer;padding:4px 8px;font-size:0.85rem;margin-right:4px;">‚úèÔ∏è</button>
                                                  <button class="delete-player-btn" title="Verwijder speler" style="background:#dc3545;color:#fff;border:none;border-radius:6px;cursor:pointer;padding:4px 8px;font-size:0.85rem;">üóëÔ∏è</button>
                                                </td>
                                              `;

          const editBtn = tr.querySelector(".edit-player-btn");
          const delBtn = tr.querySelector(".delete-player-btn");

          // Altijd mogelijk te wijzigen
          editBtn.addEventListener("click", () => openEditModal(player));

          // Verwijderen alleen als niet definitief
          delBtn.disabled = playersFinalized;
          delBtn.addEventListener("click", async () => {
            if (!activeTournamentId || playersFinalized) return;
            if (!confirm(`Verwijder speler "${player.naam}"?`)) return;

            await deleteDoc(
              doc(db, "toernooien", activeTournamentId, "spelers", player.id)
            );
            showPlayerFeedback(
              `üóëÔ∏è Speler "${player.naam}" verwijderd.`,
              "success"
            );
            await loadPlayersFromFirestore();
          });

          playerTableBody.appendChild(tr);
        });

        updatePlayerCount();
        guardSpelersTabAvailability();
      }

      async function loadPlayersFromFirestore() {
        if (!activeTournamentId) {
          clearPlayersTable();
          guardSpelersTabAvailability();
          return;
        }

        const playersSnap = await getDocs(
          collection(db, "toernooien", activeTournamentId, "spelers")
        );
        currentPlayers = playersSnap.docs.map((d) => ({
          id: d.id,
          ...d.data(),
        }));

        const tRef = doc(db, "toernooien", activeTournamentId);
        const tSnap = await getDoc(tRef);
        if (tSnap.exists()) playersFinalized = !!tSnap.data().playersFinalized;

        renderPlayersTable();
      }

      async function addPlayer(e) {
        e.preventDefault();
        if (!activeTournamentId) {
          showPlayerFeedback("‚ö†Ô∏è Geen actief toernooi geselecteerd.", "error");
          return;
        }
        if (playersFinalized) {
          showPlayerFeedback(
            "‚ùå Lijst is definitief. Bewerken niet toegestaan.",
            "error"
          );
          return;
        }

        const naam = document.getElementById("playerName").value.trim();
        const email = document.getElementById("playerEmail").value.trim();
        const telefoon = document.getElementById("playerPhone").value.trim();
        const caramboles = document
          .getElementById("playerCaramboles")
          .value.trim();

        if (!naam) {
          showPlayerFeedback("‚ùå Naam speler is verplicht.", "error");
          return;
        }

        const newPlayer = {
          naam,
          email,
          telefoon,
          caramboles: caramboles ? Number(caramboles) : null,
        };
        await addDoc(
          collection(db, "toernooien", activeTournamentId, "spelers"),
          newPlayer
        );

        showPlayerFeedback(`‚úÖ Speler "${naam}" toegevoegd.`, "success");

        document.getElementById("playerName").value = "";
        document.getElementById("playerEmail").value = "";
        document.getElementById("playerPhone").value = "";
        document.getElementById("playerCaramboles").value = "";

        await loadPlayersFromFirestore();
      }

      sortByNameBtn.addEventListener("click", () => {
        currentSort = "name";
        renderPlayersTable();
      });

      sortByCarambolesBtn.addEventListener("click", () => {
        currentSort = "caramboles";
        renderPlayersTable();
      });

      finalizeBtn.addEventListener("click", async () => {
        if (!activeTournamentId) return;
        const confirmFinal = confirm(
          "Weet je zeker dat je de spelerslijst definitief wilt maken?"
        );
        if (!confirmFinal) return;

        await setDoc(
          doc(db, "toernooien", activeTournamentId),
          { playersFinalized: true },
          { merge: true }
        );
        playersFinalized = true;
        showPlayerFeedback("üîí Spelerslijst is definitief gemaakt.", "success");
        guardSpelersTabAvailability();
        updateR1PoulesButtons();
      });

      editBtn.addEventListener("click", async () => {
        if (!activeTournamentId) return;

        // GEEN poules/wedstrijden meer wissen hier

        await setDoc(
          doc(db, "toernooien", activeTournamentId),
          { playersFinalized: false },
          { merge: true }
        );
        playersFinalized = false;
        showPlayerFeedback("‚úèÔ∏è Spelerslijst is weer bewerkbaar.", "success");
        guardSpelersTabAvailability();

        if (typeof updateR1PoulesButtons === "function") {
          updateR1PoulesButtons();
        }
      });

      playerForm.addEventListener("submit", addPlayer);

      // NIEUWE FUNCTIES VOOR DE KNOPPEN

      async function finalizePlayersAction() {
        if (!activeTournamentId) return;
        if (playersFinalized) {
          showPlayerFeedback("‚ùå Lijst is al definitief.", "error");
          return;
        }
        // ‚úÖ Controle: mag niet definitief worden als er al poules zijn
        if (r1PoulesExist) {
          showPlayerFeedback(
            "‚ùå Kan niet definitief maken: er zijn al poules aangemaakt. Wis eerst de poules als je de lijst nog wilt wijzigen.",
            "error"
          );
          return;
        }

        const confirmFinalize = confirm(
          "Weet je zeker dat je de spelerslijst definitief wilt maken? Hierna zijn aanpassingen aan namen en caramboles niet meer mogelijk, tenzij je de lijst weer bewerkt (en er nog geen poules zijn)."
        );
        if (!confirmFinalize) return;

        try {
          const tRef = doc(db, "toernooien", activeTournamentId);
          await updateDoc(tRef, { playersFinalized: true });
          playersFinalized = true;
          showPlayerFeedback("‚úÖ Spelerslijst definitief gemaakt.", "success");
          guardSpelersTabAvailability(); // Update knoppen direct
          renderPlayersTable();
        } catch (err) {
          console.error("Fout bij definitief maken:", err);
          showPlayerFeedback("‚ö†Ô∏è Kon lijst niet definitief maken.", "error");
        }
      }

      async function editPlayersAction() {
        if (!activeTournamentId) return;
        if (!playersFinalized) {
          showPlayerFeedback("‚ùå Lijst is al bewerkbaar.", "error");
          return;
        }
        // ‚úÖ Controle: mag niet bewerkbaar worden als er al poules zijn
        if (r1PoulesExist) {
          showPlayerFeedback(
            "‚ùå Kan lijst niet bewerken: er zijn al 1e ronde poules aangemaakt. Wis eerst de poules."
          );
          return;
        }
        const confirmEdit = confirm(
          "Weet je zeker dat je de spelerslijst weer wilt bewerken? De definitieve status wordt ongedaan gemaakt, en je kunt namen/caramboles weer wijzigen."
        );
        if (!confirmEdit) return;

        try {
          const tRef = doc(db, "toernooien", activeTournamentId);
          await updateDoc(tRef, { playersFinalized: false });
          playersFinalized = false;
          showPlayerFeedback("‚úèÔ∏è Spelerslijst is weer bewerkbaar.", "success");
          guardSpelersTabAvailability(); // Update knoppen direct
          renderPlayersTable();
        } catch (err) {
          console.error("Fout bij bewerken:", err);
          showPlayerFeedback("‚ö†Ô∏è Kon lijst niet bewerkbaar maken.", "error");
        }
      }

      async function loadPlayersForActiveTournament() {
        if (!activeTournamentId) return;
        await loadPlayersFromFirestore();
      }

      /* ===== EINDE FUNCTIES TAB SPELERS ===== */

      /* ===== FUNCTIES TAB 1E RONDE POULES ===== */

      const createPoulesBtn = document.getElementById("createPoulesBtn");
      const savePoulesBtn = document.getElementById("savePoulesBtn");
      const clearPoulesBtn = document.getElementById("clearPoulesBtn");
      const availablePlayersDiv = document.getElementById("availablePlayers");
      const poulesContainer = document.getElementById("poulesContainer");
      const poulesFeedback = document.getElementById("poulesFeedback");
      const noTournamentPoulesNotice = document.getElementById(
        "noTournamentPoulesNotice"
      );

      let currentPoules = []; // [{ naam, maxSpelers, spelers:[{id,naam,caramboles,...}] }, ...]
      let selectedPlayer = null; // spelerobject die is aangeklikt links
      let availablePlayers = []; // spelers die nog NIET in een poule zitten
      let allPlayers = []; // alle spelers uit Firestore (cache)

      // ----- UI helpers -----

      function showPoulesFeedback(msg, type = "info") {
        poulesFeedback.innerHTML = `<div style="padding:6px 10px; border-radius:6px;
                                              background:${
                                                type === "error"
                                                  ? "#f8d7da"
                                                  : type === "success"
                                                  ? "#d1e7dd"
                                                  : "#e2e3e5"
                                              };
                                              color:${
                                                type === "error"
                                                  ? "#842029"
                                                  : type === "success"
                                                  ? "#0f5132"
                                                  : "#41464b"
                                              };
                                              border:1px solid ${
                                                type === "error"
                                                  ? "#f5c2c7"
                                                  : type === "success"
                                                  ? "#badbcc"
                                                  : "#d3d6d8"
                                              };
                                              margin-top:10px;">${msg}</div>`;
      }

      function updateR1PoulesButtons() {
        if (!createPoulesBtn || !savePoulesBtn || !clearPoulesBtn) return;

        const hasTournament = !!activeTournamentId;
        const hasPoules = currentPoules.length > 0;
        const playersDef = !!playersFinalized;

        // ‚úÖ NIEUW: wedstrijdschema bestaat zodra er r1Matches zijn
        const hasSchedule = Array.isArray(r1Matches) && r1Matches.length > 0;

        // hoeveel spelers al ingedeeld?
        const totalPlayers = allPlayers.length;
        const assignedPlayers = currentPoules.reduce(
          (sum, p) => sum + p.spelers.length,
          0
        );
        const allAssigned =
          totalPlayers > 0 && assignedPlayers === totalPlayers;

        // onthoud dit ook voor de spelers-tab
        r1PoulesExist = hasPoules;

        // ‚ûï Poules aanmaken
        // - alleen als er een toernooi is
        // - spelerslijst definitief is
        // - er nog g√©√©n poules bestaan
        // - ‚úÖ EN er nog g√©√©n wedstrijdschema is
        createPoulesBtn.disabled =
          !hasTournament || !playersDef || hasPoules || hasSchedule;

        // üíæ Indeling opslaan
        // - alleen als:
        //   ‚Ä¢ toernooi actief
        //   ‚Ä¢ spelerslijst definitief
        //   ‚Ä¢ er poules zijn
        //   ‚Ä¢ alle spelers zijn ingedeeld
        //   ‚Ä¢ ‚úÖ EN er nog g√©√©n wedstrijdschema is
        const canSave =
          hasTournament &&
          playersDef &&
          hasPoules &&
          allAssigned &&
          !hasSchedule;
        savePoulesBtn.disabled = !canSave;

        // üóëÔ∏è Alles wissen
        // - alleen als:
        //   ‚Ä¢ toernooi actief
        //   ‚Ä¢ spelerslijst definitief
        //   ‚Ä¢ er poules zijn
        //   ‚Ä¢ ‚úÖ EN er nog g√©√©n wedstrijdschema is
        clearPoulesBtn.disabled =
          !hasTournament || !playersDef || !hasPoules || hasSchedule;

        [createPoulesBtn, savePoulesBtn, clearPoulesBtn].forEach((btn) => {
          btn.style.opacity = btn.disabled ? "0.4" : "1";
          btn.style.cursor = btn.disabled ? "not-allowed" : "pointer";
        });

        // ‚úÖ NIEUW: verwijder-knoppen in poule-kaarten blokkeren als schema bestaat
        document
          .querySelectorAll("#poulesContainer button[data-player-id]")
          .forEach((btn) => {
            btn.disabled = hasSchedule;
            btn.style.opacity = btn.disabled ? "0.4" : "1";
            btn.style.cursor = btn.disabled ? "not-allowed" : "pointer";
          });

        // Spelers-tab ook updaten als de poules-situatie verandert
        if (typeof guardSpelersTabAvailability === "function") {
          guardSpelersTabAvailability();
        }
      }

      // ----- hulpfunctie om te bepalen wie al in een poule zit -----

      function getPlayerIdsInPoules() {
        const ids = new Set();
        currentPoules.forEach((p) => {
          p.spelers.forEach((sp) => ids.add(sp.id));
        });
        return ids;
      }

      // ----- render van de linkerkant (beschikbare spelers) -----

      function renderAvailablePlayers() {
        availablePlayersDiv.innerHTML = "";

        if (!activeTournamentId) {
          noTournamentPoulesNotice.style.display = "block";
          return;
        }
        noTournamentPoulesNotice.style.display = "none";

        // filter nogmaals: alleen spelers die niet in een poule zitten
        const idsInPoules = getPlayerIdsInPoules();
        const notAssigned = allPlayers.filter((p) => !idsInPoules.has(p.id));

        // sorteer op caramboles (hoog ‚Üí laag)
        notAssigned.sort((a, b) => (b.caramboles || 0) - (a.caramboles || 0));

        availablePlayers = notAssigned;

        if (availablePlayers.length === 0) {
          availablePlayersDiv.innerHTML = `<p style="color:#777;">Geen vrije spelers meer.</p>`;
          return;
        }

        availablePlayers.forEach((p) => {
          const div = document.createElement("div");
          div.className = "player-item";
          div.innerHTML = `<strong>${p.naam}</strong> (${p.caramboles || 0})`;
          div.dataset.id = p.id;
          div.style.cssText = `
                                                padding:6px 8px; border:1px solid #ccc; border-radius:5px;
                                                margin-bottom:4px; background:white; cursor:pointer;
                                                transition:all 0.2s ease;
                                              `;
          div.addEventListener("click", () => selectPlayer(p.id, div));
          availablePlayersDiv.appendChild(div);
        });
      }

      // ----- selectie van een speler links -----

      function selectPlayer(id, element) {
        document
          .querySelectorAll(".player-item")
          .forEach((el) => (el.style.background = "white"));
        const player = availablePlayers.find((p) => p.id === id);
        if (!player) return;
        selectedPlayer = player;
        element.style.background = "#cce5ff";
        showPoulesFeedback(`üéØ Geselecteerd: ${player.naam}`, "info");
      }

      // ----- render van de poules rechts -----

      function renderPoules() {
        poulesContainer.innerHTML = "";

        currentPoules.forEach((poule) => {
          const isFull = poule.spelers.length >= poule.maxSpelers;

          const card = document.createElement("div");
          card.className = "poule-card";
          card.style.cssText = `
                                                border:3px solid ${
                                                  isFull ? "#198754" : "#ccc"
                                                };
                                                border-radius:8px; padding:8px; background:#fff; min-height:120px; cursor:pointer;
                                                transition:all 0.2s ease;
                                              `;

          // header met aantallen
          const header = document.createElement("h5");
          header.innerHTML = `
                                                ${poule.naam}
                                                <span style="font-weight:normal;font-size:0.9em;color:#555;">
                                                  (${poule.spelers.length}/${poule.maxSpelers})
                                                </span>
                                              `;
          card.appendChild(header);

          // lijst met spelers
          const list = document.createElement("ul");
          list.style.marginTop = "5px";
          list.style.paddingLeft = "15px";

          poule.spelers.forEach((sp) => {
            const li = document.createElement("li");
            li.style.display = "flex";
            li.style.justifyContent = "space-between";
            li.style.alignItems = "center";
            li.style.marginBottom = "2px";

            // speler + caramboles op 1 regel
            const labelSpan = document.createElement("span");
            labelSpan.textContent = `${sp.naam} (${sp.caramboles || 0})`;

            const delBtn = document.createElement("button");
            delBtn.title = "Verwijder speler uit poule";
            delBtn.style.cssText = `
                                                  background:#dc3545;
                                                  color:white;
                                                  border:none;
                                                  border-radius:4px;
                                                  cursor:pointer;
                                                  padding:2px 5px;
                                                  font-size:0.8rem;
                                                `;
            delBtn.textContent = "üóëÔ∏è";
            delBtn.addEventListener("click", (e) => {
              e.stopPropagation(); // voorkom dat klik op poule zelf ook triggert
              removePlayerFromPoule(poule.naam, sp.id);
            });

            li.appendChild(labelSpan);
            li.appendChild(delBtn);
            list.appendChild(li);
          });

          card.appendChild(list);

          // klik op poule = probeer geselecteerde speler toe te voegen
          card.addEventListener("click", () =>
            addSelectedPlayerToPoule(poule.naam)
          );
          poulesContainer.appendChild(card);
        });
      }

      // ----- poules aanmaken op basis van aantal spelers -----

      async function createPoules() {
        if (!activeTournamentId) {
          showPoulesFeedback("‚ö†Ô∏è Geen toernooi actief.", "error");
          return;
        }

        const playersSnap = await getDocs(
          collection(db, "toernooien", activeTournamentId, "spelers")
        );
        allPlayers = playersSnap.docs.map((d) => ({ id: d.id, ...d.data() }));

        const numPlayers = allPlayers.length;

        if (numPlayers < 12) {
          showPoulesFeedback(
            "‚ùå Er zijn minimaal 12 spelers nodig om poules te kunnen aanmaken.",
            "error"
          );
          return;
        }

        const basePoules = Math.floor(numPlayers / 4);
        const remainder = numPlayers % 4;

        let numPoules = basePoules;
        let numPoulesOf5 = 0;

        if (remainder === 1) numPoulesOf5 = 1;
        else if (remainder === 2) numPoulesOf5 = 2;
        else if (remainder === 3) numPoulesOf5 = 3;

        currentPoules = [];
        for (let i = 0; i < numPoules; i++) {
          const naam = `Poule ${String.fromCharCode(65 + i)}`;
          const maxSpelers = i < numPoulesOf5 ? 5 : 4;
          currentPoules.push({ naam, maxSpelers, spelers: [] });
        }

        selectedPlayer = null;

        // ‚úÖ Info tonen boven poules
        const poulesInfo = document.getElementById("poulesDistributionInfo");
        if (poulesInfo) {
          poulesInfo.style.display = "block";
          poulesInfo.textContent =
            `Verdeling: ${numPoulesOf5} poule${
              numPoulesOf5 !== 1 ? "s" : ""
            } met 5 spelers, ` +
            `${numPoules - numPoulesOf5} poule${
              numPoules - numPoulesOf5 !== 1 ? "s" : ""
            } met 4 spelers ` +
            `(totaal ${numPlayers} spelers)`;
        }

        showPoulesFeedback(
          `‚úÖ ${numPoules} poules aangemaakt. Klik op een speler links en daarna op een poule om toe te voegen.`,
          "success"
        );

        renderPoules();
        renderAvailablePlayers();

        updateR1PoulesButtons();
      }

      // ----- speler toevoegen aan poule -----

      function addSelectedPlayerToPoule(pouleNaam) {
        if (!selectedPlayer) {
          showPoulesFeedback("‚ö†Ô∏è Selecteer eerst een speler links.", "error");
          return;
        }

        const poule = currentPoules.find((p) => p.naam === pouleNaam);
        if (!poule) return;

        // vol?
        if (poule.spelers.length >= poule.maxSpelers) {
          showPoulesFeedback("‚ùå Deze poule zit vol.", "error");
          return;
        }

        // zit speler al ergens in?
        const alreadyInSomePoule = currentPoules.some((p) =>
          p.spelers.find((sp) => sp.id === selectedPlayer.id)
        );
        if (alreadyInSomePoule) {
          showPoulesFeedback("‚ö†Ô∏è Deze speler zit al in een poule.", "error");
          return;
        }

        // toevoegen
        poule.spelers.push(selectedPlayer);

        // haal speler uit availablePlayers
        availablePlayers = availablePlayers.filter(
          (p) => p.id !== selectedPlayer.id
        );
        selectedPlayer = null;

        // UI opnieuw tekenen
        renderPoules();
        renderAvailablePlayers();
        updateR1PoulesButtons();

        showPoulesFeedback("‚úÖ Speler toegevoegd aan poule.", "success");
      }

      // ----- speler verwijderen uit poule -----

      function removePlayerFromPoule(pouleNaam, spelerId) {
        const poule = currentPoules.find((p) => p.naam === pouleNaam);
        if (!poule) return;

        const idx = poule.spelers.findIndex((sp) => sp.id === spelerId);
        if (idx === -1) return;

        // speler die we terugzetten
        const [removedPlayer] = poule.spelers.splice(idx, 1);

        // alleen deze speler terug naar availablePlayers
        // maar niet dubbel toevoegen als hij toevallig nog vrij stond
        const alreadyFree = availablePlayers.find(
          (p) => p.id === removedPlayer.id
        );
        if (!alreadyFree) {
          availablePlayers.push(removedPlayer);
        }

        // UI opnieuw tekenen
        renderPoules();
        renderAvailablePlayers();
        updateR1PoulesButtons();

        showPoulesFeedback(
          `üóëÔ∏è ${removedPlayer.naam} is weer beschikbaar.`,
          "info"
        );
      }

      // ----- opslaan in Firestore -----

      async function savePoulesToFirestore() {
        if (!activeTournamentId) {
          showPoulesFeedback("‚ö†Ô∏è Geen toernooi actief.", "error");
          return;
        }
        if (currentPoules.length === 0) {
          showPoulesFeedback("‚ö†Ô∏è Geen poules om op te slaan.", "error");
          return;
        }

        // schrijf alle poules onder /toernooien/{id}/poules_r1/*
        const poulesRef = collection(
          db,
          "toernooien",
          activeTournamentId,
          "poules_r1"
        );

        // eerst de oude wissen
        const existing = await getDocs(poulesRef);
        for (const d of existing.docs) {
          await deleteDoc(d.ref);
        }

        // dan de huidige opslaan
        for (const p of currentPoules) {
          await setDoc(doc(poulesRef, p.naam), {
            naam: p.naam,
            maxSpelers: p.maxSpelers,
            spelers: p.spelers,
          });
        }

        showPoulesFeedback(
          "üíæ Poule-indeling opgeslagen in Firestore.",
          "success"
        );

        // ‚úÖ knop uitschakelen na succesvol opslaan
        savePoulesBtn.disabled = true;
        savePoulesBtn.style.opacity = "0.2";
        savePoulesBtn.title = "De poule-indeling is opgeslagen.";
      }

      // ----- wissen/resetten -----

      async function clearPoules() {
        if (!confirm("Weet je zeker dat je alle poules wilt wissen?")) return;

        currentPoules = [];
        selectedPlayer = null;

        poulesContainer.innerHTML = "";
        renderAvailablePlayers(); // alle spelers gaan weer links staan

        // Leegschrijven in Firestore
        if (activeTournamentId) {
          const poulesRef = collection(
            db,
            "toernooien",
            activeTournamentId,
            "poules_r1"
          );
          const existing = await getDocs(poulesRef);
          for (const d of existing.docs) {
            await deleteDoc(d.ref);
          }
        }

        updateR1PoulesButtons();

        showPoulesFeedback("üóëÔ∏è Alle poules gewist.", "success");
      }

      // ----- bestaande indeling laden bij actief toernooi -----

      async function loadPoulesForActiveTournament() {
        if (!activeTournamentId) {
          currentPoules = [];
          r1PoulesExist = false; // Reset status bij geen toernooi
          if (typeof renderPoules === "function") renderPoules(); // Zorg dat de UI leeg is
          if (typeof renderAvailablePlayers === "function")
            renderAvailablePlayers();
          guardSpelersTabAvailability(); // Update knopstatus naar 'disabled'
          return;
        }

        try {
          // Zorg eerst dat allPlayers gevuld is (nodig voor data-consistentie)
          // De functie loadPlayersForActiveTournament doet dit, maar hier een fallback/check:
          if (allPlayers.length === 0) {
            const playersSnap = await getDocs(
              collection(db, "toernooien", activeTournamentId, "spelers")
            );
            allPlayers = playersSnap.docs.map((d) => ({
              id: d.id,
              ...d.data(),
            }));
          }

          const poulesSnap = await getDocs(
            collection(db, "toernooien", activeTournamentId, "poules_r1")
          );

          // ‚úÖ 1. Stel r1PoulesExist in op basis van het resultaat
          r1PoulesExist = poulesSnap.docs.length > 0;

          currentPoules = poulesSnap.docs.map((d) => ({
            id: d.id,
            ...d.data(),
          }));

          // Zorg ervoor dat de poule-spelers de meest recente spelerdata bevatten
          currentPoules.forEach((poule) => {
            // De 'spelers' array zou moeten bestaan als de poule goed is opgeslagen
            if (!poule.spelers) poule.spelers = [];

            poule.spelers = poule.spelers
              .map((pouleSpeler) => {
                const fullPlayer = allPlayers.find(
                  (ap) => ap.id === pouleSpeler.id
                );
                // Als de speler nog bestaat, geef dan de volledige (up-to-date) speler terug
                return fullPlayer || pouleSpeler;
              })
              .filter((p) => allPlayers.some((ap) => ap.id === p.id)); // Filter spelers die niet meer in allPlayers zitten
          });

          // 3. sync beschikbare spelers op basis van wie al in currentPoules zit
          renderPoules();
          renderAvailablePlayers();

          selectedPlayer = null;

          // Knop 'Poules aanmaken' blokkeren zodra er poules bestaan
          updateR1PoulesButtons();

          // ‚úÖ 2. BELANGRIJK: Update knopstatus op het Spelers-tabblad
          guardSpelersTabAvailability();
        } catch (e) {
          console.error("Fout bij laden poules:", e);
          // Reset de status bij een fout
          r1PoulesExist = false;
          guardSpelersTabAvailability();
        }
      }

      // ----- event listeners -----

      createPoulesBtn.addEventListener("click", createPoules);
      savePoulesBtn.addEventListener("click", savePoulesToFirestore);
      clearPoulesBtn.addEventListener("click", clearPoules);

      /* ===== EINDE FUNCTIES TAB 1E RONDE POULES ===== */

      /* ===== FUNCTIES TAB 1E RONDE RESULTATEN ===== */

      // --- Elementen ophalen ---
      const noTournamentR1ResNotice = document.getElementById(
        "noTournamentR1ResNotice"
      );
      const r1matchesWrapper = document.getElementById("r1matchesWrapper");
      const r1GlobalStandTable = document.getElementById("r1GlobalStandTable");

      let r1Matches = [];
      let toernooiSettings = {};
      let r1PoulesCache = [];

      // ====== Popup melding ======
      function showPopupMessage(msg, isError = true) {
        const existing = document.getElementById("popupMsg");
        if (existing) existing.remove();

        const popup = document.createElement("div");
        popup.id = "popupMsg";
        popup.style.cssText = `
                      position:fixed; top:20%; left:50%; transform:translateX(-50%);
                      background:${isError ? "#f8d7da" : "#d1e7dd"};
                      color:${isError ? "#842029" : "#0f5132"};
                      border:1px solid ${isError ? "#f5c2c7" : "#badbcc"};
                      border-radius:8px; padding:20px 25px; z-index:2000;
                      box-shadow:0 4px 12px rgba(0,0,0,0.3); text-align:center; min-width:280px;
                    `;
        popup.innerHTML = `
                      <div>${msg}</div>
                      <button style="margin-top:12px; background:#fff; border:1px solid #ccc;
                        border-radius:4px; padding:5px 15px; cursor:pointer;">OK</button>`;
        popup.querySelector("button").onclick = () => popup.remove();
        document.body.appendChild(popup);
      }

      // ====== Scoring overzicht ======
      function renderScoringOverview() {
        const el = document.getElementById("r1ScoringOverview");
        if (!toernooiSettings || !toernooiSettings.punten) {
          el.style.display = "none";
          return;
        }
        const p = toernooiSettings.punten;
        const maxB = toernooiSettings.maxBeurten;
        const maxText = maxB ? maxB : "Niet van toepassing";
        el.style.display = "block";
        el.innerHTML = `
                      <strong>Maximaal aantal beurten:</strong> ${maxText}<br>
                      <strong>Punten:</strong>
                      Winst &lt; max: ${p.winLess}, Gelijk &lt; max: ${p.drawLess}, Verlies &lt; max: ${p.loseLess} |
                      Winst = max: ${p.winMax}, Gelijk = max: ${p.drawMax}, Verlies = max: ${p.loseMax}
                    `;
      }

      // ====== Algemeen overzicht voortgang ======
      function updateOverallProgress() {
        const total = r1Matches.length;
        const played = r1Matches.filter((m) => m.afgerond).length;
        const perc = total > 0 ? Math.round((played / total) * 100) : 0;
        const el = document.getElementById("r1OverallProgress");
        el.style.display = total === 0 ? "none" : "block";
        el.textContent =
          total === 0
            ? ""
            : `Totaal gespeeld: ${played} / ${total} wedstrijden (${perc}%)`;
      }

      function assignRankPoints(sortedArray, field, targetField) {
        let i = 0;
        while (i < sortedArray.length) {
          const startRank = i + 1; // ‚úÖ 1-based
          let j = i + 1;
          while (
            j < sortedArray.length &&
            sortedArray[j][field] === sortedArray[i][field]
          )
            j++;
          const endRank = j;
          const avgRank = (startRank + endRank) / 2;
          for (let k = i; k < j; k++) sortedArray[k][targetField] = avgRank;
          i = j;
        }
      }

      // ====== Globale eindstand berekenen ======

      /* ----------------------------------------------------------
         1E RONDE RESULTATEN ‚Äì globale ranglijst (met poule-factor)
      ---------------------------------------------------------- */
      function buildGlobalRankingFromStats(allMatches, r1Poules) {
        // Map met volledige poule-docs (voor evt. toekomstig gebruik)
        const pouleMap = {};
        (r1Poules || []).forEach((p) => {
          pouleMap[p.id] = p;
        });

        // 1. verzamelen statistieken per speler
        const statsPerSpeler = {};
        allMatches.forEach((m) => {
          if (!m.spelerX || !m.spelerY) return;

          [m.spelerX, m.spelerY].forEach((sp) => {
            if (!statsPerSpeler[sp.id]) {
              statsPerSpeler[sp.id] = {
                spelerId: sp.id,
                naam: sp.naam,
                teMaken: sp.teMaken,
                puntenTotaal: 0,
                carambolesTotaal: 0,
                beurtenTotaal: 0,
                wedstrijdenGespeeld: 0,
                poule: m.poule,
              };
            }
          });

          if (!m.afgerond) return;

          const sx = statsPerSpeler[m.spelerX.id];
          sx.puntenTotaal += Number(m.puntenX) || 0;
          sx.carambolesTotaal += Number(m.gemaakteX) || 0;
          sx.beurtenTotaal += Number(m.beurten) || 0;
          sx.wedstrijdenGespeeld++;

          const sy = statsPerSpeler[m.spelerY.id];
          sy.puntenTotaal += Number(m.puntenY) || 0;
          sy.carambolesTotaal += Number(m.gemaakteY) || 0;
          sy.beurtenTotaal += Number(m.beurten) || 0;
          sy.wedstrijdenGespeeld++;
        });

        // 2. moy, %car en puntenAdj (puntenAdj = al-herberekende punten)
        const allStats = Object.values(statsPerSpeler).map((s) => {
          const moy =
            s.beurtenTotaal > 0 ? s.carambolesTotaal / s.beurtenTotaal : 0;
          const totTeMaken = s.teMaken * (s.wedstrijdenGespeeld || 0);
          const percCar =
            totTeMaken > 0 ? (s.carambolesTotaal / totTeMaken) * 100 : 0;

          // Let op: puntenTotaal is al inclusief factor, via herberekening van de wedstrijden
          const puntenAdj = s.puntenTotaal || 0;

          return { ...s, moy, percCar, puntenAdj };
        });

        // 3. ranking voor punten (op basis van aangepaste punten)
        const byPoints = [...allStats].sort(
          (a, b) => b.puntenAdj - a.puntenAdj
        );
        // ‚úÖ gebruik helper: gelijke punten ‚Üí gemiddelde rang
        assignRankPoints(byPoints, "puntenAdj", "rankPoints_punten");

        // 4. ranking voor % caramboles
        const byPercCar = [...allStats].sort((a, b) => b.percCar - a.percCar);
        // ‚úÖ idem voor %car
        assignRankPoints(byPercCar, "percCar", "rankPoints_percCar");

        // 5. totale ranking (som van de twee rangen)
        allStats.forEach((s) => {
          s.rankTotaal = s.rankPoints_punten + s.rankPoints_percCar;
        });

        return allStats.sort((a, b) => {
          if (a.rankTotaal !== b.rankTotaal) {
            return a.rankTotaal - b.rankTotaal;
          }
          // bij gelijke rankTotaal: eerst hoogste aangepaste punten
          if (b.puntenAdj !== a.puntenAdj) {
            return b.puntenAdj - a.puntenAdj;
          }
          // daarna hoogste %car
          return b.percCar - a.percCar;
        });
      }
      // Alle gespeelde wedstrijden in een poule opnieuw doorrekenen met de huidige factor
      async function recalcR1PouleMatches(pouleId) {
        if (!activeTournamentId) return;

        const pouleDoc = r1PoulesCache.find((p) => p.id === pouleId);
        if (!pouleDoc) return;

        // Pak alle wedstrijden van deze poule
        const matchesInPoule = r1Matches.filter((m) => m.poule === pouleId);

        for (const m of matchesInPoule) {
          // alleen afgeronde wedstrijden opnieuw berekenen
          if (!m.afgerond) continue;

          const gX = Number(m.gemaakteX) || 0;
          const gY = Number(m.gemaakteY) || 0;
          const b = Number(m.beurten) || 0;

          const { pX, pY, uitslag } = calcR1Points(
            gX,
            gY,
            b,
            toernooiSettings.maxBeurten || 0,
            m.spelerX.teMaken,
            m.spelerY.teMaken,
            toernooiSettings.punten,
            pouleDoc
          );

          // Opslaan in Firestore
          await saveMatchResultFields(m.id, {
            gemaakteX: gX,
            gemaakteY: gY,
            beurten: b,
            puntenX: pX,
            puntenY: pY,
            uitslag,
          });

          // Lokale cache ook bijwerken
          m.puntenX = pX;
          m.puntenY = pY;
          m.uitslag = uitslag;
        }

        // UI opnieuw opbouwen met de nieuwe punten
        renderR1Matches();
      }

      // =============================
      // R1 RESULTATEN ‚Äì knopstatussen
      // =============================
      // =============================
      // R1 RESULTATEN ‚Äì knopstatussen
      // =============================
      function updateR1ResultsButtons() {
        const createBtn = document.getElementById("createMatchesBtn");
        const deleteBtn = document.getElementById("deleteMatchesBtn");
        if (!createBtn || !deleteBtn) return;

        const hasTournament = !!activeTournamentId;

        // Wedstrijdschema bestaat zodra er r1Matches zijn
        const hasSchedule = Array.isArray(r1Matches) && r1Matches.length > 0;

        // Poule-indeling moet al opgeslagen/bestaan
        const hasPoules = !!r1PoulesExist;

        // Er is al minstens 1 uitslag opgeslagen als er een afgeronde match is
        const hasAnyResult =
          hasSchedule && r1Matches.some((m) => m && m.afgerond === true);

        // ‚úÖ NIEUW / FIX: R2 poules bestaan?
        const hasR2PoulesLocal =
          Array.isArray(r2CurrentPoules) && r2CurrentPoules.length > 0;

        // 1) Wedstrijdschema aanmaken:
        // actief als: geen schema + w√©l poules + toernooi actief
        createBtn.disabled = !hasTournament || hasSchedule || !hasPoules;

        // 2) Wedstrijden wissen:
        // actief als: schema bestaat + g√©√©n enkele uitslag
        deleteBtn.disabled = !hasTournament || !hasSchedule || hasAnyResult;

        // extra voorwaarde: als R2-poules bestaan ‚Üí nooit wissen
        if (hasR2PoulesLocal) {
          deleteBtn.disabled = true;
        }

        [createBtn, deleteBtn].forEach((btn) => {
          btn.style.opacity = btn.disabled ? "0.4" : "1";
          btn.style.cursor = btn.disabled ? "not-allowed" : "pointer";
        });
      }

      // =============================
      // R2 RESULTATEN ‚Äì knopstatussen
      // =============================
      function updateR2ResultsButtons() {
        const createBtn = document.getElementById("createR2MatchesBtn");
        const deleteBtn = document.getElementById("deleteR2MatchesBtn");
        if (!createBtn || !deleteBtn) return;

        const hasTournament = !!activeTournamentId;

        // Wedstrijdschema 2e ronde bestaat zodra er r2Matches zijn
        const hasR2Schedule = Array.isArray(r2Matches) && r2Matches.length > 0;

        // R2-poules moeten opgeslagen/bestaan (Firestore) ‚Üí r2PoulesCache is leidend
        const hasR2PoulesSaved =
          Array.isArray(r2PoulesCache) && r2PoulesCache.length > 0;

        // Er is al minstens 1 uitslag opgeslagen als er een afgeronde match is
        const hasAnyR2Result =
          hasR2Schedule && r2Matches.some((m) => m && m.afgerond === true);

        // 1) Wedstrijdschema aanmaken:
        // actief als: geen schema + w√©l poules + toernooi actief
        createBtn.disabled =
          !hasTournament || hasR2Schedule || !hasR2PoulesSaved;

        // 2) Wedstrijden wissen:
        // actief als: schema bestaat + g√©√©n enkele uitslag
        deleteBtn.disabled = !hasTournament || !hasR2Schedule || hasAnyR2Result;

        // Visuele indicatie (zelfde stijl als elders)
        [createBtn, deleteBtn].forEach((btn) => {
          btn.style.opacity = btn.disabled ? "0.4" : "1";
          btn.style.cursor = btn.disabled ? "not-allowed" : "pointer";
        });
      }

      // ====== Wedstrijden ophalen ======
      async function loadR1MatchesFromFirestore() {
        if (!activeTournamentId) {
          noTournamentR1ResNotice.style.display = "block";
          return;
        }
        noTournamentR1ResNotice.style.display = "none";

        const tournRef = doc(db, "toernooien", activeTournamentId);
        const tournSnap = await getDoc(tournRef);
        toernooiSettings = tournSnap.data() || {};
        renderScoringOverview();

        const matchesRef = collection(
          db,
          "toernooien",
          activeTournamentId,
          "r1_wedstrijden"
        );
        const snap = await getDocs(matchesRef);
        r1Matches = snap.docs.map((d) => ({ id: d.id, ...d.data() }));

        const poulesRef = collection(
          db,
          "toernooien",
          activeTournamentId,
          "poules_r1"
        );
        const poulesSnap = await getDocs(poulesRef);
        r1PoulesCache = poulesSnap.docs.map((d) => ({ id: d.id, ...d.data() }));

        renderR1Matches();

        updateR1ResultsButtons();
        updateR1PoulesButtons(); // zodat poules-tab ook meteen meeloopt
      }

      /* ----------------------------------------------------------
         1E RONDE RESULTATEN ‚Äì helper: thuis/uit sorteren
      ---------------------------------------------------------- */
      function sortHomeAway(arr) {
        const groups = new Map();
        arr.forEach((m) => {
          const key = [m.spelerX.id, m.spelerY.id].sort().join("_");
          if (!groups.has(key)) groups.set(key, []);
          groups.get(key).push(m);
        });
        const ordered = [];
        groups.forEach((matches) => {
          if (matches.length === 1) {
            ordered.push(matches[0]);
            return;
          }
          // consistente volgorde: A‚ÄìB v√≥√≥r B‚ÄìA (alfabetisch op naam)
          matches.sort((a, b) => {
            const ka = `${a.spelerX.naam}‚Äî${a.spelerY.naam}`.toLowerCase();
            const kb = `${b.spelerX.naam}‚Äî${b.spelerY.naam}`.toLowerCase();
            return ka.localeCompare(kb);
          });
          matches.forEach((m) => ordered.push(m));
        });
        return ordered;
      }

      // ====== Wedstrijden tonen ======
      /* ----------------------------------------------------------
         1E RONDE RESULTATEN ‚Äì render wedstrijden + nieuwe stand
      ---------------------------------------------------------- */
      function renderR1Matches() {
        r1matchesWrapper.innerHTML = "";
        if (!r1Matches.length) {
          r1matchesWrapper.innerHTML =
            "<p style='color:#777'>Geen wedstrijden gevonden.</p>";
          updateOverallProgress();
          r1GlobalStandTable.innerHTML = "";
          return;
        }
        updateOverallProgress();

        const pouleMap = {};
        r1Matches.forEach((m) => {
          if (!pouleMap[m.poule]) pouleMap[m.poule] = [];
          pouleMap[m.poule].push(m);
        });

        Object.keys(pouleMap)
          .sort()
          .forEach((pouleNaam) => {
            const matchesRaw = pouleMap[pouleNaam];
            const pouleDoc = r1PoulesCache.find((p) => p.id === pouleNaam);
            const pouleSize = pouleDoc?.spelers?.length || 4;
            const is5 = pouleSize === 5;
            const matches = sortHomeAway(matchesRaw);

            const played = matches.filter((m) => m.afgerond).length;
            const total = matches.length;
            const perc = total ? Math.round((played / total) * 100) : 0;

            const headerId = `phead_${pouleNaam}`;
            const bodyId = `pbody_${pouleNaam}`;

            // factor-info uit pouleDoc (indien aanwezig)
            const basePlayers = pouleDoc?.factorBasePlayers || 4;
            const factorEnabled = !!pouleDoc?.factorEnabled;
            const rawFactorValue =
              typeof pouleDoc?.factorValue === "number"
                ? pouleDoc.factorValue
                : null;

            let factorValue;
            if (factorEnabled && rawFactorValue != null) {
              factorValue = rawFactorValue;
            } else if (is5) {
              // oude 0,75-logica blijft default voor 5-spelers poules
              factorValue = 0.75;
            } else {
              factorValue = 1.0;
            }

            const factorText =
              factorValue !== 1
                ? `(punten √ó${factorValue.toFixed(2).replace(".", ",")})`
                : "";

            const factorNote = pouleDoc?.factorNote || "";
            const factorBadge =
              factorEnabled && factorValue !== 1
                ? `<span
                      class="poule-factor-indicator"
                      title="${
                        factorNote
                          ? "Toelichting: " + factorNote.replace(/"/g, "&quot;")
                          : "Afwijkende factor voor puntentelling in deze poule"
                      }"
                      style="margin-left:4px;font-size:0.75em;background:#fff3cd;color:#856404;border-radius:999px;padding:2px 6px;border:1px solid #ffe69c;"
                   >!</span>`
                : "";
            const wasOpen = pouleOpenState[pouleNaam] === true;

            let html = `
              <div class="poule-block" data-poule="${pouleNaam}">
                <div
                  id="${headerId}"
                  class="poule-header"
                  style="cursor:pointer;display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:#f8f9fa;border-radius:8px;border:1px solid #dee2e6;"
                >
                  <div style="display:flex;align-items:center;gap:6px;">
                    <strong>${pouleNaam}</strong>
                    ${
                      factorText
                        ? `<span style="font-size:0.85em;color:#b02a37;">${factorText}</span>`
                        : ""
                    }
                    ${factorBadge}
                    <button
                      type="button"
                      class="poule-factor-btn"
                      data-poule="${pouleNaam}"
                      title="Factor voor puntentelling instellen"
                      style="margin-left:4px;background:#ffc107;color:#212529;border:none;border-radius:50%;width:22px;height:22px;font-size:0.9em;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;"
                    >!</button>
                  </div>
                  <div style="font-size:0.85em;color:#555;">
                    Totaal gespeeld: ${played} / ${total} wedstrijden
                  </div>
                </div>
                <div id="${bodyId}" class="poule-body"
                   style="display:${wasOpen ? "block" : "none"};
                   padding:10px;border:1px solid #dee2e6;border-top:none;
                    border-radius:0 0 8px 8px;background:white;">

                <table style="width:100%;border-collapse:collapse;font-size:0.92em">
                  <thead style="background:#eef2f6">
                    <tr>
                      <th style="text-align:left;padding:6px 4px">Speler A</th>
                      <th style="text-align:right;padding:6px 4px">Te&nbsp;maken A</th>
                      <th style="text-align:left;padding:6px 4px">Speler B</th>
                      <th style="text-align:right;padding:6px 4px">Te&nbsp;maken B</th>
                      <th style="text-align:right;padding:6px 4px">Gemaakte A</th>
                      <th style="text-align:right;padding:6px 4px">Gemaakte B</th>
                      <th style="text-align:right;padding:6px 4px">Beurten</th>
                      <th style="text-align:center;padding:6px 4px">Uitslag</th>
                      <th style="text-align:center;padding:6px 4px">Acties</th>
                    </tr>
                  </thead>
                  <tbody>`;

            matches.forEach((m) => {
              const gX = m.gemaakteX ?? "";
              const gY = m.gemaakteY ?? "";
              const b = m.beurten ?? "";
              const uitslag =
                m.puntenX != null && m.puntenY != null
                  ? `${m.puntenX} - ${m.puntenY}`
                  : "";
              const rowBg = m.afgerond ? "background:#B3FF87" : "";

              html += `
              <tr data-matchid="${
                m.id
              }" style="border-bottom:1px solid #eee;${rowBg}">
                <td style="padding:6px 4px">${m.spelerX?.naam ?? ""}</td>
                <td style="padding:6px 4px;text-align:right">${
                  m.spelerX?.teMaken ?? ""
                }</td>
                <td style="padding:6px 4px">${m.spelerY?.naam ?? ""}</td>
                <td style="padding:6px 4px;text-align:right">${
                  m.spelerY?.teMaken ?? ""
                }</td>
                <td style="padding:6px 4px;text-align:right"><input type="number" value="${gX}" class="r1-input" data-field="gemaakteX" style="width:70px;text-align:right"></td>
                <td style="padding:6px 4px;text-align:right"><input type="number" value="${gY}" class="r1-input" data-field="gemaakteY" style="width:70px;text-align:right"></td>
                <td style="padding:6px 4px;text-align:right"><input type="number" value="${b}" class="r1-input" data-field="beurten"   style="width:70px;text-align:right"></td>
                <td style="padding:6px 4px;text-align:center;font-weight:600">${uitslag}</td>
                <td style="padding:6px 4px;text-align:center">
                  <button class="actie-btn save" data-action="save" title="Opslaan">üíæ</button>
                  <button class="actie-btn reset" data-action="reset" title="Uitslag verwijderen">üóëÔ∏è</button>
                </td>
              </tr>`;
            });

            html += `</tbody></table>`;

            // ----- Nieuwe poule-stand -----
            html += `<div style="margin-top:12px;border-top:1px dashed #ddd;padding-top:10px">${renderPouleStandHTML(
              pouleNaam,
              matches,
              pouleDoc
            )}</div>`;

            html += `</div></div>`;
            r1matchesWrapper.insertAdjacentHTML("beforeend", html);

            // factor-knop koppelen (niet het inklappen laten triggeren)
            const factorBtn = document.querySelector(
              `.poule-factor-btn[data-poule="${pouleNaam}"]`
            );
            if (factorBtn) {
              factorBtn.addEventListener("click", (e) => {
                e.stopPropagation(); // header-click niet uitvoeren
                configureR1PouleFactor(pouleNaam);
              });
            }

            // in/uitklappen
            const headerEl = document.getElementById(headerId);
            const bodyEl = document.getElementById(bodyId);
            headerEl.addEventListener("click", () => {
              const hidden = bodyEl.style.display === "none";
              bodyEl.style.display = hidden ? "block" : "none";
              headerEl.style.borderRadius = hidden ? "8px 8px 0 0" : "8px";
              pouleOpenState[pouleNaam] = hidden; // onthouden
            });
          });

        // globale stand
        const globalStats = buildGlobalRankingFromStats(
          r1Matches,
          r1PoulesCache
        );
        let gHtml = `
          <table style="width:100%;border-collapse:collapse;font-size:0.9em;margin-top:10px">
            <thead style="background:#f8f9fa">
              <tr>
                <th style="text-align:left;padding:4px;border-bottom:1px solid #ddd">#</th>
                <th style="text-align:left;padding:4px;border-bottom:1px solid #ddd">Speler</th>
                <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">Ptn</th>
                <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">Rang&nbsp;Ptn</th>
                <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">%Car</th>
                <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">Rang&nbsp;%Car</th>
                <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">Totaal&nbsp;Rang</th>
              </tr>
            </thead>
            <tbody>`;
        globalStats.forEach((row, idx) => {
          const percCarText = row.percCar.toFixed(1).replace(".", ",") + "%";
          const isTop8 = idx < 8;
          const bgColor = "";
          gHtml += `
            <tr style="border-bottom:1px solid #eee;${bgColor}">
              <td style="padding:4px">${idx + 1}</td>
              <td style="padding:4px">${row.naam}</td>
              <td style="padding:4px;text-align:right">${Number(
                row.puntenAdj ?? row.puntenTotaal
              )}</td>
              <td style="padding:4px;text-align:right;color:#f00">${row.rankPoints_punten.toFixed(
                1
              )}</td>
              <td style="padding:4px;text-align:right">${percCarText}</td>
              <td style="padding:4px;text-align:right;color:#f00">${row.rankPoints_percCar.toFixed(
                1
              )}</td>
              <td style="padding:4px;text-align:right;font-weight:600;color:#f00">${row.rankTotaal.toFixed(
                1
              )}</td>
            </tr>`;
        });
        gHtml += `</tbody></table>`;
        r1GlobalStandTable.innerHTML = gHtml;
      }

      // ----------------------------------------------------------
      // 1E RONDE RESULTATEN ‚Äì factor per poule instellen
      // ----------------------------------------------------------
      async function configureR1PouleFactor(pouleId) {
        if (!activeTournamentId) {
          alert("Er is geen actief toernooi geladen.");
          return;
        }

        const pouleDoc = r1PoulesCache.find((p) => p.id === pouleId);
        if (!pouleDoc) {
          alert("Poule niet gevonden.");
          return;
        }

        const huidigeActual = pouleDoc.factorActualPlayers || "";
        const huidigeNote = pouleDoc.factorNote || "";
        const basePlayers = pouleDoc.factorBasePlayers || 4;

        const input = prompt(
          `Werkelijk aantal spelers voor puntentelling in ${pouleId} (leeg = factor uitzetten):`,
          huidigeActual ? String(huidigeActual) : ""
        );
        if (input === null) return; // gebruiker annuleert

        const trimmed = input.trim();

        const pouleRef = doc(
          db,
          "toernooien",
          activeTournamentId,
          "poules_r1",
          pouleId
        );

        // Leeg = factor uitzetten, terug naar "normale" logica
        if (trimmed === "") {
          await updateDoc(pouleRef, {
            factorEnabled: false,
          });
          pouleDoc.factorEnabled = false;
          // UI en globale stand opnieuw laden
          await loadR1MatchesFromFirestore();
          return;
        }

        const actual = Number(trimmed);
        if (!Number.isFinite(actual) || actual < 2 || actual > 8) {
          alert("Voer een geldig aantal spelers in (minimaal 2, maximaal 8).");
          return;
        }

        const note = prompt(
          "Korte toelichting (wordt als mouse-over getoond, bijv. welke speler is uitgevallen):",
          huidigeNote
        );

        // Factor berekenen op basis van 'normaal' 4 spelers vs werkelijk aantal
        const refPlayers = basePlayers || 4; // standaard 4
        const matchesRef = (refPlayers - 1) * 2;
        const matchesActual = (actual - 1) * 2;
        const factor = matchesActual > 0 ? matchesRef / matchesActual : 1.0;

        const factorEnabled = Math.abs(factor - 1) > 0.0001;

        await updateDoc(pouleRef, {
          factorEnabled,
          factorBasePlayers: refPlayers,
          factorActualPlayers: actual,
          factorValue: factor,
          factorNote: note || "",
        });

        // lokale cache bijwerken zodat UI niet "achterloopt"
        pouleDoc.factorEnabled = factorEnabled;
        pouleDoc.factorBasePlayers = refPlayers;
        pouleDoc.factorActualPlayers = actual;
        pouleDoc.factorValue = factor;
        pouleDoc.factorNote = note || "";

        await recalcR1PouleMatches(pouleId);

        // alles opnieuw tekenen met nieuwe factor
        await loadR1MatchesFromFirestore();
      }

      // ====== Automatisch laden bij tab ======
      async function loadR1ResultsTabForActiveTournament() {
        if (!activeTournamentId) return;
        await loadR1MatchesFromFirestore();
      }

      // ====== Poules ophalen ======
      async function getR1Poules() {
        const poulesRef = collection(
          db,
          "toernooien",
          activeTournamentId,
          "poules_r1"
        );
        const snap = await getDocs(poulesRef);
        return snap.docs.map((d) => ({ id: d.id, ...d.data() }));
      }

      // ====== Wedstrijdschema aanmaken (alle poules) ======
      async function createR1MatchSchedule() {
        if (!activeTournamentId) {
          showPopupMessage("‚ö†Ô∏è Geen toernooi geselecteerd.", true);
          return;
        }
        console.log("Test getR1Poules:", typeof getR1Poules, getR1Poules);
        const poules = await getR1Poules();

        poules.forEach((p) => {
          console.log("Poule", p.id, "heeft veldnamen:", Object.keys(p));
          console.log("‚Üí spelers:", p.spelers);
        });

        if (!poules.length) {
          showPopupMessage(
            "‚ö†Ô∏è Geen poules gevonden. Maak eerst een poule-indeling.",
            true
          );
          return;
        }

        // Oude wedstrijden wissen voor alle poules
        const matchesRef = collection(
          db,
          "toernooien",
          activeTournamentId,
          "r1_wedstrijden"
        );
        const existingSnap = await getDocs(matchesRef);
        const batchDelete = writeBatch(db);
        let deleteCount = 0;
        existingSnap.forEach((d) => {
          batchDelete.delete(d.ref);
          deleteCount++;
        });

        if (deleteCount > 0) {
          const confirmOverwrite = confirm(
            `Er bestaan al ${deleteCount} wedstrijden.\n\nWil je deze overschrijven? Alle bestaande uitslagen gaan verloren.`
          );
          if (!confirmOverwrite) return;
          await batchDelete.commit();
        }

        // Nieuwe wedstrijden aanmaken
        const batch = writeBatch(db);
        let totalMatches = 0;

        poules.forEach((poule) => {
          const spelers = poule.spelers || [];
          for (let i = 0; i < spelers.length; i++) {
            for (let j = 0; j < spelers.length; j++) {
              if (i === j) continue;
              const safePouleId = poule.id.replace(/\s+/g, "_");
              const matchId = `${safePouleId}_${spelers[i].id}_${spelers[j].id}`;

              const matchRef = doc(
                db,
                "toernooien",
                activeTournamentId,
                "r1_wedstrijden",
                matchId
              );
              batch.set(matchRef, {
                poule: poule.id,
                spelerX: {
                  id: spelers[i].id,
                  naam: spelers[i].naam,
                  teMaken:
                    spelers[i].carambolesR1 || spelers[i].caramboles || 0,
                },
                spelerY: {
                  id: spelers[j].id,
                  naam: spelers[j].naam,
                  teMaken:
                    spelers[j].carambolesR1 || spelers[j].caramboles || 0,
                },
                gemaakteX: null,
                gemaakteY: null,
                beurten: null,
                puntenX: null,
                puntenY: null,
                afgerond: false,
                resultaat: null,
              });
              totalMatches++;
            }
          }
        });
        console.log("Aanmaken wedstrijden:", totalMatches);
        await batch.commit();
        console.log(
          "Batch commit voltooid ‚Äî wedstrijden zouden nu in Firestore moeten staan"
        );

        showPopupMessage(
          `‚úÖ Wedstrijdschema aangemaakt: ${totalMatches} wedstrijden.`,
          false
        );
        await loadR1MatchesFromFirestore();

        updateR1ResultsButtons();
        updateR1PoulesButtons();
      }

      // ====== Wedstrijden wissen ======
      async function deleteR1Matches() {
        if (!activeTournamentId) {
          showPopupMessage("‚ö†Ô∏è Geen toernooi geselecteerd.", true);
          return;
        }

        const confirmDelete = confirm(
          "Weet je zeker dat je ALLE wedstrijden van de 1e ronde wilt verwijderen?\n\n‚ö†Ô∏è Alle ingevoerde uitslagen gaan verloren!"
        );
        if (!confirmDelete) return;

        const matchesRef = collection(
          db,
          "toernooien",
          activeTournamentId,
          "r1_wedstrijden"
        );
        const snap = await getDocs(matchesRef);
        if (snap.empty) {
          showPopupMessage("Er zijn geen wedstrijden om te verwijderen.", true);
          return;
        }

        const batch = writeBatch(db);
        let count = 0;
        snap.forEach((d) => {
          batch.delete(d.ref);
          count++;
        });

        await batch.commit();
        showPopupMessage(`üóëÔ∏è ${count} wedstrijden verwijderd.`, false);
        await loadR1MatchesFromFirestore();

        updateR1ResultsButtons();
        updateR1PoulesButtons();
      }

      function renderPouleStandHTML(pouleNaam, matches, pouleDoc) {
        // spelers + te maken caramboles
        const spelers = (pouleDoc?.spelers || []).map((s) => ({
          id: s.id,
          naam: s.naam,
          teMaken: s.carambolesR2 ?? s.carambolesR1 ?? s.caramboles ?? 0,
        }));

        const stats = new Map();
        spelers.forEach((s) =>
          stats.set(s.id, {
            id: s.id,
            naam: s.naam,
            teMaken: s.teMaken,
            punten: 0,
            car: 0,
            beurten: 0,
            gespeeld: 0,
          })
        );

        // ruwe stats opbouwen
        matches.forEach((m) => {
          if (!m.spelerX || !m.spelerY) return;
          if (m.gemaakteX != null) {
            const s = stats.get(m.spelerX.id);
            s.car += Number(m.gemaakteX) || 0;
            s.beurten += Number(m.beurten) || 0;
            if (m.puntenX != null) s.punten += Number(m.puntenX) || 0;
            if (m.afgerond) s.gespeeld += 1;
          }
          if (m.gemaakteY != null) {
            const s = stats.get(m.spelerY.id);
            s.car += Number(m.gemaakteY) || 0;
            s.beurten += Number(m.beurten) || 0;
            if (m.puntenY != null) s.punten += Number(m.puntenY) || 0;
            if (m.afgerond) s.gespeeld += 1;
          }
        });

        // ‚ö†Ô∏è Geen factor meer toepassen in de stand: punten zijn al inclusief factor
        const factor = 1;

        // moy, %car en aangepaste punten
        const rows = Array.from(stats.values()).map((s) => {
          const moy = s.beurten > 0 ? s.car / s.beurten : 0;
          const totTeMaken = s.teMaken * (s.gespeeld || 0);
          const percCar = totTeMaken > 0 ? (s.car / totTeMaken) * 100 : 0;
          const puntenAdj = s.punten || 0;
          return { ...s, moy, percCar, puntenAdj };
        });

        // sortering: aangepaste punten ‚Üì, gespeeld ‚Üë, %car ‚Üì, moy ‚Üì, naam ‚Üë
        rows.sort((a, b) => {
          if (b.puntenAdj !== a.puntenAdj) return b.puntenAdj - a.puntenAdj;
          if (a.gespeeld !== b.gespeeld) return a.gespeeld - b.gespeeld;
          if (b.percCar !== a.percCar) return b.percCar - a.percCar;
          if (b.moy !== a.moy) return b.moy - a.moy;
          return a.naam.localeCompare(b.naam);
        });

        let html = `
          <div style="font-weight:600;margin-bottom:6px">Stand ${pouleNaam}</div>
          <table style="width:100%;border-collapse:collapse;font-size:0.9em">
            <thead style="background:#f8f9fa">
              <tr>
                <th style="text-align:left;padding:4px;border-bottom:1px solid #ddd">Speler</th>
                <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">Te maken</th>
                <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">Gespeeld</th>
                <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">Punten</th>
                <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">Gemaakt</th>
                <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">Beurten</th>
                <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">Moy</th>
                <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">%Car</th>
              </tr>
            </thead>
            <tbody>`;

        rows.forEach((r) => {
          const perc = r.percCar.toFixed(1).replace(".", ",") + "%";
          const moy = r.moy.toFixed(3).replace(".", ",");
          const puntenText = (
            r.puntenAdj % 1 === 0 ? r.puntenAdj : r.puntenAdj.toFixed(1)
          )
            .toString()
            .replace(".", ",");

          html += `
            <tr style="border-bottom:1px solid #eee">
              <td style="padding:4px">${r.naam}</td>
              <td style="padding:4px;text-align:right">${r.teMaken}</td>
              <td style="padding:4px;text-align:right">${r.gespeeld}</td>
              <td style="padding:4px;text-align:right">${puntenText}</td>
              <td style="padding:4px;text-align:right">${r.car}</td>
              <td style="padding:4px;text-align:right">${r.beurten}</td>
              <td style="padding:4px;text-align:right">${moy}</td>
              <td style="padding:4px;text-align:right">${perc}</td>
            </tr>`;
        });

        html += `</tbody></table>`;
        return html;
      }

      /* ----------------------------------------------------------
         1E RONDE RESULTATEN ‚Äì event-listeners voor actie-knoppen
      ---------------------------------------------------------- */
      r1matchesWrapper.addEventListener("click", async (e) => {
        const btn = e.target.closest(".actie-btn");
        if (!btn) return;
        e.stopPropagation(); // voorkom conflict met rij-klik
        const tr = btn.closest("tr");
        const id = tr.dataset.matchid;
        const action = btn.dataset.action;

        if (action === "save") {
          const inputs = tr.querySelectorAll(".r1-input");
          const values = {};
          inputs.forEach((i) => (values[i.dataset.field] = Number(i.value)));

          const m = r1Matches.find((x) => x.id === id);
          const err = validateR1Inputs(
            values.gemaakteX,
            values.gemaakteY,
            values.beurten,
            toernooiSettings.maxBeurten || 0,
            m.spelerX.teMaken,
            m.spelerY.teMaken
          );
          if (err) {
            showPopupMessage(err, true);
            return;
          }

          const pouleDoc = r1PoulesCache.find((p) => p.id === m.poule);
          const { pX, pY, uitslag } = calcR1Points(
            values.gemaakteX,
            values.gemaakteY,
            values.beurten,
            toernooiSettings.maxBeurten || 0,
            m.spelerX.teMaken,
            m.spelerY.teMaken,
            toernooiSettings.punten,
            pouleDoc
          );

          await saveMatchResultFields(id, {
            gemaakteX: values.gemaakteX,
            gemaakteY: values.gemaakteY,
            beurten: values.beurten,
            puntenX: pX,
            puntenY: pY,
            resultaat: uitslag,
            afgerond: true,
          });
        } else if (action === "reset") {
          await resetMatchResult(id);
        }
      });

      /* ----------------------------------------------------------
         1E RONDE RESULTATEN ‚Äì ontbrekende helpers
      ---------------------------------------------------------- */
      function validateR1Inputs(gX, gY, b, maxB, tX, tY) {
        maxB = Number(maxB) || 0;
        if ([gX, gY, b].some((v) => Number.isNaN(v)))
          return "‚ùå Vul overal een geldig getal in.";
        if (gX < 0 || gY < 0)
          return "‚ùå Gemaakte caramboles mogen niet negatief zijn.";
        if (b <= 0) return "‚ùå Aantal beurten moet groter zijn dan 0.";

        if (gX > tX || gY > tY)
          return "‚ùå Het aantal gemaakte caramboles mag niet hoger zijn dan het aantal te maken.";
        if (maxB && b > maxB)
          return `‚ö†Ô∏è Het aantal beurten mag niet hoger zijn dan het maximale aantal beurten (${maxB}).`;
        if (!maxB || b < maxB) {
          const xKlaar = gX >= tX;
          const yKlaar = gY >= tY;
          if (!xKlaar && !yKlaar)
            return "‚ö†Ô∏è Minstens √©√©n speler moet zijn partij hebben uitgemaakt.";
        }
        return null;
      }

      function calcR1FactorForPoule(pouleDoc) {
        if (!pouleDoc) return 1;

        // Als jij later factorEnabled/factorValue in de poule-doc opslaat:
        if (
          pouleDoc.factorEnabled &&
          typeof pouleDoc.factorValue === "number"
        ) {
          return pouleDoc.factorValue;
        }

        // Default: 5-spelers-poule ‚Üí 0,75, anders 1,0
        const size = (pouleDoc.spelers || []).length || 4;
        if (size === 5) return 0.75;
        return 1;
      }

      function calcR1Points(
        gX,
        gY,
        b,
        maxB,
        tX,
        tY,
        pCfg = {},
        pouleDoc = null
      ) {
        maxB = Number(maxB) || 0;

        const factor = calcR1FactorForPoule(pouleDoc);
        const punten = {
          winLess: (pCfg.winLess ?? 2) * factor,
          drawLess: (pCfg.drawLess ?? 1) * factor,
          loseLess: (pCfg.loseLess ?? 0) * factor,
          winMax: (pCfg.winMax ?? 2) * factor,
          drawMax: (pCfg.drawMax ?? 1) * factor,
          loseMax: (pCfg.loseMax ?? 0) * factor,
        };

        let pX = 0,
          pY = 0,
          uitslag = "";

        if (!maxB || b < maxB) {
          const xKlaar = gX >= tX;
          const yKlaar = gY >= tY;
          if (xKlaar && !yKlaar) {
            pX = punten.winLess;
            pY = punten.loseLess;
            uitslag = "1 - 0";
          } else if (!xKlaar && yKlaar) {
            pX = punten.loseLess;
            pY = punten.winLess;
            uitslag = "0 - 1";
          } else if (xKlaar && yKlaar) {
            pX = pY = punten.drawLess;
            uitslag = "¬Ω - ¬Ω";
          }
        } else if (maxB && b === maxB) {
          const percX = (gX / tX) * 100;
          const percY = (gY / tY) * 100;
          if (percX > percY) {
            pX = punten.winMax;
            pY = punten.loseMax;
            uitslag = "1 - 0";
          } else if (percY > percX) {
            pX = punten.loseMax;
            pY = punten.winMax;
            uitslag = "0 - 1";
          } else {
            pX = pY = punten.drawMax;
            uitslag = "¬Ω - ¬Ω";
          }
        }
        return { pX, pY, uitslag };
      }

      async function saveMatchResultFields(matchId, update) {
        const ref = doc(
          db,
          "toernooien",
          activeTournamentId,
          "r1_wedstrijden",
          matchId
        );
        await updateDoc(ref, update);
        showPopupMessage("‚úÖ Wedstrijd opgeslagen", false);
        await loadR1MatchesFromFirestore();
      }

      async function resetMatchResult(matchId) {
        const ok = confirm(
          "Alleen de ingevoerde resultaten van deze wedstrijd verwijderen?"
        );
        if (!ok) return;
        const ref = doc(
          db,
          "toernooien",
          activeTournamentId,
          "r1_wedstrijden",
          matchId
        );
        await updateDoc(ref, {
          gemaakteX: null,
          gemaakteY: null,
          beurten: null,
          puntenX: null,
          puntenY: null,
          afgerond: false,
          resultaat: null,
        });
        showPopupMessage("üóëÔ∏è Uitslag verwijderd", false);
        await loadR1MatchesFromFirestore();
      }
      /* ===== EINDE FUNCTIES TAB 1E RONDE RESULTATEN ===== */

      /* =========================================================
         2E RONDE POULES ‚Äì GLOBALE VARIABELEN
      ========================================================= */
      let r2CurrentPoules = []; // [{naam, maxSpelers:4, spelers:[]}, ...]
      let r2SelectedPlayer = null; // spelerobject
      let r2AllPlayers = []; // globale ranglijst 1e ronde
      let r2AvailablePlayers = []; // nog niet ingedeeld

      /* =========================================================
         2E RONDE POULES ‚Äì UI HELPERS
      ========================================================= */
      function showR2PoulesFeedback(msg, type = "info") {
        const fb = document.getElementById("r2poulesFeedback");
        const color =
          type === "error"
            ? "#f8d7da"
            : type === "success"
            ? "#d1e7dd"
            : "#e2e3e5";
        const textColor =
          type === "error"
            ? "#842029"
            : type === "success"
            ? "#0f5132"
            : "#41464b";
        fb.innerHTML = `<div style="padding:6px 10px;border-radius:6px;background:${color};color:${textColor};border:1px solid ${
          type === "error"
            ? "#f5c2c7"
            : type === "success"
            ? "#badbcc"
            : "#d3d6d8"
        }">${msg}</div>`;
      }

      /* =========================================================
         2E RONDE POULES ‚Äì RANGLIJST LADEN
      ========================================================= */
      /* =========================================================
         2E RONDE POULES ‚Äì RANGLIJST LADEN
      ========================================================= */
      async function loadR2GlobalRanking() {
        if (!activeTournamentId) return;

        // 1. Bouw globale ranglijst op basis van 1e ronde-wedstrijden
        const globalStats = buildGlobalRankingFromStats(
          r1Matches,
          r1PoulesCache
        );

        // 2. Sorteer op totaalrang (laagste = beste)
        const sortedStats = [...globalStats].sort(
          (a, b) => a.rankTotaal - b.rankTotaal
        );

        // 3. Combineer met spelersgegevens (caramboles 1e & 2e ronde)
        r2AllPlayers = sortedStats.map((p, idx) => {
          // bijbehorend speler-document uit de spelers-collection (voor carambolesR2)
          const spelerDoc = Array.isArray(currentPlayers)
            ? currentPlayers.find((sp) => sp.id === p.spelerId) || {}
            : {};

          // te maken caramboles in de 1e ronde
          const caramboles1e = p.teMaken ?? spelerDoc.caramboles ?? 0;

          // eventueel eerder ingevulde caramboles voor de 2e ronde
          const caramboles2e =
            spelerDoc.carambolesR2 != null ? spelerDoc.carambolesR2 : undefined;

          return {
            id: p.spelerId,
            naam: p.naam,
            punten: p.puntenTotaal,
            percCar: p.percCar,
            rankPunten: p.rankPoints_punten,
            rankPercCar: p.rankPoints_percCar,
            rankTotaal: p.rankTotaal,
            // vaste rangnummer uit de 1e ronde (blijft altijd gekoppeld aan deze speler)
            startRank: idx + 1,
            // caramboles voor de UI
            caramboles: caramboles1e,
            carambolesR2: caramboles2e,
          };
        });

        // 4. lijst met beschikbare spelers initialiseren
        r2AvailablePlayers = [...r2AllPlayers];

        // 5. tabel links renderen
        renderR2AvailablePlayers();
        updateR2PoulesButtons();
      }

      /* ----------------------------------------------------------
         2E RONDE POULES ‚Äì RANGLIJST ALS TABEL (vervangt vorige renderR2AvailablePlayers)
      ---------------------------------------------------------- */
      function renderR2AvailablePlayers() {
        const tbody = document.getElementById("r2RankTableBody");
        tbody.innerHTML = "";

        if (!r2AvailablePlayers.length) {
          tbody.innerHTML =
            '<tr><td colspan="4" style="color:#777;padding:6px">Geen vrije spelers meer.</td></tr>';
          return;
        }

        // Altijd sorteren op vaste startRank uit de 1e ronde
        const sorted = [...r2AvailablePlayers].sort(
          (a, b) => (a.startRank || 9999) - (b.startRank || 9999)
        );

        sorted.forEach((p) => {
          const tr = document.createElement("tr");
          tr.dataset.id = p.id;
          tr.style.cursor = "pointer";

          tr.innerHTML = `
            <td style="padding:6px 4px">${p.startRank ?? ""}</td>
            <td style="padding:6px 4px">${p.naam}</td>
            <td style="padding:6px 4px;text-align:right">${
              p.caramboles ?? 0
            }</td>
            <td style="padding:6px 4px;text-align:right">
              <input
                type="number"
                class="carambolesR2-input small"
                value="${p.carambolesR2 ?? p.caramboles ?? 0}"
                min="0"
                max="999"
                style="width:60px;text-align:right"
              >
            </td>`;

          // Klik op de rij = speler selecteren (behalve in het inputveld zelf)
          tr.addEventListener("click", (e) => {
            if (e.target.tagName !== "INPUT") {
              selectR2Player(p.id, tr);
            }
          });

          tbody.appendChild(tr);
        });
        updateR2PoulesButtons();
      }

      /* ----------------------------------------------------------
         2E RONDE POULES ‚Äì SPELER SELECTEREN
      ---------------------------------------------------------- */
      function selectR2Player(id, rowEl) {
        // alle rijen eerst "resetten"
        document
          .querySelectorAll("#r2RankTableBody tr")
          .forEach((el) => (el.style.background = "white"));

        const player = r2AvailablePlayers.find((p) => p.id === id);
        if (!player) return;

        r2SelectedPlayer = player;

        // highlight de geselecteerde rij
        if (rowEl) {
          rowEl.style.background = "#cce5ff";
        }

        showR2PoulesFeedback(`üéØ Geselecteerd: ${player.naam}`, "info");
      }

      /* =========================================================
         2E RONDE POULES ‚Äì POULES AANMAKEN
      ========================================================= */
      async function createR2Poules() {
        if (!activeTournamentId) {
          showR2PoulesFeedback("‚ö†Ô∏è Geen toernooi actief.", "error");
          return;
        }
        await loadR2GlobalRanking();
        if (r2AllPlayers.length === 0) {
          showR2PoulesFeedback("‚ö†Ô∏è Geen ranglijst 1e ronde gevonden.", "error");
          return;
        }
        const aantal = prompt(
          "Hoeveel poules moeten er worden aangemaakt?",
          "4"
        );
        const n = parseInt(aantal);
        if (!n || n < 1) {
          showR2PoulesFeedback("‚ùå Ongeldig aantal.", "error");
          return;
        }
        r2CurrentPoules = [];
        for (let i = 0; i < n; i++) {
          r2CurrentPoules.push({
            naam: `Poule ${String.fromCharCode(65 + i)}`,
            maxSpelers: 4,
            spelers: [],
          });
        }
        r2SelectedPlayer = null;
        renderR2Poules();
        renderR2AvailablePlayers();
        showR2PoulesFeedback(`‚úÖ ${n} poules aangemaakt.`, "success");
        updateR2PoulesButtons();
      }

      /* =========================================================
         2E RONDE POULES ‚Äì POULES RENDEREN
      ========================================================= */
      function renderR2Poules() {
        const container = document.getElementById("r2PoulesContainer");
        container.innerHTML = "";

        r2CurrentPoules.forEach((poule) => {
          const isFull = poule.spelers.length >= poule.maxSpelers;

          const card = document.createElement("div");
          card.className = "poule-card";
          card.style.cssText = `border:3px solid ${
            isFull ? "#198754" : "#ccc"
          };border-radius:8px;padding:8px;background:#fff;min-height:120px;cursor:pointer;`;

          // HTML voor de poulekaart inclusief delete-knoppen met data-player-id
          card.innerHTML = `
            <h5>
              ${poule.naam}
              <span style="font-weight:normal;font-size:0.9em;color:#555;">
                (${poule.spelers.length}/${poule.maxSpelers})
              </span>
            </h5>
            <ul style="margin-top:5px;padding-left:15px">
              ${poule.spelers
                .map(
                  (sp) => `
                <li style="display:flex;justify-content:space-between;margin-bottom:2px">
                  <span>${sp.naam} (${sp.carambolesR2})</span>
                  <button
                    type="button"
                    data-player-id="${sp.id}"
                    style="background:#dc3545;color:white;border:none;border-radius:4px;cursor:pointer;padding:2px 5px;font-size:0.8rem"
                    title="Verwijder speler uit poule"
                  >
                    üóëÔ∏è
                  </button>
                </li>`
                )
                .join("")}
            </ul>
          `;

          // Verwijder-knoppen binnen deze kaart aankoppelen
          const delButtons = card.querySelectorAll("button[data-player-id]");
          delButtons.forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation(); // voorkom dat de kaart-click ook triggert
              const spelerId = btn.dataset.playerId;
              removeR2PlayerFromPoule(poule.naam, spelerId);
            });
          });

          // Klik op de kaart zelf = geselecteerde speler toevoegen aan deze poule
          card.addEventListener("click", () =>
            addSelectedR2PlayerToPoule(poule.naam)
          );

          container.appendChild(card);
        });
        updateR2PoulesButtons();
      }

      /* =========================================================
         2E RONDE POULES ‚Äì SPELER VERWIJDEREN UIT POULE
      ========================================================= */
      function removeR2PlayerFromPoule(pouleNaam, spelerId) {
        const poule = r2CurrentPoules.find((p) => p.naam === pouleNaam);
        if (!poule) return;

        const idx = poule.spelers.findIndex((sp) => sp.id === spelerId);
        if (idx === -1) return;

        // speler die we terugzetten
        const [removedPlayer] = poule.spelers.splice(idx, 1);

        // alleen deze speler terug naar r2AvailablePlayers
        const alreadyFree = r2AvailablePlayers.find(
          (p) => p.id === removedPlayer.id
        );
        if (!alreadyFree) {
          r2AvailablePlayers.push(removedPlayer);
        }

        // als deze speler toevallig geselecteerd was, selectie verwijderen
        if (r2SelectedPlayer && r2SelectedPlayer.id === removedPlayer.id) {
          r2SelectedPlayer = null;
        }

        // UI opnieuw tekenen
        renderR2Poules();
        renderR2AvailablePlayers();
        showR2PoulesFeedback(
          "‚ôªÔ∏è Speler is uit de poule gehaald en staat weer bij de beschikbare spelers.",
          "success"
        );
        updateR2PoulesButtons();
      }

      /* =========================================================
         2E RONDE POULES ‚Äì SPELER TOEVOEGEN AAN POULE
      ========================================================= */
      function addSelectedR2PlayerToPoule(pouleNaam) {
        if (!r2SelectedPlayer) {
          showR2PoulesFeedback("‚ö†Ô∏è Selecteer eerst een speler links.", "error");
          return;
        }
        const poule = r2CurrentPoules.find((p) => p.naam === pouleNaam);
        if (!poule) return;
        if (poule.spelers.length >= poule.maxSpelers) {
          showR2PoulesFeedback("‚ùå Deze poule zit vol.", "error");
          return;
        }
        const alreadyInSomePoule = r2CurrentPoules.some((p) =>
          p.spelers.find((sp) => sp.id === r2SelectedPlayer.id)
        );
        if (alreadyInSomePoule) {
          showR2PoulesFeedback("‚ö†Ô∏è Deze speler zit al in een poule.", "error");
          return;
        }
        poule.spelers.push(r2SelectedPlayer);
        r2AvailablePlayers = r2AvailablePlayers.filter(
          (p) => p.id !== r2SelectedPlayer.id
        );
        r2SelectedPlayer = null;
        renderR2Poules();
        renderR2AvailablePlayers();
        showR2PoulesFeedback("‚úÖ Speler toegevoegd aan poule.", "success");
        updateR2PoulesButtons();
      }

      /* =========================================================
         2E RONDE POULES ‚Äì OPSLAAN IN FIRESTORE
      ========================================================= */

      async function saveCarambolesR2(spelerId, nieuweWaarde) {
        if (!activeTournamentId) return;

        const spelerRef = doc(
          db,
          "toernooien",
          activeTournamentId,
          "spelers",
          spelerId
        );

        // 1. Schrijf naar Firestore
        await updateDoc(spelerRef, { carambolesR2: nieuweWaarde });

        // 2. Update lokale caches in dit tabblad
        const p = r2AllPlayers.find((x) => x.id === spelerId);
        if (p) p.carambolesR2 = nieuweWaarde;

        const q = r2AvailablePlayers.find((x) => x.id === spelerId);
        if (q) q.carambolesR2 = nieuweWaarde;

        // 3. Heel belangrijk: ook de globale spelerslijst bijwerken
        if (
          typeof currentPlayers !== "undefined" &&
          Array.isArray(currentPlayers)
        ) {
          const cp = currentPlayers.find((x) => x.id === spelerId);
          if (cp) {
            cp.carambolesR2 = nieuweWaarde;
          }
        }
        updateR2PoulesButtons();
      }

      async function saveR2PoulesToFirestore() {
        if (!activeTournamentId) {
          showR2PoulesFeedback("‚ö†Ô∏è Geen toernooi actief.", "error");
          return;
        }
        if (r2CurrentPoules.length === 0) {
          showR2PoulesFeedback("‚ö†Ô∏è Geen poules om op te slaan.", "error");
          return;
        }
        const poulesRef = collection(
          db,
          "toernooien",
          activeTournamentId,
          "poules_r2"
        );
        const existing = await getDocs(poulesRef);
        for (const d of existing.docs) await deleteDoc(d.ref);
        for (const p of r2CurrentPoules) {
          await setDoc(doc(poulesRef, p.naam), {
            naam: p.naam,
            maxSpelers: p.maxSpelers,
            spelers: p.spelers,
          });
        }
        showR2PoulesFeedback("üíæ 2e ronde poules opgeslagen.", "success");
        updateR2PoulesButtons();
      }

      /* =========================================================
         2E RONDE POULES ‚Äì ALLES WISSEN
      ========================================================= */
      async function clearR2Poules() {
        if (!confirm("Weet je zeker dat je alle 2e ronde poules wilt wissen?"))
          return;
        r2CurrentPoules = [];
        r2SelectedPlayer = null;
        renderR2Poules();
        await loadR2GlobalRanking(); // herset beschikbare spelers
        if (activeTournamentId) {
          const poulesRef = collection(
            db,
            "toernooien",
            activeTournamentId,
            "poules_r2"
          );
          const existing = await getDocs(poulesRef);
          for (const d of existing.docs) await deleteDoc(d.ref);
        }
        showR2PoulesFeedback("üóëÔ∏è Alle 2e ronde poules gewist.", "success");
        updateR2PoulesButtons();
      }

      async function resetAllCarambolesR2() {
        if (!activeTournamentId) return;

        const ok = confirm(
          "Weet je zeker dat je alle 2e ronde caramboles wilt resetten naar de waarden uit de 1e ronde?"
        );
        if (!ok) return;

        // Voor iedere speler: 2e ronde gelijk maken aan caramboles (1e ronde)
        for (const speler of r2AllPlayers) {
          const nieuweWaarde = speler.caramboles ?? 0;
          await saveCarambolesR2(speler.id, nieuweWaarde);
        }

        // Tabel opnieuw tekenen met de nieuwe waarden
        renderR2AvailablePlayers();

        showR2PoulesFeedback(
          "üîÅ Alle 2e ronde caramboles zijn gereset naar de 1e ronde.",
          "success"
        );
        updateR2PoulesButtons();
      }

      async function saveAllCarambolesR2FromTable() {
        if (!activeTournamentId) return;

        const ok = confirm(
          "Wil je alle huidige waarden voor 2e ronde caramboles opslaan?"
        );
        if (!ok) return;

        // Loop over alle spelers in de ranglijst
        for (const speler of r2AllPlayers) {
          const waarde = speler.carambolesR2 ?? speler.caramboles ?? 0;
          await saveCarambolesR2(speler.id, waarde);
        }

        showR2PoulesFeedback(
          "üíæ Alle 2e ronde caramboles zijn opgeslagen.",
          "success"
        );
        updateR2PoulesButtons();
      }

      /* =========================================================
         2E RONDE POULES ‚Äì EVENT LISTENERS
      ========================================================= */
      document
        .getElementById("createR2PoulesBtn")
        .addEventListener("click", createR2Poules);
      document
        .getElementById("saveR2PoulesBtn")
        .addEventListener("click", saveR2PoulesToFirestore);
      document
        .getElementById("clearR2PoulesBtn")
        .addEventListener("click", clearR2Poules);
      document
        .getElementById("saveCarambolesR2Btn")
        .addEventListener("click", saveAllCarambolesR2FromTable);

      document
        .getElementById("resetCarambolesR2Btn")
        .addEventListener("click", resetAllCarambolesR2);

      // Opslaan van carambolesR2 bij wijziging in de tabel
      document
        .getElementById("r2RankTableBody")
        .addEventListener("change", async (e) => {
          if (!e.target.classList.contains("carambolesR2-input")) return;

          const row = e.target.closest("tr");
          if (!row) return;

          const spelerId = row.dataset.id;
          const nieuweWaarde = Number(e.target.value);
          await saveCarambolesR2(spelerId, nieuweWaarde);
          showR2PoulesFeedback("‚úÖ Aangepast", "success");
        });

      // Direct opslaan bij Enter-toets in de input
      document
        .getElementById("r2RankTableBody")
        .addEventListener("keydown", async (e) => {
          if (
            e.key === "Enter" &&
            e.target.classList.contains("carambolesR2-input")
          ) {
            e.preventDefault(); // voorkom submit/blur gedrag buiten onze controle
            e.target.blur(); // triggert het change-event hierboven
          }
        });

      // =============================================
      // 2E RONDE POULES ‚Äì knopstatussen
      // =============================================
      function updateR2PoulesButtons() {
        const createBtn = document.getElementById("createR2PoulesBtn");
        const saveBtn = document.getElementById("saveR2PoulesBtn");
        const clearBtn = document.getElementById("clearR2PoulesBtn");
        const resetCarBtn = document.getElementById("resetCarambolesR2Btn");
        const saveCarBtn = document.getElementById("saveCarambolesR2Btn");

        if (!createBtn || !saveBtn || !clearBtn || !resetCarBtn || !saveCarBtn)
          return;

        const hasTournament = !!activeTournamentId;

        // Poule-inhoud bestaat zodra r2CurrentPoules gevuld is
        const hasR2Poules =
          Array.isArray(r2CurrentPoules) && r2CurrentPoules.length > 0;

        // Wedstrijdschema 2e ronde bestaat zodra r2Matches bestaan
        const hasR2Schedule = Array.isArray(r2Matches) && r2Matches.length > 0;

        // Caramboles 2e ronde opgeslagen?
        // (we leiden dit af uit r2AllPlayers: iedereen heeft carambolesR2)
        const carambolesSaved =
          Array.isArray(r2AllPlayers) &&
          r2AllPlayers.length > 0 &&
          r2AllPlayers.every((p) => p.carambolesR2 != null);

        // Alle poules gevuld?
        let allFilled = false;
        if (hasR2Poules) {
          allFilled = r2CurrentPoules.every(
            (p) => Array.isArray(p.spelers) && p.spelers.length === p.maxSpelers
          );
        }

        // === Knopstatussen volgen jouw regels ===

        // 1) Poules aanmaken
        // actief als: g√©√©n poules + caramboles opgeslagen + g√©√©n wedstrijdschema
        createBtn.disabled =
          !hasTournament || hasR2Poules || !carambolesSaved || hasR2Schedule;

        // 2) Indeling opslaan
        // actief als: poules bestaan + alle poules gevuld + g√©√©n schema
        saveBtn.disabled =
          !hasTournament || !hasR2Poules || !allFilled || hasR2Schedule;

        // 3) Alles wissen
        // actief als: poules bestaan + g√©√©n schema
        clearBtn.disabled = !hasTournament || !hasR2Poules || hasR2Schedule;

        // 4) Reset caramboles
        // actief als: g√©√©n poules
        resetCarBtn.disabled = !hasTournament || hasR2Poules;

        // 5) Opslaan car. 2e ronde
        // actief als: caramboles nog NIET zijn opgeslagen
        saveCarBtn.disabled = !hasTournament || carambolesSaved;

        // 6) Delete-knoppen achter spelers in poules deactiveren als schema bestaat
        document
          .querySelectorAll("#r2PoulesContainer button[data-player-id]")
          .forEach((btn) => {
            btn.disabled = hasR2Schedule;
            btn.style.opacity = btn.disabled ? "0.4" : "1";
            btn.style.cursor = btn.disabled ? "not-allowed" : "pointer";
          });

        // Visuele indicatie
        [createBtn, saveBtn, clearBtn, resetCarBtn, saveCarBtn].forEach(
          (btn) => {
            btn.style.opacity = btn.disabled ? "0.4" : "1";
            btn.style.cursor = btn.disabled ? "not-allowed" : "pointer";
          }
        );
      }

      /* =========================================================
         2E RONDE POULES ‚Äì START BIJ TAB-OPENING
      ========================================================= */
      async function loadR2PoulesForActiveTournament() {
        if (!activeTournamentId) return;

        // 1) Altijd eerst ranglijst (her)bouwen
        await loadR2GlobalRanking();

        // 2) Probeer poules uit Firestore te halen
        const poulesRef = collection(
          db,
          "toernooien",
          activeTournamentId,
          "poules_r2"
        );
        const snap = await getDocs(poulesRef);

        if (!snap.empty) {
          // Firestore is leidend als er al opgeslagen poules zijn
          r2CurrentPoules = snap.docs.map((d) => d.data());
        }
        // else: Firestore leeg ‚Üí houd lokale r2CurrentPoules zoals ze zijn

        // 3) Ongeacht bron: haal alle spelers die al in een poule zitten uit available
        const idsInPoules = new Set(
          (r2CurrentPoules || []).flatMap((p) =>
            (p.spelers || []).map((sp) => sp.id)
          )
        );

        r2AvailablePlayers = r2AllPlayers.filter((p) => !idsInPoules.has(p.id));

        // 4) UI altijd opnieuw tekenen
        renderR2Poules();
        renderR2AvailablePlayers();
        updateR2PoulesButtons();
      }

      /* =========================================================
         2E RONDE POULES ‚Äì AUTO-LADEN BIJ TAB-KLIK
      ========================================================= */
      document
        .querySelector('button[data-tab="r2poules"]')
        .addEventListener("click", () => {
          loadR2PoulesForActiveTournament();

          updateR2PoulesButtons();
        });

      /* =========================================================
         2E RONDE RESULTATEN ‚Äì GLOBALE VARIABELEN
      ========================================================= */
      let r2Matches = [];
      let r2ToernooiSettings = {};
      let r2PoulesCache = [];

      /* =========================================================
         2E RONDE RESULTATEN ‚Äì UI HELPERS
      ========================================================= */
      function showR2PopupMessage(msg, isError = true) {
        const existing = document.getElementById("r2PopupMsg");
        if (existing) existing.remove();
        const popup = document.createElement("div");
        popup.id = "r2PopupMsg";
        popup.style.cssText = `
          position:fixed;top:20%;left:50%;transform:translateX(-50%);
          background:${isError ? "#f8d7da" : "#d1e7dd"};
          color:${isError ? "#842029" : "#0f5132"};
          border:1px solid ${isError ? "#f5c2c7" : "#badbcc"};
          border-radius:8px;padding:20px 25px;z-index:2000;
          box-shadow:0 4px 12px rgba(0,0,0,0.3);text-align:center;min-width:280px`;
        popup.innerHTML = `
          <div>${msg}</div>
          <button style="margin-top:12px;background:#fff;border:1px solid #ccc;
            border-radius:4px;padding:5px 15px;cursor:pointer;">OK</button>`;
        popup.querySelector("button").onclick = () => popup.remove();
        document.body.appendChild(popup);
      }

      function renderR2ScoringOverview() {
        const el = document.getElementById("r2ScoringOverview");
        if (!r2ToernooiSettings || !r2ToernooiSettings.punten) {
          el.style.display = "none";
          return;
        }
        const p = r2ToernooiSettings.punten;
        const maxB = r2ToernooiSettings.maxBeurten;
        const maxText = maxB ? maxB : "Niet van toepassing";
        el.style.display = "block";
        el.innerHTML = `
          <strong>Maximaal aantal beurten:</strong> ${maxText}<br>
          <strong>Punten:</strong>
          Winst &lt; max: ${p.winLess}, Gelijk &lt; max: ${p.drawLess}, Verlies &lt; max: ${p.loseLess} |
          Winst = max: ${p.winMax}, Gelijk = max: ${p.drawMax}, Verlies = max: ${p.loseMax}`;
      }

      function updateR2OverallProgress() {
        const total = r2Matches.length;
        const played = r2Matches.filter((m) => m.afgerond).length;
        const perc = total ? Math.round((played / total) * 100) : 0;
        const el = document.getElementById("r2OverallProgress");
        el.style.display = total === 0 ? "none" : "block";
        el.textContent = `Totaal gespeeld: ${played} / ${total} wedstrijden (${perc}%)`;
      }

      /* =========================================================
         2E RONDE RESULTATEN ‚Äì WEDSTRIJDEN LADEN
      ========================================================= */
      async function loadR2MatchesFromFirestore() {
        if (!activeTournamentId) {
          document.getElementById("noTournamentR2ResNotice").style.display =
            "block";
          return;
        }
        document.getElementById("noTournamentR2ResNotice").style.display =
          "none";

        const tournRef = doc(db, "toernooien", activeTournamentId);
        const tournSnap = await getDoc(tournRef);
        r2ToernooiSettings = tournSnap.data() || {};
        renderR2ScoringOverview();

        const matchesRef = collection(
          db,
          "toernooien",
          activeTournamentId,
          "r2_wedstrijden"
        );
        const snap = await getDocs(matchesRef);
        r2Matches = snap.docs.map((d) => ({ id: d.id, ...d.data() }));

        const poulesRef = collection(
          db,
          "toernooien",
          activeTournamentId,
          "poules_r2"
        );
        const poulesSnap = await getDocs(poulesRef);
        r2PoulesCache = poulesSnap.docs.map((d) => ({ id: d.id, ...d.data() }));
        renderR2Matches();
        updateR2ResultsButtons(); // ‚úÖ knoppen altijd goed zetten na laden
      }

      // ======================================================================
      // 2E RONDE RESULTATEN ‚Äì ALLE WEDSTRIJDEN VAN EEN POULE OPNIEUW BEREKENEN
      // ======================================================================
      async function recalcR2PouleMatches(pouleId) {
        if (!activeTournamentId) return;

        const pouleDoc = r2PoulesCache.find((p) => p.id === pouleId);
        if (!pouleDoc) return;

        // Alle wedstrijden van deze poule
        const matchesInPoule = r2Matches.filter((m) => m.poule === pouleId);

        for (const m of matchesInPoule) {
          if (!m.afgerond) continue; // alleen afgeronde wedstrijden herberekenen

          const gX = Number(m.gemaakteX) || 0;
          const gY = Number(m.gemaakteY) || 0;
          const b = Number(m.beurten) || 0;

          // Punten opnieuw bepalen op basis van DE NIEUWE factor
          const { pX, pY, uitslag } = calcR1Points(
            gX,
            gY,
            b,
            toernooiSettings.maxBeurten || 0,
            m.spelerX.teMaken,
            m.spelerY.teMaken,
            toernooiSettings.punten,
            pouleDoc
          );

          // Opslaan in Firestore
          await saveR2MatchResultFields(m.id, {
            gemaakteX: gX,
            gemaakteY: gY,
            beurten: b,
            puntenX: pX,
            puntenY: pY,
            uitslag,
          });

          // Update lokale cache
          m.puntenX = pX;
          m.puntenY = pY;
          m.uitslag = uitslag;
        }

        // UI opnieuw opbouwen
        await loadR2MatchesFromFirestore();
      }

      /* =========================================================
         2E RONDE RESULTATEN ‚Äì WEDSTRIJDEN TONEN
      ========================================================= */
      function renderR2Matches() {
        const wrapper = document.getElementById("r2matchesWrapper");
        wrapper.innerHTML = "";
        if (!r2Matches.length) {
          wrapper.innerHTML =
            "<p style='color:#777'>Geen wedstrijden gevonden.</p>";
          updateR2OverallProgress();
          document.getElementById("r2GlobalStandTable").innerHTML = "";
          return;
        }
        updateR2OverallProgress();

        const pouleMap = {};
        r2Matches.forEach((m) => {
          if (!pouleMap[m.poule]) pouleMap[m.poule] = [];
          pouleMap[m.poule].push(m);
        });

        Object.keys(pouleMap)
          .sort()
          .forEach((pouleNaam) => {
            const matchesRaw = pouleMap[pouleNaam];
            const pouleDoc = r2PoulesCache.find((p) => p.id === pouleNaam);
            const pouleSize = pouleDoc?.spelers?.length || 4;
            const is5 = pouleSize === 5;
            const matches = sortHomeAway(matchesRaw); // hergebruik bestaande helper

            const played = matches.filter((m) => m.afgerond).length;
            const total = matches.length;
            const perc = total ? Math.round((played / total) * 100) : 0;

            const headerId = `r2phead_${pouleNaam}`;
            const bodyId = `r2pbody_${pouleNaam}`;

            // factor-info uit pouleDoc (indien aanwezig)
            const basePlayers = pouleDoc?.factorBasePlayers || 4;
            const factorEnabled = !!pouleDoc?.factorEnabled;
            const rawFactorValue =
              typeof pouleDoc?.factorValue === "number"
                ? pouleDoc.factorValue
                : null;

            let factorValue;
            if (factorEnabled && rawFactorValue != null) {
              factorValue = rawFactorValue;
            } else if (is5) {
              // default 5-spelers poule ‚Üí 0,75
              factorValue = 0.75;
            } else {
              factorValue = 1.0;
            }

            const factorText =
              factorValue !== 1
                ? `(punten √ó${factorValue.toFixed(2).replace(".", ",")})`
                : "";

            const factorNote = pouleDoc?.factorNote || "";
            const factorBadge =
              factorEnabled && factorValue !== 1
                ? `<span
                    class="r2-poule-factor-indicator"
                    title="${
                      factorNote
                        ? "Toelichting: " + factorNote.replace(/"/g, "&quot;")
                        : "Afwijkende factor voor puntentelling in deze poule"
                    }"
                    style="margin-left:4px;font-size:0.75em;background:#fff3cd;color:#856404;border-radius:999px;padding:2px 6px;border:1px solid #ffe69c;"
                  >!</span>`
                : "";

            const wasOpen = pouleOpenStateR2[pouleNaam] === true;

            let html = `
              <div class="poule-block" data-poule="${pouleNaam}" style="border:1px solid #ccc;border-radius:8px;background:#fff;margin-bottom:16px">
                <div
                  id="${headerId}"
                  class="poule-header"
                  style="cursor:pointer;display:flex;justify-content:space-between;align-items:center;background:#e9f5ff;padding:8px 10px;border-radius:8px 8px 0 0;font-weight:600"
                >
                  <div style="display:flex;align-items:center;gap:6px;">
                    <strong>${pouleNaam}</strong>
                    ${
                      factorText
                        ? `<span style="font-size:0.85em;color:#0c6dfd;">${factorText}</span>`
                        : ""
                    }
                    ${factorBadge}
                    <button
                      type="button"
                      class="r2-poule-factor-btn"
                      data-poule="${pouleNaam}"
                      title="Factor voor puntentelling instellen (2e ronde)"
                      style="margin-left:4px;background:#ffc107;color:#212529;border:none;border-radius:50%;width:22px;height:22px;font-size:0.9em;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;"
                    >!</button>
                  </div>
                  <div style="font-size:0.85em;color:#34495e;">
                    Totaal gespeeld: ${played} / ${total} wedstrijden (${perc}%)
                  </div>
                </div>
                   <div id="${bodyId}" class="poule-body"
                    style="display:${
                      wasOpen ? "block" : "none"
                    };padding:10px 10px 12px">

                <table style="width:100%;border-collapse:collapse;font-size:0.92em">
                  <thead style="background:#eef2f6">
                    <tr>
                      <th style="text-align:left;padding:6px 4px">Speler A</th>
                      <th style="text-align:right;padding:6px 4px">Te&nbsp;maken A</th>
                      <th style="text-align:left;padding:6px 4px">Speler B</th>
                      <th style="text-align:right;padding:6px 4px">Te&nbsp;maken B</th>
                      <th style="text-align:right;padding:6px 4px">Gemaakte A</th>
                      <th style="text-align:right;padding:6px 4px">Gemaakte B</th>
                      <th style="text-align:right;padding:6px 4px">Beurten</th>
                      <th style="text-align:center;padding:6px 4px">Uitslag</th>
                      <th style="text-align:center;padding:6px 4px">Acties</th>
                    </tr>
                  </thead>
                  <tbody>`;

            matches.forEach((m) => {
              const gX = m.gemaakteX ?? "";
              const gY = m.gemaakteY ?? "";
              const b = m.beurten ?? "";
              const uitslag =
                m.puntenX != null && m.puntenY != null
                  ? `${m.puntenX} - ${m.puntenY}`
                  : "";
              const rowBg = m.afgerond ? "background:#B3FF87" : "";

              html += `
              <tr data-matchid="${
                m.id
              }" style="border-bottom:1px solid #eee;${rowBg}">
                <td style="padding:6px 4px">${m.spelerX?.naam ?? ""}</td>
                <td style="padding:6px 4px;text-align:right">${
                  m.spelerX?.teMaken ?? ""
                }</td>
                <td style="padding:6px 4px">${m.spelerY?.naam ?? ""}</td>
                <td style="padding:6px 4px;text-align:right">${
                  m.spelerY?.teMaken ?? ""
                }</td>
                <td style="padding:6px 4px;text-align:right"><input type="number" value="${gX}" class="r2-input" data-field="gemaakteX" style="width:70px;text-align:right"></td>
                <td style="padding:6px 4px;text-align:right"><input type="number" value="${gY}" class="r2-input" data-field="gemaakteY" style="width:70px;text-align:right"></td>
                <td style="padding:6px 4px;text-align:right"><input type="number" value="${b}" class="r2-input" data-field="beurten" style="width:70px;text-align:right"></td>
                <td style="padding:6px 4px;text-align:center;font-weight:600">${uitslag}</td>
                <td style="padding:6px 4px;text-align:center">
                  <button class="actie-btn save" data-action="save" title="Opslaan">üíæ</button>
                  <button class="actie-btn reset" data-action="reset" title="Uitslag verwijderen">üóëÔ∏è</button>
                </td>
              </tr>`;
            });

            html += `</tbody></table>`;
            html += `<div style="margin-top:12px;border-top:1px dashed #ddd;padding-top:10px">${renderPouleStandHTML(
              pouleNaam,
              matches,
              pouleDoc
            )}</div>`;
            html += `</div></div>`;
            wrapper.insertAdjacentHTML("beforeend", html);

            // in/uitklappen ‚Äì beginstatus: ingeklapt
            const headerEl = document.getElementById(headerId);
            const bodyEl = document.getElementById(bodyId);

            // bij initial render alles dicht
            bodyEl.style.display = "none";
            headerEl.style.borderRadius = "8px";

            headerEl.addEventListener("click", () => {
              const hidden = bodyEl.style.display === "none";
              bodyEl.style.display = hidden ? "block" : "none";
              headerEl.style.borderRadius = hidden ? "8px 8px 0 0" : "8px";
              pouleOpenStateR2[pouleNaam] = hidden; // onthouden
            });

            // factor-knop koppelen (voorkom dat de header inklapt)
            const factorBtn = document.querySelector(
              `.r2-poule-factor-btn[data-poule="${pouleNaam}"]`
            );
            if (factorBtn) {
              factorBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                configureR2PouleFactor(pouleNaam);
              });
            }
          });

        // globale stand
        const globalStats = buildGlobalRankingFromStats(
          r2Matches,
          r2PoulesCache
        );
        let gHtml = `
          <table style="width:100%;border-collapse:collapse;font-size:0.9em;margin-top:10px">
            <thead style="background:#f8f9fa">
              <tr>
                <th style="text-align:left;padding:4px;border-bottom:1px solid #ddd">#</th>
                <th style="text-align:left;padding:4px;border-bottom:1px solid #ddd">Speler</th>
                <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">Ptn</th>
                <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">Rang&nbsp;Ptn</th>
                <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">%Car</th>
                <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">Rang&nbsp;%Car</th>
                <th style="text-align:right;padding:4px;border-bottom:1px solid #ddd">Totaal&nbsp;Rang</th>
              </tr>
            </thead>
            <tbody>`;
        globalStats.forEach((row, idx) => {
          const percCarText = row.percCar.toFixed(1).replace(".", ",") + "%";
          const isTop8 = idx < 8;
          const bgColor = isTop8 ? "background:#d1e7dd;" : "";
          gHtml += `
            <tr style="border-bottom:1px solid #eee;${bgColor}">
              <td style="padding:4px">${idx + 1}</td>
              <td style="padding:4px">${row.naam}</td>
              <td style="padding:4px;text-align:right">${Number(
                row.puntenTotaal
              )}</td>
              <td style="padding:4px;text-align:right">${row.rankPoints_punten.toFixed(
                1
              )}</td>
              <td style="padding:4px;text-align:right">${percCarText}</td>
              <td style="padding:4px;text-align:right">${row.rankPoints_percCar.toFixed(
                1
              )}</td>
              <td style="padding:4px;text-align:right;font-weight:600">${row.rankTotaal.toFixed(
                1
              )}</td>
            </tr>`;
        });
        gHtml += `</tbody></table>`;
        document.getElementById("r2GlobalStandTable").innerHTML = gHtml;
      }

      // ----------------------------------------------------------
      // 2E RONDE RESULTATEN ‚Äì factor per poule instellen
      // ----------------------------------------------------------
      async function configureR2PouleFactor(pouleId) {
        if (!activeTournamentId) {
          alert("Er is geen actief toernooi geladen.");
          return;
        }

        const pouleDoc = r2PoulesCache.find((p) => p.id === pouleId);
        if (!pouleDoc) {
          alert("Poule niet gevonden.");
          return;
        }

        const huidigeActual = pouleDoc.factorActualPlayers || "";
        const huidigeNote = pouleDoc.factorNote || "";
        const basePlayers = pouleDoc.factorBasePlayers || 4;

        const input = prompt(
          `Werkelijk aantal spelers voor puntentelling in ${pouleId} (leeg = factor uitzetten):`,
          huidigeActual ? String(huidigeActual) : ""
        );
        if (input === null) return; // gebruiker annuleert

        const trimmed = input.trim();

        const pouleRef = doc(
          db,
          "toernooien",
          activeTournamentId,
          "poules_r2",
          pouleId
        );

        // Leeg = factor uitzetten, terug naar normale logica
        if (trimmed === "") {
          await updateDoc(pouleRef, {
            factorEnabled: false,
          });
          pouleDoc.factorEnabled = false;
          await loadR2MatchesFromFirestore();
          return;
        }

        const actual = Number(trimmed);
        if (!Number.isFinite(actual) || actual < 2 || actual > 8) {
          alert("Voer een geldig aantal spelers in (minimaal 2, maximaal 8).");
          return;
        }

        const note = prompt(
          "Korte toelichting (wordt als mouse-over getoond, bijv. welke speler is uitgevallen):",
          huidigeNote
        );

        // Factor berekenen op basis van 'normaal' aantal spelers vs werkelijk aantal
        const refPlayers = basePlayers || 4; // standaard 4
        const matchesRef = (refPlayers - 1) * 2;
        const matchesActual = (actual - 1) * 2;
        const factor = matchesActual > 0 ? matchesRef / matchesActual : 1.0;

        const factorEnabled = Math.abs(factor - 1) > 0.0001;

        await updateDoc(pouleRef, {
          factorEnabled,
          factorBasePlayers: refPlayers,
          factorActualPlayers: actual,
          factorValue: factor,
          factorNote: note || "",
        });

        // lokale cache bijwerken
        pouleDoc.factorEnabled = factorEnabled;
        pouleDoc.factorBasePlayers = refPlayers;
        pouleDoc.factorActualPlayers = actual;
        pouleDoc.factorValue = factor;
        pouleDoc.factorNote = note || "";

        // ============================
        // Uitslagen opnieuw berekenen
        // ============================
        await recalcR2PouleMatches(pouleId);

        // alles opnieuw laden met nieuwe factor
        await loadR2MatchesFromFirestore();
      }

      /* =========================================================
         2E RONDE RESULTATEN ‚Äì EVENT-LISTENERS VOOR ACTIE-KNOPPEN
      ========================================================= */
      document
        .getElementById("r2matchesWrapper")
        .addEventListener("click", async (e) => {
          const btn = e.target.closest(".actie-btn");
          if (!btn) return;
          e.stopPropagation();
          const tr = btn.closest("tr");
          const id = tr.dataset.matchid;
          const action = btn.dataset.action;

          if (action === "save") {
            const inputs = tr.querySelectorAll(".r2-input");
            const values = {};
            inputs.forEach((i) => (values[i.dataset.field] = Number(i.value)));

            const m = r2Matches.find((x) => x.id === id);
            const err = validateR1Inputs(
              values.gemaakteX,
              values.gemaakteY,
              values.beurten,
              r2ToernooiSettings.maxBeurten || 0,
              m.spelerX.teMaken,
              m.spelerY.teMaken
            );
            if (err) {
              showR2PopupMessage(err, true);
              return;
            }

            const pouleDoc = r2PoulesCache.find((p) => p.id === m.poule);
            const { pX, pY, uitslag } = calcR1Points(
              values.gemaakteX,
              values.gemaakteY,
              values.beurten,
              r2ToernooiSettings.maxBeurten || 0,
              m.spelerX.teMaken,
              m.spelerY.teMaken,
              r2ToernooiSettings.punten,
              pouleDoc
            );

            await saveR2MatchResultFields(id, {
              gemaakteX: values.gemaakteX,
              gemaakteY: values.gemaakteY,
              beurten: values.beurten,
              puntenX: pX,
              puntenY: pY,
              resultaat: uitslag,
              afgerond: true,
            });
          } else if (action === "reset") {
            await resetR2MatchResult(id);
          }
        });

      /* =========================================================
         2E RONDE RESULTATEN ‚Äì HELPERS (hergebruik 1e ronde)
      ========================================================= */
      async function saveR2MatchResultFields(matchId, update) {
        const ref = doc(
          db,
          "toernooien",
          activeTournamentId,
          "r2_wedstrijden",
          matchId
        );
        await updateDoc(ref, update);
        showR2PopupMessage("‚úÖ Wedstrijd opgeslagen", false);
        await loadR2MatchesFromFirestore();
      }
      async function resetR2MatchResult(matchId) {
        const ok = confirm(
          "Alleen de ingevoerde resultaten van deze wedstrijd verwijderen?"
        );
        if (!ok) return;
        const ref = doc(
          db,
          "toernooien",
          activeTournamentId,
          "r2_wedstrijden",
          matchId
        );
        await updateDoc(ref, {
          gemaakteX: null,
          gemaakteY: null,
          beurten: null,
          puntenX: null,
          puntenY: null,
          afgerond: false,
          resultaat: null,
        });
        showR2PopupMessage("üóëÔ∏è Uitslag verwijderd", false);
        await loadR2MatchesFromFirestore();
      }

      /* =========================================================
         2E RONDE RESULTATEN ‚Äì WEDSTRIJDEN AANMAKEN
      ========================================================= */
      async function createR2MatchSchedule() {
        if (!activeTournamentId) {
          showR2PopupMessage("‚ö†Ô∏è Geen toernooi geselecteerd.", true);
          return;
        }
        const poules = await getR2Poules();
        if (!poules.length) {
          showR2PopupMessage(
            "‚ö†Ô∏è Geen poules gevonden. Maak eerst een poule-indeling.",
            true
          );
          return;
        }

        const matchesRef = collection(
          db,
          "toernooien",
          activeTournamentId,
          "r2_wedstrijden"
        );
        const existingSnap = await getDocs(matchesRef);
        if (!existingSnap.empty) {
          const confirmOverwrite = confirm(
            `Er bestaan al ${existingSnap.size} wedstrijden in 2e ronde.\n\nWil je deze overschrijven? Alle bestaande uitslagen gaan verloren.`
          );
          if (!confirmOverwrite) return;
          const batch = writeBatch(db);
          existingSnap.forEach((d) => batch.delete(d.ref));
          await batch.commit();
        }

        const batch = writeBatch(db);
        let totalMatches = 0;
        poules.forEach((poule) => {
          const spelers = poule.spelers || [];
          for (let i = 0; i < spelers.length; i++) {
            for (let j = 0; j < spelers.length; j++) {
              if (i === j) continue;
              const safePouleId = poule.id.replace(/\s+/g, "_");
              const matchId = `${safePouleId}_${spelers[i].id}_${spelers[j].id}`;
              const matchRef = doc(
                db,
                "toernooien",
                activeTournamentId,
                "r2_wedstrijden",
                matchId
              );
              batch.set(matchRef, {
                poule: poule.id,
                spelerX: {
                  id: spelers[i].id,
                  naam: spelers[i].naam,
                  teMaken:
                    spelers[i].carambolesR2 || spelers[i].caramboles || 0,
                },
                spelerY: {
                  id: spelers[j].id,
                  naam: spelers[j].naam,
                  teMaken:
                    spelers[j].carambolesR2 || spelers[j].caramboles || 0,
                },
                gemaakteX: null,
                gemaakteY: null,
                beurten: null,
                puntenX: null,
                puntenY: null,
                afgerond: false,
                resultaat: null,
              });
              totalMatches++;
            }
          }
        });
        await batch.commit();
        showR2PopupMessage(
          `‚úÖ Wedstrijdschema 2e ronde aangemaakt: ${totalMatches} wedstrijden.`,
          false
        );
        await loadR2MatchesFromFirestore();
      }

      /* =========================================================
         2E RONDE RESULTATEN ‚Äì WEDSTRIJDEN WISSEN
      ========================================================= */
      async function deleteR2Matches() {
        if (!activeTournamentId) {
          showR2PopupMessage("‚ö†Ô∏è Geen toernooi geselecteerd.", true);
          return;
        }
        const confirmDelete = confirm(
          "Weet je zeker dat je ALLE wedstrijden van de 2e ronde wilt verwijderen?\n\n‚ö†Ô∏è Alle ingevoerde uitslagen gaan verloren!"
        );
        if (!confirmDelete) return;
        const matchesRef = collection(
          db,
          "toernooien",
          activeTournamentId,
          "r2_wedstrijden"
        );
        const snap = await getDocs(matchesRef);
        if (snap.empty) {
          showR2PopupMessage(
            "Er zijn geen wedstrijden om te verwijderen.",
            true
          );
          return;
        }
        const batch = writeBatch(db);
        let count = 0;
        snap.forEach((d) => {
          batch.delete(d.ref);
          count++;
        });
        await batch.commit();
        showR2PopupMessage(
          `üóëÔ∏è ${count} wedstrijden 2e ronde verwijderd.`,
          false
        );
        await loadR2MatchesFromFirestore();
      }

      /* =========================================================
         2E RONDE RESULTATEN ‚Äì POULES OPVRAGEN
      ========================================================= */
      async function getR2Poules() {
        const poulesRef = collection(
          db,
          "toernooien",
          activeTournamentId,
          "poules_r2"
        );
        const snap = await getDocs(poulesRef);
        return snap.docs.map((d) => ({ id: d.id, ...d.data() }));
      }

      /* =========================================================
   ADMIN TAB: USERS CRUD
========================================================= */
      const userForm = document.getElementById("userForm");
      const usersTableWrap = document.getElementById("usersTableWrap");
      const adminFeedback = document.getElementById("adminFeedback");
      const linkUserSelect = document.getElementById("linkUserSelect");
      const linkTournamentsList = document.getElementById(
        "linkTournamentsList"
      );
      const saveLinksBtn = document.getElementById("saveLinksBtn");

      let adminUsersCache = [];
      let adminTournamentsCache = [];

      function showAdminFeedback(msg, type = "info") {
        const color =
          type === "error"
            ? "#f8d7da"
            : type === "success"
            ? "#d1e7dd"
            : "#e2e3e5";
        const textColor =
          type === "error"
            ? "#842029"
            : type === "success"
            ? "#0f5132"
            : "#41464b";
        adminFeedback.innerHTML = `
    <div class="message" style="background:${color};color:${textColor};">
      ${msg}
      <span class="close" onclick="this.parentElement.remove()">√ó</span>
    </div>`;
      }

      async function loadUsersAdminTab() {
        const snap = await getDocs(collection(db, "users"));
        adminUsersCache = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
        renderUsersTable();
        buildLinkUserSelect();
      }

      function renderTournamentBadges(tournamentIds) {
        if (!tournamentIds.length) return "0";

        const labels = tournamentIds.map((tid) => {
          const t = adminTournamentsCache.find((x) => x.id === tid);
          if (!t) return tid; // fallback als cache nog leeg is
          return `${t.naam} (${t.jaar})`;
        });

        const count = tournamentIds.length;
        return `
        <div style="display:flex;flex-direction:column;gap:4px;">
          <div><strong>${count}</strong></div>
          <div style="font-size:12px;color:#555;">
            ${labels.join("<br>")}
          </div>
        </div>
      `;
      }

      function renderUsersTable() {
        if (!usersTableWrap) return;

        if (!adminUsersCache.length) {
          usersTableWrap.innerHTML = "<p>Nog geen gebruikers.</p>";
          return;
        }

        let html = `
    <table class="player-table">
      <thead>
        <tr>
          <th>Gebruikersnaam</th>
          <th>Naam</th>
          <th>Rol</th>
          <th>Toernooien</th>
          <th style="text-align:center;">Acties</th>
        </tr>
      </thead>
      <tbody>`;

        adminUsersCache.forEach((u) => {
          html += `
      <tr data-uid="${u.id}">
        <td>${u.username || ""}</td>
        <td>${u.displayName || ""}</td>
        <td>${u.role || "user"}</td>
        <td>
          ${renderTournamentBadges(u.tournaments || [])}
        </td>

        <td class="actions">
          <button class="edit-user-btn" style="background:#0d6efd;color:#fff;border:none;border-radius:6px;padding:4px 8px;">‚úèÔ∏è</button>
          <button class="delete-user-btn" style="background:#dc3545;color:#fff;border:none;border-radius:6px;padding:4px 8px;">üóëÔ∏è</button>
        </td>
      </tr>`;
        });

        html += `</tbody></table>`;
        usersTableWrap.innerHTML = html;

        usersTableWrap.querySelectorAll(".edit-user-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const tr = btn.closest("tr");
            const u = adminUsersCache.find((x) => x.id === tr.dataset.uid);
            if (!u) return;
            document.getElementById("uUsername").value = u.username || "";
            document.getElementById("uDisplay").value = u.displayName || "";
            document.getElementById("uRole").value = u.role || "user";
            document.getElementById("uPassword").value = ""; // leeg laten => alleen wijzigen als ingevuld
            userForm.dataset.editing = u.id;
            showAdminFeedback(`Bewerken: ${u.username}`, "info");
          });
        });

        usersTableWrap.querySelectorAll(".delete-user-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const tr = btn.closest("tr");
            const uid = tr.dataset.uid;
            const u = adminUsersCache.find((x) => x.id === uid);
            if (!u) return;

            // ‚úÖ Check: laatste admin mag niet verwijderd worden
            if (u.role === "admin") {
              const adminsLeft = adminUsersCache.filter(
                (x) => x.role === "admin" && x.id !== uid
              );
              if (adminsLeft.length === 0) {
                showAdminFeedback(
                  "Je kunt de laatste admin niet verwijderen.",
                  "error"
                );
                return;
              }
            }

            if (!confirm(`Verwijder gebruiker "${u.username}"?`)) return;

            await deleteDoc(doc(db, "users", uid));
            showAdminFeedback("Gebruiker verwijderd.", "success");
            await loadUsersAdminTab();
          });
        });
      }

      userForm?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const username = document.getElementById("uUsername").value.trim();
        const displayName = document.getElementById("uDisplay").value.trim();
        const password = document.getElementById("uPassword").value;
        const role = document.getElementById("uRole").value;

        if (!username || !displayName) {
          showAdminFeedback("Gebruikersnaam en naam zijn verplicht.", "error");
          return;
        }

        const editingId = userForm.dataset.editing || null;

        // ‚úÖ check: laatste admin mag niet gedegradeerd worden
        if (editingId) {
          const existing = adminUsersCache.find((x) => x.id === editingId);
          if (existing?.role === "admin" && role !== "admin") {
            const otherAdmins = adminUsersCache.filter(
              (x) => x.role === "admin" && x.id !== editingId
            );
            if (otherAdmins.length === 0) {
              showAdminFeedback(
                "Je kunt de laatste admin niet omzetten naar gebruiker.",
                "error"
              );
              return;
            }
          }
        }

        // wachtwoord alleen verplicht bij nieuwe user
        if (!editingId && !password) {
          showAdminFeedback(
            "Wachtwoord is verplicht bij nieuwe gebruiker.",
            "error"
          );
          return;
        }

        // username uniek houden
        const lower = username.toLowerCase();
        const conflict = adminUsersCache.find(
          (u) => u.username?.toLowerCase() === lower && u.id !== editingId
        );
        if (conflict) {
          showAdminFeedback("Gebruikersnaam bestaat al.", "error");
          return;
        }

        const data = { username, displayName, role };

        if (password) {
          data.password = password;
        }

        if (editingId) {
          await setDoc(doc(db, "users", editingId), data, { merge: true });
          showAdminFeedback("Gebruiker bijgewerkt.", "success");
          userForm.dataset.editing = "";
        } else {
          data.tournaments = [];
          await addDoc(collection(db, "users"), data);
          showAdminFeedback("Gebruiker toegevoegd.", "success");
        }

        userForm.reset();
        await loadUsersAdminTab();
      });

      /* =========================================================
   ADMIN TAB: TOERNOOI KOPPELINGEN
========================================================= */
      async function loadTournamentsForLinking() {
        const snap = await getDocs(collection(db, "toernooien"));
        adminTournamentsCache = snap.docs.map((d) => ({
          id: d.id,
          ...d.data(),
        }));
        renderTournamentsChecklist();

        // ‚úÖ extra: nu cache gevuld is, usertabel opnieuw tekenen met namen
        renderUsersTable();
      }

      function buildLinkUserSelect() {
        if (!linkUserSelect) return;
        linkUserSelect.innerHTML = `<option value="">Kies gebruiker...</option>`;
        adminUsersCache.forEach((u) => {
          linkUserSelect.innerHTML += `<option value="${u.id}">${u.username} (${u.displayName})</option>`;
        });

        linkUserSelect.onchange = () => renderTournamentsChecklist();
      }

      function renderTournamentsChecklist() {
        if (!linkTournamentsList) return;
        const uid = linkUserSelect.value;
        const user = adminUsersCache.find((u) => u.id === uid);

        linkTournamentsList.innerHTML = "";

        adminTournamentsCache
          .sort(
            (a, b) =>
              (a.jaar || 0) - (b.jaar || 0) ||
              (a.naam || "").localeCompare(b.naam || "")
          )
          .forEach((t) => {
            const checked = user?.tournaments?.includes(t.id) ? "checked" : "";
            const row = document.createElement("label");
            row.style.display = "block";
            row.style.marginBottom = "4px";
            row.innerHTML = `
        <input type="checkbox" data-tid="${t.id}" ${checked} />
        ${t.naam} (${t.jaar})
      `;
            linkTournamentsList.appendChild(row);
          });
      }

      saveLinksBtn?.addEventListener("click", async () => {
        const uid = linkUserSelect.value;
        if (!uid) {
          showAdminFeedback("Kies eerst een gebruiker.", "error");
          return;
        }
        const selected = [
          ...linkTournamentsList.querySelectorAll("input[type=checkbox]"),
        ]
          .filter((cb) => cb.checked)
          .map((cb) => cb.dataset.tid);

        await setDoc(
          doc(db, "users", uid),
          { tournaments: selected },
          { merge: true }
        );
        showAdminFeedback("Koppelingen opgeslagen.", "success");
        await loadUsersAdminTab();
      });

      /* =========================================================
   1E RONDE RESULTATEN ‚Äì AUTO-LADEN BIJ TAB-KLIK
========================================================= */
      document
        .querySelector('button[data-tab="r1resultaten"]')
        .addEventListener("click", () => {
          Object.keys(pouleOpenState).forEach(
            (k) => (pouleOpenState[k] = false)
          );
          loadR1MatchesFromFirestore(); // vult r1Matches
          updateR1ResultsButtons(); // zet knoppen direct goed
        });

      /* =========================================================
         2E RONDE RESULTATEN ‚Äì AUTO-LADEN BIJ TAB-KLIK
      ========================================================= */
      document
        .querySelector('button[data-tab="r2resultaten"]')
        .addEventListener("click", async () => {
          Object.keys(pouleOpenStateR2).forEach(
            (k) => (pouleOpenStateR2[k] = false)
          );
          await loadR2MatchesFromFirestore(); // vult r2Matches + r2PoulesCache
          updateR2ResultsButtons(); // zet knoppen direct goed
        });

      /* =========================================================
         2E RONDE RESULTATEN ‚Äì KNOPPEN EVENT LISTENERS
      ========================================================= */
      document
        .getElementById("createR2MatchesBtn")
        .addEventListener("click", createR2MatchSchedule);
      document
        .getElementById("deleteR2MatchesBtn")
        .addEventListener("click", deleteR2Matches);

      /* =========================================================
                                                 EVENT LISTENERS VOOR TOERNOOI KNOPPEN
                                                 ========================================================= */
      document
        .getElementById("tournamentForm")
        .addEventListener("submit", (e) => {
          e.preventDefault();
          saveTournament();
        });

      document
        .getElementById("loadBtn")
        .addEventListener("click", loadTournamentList);
      document
        .getElementById("deleteBtn")
        .addEventListener("click", deleteTournament);

      // ‚úÖ TOEVOEGEN: Event listeners voor de spelerslijst status knoppen
      if (finalizeBtn)
        finalizeBtn.addEventListener("click", finalizePlayersAction);
      if (editBtn) editBtn.addEventListener("click", editPlayersAction);

      document
        .getElementById("createMatchesBtn")
        .addEventListener("click", createR1MatchSchedule);

      document
        .getElementById("deleteMatchesBtn")
        .addEventListener("click", deleteR1Matches);

      /* =========================================================
                                                 INIT
                                                 ========================================================= */
      document.addEventListener("DOMContentLoaded", showConnectionBanner);
      guardSpelersTabAvailability();

      if (typeof updateR2PoulesButtons === "function") {
        updateR2PoulesButtons();
      }
    </script>
  </body>
</html>
